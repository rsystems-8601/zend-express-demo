!function(){var e=angular.module("pacificaDirectives",[]);e.directive("practitionerOnboarding",["$sce","$parse",function(e,t){return{restrict:"E",templateUrl:"templates/practitioner/onboarding.directive.html",replace:!0,scope:!0,controller:["$scope","$state","$element","$timeout","$analytics","$translate","$ionicPopup","$ionicModal","MediaService","AccountService","PractitionerService","GeneralService","Environment","OverlayService",function(t,e,n,i,a,o,r,c,l,s,u,d,f,p){t.isStepComplete=function(e){return 1==e?t.isEmailValidated():2==e?t.hasSignedTOS():t.hasSignedBAA()},t.checkEmailValidation=function(){s.checkRemoteEmailValidation().success(function(e){e.validated?s.getAccountUser().user.emailVerifiedAt=new Date:r.alert({title:o.instant("CHECK_EMAIL"),template:o.instant("EMAIL_NOT_YET_VALIDATED"),okText:o.instant("OK_GOT_IT"),okType:"button-default"})}).error(function(){r.alert({template:o.instant("GENERIC_ERROR"),okText:o.instant("OK_GOT_IT"),okType:"button-default"})})},t.resendEmailValidation=function(){s.resendValidationEmail().success(function(){var e=o.instant("VALIDATION_EMAIL_SENT_WITH_EMAIL");e=e.replace("XXXEMAILXXX",s.getAccountUser().user.email),r.alert({title:o.instant("VALIDATE_EMAIL"),template:e,okText:o.instant("OK_GOT_IT"),okType:"button-default"})}).error(function(e,t,n,i){r.alert({template:o.instant("GENERIC_ERROR"),okText:o.instant("OK_GOT_IT"),okType:"button-default"})})},t.showTOSModal=function(){p.modal.open({modalId:"TermsOfServiceModal",templateUrl:"templates/practitioner/supplemental.tos.modal.html",scope:t,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){t.tosModal=e})},t.closeTOSModal=function(){p.modal.close(t.tosModal).then(function(e){t.tosModal=e})},t.approveSupplementalTos=function(){t.closeTOSModal(),s.setUserPreference("signed_supplemental_tos","true")},t.reviewBAA=function(){t.checkForBAAModal()}}]}}]),e.directive("postUpgrade",["$sce","$parse",function(e,t){return{restrict:"E",templateUrl:"templates/practitioner/postupgrade.directive.html",replace:!0,scope:!0,controller:["$sce","$scope","$state","$element","$timeout","$analytics","$translate","$ionicPopup","MediaService","AccountService","PractitionerService","GeneralService","Environment",function(e,t,n,i,a,o,r,c,l,s,u,d,f){t.dismiss=function(){c.confirm({template:"<div>"+r.instant("DISMISS_POST_UPGRADE_WORKFLOW")+"</div>",cancelText:r.instant("CANCEL"),cancelType:"button-default",okText:r.instant("DISMISS"),okType:"button-default"}).then(function(e){e&&s.setUserPreference("practitioner_completed_postupgrade",!0)})},t.getBAAText=function(){return e.getTrustedHtml(r.instant("PLEASE_SIGN_BAA"))},t.goToClients=function(e){n.go("practitioner.clients",{invite:e})},t.isStepComplete=function(e){if(1==e){var t=s.getAccountUser();if(t&&t.practitioner)return t.practitioner.baaSigned}else{return 2==e?u.hasInvitedOther():"true"==s.getUserPreference("practitioner_completed_postupgrade")}return!1}}]}}]),e.directive("contenteditable",["$sce","$parse",function(r,c){return{restrict:"A",require:"?ngModel",link:function(e,t,n,i){var a;i&&(i.$render=function(){try{t.html(r.getTrustedHtml(i.$viewValue||""))}catch(e){console.log("Caught strange contenteditable unsafe error that has no effect.")}},t.on("blur keyup change",function(){e.$evalAsync(o)}),a=c(n.ngModel)(e),t.html(a));function o(){var e=t.html();n.stripBr&&"<br>"==e&&(e=""),i.$setViewValue(e)}}}}]),e.directive("audioLineItem",function(){return{restrict:"E",templateUrl:"templates/audioLineItem.html",replace:!0,scope:{src:"=",duration:"=",tags:"=",bgColor:"@",hide:"="},controller:["$scope","$element","$timeout","$analytics","$translate","$ionicPopup","MediaService","GeneralService","Environment",function(c,e,t,i,n,a,o,r,l){var s=e.find(".audioPlayer")[0];function u(){var e=playingAudioLineItems.indexOf(c);0<=e&&playingAudioLineItems.splice(e,1)}s.id="jwPlayer"+ ++playerIds,c.media=jwplayer(s),c.media.setup({file:c.src,primary:"html5",height:40}),c.media.on("setupError",function(e){console.log("error",e)}),c.media.on("error",function(e){console.log("error",e)}),c.loading=!1,c.playing=!1,c.currentTime=0,c.canvasScale=window.devicePixelRatio,c.getDuration=function(){return r.getTimeDisplay(c.duration)},c.getAudioClass=function(){return c.loading?"loading":c.playing?"playing":"paused"},c.monitorPlay=function(){var e=c.media.getPosition();e<0&&(e=0),c.currentTime=e,p(),c.playing&&t(c.monitorPlay,5)},c.$watch("hide",function(){c.playing&&c.hide&&c.playPause()}),c.playPause=function(e){if(void 0!==e)var t=e.originalEvent;if(void 0!==window.event)t=window.event;if("undefined"!=typeof event)t=event;t.stopPropagation(),t.preventDefault(),function(){var e=c.playing;if(c.playing=!c.playing,e)u(),c.media.pause(),i.eventTrack("playAudioLineItem",{category:"thoughts"});else{if(0<playingAudioLineItems.length){var t=playingAudioLineItems[0];playingAudioLineItems.length=0,t.playPause()}playingAudioLineItems.push(c),c.media.play(),c.monitorPlay();var n=Math.floor(c.currentTime/c.duration*100);i.eventTrack("pauseAudioLineItem",{category:"thoughts",value:n})}}()},c.$on("$destroy",function(){u(),c.playing=!1,c.media&&(c.media.stop(),c.media.remove())});var d=e.find("canvas")[0];d.width=250*c.canvasScale,d.height=3*c.canvasScale;var f=d.getContext("2d");function p(){var e=d.width,t=d.height;if(f.clearRect(0,0,e,t),f.beginPath(),f.rect(0,0,e,t),c.bgColor?f.fillStyle=c.bgColor:f.fillStyle="#969696",f.fill(),c.tags)for(var n=0;n<c.tags.length;++n){var i=c.tags[n],a=Math.floor(i.tagTime/c.duration*e);f.beginPath(),f.rect(a-3,0,7,t),"positive"==i.tagTypeString?f.fillStyle="#60d293":f.fillStyle="#ff6669",f.fill()}var o=Math.floor(c.currentTime/c.duration*e);f.beginPath(),f.rect(o,0,2,t),f.fillStyle="#fff",f.fill()}d.addEventListener("touchstart",function(e){!function(e){e.stopPropagation(),e.preventDefault();var t=parseInt($(d).css("padding-left")),n=parseInt($(d).css("padding-right")),i=$(d).outerWidth()-t-n,a=($(d).outerHeight(),0);e.changedTouches&&(a=e.changedTouches[0].pageX-d.getBoundingClientRect().left-t);var o=a/i,r=c.media.getDuration();c.media.seekTo(o*r*1e3)}(e)},!1),p()}]}}),e.directive("healthSelector",["$window",function(i){return{restrict:"E",templateUrl:"templates/healthSelector.html",replace:!0,scope:{habit:"=",value:"=",editingGoals:"=",redraw:"=",callbacks:"=",removeEmptyState:"=",disabled:"="},link:function(e,t,n){angular.element(i).bind("resize",function(){e.drawCanvas(),e.$apply()})},controller:["$scope","$element","$timeout","$analytics","MediaService","GeneralService","HabitsService","Environment",function(c,e,t,n,i,a,o,r){var l=c.value;c.$watch("redraw",function(e,t){c.drawCanvas()}),c.$watch("habit",function(e,t){c.drawCanvas()}),c.canvasScale=window.devicePixelRatio;var s=e.find("canvas")[0],u=s.getContext("2d"),d=$(s).innerWidth(),f=$(s).innerHeight();s.width!=d*c.canvasScale&&(s.width=d*c.canvasScale),s.height!=f*c.canvasScale&&(s.height=f*c.canvasScale);var p,h,v,g,m=s.width,y=s.height,S=c.removeEmptyState?0:.1;function w(){if(0===c.value)return m*S/2;var e=c.habit.habitValues.length,t=m*(1-S)/e;return m*S+t/2+(c.value-1)*t}function b(e){if(e.preventDefault(),e.stopPropagation(),c.disabled)c.callbacks.disabledInteraction&&c.callbacks.disabledInteraction();else{var t=s.width,n=getMousePos(s,e);n.x*=c.canvasScale;var i,a=n.x/t;if(a<S)i=c.editingGoals||0<l?1:0;else{var o=c.habit.habitValues.length,r=S*t;1<=(a=(n.x-r)/(t-r))&&(a=.9999),i=Math.floor(o*a)+1}i!=c.value&&(c.value=i,c.drawCanvas(),c.$$phase||c.$apply(),c.callbacks&&c.callbacks.valueUpdated&&c.callbacks.valueUpdated(c.habit))}}function T(e){var t=getMousePos(s,e),n=w(),i=Math.abs(t.x-n/c.canvasScale),a=Math.abs(t.y-y/c.canvasScale/2);i<=v/c.canvasScale&&c.canvasScale;return!0}var E=!(c.drawCanvas=function(){if(c.habit){var e;for(S=c.removeEmptyState?0:.1,e=c.editingGoals?c.value-1:c.habit.goalOrdinal,c.habit.goalMinimized&&(e+=1),p=(1-S)*(e/c.habit.habitValues.length),h=1-S-p,d=$(s).innerWidth(),f=$(s).innerHeight(),s.width!=d*c.canvasScale&&(s.width=d*c.canvasScale),s.height!=f*c.canvasScale&&(s.height=f*c.canvasScale),m=s.width,y=s.height,v=30*c.canvasScale,g=c.removeEmptyState?m*(1/c.habit.habitValues.length):Math.min(m*S,m*(1-S)*(1/c.habit.habitValues.length));g<v;)v*=.8;var t=5*c.canvasScale;u.clearRect(0,0,m,y);var n=y/2;u.fillStyle="#aaaaaa",u.beginPath(),u.rect(0,n-t/2,m*S,t),u.fill(),1==c.habit.id?u.fillStyle=a.COLORS[c.value-1]:c.disabled?u.fillStyle="cccccc":c.habit.goalMinimized?u.fillStyle="#60d293":u.fillStyle="#ff6669",u.beginPath(),u.rect(m*S,n-t/2,m*p,t),u.fill(),c.disabled||1==c.habit.id?u.fillStyle="cccccc":c.habit.goalMinimized?u.fillStyle="#ff6669":u.fillStyle="#60d293",u.beginPath(),u.rect(m*(S+p),n-t/2,m*h,t),u.fill();var i=w();0===c.value?(u.fillStyle="#ffffff",u.beginPath(),u.arc(i,n,v/2,0,2*Math.PI),u.fill(),u.fillStyle="#cccccc",u.beginPath(),u.arc(i,n,v/2*.7,0,2*Math.PI)):(1==c.habit.id?u.fillStyle=a.COLORS[c.value-1]:c.disabled?u.fillStyle="cccccc":o.metGoal(c.habit,c.value-1)||c.editingGoals?u.fillStyle="#60d293":u.fillStyle="#ff6669",u.beginPath(),u.arc(i,n,v/2,0,2*Math.PI)),u.fill()}});s.addEventListener("touchstart",function(e){E=T(e)},!1),s.addEventListener("touchend",function(e){E=!1},!1),s.addEventListener("touchmove",function(e){E&&b(e)},!1),s.addEventListener("mousedown",function(e){E=T(e)}),s.addEventListener("mouseup",function(e){E=!1}),s.addEventListener("mousemove",function(e){E&&b(e)}),c.drawCanvas()}]}}]),e.directive("twilioVideo",function(){return{template:'<div class="twilio-video-media-container"></div>',restrict:"E",replace:!0,scope:{tracks:"="},link:function(n,i,e){n.$watchCollection("tracks",function(e,t){for(;i[0].hasChildNodes();)i[0].removeChild(i[0].lastChild);n.tracks.forEach(function(e){i[0].appendChild(e.attach())})})}}}),e.directive("scrollModal",[function(){return{restrict:"C",link:function(e,t,n){e.$on("modal.shown",function(){$(window).scrollTop(0)})}}}]),e.directive("onFinishRender",["$timeout",function(i){return{restrict:"A",link:function(e,t,n){!0===e.$last&&i(function(){e.$apply(n.onFinishRender)})}}}]),e.directive("scrollTrigger",["$window",function(e){return{link:function(n,e,i){var t=i.scrollElementType;if("window"===t)var a=$(window),o=angular.element(document);else if("this"===t)a=$(".chat-scroll-container"),o=angular.element(".chat-scroll-container");var r=parseInt(i.threshold)||0,c=0;o.bind("scroll",_.debounce(function(){var e=a.scrollTop(),t=e<=c;"down"!==i.triggerDirection||t||$(window).height()+$(window).scrollTop()>=$(document).height()-r&&(n.isLoadingMore=!0,n.$apply(i.scrollTrigger));"up"===i.triggerDirection&&t&&(e<=r&&(n.isLoadingMore=!0,n.$apply(i.scrollTrigger)));c=e,n.isLoadingMore=!1},1e3,!0))}}}]),e.directive("closeHandler",["$rootScope",function(a){return{restrict:"A",link:function(n,e,i){n.$on("modal.shown",function(e,t){a.closeActiveModal=function(){n.$eval(i.closeHandler)}}),n.$on("modal.hidden",function(e,t){a.closeActiveModal=void 0})}}}]),e.directive("scrollTopOnShow",[function(){return{restrict:"A",link:function(e,t,n){e.$watch(function(){return t.is(":visible")},function(e,t){!0===e&&$(window).scrollTop(0)})}}}]),e.directive("dropdownButton",["$timeout",function(e){return{restrict:"E",scope:{isShown:"="},link:function(t,n,e){var i=n.find("a"),a=n.find("ul"),o="click.clickAway",r=function(e){$(e.target).closest(n).length&&n.find("ul")[0]!=e.target.parentElement||t.$apply(function(){t.isShown&&l()})},c=function(){jQuery(document).off(o,r)};t.$on("$destroy",function(){c()});var l=function(){t.isShown?(a.addClass("ng-hide"),t.isShown=!1,c()):(a.removeClass("ng-hide"),t.isShown=!0,jQuery(document).on(o,r))};i.on("click",l)}}}]),e.directive("hcChart",function(){return{restrict:"E",template:"<div></div>",scope:{config:"=",ready:"=",watchData:"=",redrawvar:"=",type:"@"},link:function(e,t){var n=function(){e.config&&(e.config.credits={enabled:!1},"sparkline"==e.type?e.chartObj=Highcharts.SparkLine(t[0],e.config):e.chartObj=Highcharts.chart(t[0],e.config))};e.$watch("ready",function(e,t){e!=t&&e&&n()}),e.$watch("watchData",function(e,t){e!=t&&n()}),e.$watch("redrawvar",function(e,t){e!=t&&n()}),e.ready&&n()}}}),e.service("ngCopy",["$window",function(e){var n=angular.element(e.document.body),i=angular.element("<textarea/>");return i.css({position:"fixed",opacity:"0"}),function(t){i.val(t),n.append(i),i[0].select();try{var e=document.execCommand("copy");if(!e)throw e}catch(e){window.prompt("Copy to clipboard: Ctrl+C, Enter",t)}i.remove()}}]),e.directive("ngClickCopy",["ngCopy",function(i){return{restrict:"A",scope:{callback:"="},link:function(t,e,n){e.bind("click",function(e){i(n.ngClickCopy),t.callback&&t.callback(n.ngClickCopy)})}}}]),e.directive("ngDraggable",["$document",function(m){return{restrict:"A",scope:{dragOptions:"=ngDraggable",fullscreen:"="},link:function(e,n,t){var i,a,o,r,c,l,s=0,u=0,d=n[0].offsetWidth,f=n[0].offsetHeight;if(e.dragOptions){o=e.dragOptions.start,c=e.dragOptions.drag,r=e.dragOptions.stop;var p=e.dragOptions.container;p&&(l=document.getElementById(p).getBoundingClientRect())}function h(){console.log("bind"),n.on("mousedown",function(e){e.preventDefault(),i=e.clientX-n[0].offsetLeft,a=e.clientY-n[0].offsetTop,m.on("mousemove",v),m.on("mouseup",g),o&&o(e)})}function v(e){u=e.clientY-a,s=e.clientX-i,function(){l&&(s<l.left?s=l.left:s>l.right-d&&(s=l.right-d),u<l.top?u=l.top:u>l.bottom-f&&(u=l.bottom-f));n.css({top:u+"px",left:s+"px",bottom:"auto"})}(),c&&c(e)}function g(e){m.unbind("mousemove",v),m.unbind("mouseup",g),r&&r(e)}e.$watch("fullscreen",function(e,t){e?(m.unbind("mousemove",v),m.unbind("mouseup",g),n.unbind("mousedown"),n.css({top:"0px",left:"0px"})):(h(),n.css({bottom:"0px",top:"auto"}))}),h()}}}]),e.directive("clientSearch",["$state",function(s){return{restrict:"E",templateUrl:"templates/practitioner/client-search.directive.html",link:function(n,t,e){var i="click.clickAway",a=t.find("ul");n.emptyResults=!1,n.clearClientSearch=function(e){"clientSearchInput"!=e.target.id&&(n.searchResults=[])},n.onSelectClient=function(e){var t=n.searchResults[e];n.userSearch="",n.searchResults=[],n.clientSearchInput="",n.isShown=!1,l(),s.go("practitioner.client.view",{clientId:t.account.id,activeTab:null},{reload:!0})},n.clientSearchInput="",n.searchResults=[],n.filterClients=function(){""!=n.clientSearchInput?(n.isShown=!0,n.emptyResults=!1,c(),n.searchResults=_.filter(n.clients,function(e){return-1<e.fullName.toLowerCase().indexOf(n.clientSearchInput.toLowerCase())}),0==n.searchResults.length&&0<n.clientSearchInput.length&&(n.emptyResults=!0)):o()};var o=function(){a.addClass("ng-hide"),n.isShown=!1,l()},r=function(e){$(e.target).closest(t).length&&t.find("ul")[0]!=e.target.parentElement||n.$apply(function(){n.isShown&&o()})},c=function(){jQuery(document).on(i,r)},l=function(){jQuery(document).off(i,r)};n.$on("$destroy",function(){l()})}}}])}();