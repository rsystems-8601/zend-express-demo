(servicesModule=angular.module("accessibilityService",[])).factory("AccessibilityService",["$q","$rootScope","$timeout",function(e,i,n){var o,a={initialized:!1,usingScreenReader:!1,plugin:null};return a.speak=function(e,t){var i=t||null;o&&o.speak(e,i)},a.setTextZoomClass=function(){a.plugin.getTextZoom(function(e){var t={"text-zoom-default":function(e){return e<=100},"text-zoom-large":function(e){return 100<e&&e<119},"text-zoom-xlarge":function(e){return 119<=e&&e<131},"text-zoom-xxlarge":function(e){return 131<=e}};var i=angular.element(document.querySelector("body"));_.map(_.keys(t),function(e){i.removeClass(e)});var n,o,a=(n=e,_.each(t,function(e,t){e(n)&&(o=t)}),o);i.addClass(a)})},a.initialize=function(){var t=e.defer();return(o=window.plugins?window.MobileAccessibility:void 0)?o.isScreenReaderRunning(function(e){a.plugin=o,a.usingScreenReader=e,a.initialized=!0,o.usePreferredTextZoom(!1),i.$broadcast("event:accessibilityServiceInitialized",e),t.resolve(a)}):n(function(){i.$broadcast("event:accessibilityServiceInitialized",a),t.resolve(a)}),t.promise},a.onceInitialized=function(e){a.initialized?e():once(i,"event:accessibilityServiceInitialized",e)},a}]),(servicesModule=angular.module("accountService",[])).factory("AccountService",["$http","$state","$rootScope","$translate","$timeout","$analytics","$ionicModal","$ionicPopup","$interval","authHttp","Environment","StorageService","GeneralService","Token","FeedService","OverlayService",function(s,e,n,l,u,d,t,a,o,p,m,f,T,r,c,g){var A={accountUser:{},userPreferences:{},experienceTips:{},appointmentContext:{},splitTestContext:{},connectionContext:{},consentContext:{},userNotification:{},refreshedStore:!1,locale:void 0,isCreatingAccount:!1,googleSignin:!1,offlinePreferences:[],MOOD_VIDEO:0,RELAX_VIDEO:1,THOUGHTS_VIDEO:2,GOALS_VIDEO:3,HEALTH_VIDEO:4,COMMUNITY_VIDEO:5,FINAL_VIDEO:5,FEED_VIDEO:6,loginTimeout:36e5,deletionReason:null,finishVidCallback:null,creatingAccount:function(e){return _.isUndefined(e)||(A.isCreatingAccount=e),A.isCreatingAccount}},E=localStorage.getItem("loginTimeout");function I(e){var t=e||{};return window.device&&(t.appVersion=m.getAppVersion(),t.cordovaVersion=device.cordova,t.model=device.model,t.platform=device.platform,t.uuid=device.uuid,t.version=device.version),t}function v(){f.setItem("accountUser",JSON.stringify(A.accountUser))}function S(){f.setItem("userPreferences",JSON.stringify(A.userPreferences))}function C(){f.setItem("offlinePreferences",JSON.stringify(A.offlinePreferences))}E&&(A.loginTimeout=+E),A.setLoginTimeout=function(e){A.loginTimeout=e,localStorage.setItem("loginTimeout",e)},A.getLoginTimeout=function(){return A.loginTimeout},A.initFromLocalStorage=function(){f.getItem("accountUser",function(e){if(e){var t=JSON.parse(e);A.accountUser=t}}),f.getItem("userPreferences",function(e){if(e){var t=JSON.parse(e);A.userPreferences=t,n.$broadcast("request:updateLocalCompletedActivities")}}),f.getItem("offlinePreferences",function(e){if(e){var t=JSON.parse(e);A.offlinePreferences=t}}),f.getItem("splitTestContext",function(e){if(e)try{var t=JSON.parse(e);A.splitTestContext=t}catch(e){console.log("There was an error parsing the split test context: "+e)}}),f.getItem("connectionContext",function(e){if(e)try{var t=JSON.parse(e);A.connectionContext=t}catch(e){console.log("There was an error parsing the connection context: "+e)}})},n.$on("event:online",function(){f.onceInitialized(function(){A.onceUserContextInitialized(function(){_.each(A.offlinePreferences,function(e){A.setUserPreference(e.preference,e.value,function(){console.log("set "+e.preference+" to "+e.value)})}),A.offlinePreferences=[],C()})})}),A.enablePremiumAccount=function(e,t){A.accountUser.account.premium=!0,A.accountUser.account.paymentType=t||"PURCHASE",A.accountUser.account.premiumExpiresAt=e,v()},A.enablePremiumFeatures=function(e,t,i,o){A.canUpgrade()?e&&("ios-appstore"==e.type?p.post(m.serverURL+"/account/verifyIOSPurchase",{transactionId:e.id,subscriptionId:t,receipt:e.appStoreReceipt,price:i},{transformResponse:void 0}).success(function(e){console.log("Received verify response: "),console.log(e),e&&"false"!=e&&A.enablePremiumAccount(e),o&&o(e)}).error(function(e,t,i,n){o&&o(!1)}):"android-playstore"==e.type&&(console.log("Received android transaction:"),console.log(e),p.post(m.serverURL+"/account/verifyAndroidPurchase",{transactionId:e.id,subscriptionId:t,purchaseToken:e.purchaseToken,price:i}).success(function(e){console.log("Received verify response: "),console.log(e),e&&"false"!=e&&A.enablePremiumAccount(e),o&&o(e)}).error(function(e,t,i,n){o&&o(!1)}))):o(!0)},A.isLoggedIn=function(){return m.isWeb()?r.hasToken():!!A.accountUser.user&&r.hasToken()},A.isPremiumEnabled=function(){var e=A.accountUser.account&&!0===A.accountUser.account.premium;e&&((e=new Date(A.accountUser.account.premiumExpiresAt)>new Date)||"PURCHASE"!=A.accountUser.account.paymentType||A.refreshedStore||(A.refreshedStore=!0,n.$broadcast("event:refreshStore")));return e},A.hasUnlockedTracking=function(){var e=A.getUserPreference("unlimited_tracking");return!(!e||"true"!=e)||A.isPremiumEnabled()},A.getPremiumExpiration=function(){var e=A.isPremiumEnabled()?new Date(A.accountUser.account.premiumExpiresAt):void 0;return e?moment(e).format("LLLL"):""},A.canUpgrade=function(){return!A.isPremiumEnabled()||"TRIAL"==A.accountUser.account.paymentType||"COMPLIMENTARY"==A.accountUser.account.paymentType},A.findUserContext=function(){var e=I();return p.post(m.serverURL+"/account/context",e)},A.onceUserContextInitialized=function(e){n.retrievedUserContext?e():once(n,"event:userContextInitialized",e)},A.createAccount=function(e,t,i,n,o){var a={};p.addTimezone(a),p.addPlatform(a);var r={email:e,password:t,name:i,lang:A.getLocale(),joinGroupCode:o,preventDefaultHabits:!1};return n&&(r.referralCode=n),I(r),a.withCredentials=!0,s.post(m.serverURL+"/account/createV2",r,a)},A.resetPassword=function(e){return s.post(m.serverURL+"/account/requestPasswordReset",e)},A.updateToken=function(e){p.update(e)},A.setNickname=function(e){var t=createPromise();return p.post(m.serverURL+"/account/name",e).success(function(){A.accountUser.user.name=e,v(),t.successCallback&&t.successCallback()}).error(function(){d.addEventAppsee("errorTriggered","setNickname"),t.errorCallback&&t.errorCallback()}),t},A.setPublicNickname=function(e){return p.post(m.serverURL+"/account/publicName",e)},A.updateLocalPublicNickname=function(e){A.accountUser.user.publicName=e,v()},A.setAvatar=function(e){return A.getAccountUser().user.avatar=e,v(),p.post(m.serverURL+"/account/avatar",e)},A.getAvatarCharacter=function(e,t){switch(t){case 1:return"pacifica";case 1003:return"dale";case 1001:return"chris";case 1171516:return"ashley";case 1057724:return"enda";case 1064918:return"christine"}if(!e){var i=t%26;e=String.fromCharCode(97+i)}return e},A.getPostAvatar=function(e){return e?"avatar_"+A.getAvatarCharacter(e.creatorAvatar,e.creatorId):""},A.setPhoneNumber=function(e,t){var i=createPromise();e=e.replace(/[^0-9.]/g,"");var n=A.accountUser.user.phone!=e;return p.post(m.serverURL+"/account/phone",{phone:e,sendCode:t}).success(function(){A.accountUser.user.phone=e,n&&(A.accountUser.user.phoneVerifiedAt=void 0),v(),i.successCallback&&i.successCallback()}).error(function(){d.appseeScreenAction("accountSetPhone"),i.errorCallback&&i.errorCallback()}),i},A.setEmailAddress=function(e){var t=createPromise();return p.post(m.serverURL+"/account/email",e).success(function(){A.accountUser.user.email=e,A.accountUser.user.emailVerifiedAt=void 0,v(),t.successCallback&&t.successCallback()}).error(function(){d.addEventAppsee("errorTriggered","setEmail"),t.errorCallback&&t.errorCallback()}),t},A.isEmailValidated=function(){var e=A.getAccountUser();return e&&e.user&&!!e.user.emailVerifiedAt},A.isPhoneValidated=function(){var e=A.getAccountUser();return e&&e.user&&!!e.user.phoneVerifiedAt},A.checkRemoteEmailValidation=function(){return p.get(m.serverURL+"/account/isEmailValidated")},A.validatePhone=function(e){var t=createPromise();return p.post(m.serverURL+"/account/validatePhone",{phone:A.getAccountUser().user.phone,phoneVerificationCode:e}).success(function(e){e.validated&&(A.accountUser.user.phoneVerifiedAt=new Date,v()),t.successCallback&&t.successCallback(e)}).error(function(){t.errorCallback&&t.errorCallback()}),t},A.cancelConsultation=function(i){var n=createPromise();return p.post(m.serverURL+"/account/cancelConsultation/"+i.id).success(function(e){if(A.appointmentContext.appointments){var t=A.appointmentContext.appointments.indexOf(i);A.appointmentContext.appointments.splice(t,1),n.successCallback&&n.successCallback(i)}}).error(function(){n.errorCallback&&n.errorCallback()}),n},A.claimConsultation=function(i,n,e){var o=createPromise();return p.post(m.serverURL+"/account/claimConsultation",{appointmentId:e.id,firstName:i,lastName:n,startTime:e.startTime}).success(function(e){var t=A.getAccountUser();t.account.firstName=i,t.account.lastName=n,v(),A.appointmentContext.appointments||(A.appointmentContext.appointments=[]),A.appointmentContext.appointments.push(e),o.successCallback&&o.successCallback()}).error(function(e){o.errorCallback&&o.errorCallback(e)}),o},A.handleInsecureStorage=function(){f.clear(),n.$broadcast("event:loginRequired"),g.modal.open({modalId:"InsecureDeviceModal",templateUrl:"views/account/account.insecureDevice.modal.html",scope:n,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){n.insecureDeviceModal=e})},A.checkSecureStorage=function(){var e=A.accountUser;e&&e.user&&(e.user.phi||A.isPractitioner())&&(d.disable(),n.closeInsecureDeviceModal=function(){g.modal.close(n.insecureDeviceModal).then(function(e){n.insecureDeviceModal=e})},f.isKeyguardSecure(function(e){e||A.handleInsecureStorage()},function(){A.handleInsecureStorage()}))},A.setAccountUser=function(e){A.accountUser=e,v(),A.checkSecureStorage()},A.getAccountUser=function(){return A.accountUser},A.setupAccountTimezone=function(e){p.setActiveTimezone(e),moment.tz.setDefault(e)},A.setUserPreferences=function(e){if(A.userPreferences={},e)for(var t=0;t<e.length;++t){var i=e[t];A.userPreferences[i.preference]=i.value}S(),A.getUserTimeZone(A.setupAccountTimezone)},A.getUserPreference=function(e){return A.userPreferences[e]},A.setUserNotification=function(e){A.userNotification=e},A.getUserNotification=function(){return A.userNotification},A.getSystemNotification=function(){return A.userNotification.systemNotification},A.setSplitTestContext=function(e){(A.splitTestContext=e)&&f.setItem("splitTestContext",JSON.stringify(e))},A.getSplitTestContext=function(){return A.splitTestContext},A.isStudyUser=function(){var e=A.getSplitTestContext();if(e&&e.splitTestGroups){if(void 0!==e.splitTestGroups.pacificaStudy)return!0;if(void 0!==e.splitTestGroups.ukyPilot)return!0}return!1},A.usesSocialLogin=function(){return A.getUserPreference("oauth_signup")},A.setAppointmentContext=function(e){A.appointmentContext=e},A.getAppointmentContext=function(){return A.appointmentContext},A.setPremiumContext=function(e){(A.premiumContext=e)&&f.setItem("premiumContext",JSON.stringify(e))},A.getPremiumContext=function(){return A.premiumContext},A.setConnectionContext=function(e){(A.connectionContext=e)&&f.setItem("connectionContext",JSON.stringify(e)),A.checkHipaaAuthorizations()},A.getConnectionContext=function(){return A.connectionContext};var h=function(e,t,i){var n={withCredentials:!0};p.addTimezone(n),p.addPlatform(n);var o={token:t};return i&&(o.loginTimeout=i,A.setLoginTimeout(i)),I(o),s.post(m.serverURL+"/account/"+e,o,n)};function O(e){return(e=e.toLowerCase()).startsWith("es")?e="es":e.startsWith("fr")?e="fr":"en-us"!=e&&"en-gb"!=e&&(e="en-us"),e}function y(e){n.viewingVideo=!1,"boolean"!=typeof e&&(e="true"===e),e?(console.log("Finished video."),A.finishVidCallback&&(A.finishVidCallback(),A.finishVidCallback=null)):console.log("Did not finish video.");var t=ionic.Platform.isAndroid()?500:0;u(window.playVideo,t)}A.loginWithFacebook=function(e,t){return h("loginWithFacebook",e,t)},A.loginWithGoogle=function(e,t){return h("loginWithGoogle",e,t)},A.signUpWithFacebook=function(e){return h("signUpWithFacebook",e)},A.signUpWithGoogle=function(e){return h("signUpWithGoogle",e)},A.login=function(e,t,i){var n={withCredentials:!0,headers:{}},o=A.getUserTimeZone();o&&(n.headers.TimezoneLocale=o),p.addPlatform(n);var a={email:e,password:t};return i&&(a.loginTimeout=i,A.setLoginTimeout(i)),I(a),s.post(m.serverURL+"/account/login",a,n)},A.hasCompletedOnboarding=function(){return"completed"===(A.getUserPreference("last_nux_state")||n.lastNuxState)},A.clearData=function(){c.clearData(),A.accountUser={},A.userPreferences={},A.splitTestContext={},A.userNotification={},A.offlinePreferences=[],A.googleSignin=!1,v(),S(),localStorage.removeItem("cachedHomeImageUrl"),localStorage.removeItem("suggestedActivities"),localStorage.removeItem("viewed_daily_checkin_popup_date"),localStorage.removeItem("viewed_streak_popup_date"),f.removeItem("lastAppRatingDay"),f.removeItem("offlineActivities"),f.removeItem("offlinePreferences"),f.removeItem("splitTestContext")},A.setOffline=function(){return p.post(m.serverURL+"/account/setOffline")},A.logout=function(){return A.googleSignin&&window.plugins.googleplus.disconnect(),A.clearData(),p.post(m.serverURL+"/account/logout")},A.ping=function(){return p.get(m.serverURL+"/ping")},A.clearUserPreference=function(e){return delete A.userPreferences[e],p.post(m.serverURL+"/account/clearPreference",{preference:e})},A.saveUserPreferences=function(e,t){var n=!m.isOnline(),o=[],a=function(e,t){"boolean"==typeof e&&(e+=""),o.push({preference:t,value:e}),A.userPreferences[t]=e,n&&A.offlinePreferences.push({preference:t,value:e})};for(i=0;i<e.length;i++)_.each(e[i],a);S(),n?(C(),t&&t()):p.post(m.serverURL+"/account/preferences",o).success(function(){t&&t()})},A.setUserPreference=function(t,e,i){if(void 0!==e)if("boolean"==typeof e&&(e+=""),A.isLoggedIn()){var n=void 0===A.userPreferences[t]||A.userPreferences[t]!=e,o=0<_.filter(A.offlinePreferences,function(e){return e.preference===t}).length;if(n||o){if(A.userPreferences[t]=e,S(),"preferred_timezone"===t&&A.setupAccountTimezone(e),console.log("set user preference ["+t+"]: "+e),m.isOnline())return p.post(m.serverURL+"/account/preference",{preference:t,value:e});A.offlinePreferences.push({preference:t,value:e}),C()}}else i&&u(i);else console.log("MISSING VALUE while setting preference: "+t)},A.registerGCMToken=function(e,t){return p.post(m.serverURL+"/account/gcmToken",e).then(function(e){},t)},A.registerAPNSToken=function(e){return p.post(m.serverURL+"/account/apnsToken",e)},A.getDaysSinceSignup=function(){var e=0;if(A.accountUser.user){var t=A.accountUser.user,i=T.getDayString(new Date(t.createdAtStr)),n=new Date(i),o=new Date(T.getTodayString());e=T.getDifferenceInDays(n,o)}return e},A.getLang=function(e){var t=e,i=t.indexOf("-");return 0<i&&(t=t.substring(0,i)),t},A.getLocale=function(){return A.locale},A.updateLocale=function(e){A.locale=O(e);var t=A.getLang(A.locale);$("body").removeClass("en"),$("body").removeClass("es"),$("body").removeClass("fr"),$("body").addClass(t),angular.element(document.querySelector("html")).attr("lang",t),console.log("Setting translation: "+t),l.use(t),moment.locale(A.locale)},A.setLocale=function(e){return A.locale=e,A.updateLocale(A.locale),e=O(e),A.setUserPreference("preferred_locale",e)},A.getPublicUser=function(e){return p.get(m.serverURL+"/account/publicUser?userId="+e)},A.getUserTimeZone=function(t){var e=A.getUserPreference("preferred_timezone");if(e)t(e);else{if(m.isWeb()){var i=jstz.determine();return t&&t(i.name()),i.name()}navigator&&navigator.globalization&&navigator.globalization.getDatePattern(function(e){t(e.iana_timezone)})}},A.resendValidationEmail=function(){return p.post(m.serverURL+"/account/sendValidateEmail")},A.forceAppRatingPrompt=function(){AppRate.preferences.storeAppURL.ios="922968861",AppRate.preferences.storeAppURL.android="market://details?id=com.pacificalabs.pacifica",AppRate.preferences.callbacks.onRateDialogShow=function(e){callbackForRating=e},AppRate.preferences.callbacks.onButtonClicked=function(e){1==e||3==e?A.setUserPreference("viewed_rate_app_popup",!0):f.setItem("lastAppRatingDay",T.getTodayString())},AppRate.preferences.useLanguage="en",AppRate.preferences.customLocale={title:l.instant("APPRATE_TITLE")+" %@?",message:l.instant("APPRATE_MESSAGE"),cancelButtonLabel:l.instant("APPRATE_CANCEL_BUTTON_LABEL"),laterButtonLabel:l.instant("APPRATE_LATER_BUTTON_LABEL"),rateButtonLabel:l.instant("APPRATE_RATE_BUTTON_LABEL"),yesButtonLabel:l.instant("APPRATE_YES_BUTTON_LABEL"),noButtonLabel:l.instant("APPRATE_NO_BUTTON_LABEL"),appRatePromptTitle:l.instant("APPRATE_APP_RATE_PROMPT_TITLE")+" %@?",feedbackPromptTitle:l.instant("APPRATE_FEEDBACK_PROMPT_TITLE")},AppRate.promptForRating(!0)},A.checkForRatingPrompt=function(){var e=A.getUserPreference("viewed_rate_app_popup");e&&"false"!=e||window.AppRate&&f.getItem("lastAppRatingDay",function(e){e!=T.getTodayString()&&(3<=A.getDaysSinceSignup()&&A.forceAppRatingPrompt())})},A.clearPasscode=function(){return A.getAccountUser().user.passcode=void 0,v(),p.post(m.serverURL+"/account/clearPasscode")},A.setPasscode=function(e){return A.getAccountUser().user.passcode=e,v(),p.post(m.serverURL+"/account/setPasscode",{passcode:e})},A.getDownloadGiftCodeToken=function(){return p.get(m.serverURL+"/payment/getGiftCodeDownloadToken")},A.redeemGiftCode=function(e){return p.post(m.serverURL+"/payment/redeemGiftCode",{code:e})},A.bulkPurchaseWithtoken=function(e,t,i,n,o,a,r,s,c,l,u,d){return p.post(m.serverURL+"/payment/bulkPurchase",{token:e,firstName:t,lastName:i,address1:n,address2:o,city:a,state:r,postalCode:s,country:c,subscription:l,coupon:u,purchases:d})},A.subscribeWithToken=function(e,t,i,n,o,a,r,s,c,l,u){return p.post(m.serverURL+"/payment/subscribeWithToken",{token:e,firstName:t,lastName:i,address1:n,address2:o,city:a,state:r,postalCode:s,country:c,subscription:l,coupon:u})},A.cancelSubscription=function(){return p.post(m.serverURL+"/payment/cancelSubscription")},A.viewVideo=function(e,t){if(A.finishVidCallback=t,e<0||6<=e)console.log("ERROR: index for video viewing is invalid.");else if(window.plugins&&window.plugins.streamingMedia){var i=m.serverURL+"/media/introVideo/stream/"+e;p.get(i).success(function(e){n.viewingVideo=!0,window.pauseVideo(),window.plugins.streamingMedia.playVideo(e.url,{successCallback:y,shouldAutoClose:!0})}).error(function(){console.log("Error viewing video.")})}},A.isAdmin=function(){var e=A.getAccountUser().user;return void 0!==e&&void 0!==e.roles&&null!==e.roles&&-1!=e.roles.indexOf("ADMIN")},A.isPractitioner=function(){var e=A.getAccountUser().user;return void 0!==e&&void 0!==e.roles&&null!==e.roles&&-1!=e.roles.indexOf("PRACTITIONER")},A.isPHI=function(){var e=A.accountUser;return!!(e&&e.user&&e.user.phi)},A.getPractitionerInvite=function(e){return p.post(m.serverURL+"/account/getPractitionerInvite",{inviteCode:e})},A.connectPractitioner=function(e){var o=createPromise();return p.post(m.serverURL+"/account/connect",{inviteCode:e}).success(function(e){d.finishAppseeSession(),A.accountUser.user.phi=!0,v(),d.disable(),o.successCallback&&o.successCallback(e)}).error(function(e,t,i,n){o.errorCallback&&o.errorCallback(e,t,i,n)}),o},A.disconnectPractitioner=function(e){var t=createPromise();return p.post(m.serverURL+"/account/disconnect",{practitionerId:e.id}).success(function(e){A.connectionContext||(A.connectionContext={}),A.connectionContext.authorizations&&(A.connectionContext.authorizations=[]),A.connectionContext.authorizations.push(e),A.checkHipaaAuthorizations(),t.successCallback&&t.successCallback()}).error(function(){t.errorCallback&&t.errorCallback()}),t},A.sendReportToSelf=function(e,t){return p.post(m.serverURL+"/activity/sendReportToSelf",{sendToSelf:!0,week:e,userName:t})},A.sendReportToOther=function(e,t,i,n,o){return p.post(m.serverURL+"/activity/sendReportToOther",{sendToSelf:!1,week:e,userName:t,name:i,email:n,type:o})},A.checkHipaaAuthorizations=function(){var e=A.connectionContext;if(e){var t=e.authorizations;if(t)for(var i=0;i<t.length;++i){var n=t[i];if(!n.authorizedAt&&!n.deniedAt){A.presentHipaaAuthorization(n);break}}}},A.presentHipaaAuthorization=function(t){var o=n.$new();o.data={fullName:""},o.authorizationText=t.authorizationText,o.checkName=function(){o.nameError=o.data.fullName.length<2},o.closeHipaaModal=function(){g.modal.close($scope.hipaaModal).then(function(e){$scope.hipaaModal=e})},o.authorize=function(){o.checkName(),o.nameError||(o.busy=!0,A.authorizeHIPAA(t.id,o.data.fullName).success(function(){t.authorizedAt=(new Date).getTime(),f.setItem("connectionContext",JSON.stringify(A.connectionContext)),o.closeHipaaModal(),o.busy=!1}).error(function(e,t,i,n){o.busy=!1}))},o.deny=function(){(o.checkName(),o.nameError)||a.confirm({template:"<div focus-on-open>"+l.instant("DENY_HIPAA_CONFIRM")+"</div>",cancelText:l.instant("CANCEL"),cancelType:"button-default",okText:l.instant("DELETE_MY_DATA"),okType:"button-default"}).then(function(e){e&&(o.busy=!0,A.denyHIPAA(t.id,o.data.fullName).success(function(){t.deniedAt=(new Date).getTime(),f.setItem("connectionContext",JSON.stringify(A.connectionContext)),o.closeHipaaModal(),o.busy=!1,g.popup.alert({template:l.instant("DENY_HIPAA_LOGOUT"),okText:l.instant("OK_GOT_IT"),okType:"button-default"}),n.$broadcast("event:loginRequired")}).error(function(e,t,i,n){o.busy=!1}))})};var e=m.isWeb()?"templates/account.authorizeHIPAA.modal.html":"views/account/account.authorizeHIPAA.modal.html";g.modal.open({modalId:"HIPAAModal",templateUrl:e,scope:o,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){$scope.hipaaModal=e})},A.authorizeHIPAA=function(e,t){return p.post(m.serverURL+"/account/authorizeHIPAA",{authorizationId:e,userName:t})},A.denyHIPAA=function(e,t){return p.post(m.serverURL+"/account/denyHIPAA",{authorizationId:e,userName:t})},A.getVideoToken=function(){return p.get(m.serverURL+"/video/token")},A.sharePacificaWithPractitioner=function(e,t,i,n){return p.post(m.serverURL+"/account/sharePacificaWithPractitioner",{practitionerType:e,practitionerName:t,practitionerEmail:i,userName:n})},A.canStartAppointment=function(e){if(e&&"TELETHERAPY"==e.appointmentType||"CONSULTATION"==e.appointmentType){var t=new Date,i=new Date(e.startTime-3e5),n=new Date(e.startTime+60*e.duration*1e3+9e5);return i<t&&t<n}return!1},A.initializeAppointmentFunctionality=function(i,n){i.isAppointmentToday=function(e){if(e){var t=T.getTodayString(),i=new Date(e.startTime-3e5),n=new Date(e.startTime+60*e.duration*1e3+9e5);return t==T.getDayString(i)||t==T.getDayString(n)}},i.toggleShowAdditionalAppointments=function(){i.isShowingMoreAppointments=!i.isShowingMoreAppointments};var e=A.getAppointmentContext();e&&(i.todaysAppointments=_.filter(e.appointments,function(e){return i.isAppointmentToday(e)}),i.upcomingAppointments=_.filter(e.appointments,function(e){var t=null===e.cancelTime;return"CONSULTATION"!==e.appointmentType&&t}),i.upcomingConsultations=_.filter(e.appointments,function(e){var t=moment(),i=moment(e.endTime).isAfter(t),n=null===e.cancelTime;return"CONSULTATION"===e.appointmentType&&i&&n}),i.completedConsultations=_.filter(e.appointments,function(e){var t=moment(),i=moment(e.endTime).isAfter(t);return"CONSULTATION"===e.appointmentType&&!i}),i.upcomingAppointments=_.sortBy(i.upcomingAppointments,"startTime"),i.upcomingConsultations=_.sortBy(i.upcomingConsultations,"startTime"),i.completedConsultations=_.sortBy(i.completedConsultations,"startTime"),i.completedConsultations.reverse()),i.appointmentsDisplayedTime=new Date,i.updateAppointmentsDisplayedTime=function(){i.appointmentsDisplayedTime=new Date},i.hasConsultationWithClinician=function(t){return!(i.upcomingConsultations.length<1)&&0<_.filter(i.upcomingConsultations,function(e){return e.practitionerId===t.id}).length},i.getAppointmentTimeDiff=function(e){return T.getElapsedTimeDisplay(e.startTime,i.appointmentsDisplayedTime)},i.canStartAppointment=function(e){return A.canStartAppointment(e)},i.tappedAppointment=function(e,t){"TELETHERAPY"!=e.appointmentType&&"CONSULTATION"!=e.appointmentType||(i.canStartAppointment(e)?i.startAppointment(e,t):T.showToast(l.instant("APPOINTMENT_UNAVAILABLE_MSG")))},i.getAppointmentTypeDisplay=function(e){return"TELETHERAPY"==e?l.instant("TELETHERAPY"):"IN_PERSON"==e?l.instant("IN_PERSON"):void 0},i.startAppointment=function(t,e){e&&(e.stopPropagation(),e.preventDefault()),window.pauseVideo&&window.pauseVideo(),A.getVideoToken().success(function(e){console.log("got token"+e),i.mobile&&(window.plugins&&window.plugins.twilio&&!ionic.Platform.isAndroid()?window.plugins.twilio(e.token,t.roomId,function(e,t){console.log("msgType: "+e),console.log("value: "+t)}):n.go("videochat",{token:e.token,roomId:t.roomId}))}).error(function(){console.log("Could not retrieve video token.")})},i.$on("$ionicView.enter",function(){i.todaysAppointments&&0<i.todaysAppointments.length&&(i.updateAppointmentsDisplayedTime(),i.updateAppointmentTimePromise||(i.updateAppointmentTimePromise=o(function(){console.log("updateAppointmentsDisplayedTime"),i.updateAppointmentsDisplayedTime()},15e3)))}),i.$on("$ionicView.leave",function(){i.updateAppointmentTimePromise&&o.cancel(i.updateAppointmentTimePromise)})},A.isUserConnected=function(t){var e=A.getConnectionContext();return!(!e||!e.practitioners)&&0<_.filter(e.practitioners,function(e){return e.id==t.id}).length},A.initializeInviteFunctionality=function(i,e,n,o,t){var a=A.getConnectionContext();a&&a.practitioners?i.practitionerConnections=a.practitioners:i.practitionerConnections=[],i.isConnectedToPractitioner=function(){return 0<i.practitionerConnections.length},i.practitionerData={inviteCode:"",practitioner:void 0},i.insecureEmail={checked:!1},i.insecurePushes={checked:!1};var r=A.getUserPreference("receive_phi_in_email");void 0!==r&&(i.insecureEmail.checked="true"==r);var s=A.getUserPreference("receive_phi_in_pushes");function c(){g.modal.open({modalId:"InsecureDeviceModal",templateUrl:"views/account/account.insecureDevice.modal.html",scope:i,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){i.insecureDeviceModal=e})}void 0!==s&&(i.insecurePushes.checked="true"==s),i.enteringInvite=!0,i.getTherapyIntroText=function(){return t.trustAsHtml(l.instant("THERAPY_INTRO_1"))},i.copyTherapyLink=function(){cordova.plugins.clipboard.copy("http://thinkpacifica.com/clinicians/",function(){T.showToast(l.instant("URL_COPIED_TO_CLIPBOARD"),!0)},function(){})},i.getPractitionerName=function(e){return e?e.fullName:""},i.getPractitionerDetails=function(e){if(!e)return"";var t=i.getPractitionerName(e);return t+=", "+e.location.address+", "+e.location.city+", "+e.location.state},i.getAuthorizationText=function(){if(i.practitionerData.practitioner){var e=l.instant("CONNECT_TO_PRACTITIONER_DESC");return e=e.replace("XXXPRACTITIONER_NAMEXXX",i.getPractitionerName(i.practitionerData.practitioner)),t.trustAsHtml(e)}return""},i.closeConnectModal=function(){g.modal.close(i.connectModal).then(function(e){i.connectModal=e,i.enteringInvite=!0,i.practitionerData.practitioner=void 0})},i.closeInsecureDeviceModal=function(){g.modal.close(i.insecureDeviceModal).then(function(e){i.insecureDeviceModal=e})},i.showConnectModal=function(){i.practitionerData.inviteCode="",i.practitionerData.practitioner=void 0;var t=m.isWeb()?"templates/account.connect.modal.html":"views/account/account.connect.modal.html";m.isWebDebug()?g.modal.open({modalId:"TherapistConnectModal",templateUrl:t,scope:i,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){i.connectModal=e,u(o.resize())}):f.secureStorage.isKeyguardSecure(function(e){e?g.modal.open({modalId:"TherapistConnectModal",templateUrl:t,scope:i,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){i.connectModal=e,u(o.resize())}):c()},function(){c()})},i.closeInsecureEmailModal=function(){g.modal.close(i.insecureEmailModal).then(function(e){i.insecureEmailModal=e,o.$getByHandle("therapyScroller").resize(),o.$getByHandle("therapyScroller").scrollTop(!1)})},i.closeTherapistSharemodal=function(){g.modal.close(i.therapistSharemodal).then(function(e){i.therapistSharemodal=e})},i.showTherapistShareModal=function(){i.practitionerData={type:l.instant("THERAPIST")},i.showConfirmScreen=!1;var e=m.isWeb()?"templates/therapist.info.modal.html":"views/therapy/therapist.info.modal.html";g.modal.open({modalId:"TherapistShareModal",templateUrl:e,scope:i,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){i.therapistSharemodal=e})},i.sharePacificaInfo=function(){i.sendingEmail=!0,A.sharePacificaWithPractitioner(i.practitionerData.type,i.practitionerData.name,i.practitionerData.email,i.practitionerData.userName).success(function(){i.confirmMsg=l.instant("SHARED_PACIFICA_FOR_CLINICIANS").replace("XXXPRACTITIONERXXX",i.practitionerData.type.toLowerCase()),i.sendingEmail=!1,m.isWeb()?i.showConfirmScreen=!0:(i.closeTherapistSharemodal(),T.showToast(i.confirmMsg),i.nextNuxSlide&&i.nextNuxSlide())}).error(function(){i.sendingEmail=!1,d.addEventAppsee("errorTriggered","sharePacifica"),g.popup.alert({template:l.instant("SHARE_PACIFICA_ERROR"),okText:l.instant("OK_GOT_IT"),okType:"button-default"})})},i.updateInsecureEmailPreference=function(){A.setUserPreference("receive_phi_in_email",i.insecureEmail.checked)},i.updateInsecurePushPreference=function(){A.setUserPreference("receive_phi_in_pushes",i.insecurePushes.checked)},i.showInsecureEmailPreference=function(){return void 0!==A.getUserPreference("receive_phi_in_email")},i.showInsecureEmailModal=function(){var e=m.isWeb()?"templates/account.insecureEmail.modal.html":"views/account/account.insecureEmail.modal.html";g.modal.open({modalId:"InsecureEmailModal",templateUrl:e,scope:i,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){i.insecureEmailModal=e})},i.getPractitionerInvite=function(){A.getPractitionerInvite(i.practitionerData.inviteCode).success(function(e){i.practitionerData.practitioner=e,i.enteringInvite=!1,u(o.resize,200)}).error(function(e,t,i,n){d.addEventAppsee("errorTriggered","connectPractitioner"),404==t?g.popup.alert({template:l.instant("CONNECT_PRACTITIONER_INVALID_CODE"),okText:l.instant("OK_GOT_IT"),okType:"button-default"}):g.popup.alert({template:l.instant("CONNECT_PRACTITIONER_ERROR"),okText:l.instant("OK_GOT_IT"),okType:"button-default"})})},i.connectToPractitioner=function(){i.enteringInvite?i.getPractitionerInvite():A.connectPractitioner(i.practitionerData.inviteCode).success(function(e){i.practitionerConnections.push(e),i.$broadcast("event:userContextRefreshRequest"),void 0===A.getUserPreference("receive_phi_in_email")&&i.showInsecureEmailModal(),i.closeConnectModal(),A.setUserPreference("receive_phi_in_email",!1),A.setUserPreference("receive_phi_in_pushes",!1),u(o.scrollTop),u(o.resize,200)}).error(function(e,t,i,n){var o;o=404==t?l.instant("CONNECT_PRACTITIONER_INVALID_CODE"):409==t?l.instant("CONNECT_TO_PRACTITIONER_CONFLICT"):l.instant("CONNECT_PRACTITIONER_ERROR"),g.popup.alert({template:o,okText:l.instant("OK_GOT_IT"),okType:"button-default"})})},i.disconnectPractitioner=function(t){n.confirm({template:"<div focus-on-open>"+l.instant("DISCONNECT_PRACTITIONER_POPUP")+"</div>",cancelText:l.instant("CANCEL"),cancelType:"button-default",okText:l.instant("DISCONNECT"),okType:"button-default"}).then(function(e){e&&A.disconnectPractitioner(t).success(function(){var e=i.practitionerConnections.indexOf(t);0<=e&&i.practitionerConnections.splice(e,1)}).error(function(e,t,i,n){d.addEventAppsee("errorTriggered","disconnectPractitioner"),g.popup.alert({template:l.instant("CONNECT_PRACTITIONER_ERROR"),okText:l.instant("OK_GOT_IT"),okType:"button-default"})})})}},A.timeZones={"Africa/Abidjan":"Africa/Abidjan","Africa/Accra":"Africa/Accra","Africa/Addis_Ababa":"Africa/Addis Ababa","Africa/Algiers":"Africa/Algiers","Africa/Asmara":"Africa/Asmara","Africa/Bamako":"Africa/Bamako","Africa/Bangui":"Africa/Bangui","Africa/Banjul":"Africa/Banjul","Africa/Bissau":"Africa/Bissau","Africa/Blantyre":"Africa/Blantyre","Africa/Brazzaville":"Africa/Brazzaville","Africa/Bujumbura":"Africa/Bujumbura","Africa/Cairo":"Africa/Cairo","Africa/Casablanca":"Africa/Casablanca","Africa/Ceuta":"Africa/Ceuta","Africa/Conakry":"Africa/Conakry","Africa/Dakar":"Africa/Dakar","Africa/Dar_es_Salaam":"Africa/Dar es Salaam","Africa/Djibouti":"Africa/Djibouti","Africa/Douala":"Africa/Douala","Africa/El_Aaiun":"Africa/El Aaiun","Africa/Freetown":"Africa/Freetown","Africa/Gaborone":"Africa/Gaborone","Africa/Harare":"Africa/Harare","Africa/Johannesburg":"Africa/Johannesburg","Africa/Kampala":"Africa/Kampala","Africa/Khartoum":"Africa/Khartoum","Africa/Kigali":"Africa/Kigali","Africa/Kinshasa":"Africa/Kinshasa","Africa/Lagos":"Africa/Lagos","Africa/Libreville":"Africa/Libreville","Africa/Lome":"Africa/Lome","Africa/Luanda":"Africa/Luanda","Africa/Lubumbashi":"Africa/Lubumbashi","Africa/Lusaka":"Africa/Lusaka","Africa/Malabo":"Africa/Malabo","Africa/Maputo":"Africa/Maputo","Africa/Maseru":"Africa/Maseru","Africa/Mbabane":"Africa/Mbabane","Africa/Mogadishu":"Africa/Mogadishu","Africa/Monrovia":"Africa/Monrovia","Africa/Nairobi":"Africa/Nairobi","Africa/Ndjamena":"Africa/Ndjamena","Africa/Niamey":"Africa/Niamey","Africa/Nouakchott":"Africa/Nouakchott","Africa/Ouagadougou":"Africa/Ouagadougou","Africa/Porto-Novo":"Africa/Porto-Novo","Africa/Sao_Tome":"Africa/Sao Tome","Africa/Tripoli":"Africa/Tripoli","Africa/Tunis":"Africa/Tunis","Africa/Windhoek":"Africa/Windhoek","America/Adak":"America/Adak","America/Anchorage":"America/Anchorage","America/Anguilla":"America/Anguilla","America/Antigua":"America/Antigua","America/Araguaina":"America/Araguaina","America/Argentina/Buenos_Aires":"America/Argentina/Buenos Aires","America/Argentina/Catamarca":"America/Argentina/Catamarca","America/Argentina/Cordoba":"America/Argentina/Cordoba","America/Argentina/Jujuy":"America/Argentina/Jujuy","America/Argentina/La_Rioja":"America/Argentina/La Rioja","America/Argentina/Mendoza":"America/Argentina/Mendoza","America/Argentina/Rio_Gallegos":"America/Argentina/Rio Gallegos","America/Argentina/Salta":"America/Argentina/Salta","America/Argentina/San_Juan":"America/Argentina/San Juan","America/Argentina/San_Luis":"America/Argentina/San Luis","America/Argentina/Tucuman":"America/Argentina/Tucuman","America/Argentina/Ushuaia":"America/Argentina/Ushuaia","America/Aruba":"America/Aruba","America/Asuncion":"America/Asuncion","America/Atikokan":"America/Atikokan","America/Bahia_Banderas":"America/Bahia Banderas","America/Bahia":"America/Bahia","America/Barbados":"America/Barbados","America/Belem":"America/Belem","America/Belize":"America/Belize","America/Blanc-Sablon":"America/Blanc-Sablon","America/Boa_Vista":"America/Boa Vista","America/Bogota":"America/Bogota","America/Boise":"America/Boise","America/Cambridge_Bay":"America/Cambridge Bay","America/Campo_Grande":"America/Campo Grande","America/Cancun":"America/Cancun","America/Caracas":"America/Caracas","America/Cayenne":"America/Cayenne","America/Cayman":"America/Cayman","America/Chicago":"America/Chicago","America/Chihuahua":"America/Chihuahua","America/Costa_Rica":"America/Costa Rica","America/Cuiaba":"America/Cuiaba","America/Curacao":"America/Curacao","America/Danmarkshavn":"America/Danmarkshavn","America/Dawson_Creek":"America/Dawson Creek","America/Dawson":"America/Dawson","America/Denver":"America/Denver","America/Detroit":"America/Detroit","America/Dominica":"America/Dominica","America/Edmonton":"America/Edmonton","America/Eirunepe":"America/Eirunepe","America/El_Salvador":"America/El Salvador","America/Fortaleza":"America/Fortaleza","America/Glace_Bay":"America/Glace Bay","America/Godthab":"America/Godthab","America/Goose_Bay":"America/Goose Bay","America/Grand_Turk":"America/Grand Turk","America/Grenada":"America/Grenada","America/Guadeloupe":"America/Guadeloupe","America/Guatemala":"America/Guatemala","America/Guayaquil":"America/Guayaquil","America/Guyana":"America/Guyana","America/Halifax":"America/Halifax","America/Havana":"America/Havana","America/Hermosillo":"America/Hermosillo","America/Indiana/Indianapolis":"America/Indiana/Indianapolis","America/Indiana/Knox":"America/Indiana/Knox","America/Indiana/Marengo":"America/Indiana/Marengo","America/Indiana/Petersburg":"America/Indiana/Petersburg","America/Indiana/Tell_City":"America/Indiana/Tell City","America/Indiana/Vevay":"America/Indiana/Vevay","America/Indiana/Vincennes":"America/Indiana/Vincennes","America/Indiana/Winamac":"America/Indiana/Winamac","America/Inuvik":"America/Inuvik","America/Iqaluit":"America/Iqaluit","America/Jamaica":"America/Jamaica","America/Juneau":"America/Juneau","America/Kentucky/Louisville":"America/Kentucky/Louisville","America/Kentucky/Monticello":"America/Kentucky/Monticello","America/La_Paz":"America/La Paz","America/Lima":"America/Lima","America/Los_Angeles":"America/Los Angeles","America/Maceio":"America/Maceio","America/Managua":"America/Managua","America/Manaus":"America/Manaus","America/Marigot":"America/Marigot","America/Martinique":"America/Martinique","America/Matamoros":"America/Matamoros","America/Mazatlan":"America/Mazatlan","America/Menominee":"America/Menominee","America/Merida":"America/Merida","America/Metlakatla":"America/Metlakatla","America/Mexico_City":"America/Mexico City","America/Miquelon":"America/Miquelon","America/Moncton":"America/Moncton","America/Monterrey":"America/Monterrey","America/Montevideo":"America/Montevideo","America/Montreal":"America/Montreal","America/Montserrat":"America/Montserrat","America/Nassau":"America/Nassau","America/New_York":"America/New York","America/Nipigon":"America/Nipigon","America/Nome":"America/Nome","America/Noronha":"America/Noronha","America/North_Dakota/Beulah":"America/North Dakota/Beulah","America/North_Dakota/Center":"America/North Dakota/Center","America/North_Dakota/New_Salem":"America/North Dakota/New Salem","America/Ojinaga":"America/Ojinaga","America/Panama":"America/Panama","America/Pangnirtung":"America/Pangnirtung","America/Paramaribo":"America/Paramaribo","America/Phoenix":"America/Phoenix","America/Port_of_Spain":"America/Port of Spain","America/Port-au-Prince":"America/Port-au-Prince","America/Porto_Velho":"America/Porto Velho","America/Puerto_Rico":"America/Puerto Rico","America/Rainy_River":"America/Rainy River","America/Rankin_Inlet":"America/Rankin Inlet","America/Recife":"America/Recife","America/Regina":"America/Regina","America/Resolute":"America/Resolute","America/Rio_Branco":"America/Rio Branco","America/Santa_Isabel":"America/Santa Isabel","America/Santarem":"America/Santarem","America/Santiago":"America/Santiago","America/Santo_Domingo":"America/Santo Domingo","America/Sao_Paulo":"America/Sao Paulo","America/Scoresbysund":"America/Scoresbysund","America/Shiprock":"America/Shiprock","America/Sitka":"America/Sitka","America/St_Barthelemy":"America/St Barthelemy","America/St_Johns":"America/St Johns","America/St_Kitts":"America/St Kitts","America/St_Lucia":"America/St Lucia","America/St_Thomas":"America/St Thomas","America/St_Vincent":"America/St Vincent","America/Swift_Current":"America/Swift Current","America/Tegucigalpa":"America/Tegucigalpa","America/Thule":"America/Thule","America/Thunder_Bay":"America/Thunder Bay","America/Tijuana":"America/Tijuana","America/Toronto":"America/Toronto","America/Tortola":"America/Tortola","America/Vancouver":"America/Vancouver","America/Whitehorse":"America/Whitehorse","America/Winnipeg":"America/Winnipeg","America/Yakutat":"America/Yakutat","America/Yellowknife":"America/Yellowknife","Antarctica/Casey":"Antarctica/Casey","Antarctica/Davis":"Antarctica/Davis","Antarctica/DumontDUrville":"Antarctica/DumontDUrville","Antarctica/Macquarie":"Antarctica/Macquarie","Antarctica/Mawson":"Antarctica/Mawson","Antarctica/McMurdo":"Antarctica/McMurdo","Antarctica/Palmer":"Antarctica/Palmer","Antarctica/Rothera":"Antarctica/Rothera","Antarctica/South_Pole":"Antarctica/South Pole","Antarctica/Syowa":"Antarctica/Syowa","Antarctica/Vostok":"Antarctica/Vostok","Arctic/Longyearbyen":"Arctic/Longyearbyen","Asia/Aden":"Asia/Aden","Asia/Almaty":"Asia/Almaty","Asia/Amman":"Asia/Amman","Asia/Anadyr":"Asia/Anadyr","Asia/Aqtau":"Asia/Aqtau","Asia/Aqtobe":"Asia/Aqtobe","Asia/Ashgabat":"Asia/Ashgabat","Asia/Baghdad":"Asia/Baghdad","Asia/Bahrain":"Asia/Bahrain","Asia/Baku":"Asia/Baku","Asia/Bangkok":"Asia/Bangkok","Asia/Beirut":"Asia/Beirut","Asia/Bishkek":"Asia/Bishkek","Asia/Brunei":"Asia/Brunei","Asia/Choibalsan":"Asia/Choibalsan","Asia/Chongqing":"Asia/Chongqing","Asia/Colombo":"Asia/Colombo","Asia/Damascus":"Asia/Damascus","Asia/Dhaka":"Asia/Dhaka","Asia/Dili":"Asia/Dili","Asia/Dubai":"Asia/Dubai","Asia/Dushanbe":"Asia/Dushanbe","Asia/Gaza":"Asia/Gaza","Asia/Harbin":"Asia/Harbin","Asia/Ho_Chi_Minh":"Asia/Ho Chi Minh","Asia/Hong_Kong":"Asia/Hong Kong","Asia/Hovd":"Asia/Hovd","Asia/Irkutsk":"Asia/Irkutsk","Asia/Jakarta":"Asia/Jakarta","Asia/Jayapura":"Asia/Jayapura","Asia/Jerusalem":"Asia/Jerusalem","Asia/Kabul":"Asia/Kabul","Asia/Kamchatka":"Asia/Kamchatka","Asia/Karachi":"Asia/Karachi","Asia/Kashgar":"Asia/Kashgar","Asia/Kathmandu":"Asia/Kathmandu","Asia/Kolkata":"Asia/Kolkata","Asia/Krasnoyarsk":"Asia/Krasnoyarsk","Asia/Kuala_Lumpur":"Asia/Kuala Lumpur","Asia/Kuching":"Asia/Kuching","Asia/Kuwait":"Asia/Kuwait","Asia/Macau":"Asia/Macau","Asia/Magadan":"Asia/Magadan","Asia/Makassar":"Asia/Makassar","Asia/Manila":"Asia/Manila","Asia/Muscat":"Asia/Muscat","Asia/Nicosia":"Asia/Nicosia","Asia/Novokuznetsk":"Asia/Novokuznetsk","Asia/Novosibirsk":"Asia/Novosibirsk","Asia/Omsk":"Asia/Omsk","Asia/Oral":"Asia/Oral","Asia/Phnom_Penh":"Asia/Phnom Penh","Asia/Pontianak":"Asia/Pontianak","Asia/Pyongyang":"Asia/Pyongyang","Asia/Qatar":"Asia/Qatar","Asia/Qyzylorda":"Asia/Qyzylorda","Asia/Rangoon":"Asia/Rangoon","Asia/Riyadh":"Asia/Riyadh","Asia/Sakhalin":"Asia/Sakhalin","Asia/Samarkand":"Asia/Samarkand","Asia/Seoul":"Asia/Seoul","Asia/Shanghai":"Asia/Shanghai","Asia/Singapore":"Asia/Singapore","Asia/Taipei":"Asia/Taipei","Asia/Tashkent":"Asia/Tashkent","Asia/Tbilisi":"Asia/Tbilisi","Asia/Tehran":"Asia/Tehran","Asia/Thimphu":"Asia/Thimphu","Asia/Tokyo":"Asia/Tokyo","Asia/Ulaanbaatar":"Asia/Ulaanbaatar","Asia/Urumqi":"Asia/Urumqi","Asia/Vientiane":"Asia/Vientiane","Asia/Vladivostok":"Asia/Vladivostok","Asia/Yakutsk":"Asia/Yakutsk","Asia/Yekaterinburg":"Asia/Yekaterinburg","Asia/Yerevan":"Asia/Yerevan","Atlantic/Azores":"Atlantic/Azores","Atlantic/Bermuda":"Atlantic/Bermuda","Atlantic/Canary":"Atlantic/Canary","Atlantic/Cape_Verde":"Atlantic/Cape Verde","Atlantic/Faroe":"Atlantic/Faroe","Atlantic/Madeira":"Atlantic/Madeira","Atlantic/Reykjavik":"Atlantic/Reykjavik","Atlantic/South_Georgia":"Atlantic/South Georgia","Atlantic/St_Helena":"Atlantic/St Helena","Atlantic/Stanley":"Atlantic/Stanley","Australia/Adelaide":"Australia/Adelaide","Australia/Brisbane":"Australia/Brisbane","Australia/Broken_Hill":"Australia/Broken Hill","Australia/Currie":"Australia/Currie","Australia/Darwin":"Australia/Darwin","Australia/Eucla":"Australia/Eucla","Australia/Hobart":"Australia/Hobart","Australia/Lindeman":"Australia/Lindeman","Australia/Lord_Howe":"Australia/Lord Howe","Australia/Melbourne":"Australia/Melbourne","Australia/Perth":"Australia/Perth","Australia/Sydney":"Australia/Sydney","Europe/Amsterdam":"Europe/Amsterdam","Europe/Andorra":"Europe/Andorra","Europe/Athens":"Europe/Athens","Europe/Belgrade":"Europe/Belgrade","Europe/Berlin":"Europe/Berlin","Europe/Bratislava":"Europe/Bratislava","Europe/Brussels":"Europe/Brussels","Europe/Bucharest":"Europe/Bucharest","Europe/Budapest":"Europe/Budapest","Europe/Chisinau":"Europe/Chisinau","Europe/Copenhagen":"Europe/Copenhagen","Europe/Dublin":"Europe/Dublin","Europe/Gibraltar":"Europe/Gibraltar","Europe/Guernsey":"Europe/Guernsey","Europe/Helsinki":"Europe/Helsinki","Europe/Isle_of_Man":"Europe/Isle of Man","Europe/Istanbul":"Europe/Istanbul","Europe/Jersey":"Europe/Jersey","Europe/Kaliningrad":"Europe/Kaliningrad","Europe/Kiev":"Europe/Kiev","Europe/Lisbon":"Europe/Lisbon","Europe/Ljubljana":"Europe/Ljubljana","Europe/London":"Europe/London","Europe/Luxembourg":"Europe/Luxembourg","Europe/Madrid":"Europe/Madrid","Europe/Malta":"Europe/Malta","Europe/Mariehamn":"Europe/Mariehamn","Europe/Minsk":"Europe/Minsk","Europe/Monaco":"Europe/Monaco","Europe/Moscow":"Europe/Moscow","Europe/Oslo":"Europe/Oslo","Europe/Paris":"Europe/Paris","Europe/Podgorica":"Europe/Podgorica","Europe/Prague":"Europe/Prague","Europe/Riga":"Europe/Riga","Europe/Rome":"Europe/Rome","Europe/Samara":"Europe/Samara","Europe/San_Marino":"Europe/San Marino","Europe/Sarajevo":"Europe/Sarajevo","Europe/Simferopol":"Europe/Simferopol","Europe/Skopje":"Europe/Skopje","Europe/Sofia":"Europe/Sofia","Europe/Stockholm":"Europe/Stockholm","Europe/Tallinn":"Europe/Tallinn","Europe/Tirane":"Europe/Tirane","Europe/Uzhgorod":"Europe/Uzhgorod","Europe/Vaduz":"Europe/Vaduz","Europe/Vatican":"Europe/Vatican","Europe/Vienna":"Europe/Vienna","Europe/Vilnius":"Europe/Vilnius","Europe/Volgograd":"Europe/Volgograd","Europe/Warsaw":"Europe/Warsaw","Europe/Zagreb":"Europe/Zagreb","Europe/Zaporozhye":"Europe/Zaporozhye","Europe/Zurich":"Europe/Zurich","Indian/Antananarivo":"Indian/Antananarivo","Indian/Chagos":"Indian/Chagos","Indian/Christmas":"Indian/Christmas","Indian/Cocos":"Indian/Cocos","Indian/Comoro":"Indian/Comoro","Indian/Kerguelen":"Indian/Kerguelen","Indian/Mahe":"Indian/Mahe","Indian/Maldives":"Indian/Maldives","Indian/Mauritius":"Indian/Mauritius","Indian/Mayotte":"Indian/Mayotte","Indian/Reunion":"Indian/Reunion","Pacific/Apia":"Pacific/Apia","Pacific/Auckland":"Pacific/Auckland","Pacific/Chatham":"Pacific/Chatham","Pacific/Chuuk":"Pacific/Chuuk","Pacific/Easter":"Pacific/Easter","Pacific/Efate":"Pacific/Efate","Pacific/Enderbury":"Pacific/Enderbury","Pacific/Fakaofo":"Pacific/Fakaofo","Pacific/Fiji":"Pacific/Fiji","Pacific/Funafuti":"Pacific/Funafuti","Pacific/Galapagos":"Pacific/Galapagos","Pacific/Gambier":"Pacific/Gambier","Pacific/Guadalcanal":"Pacific/Guadalcanal","Pacific/Guam":"Pacific/Guam","Pacific/Honolulu":"Pacific/Honolulu","Pacific/Johnston":"Pacific/Johnston","Pacific/Kiritimati":"Pacific/Kiritimati","Pacific/Kosrae":"Pacific/Kosrae","Pacific/Kwajalein":"Pacific/Kwajalein","Pacific/Majuro":"Pacific/Majuro","Pacific/Marquesas":"Pacific/Marquesas","Pacific/Midway":"Pacific/Midway","Pacific/Nauru":"Pacific/Nauru","Pacific/Niue":"Pacific/Niue","Pacific/Norfolk":"Pacific/Norfolk","Pacific/Noumea":"Pacific/Noumea","Pacific/Pago_Pago":"Pacific/Pago Pago","Pacific/Palau":"Pacific/Palau","Pacific/Pitcairn":"Pacific/Pitcairn","Pacific/Pohnpei":"Pacific/Pohnpei","Pacific/Port_Moresby":"Pacific/Port Moresby","Pacific/Rarotonga":"Pacific/Rarotonga","Pacific/Saipan":"Pacific/Saipan","Pacific/Tahiti":"Pacific/Tahiti","Pacific/Tarawa":"Pacific/Tarawa","Pacific/Tongatapu":"Pacific/Tongatapu","Pacific/Wake":"Pacific/Wake","Pacific/Wallis":"Pacific/Wallis",UTC:"UTC"},A.getTimeZones=function(){return A.timeZones},A.getTimeZoneDisplay=function(e){return A.timeZones[e]},A.exportProgressHistory=function(t){var i=t.$new(!0);i.mode=void 0,i.week="current",i.recipient="me",i.errors=[],i.meData={email:A.getAccountUser().user.email,name:""},i.otherData={type:l.instant("THERAPIST"),email:"",name:"",userName:""},i.setRecipient=function(e){i.recipient=e,i.removeError("recipient")},i.setWeek=function(e){i.week=e,i.removeError("week")},i.hasError=function(e){return 0<=i.errors.indexOf(e)},i.addError=function(e){i.errors.indexOf(e)<0&&i.errors.push(e)},i.removeError=function(e){var t=i.errors.indexOf(e);0<=t&&i.errors.splice(t,1)},i.closeExportModal=function(){g.modal.close(t.exportModal).then(function(e){t.exportModal=e})},i.canSendReport=function(){var e=!0;return i.recipient||(i.addError("recipient"),e=!1),i.week||(i.addError("week"),e=!1),!(!e||"me"!=i.recipient)||"other"==i.recipient&&(T.isEmailValid(i.otherData.email)||(i.addError("email"),e=!1),0===i.otherData.name.length&&(i.addError("name"),e=!1),0===i.otherData.userName.length&&(i.addError("userName"),e=!1),e)},i.sendReport=function(){function e(){i.sendingReport=!1,i.closeExportModal()}function t(){d.addEventAppsee("errorTriggered","sendReport"),g.popup.alert({template:"<div>"+l.instant("SEND_REPORT_ERROR")+"</div>",okText:l.instant("OK_GOT_IT"),okType:"button-default"}),i.sendingReport=!1,i.closeExportModal()}i.canSendReport()&&(i.sendingReport=!0,"me"==i.recipient?A.sendReportToSelf(i.week,i.meData.name).success(e).error(t):A.sendReportToOther(i.week,i.otherData.userName,i.otherData.name,i.otherData.email,i.otherData.type).success(e).error(t))},g.modal.open({modalId:"ExportModal",templateUrl:"views/progress/export.modal.html",scope:i,animation:"none",ignoreStatusBar:!1,recordAppseeEvent:!0}).then(function(e){t.exportModal=e})},A.isUKYControl=function(){var e=A.getSplitTestContext();return!(!e||!e.splitTestGroups)&&(e&&"A"==e.ukyPilot)},A.isUKYControl=function(){var e=A.getSplitTestContext();return!(!e||!e.splitTestGroups)&&(e&&"A"==e.ukyPilot)},A.postJSError=function(e,t,i){p.post(m.serverURL+"/support/jserror",{msg:e,url:t,line:i})},A.showConfirmDeleteModal=function(e,t){A.isPHI()?g.popup.alert({template:l.instant("CANNOT_DELETE_PHI"),okText:l.instant("OK_GOT_IT"),okType:"button-default"}):(t.confirmData={inputText:"",reason:null},t.confirmError=!1,g.modal.open({modalId:"DeleteAccountModal",templateUrl:e,scope:t,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!0}).then(function(e){return t.deleteModal=e,t.deleteModal}))},A.deleteUser=function(){var e=A.getDeletionReason();return p.post(m.serverURL+"/account/deleteUser",{reason:e})};var L=function(){A.deleteUser().success(function(){A.googleSignin&&window.plugins.googleplus.disconnect(),A.clearData(),n.$broadcast("event:loginRequired",{showDataDisclaimer:!0})}).error(function(){d.addEventAppsee("errorTriggered","accountDelete"),g.popup.alert({template:"<div focus-on-open>"+l.instant("DELETE_ERROR")+"</div>",okText:l.instant("OK_GOT_IT"),okType:"button-default"})})},R=function(){console.log("appsee delete error"),L()};return A.setDeletionReason=function(e){A.deletionReason=e},A.getDeletionReason=function(){return A.deletionReason},A.validateDeleteText=function(e,t,i){return deleteText=e.inputText.toLowerCase(),A.setDeletionReason(e.reason),("delete"===deleteText||"supprimer"==deleteText)&&(d.appseeDeleteUser(L,R),i&&i(),!0)},A.shouldViewTerms=function(){if(0===A.consentContext.consents.length)return!0},A.userAcceptTerms=function(){var e={userId:A.accountUser.user.id,consentType:"TermsOfService",consentGiven:!0};p.post(m.serverURL+"/account/consent",e).success(function(){A.consentContext.consents.push(e)}).error(function(){console.log("consent error")})},A.setConsentContext=function(e){A.consentContext=e},A.canUseSiriNotifications=function(){return m.isIos()&&12<=ionic.Platform.version()&&window.cordova&&window.cordova.plugins&&void 0!==window.cordova.plugins.SiriShortcuts},A.initVideoTextView=function(i){i.closeTextModal=function(){g.modal.close(i.textModal).then(function(e){i.textModal=e})},i.viewText=function(e,t){e.stopPropagation(),e.preventDefault(),i.vidIndex=function(e){switch(e){case"milo-mood":return A.MOOD_VIDEO;case"milo-relax":return A.RELAX_VIDEO;case"milo-goals":return A.GOALS_VIDEO;case"milo-health":return A.HEALTH_VIDEO;case"milo-thoughts":return A.THOUGHTS_VIDEO;case"milo-community":return A.COMMUNITY_VIDEO}}(t),i.vidIndex&&(i.isMiloVideo=!0),i.textFile="views/videoText/"+t+".html",g.modal.open({modalId:"VideoTextModal",templateUrl:"views/videoText/videoText.modal.html",scope:i,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){i.textModal=e})},i.finishVideo=function(){if(i.closeTextModal(),i.isMiloVideo){var e,t=A.getUserPreference("milo_video_mask");63!=parseInt(t)&&(e=t?parseInt(t)|1<<i.vidIndex:1<<i.vidIndex,A.setUserPreference("milo_video_mask",e))}}},A}]),(servicesModule=angular.module("activityService",[])).factory("ActivityService",["AccountService","Environment","authHttp","$translate","GeneralService","StorageService","$rootScope","$q","$timeout",function(r,s,c,o,a,e,l,i,n){var u={activityContext:{},offlineActivities:[],completedActivities:[],activitiesById:{},activities:{LOGIN:{name:"LOGIN",id:1,type:"account"},LOGOUT:{name:"LOGOUT",id:2,type:"account"},COMPLETED_EXPERIMENT:{name:"COMPLETED_EXPERIMENT",displayKey:"COMPLETE_AN_EXPERIMENT",id:5,type:"goals",premium:!1,actionClass:"goal",actionTitle:"COMPLETED_GOAL"},COMPLETED_BREATHING:{name:"COMPLETED_BREATHING",displayKey:"RELAX_ACTIVITY_DEEP_BREATHING",id:3,type:"relax",premium:!1,actionClass:"deep-breathing",actionTitle:"COMPLETED_DEEP_BREATHING",isSkillActivity:!0,exercise:"Deep Breathing",audio:"none",audioLength:0,meditation:!1,activity:"COMPLETED_BREATHING",relaxCategory:"BASICS"},COMPLETED_MUSCLE_RELAXATION:{name:"COMPLETED_MUSCLE_RELAXATION",displayKey:"RELAX_ACTIVITY_MUSCLE_RELAXATION",id:6,type:"relax",premium:!1,actionClass:"muscle-relaxation",actionTitle:"COMPLETED_MUSCLE_RELAXATION",isSkillActivity:!0,exercise:"Muscle Relaxation",audio:"musclerelaxation.mp3",audioLength:528,oldAudioLength:471,meditation:!0,activity:"COMPLETED_MUSCLE_RELAXATION",size:9080631,relaxCategory:"BASICS"},COMPLETED_MINDFULNESS:{name:"COMPLETED_MINDFULNESS",id:8,type:"relax",premium:!1,isSkillActivity:!0},COMPLETED_UNGUIDED_MEDITATION:{name:"COMPLETED_UNGUIDED_MEDITATION",displayKey:"UNGUIDED_MEDITATION_DISPLAY",descriptionDisplayKey:"RELAX_ACTIVITY_SOUNDSCAPE_MODE_DESCRIPTION",id:10,type:"relax",premium:!1,actionClass:"unguided-meditation",actionTitle:"COMPLETED_UNGUIDED_MEDITATION",isSkillActivity:!0,exercise:"Soundscape Mode",audio:"none",audioLength:0,meditation:!1,activity:"COMPLETED_UNGUIDED_MEDITATION",relaxCategory:"BASICS"},COMPLETED_POSITIVE_VISUALIZATION:{name:"COMPLETED_POSITIVE_VISUALIZATION",displayKey:"RELAX_VISUALIZE_HELP_TITLE",descriptionDisplayKey:"RELAX_ACTIVITY_VISUALIZATION_DESCRIPTION",id:7,type:"relax",premium:!1,actionClass:"positive-visualization",actionTitle:"COMPLETED_POSITIVE_VISUALIZATION",isSkillActivity:!0,exercise:"Visualization",audio:"",audioLength:0,meditation:!1,activity:"COMPLETED_POSITIVE_VISUALIZATION",relaxCategory:"BASICS"},COMPLETED_MINDFUL_SENSES:{name:"COMPLETED_MINDFUL_SENSES",displayKey:"RELAX_ACTIVITY_MINDFUL_SENSES",id:15,type:"relax",premium:!1,actionClass:"mindful-senses",actionTitle:"COMPLETED_MINDFUL_SENSES",isSkillActivity:!0,exercise:"Mindful: Senses",audio:"mindfulsenses.mp3",audioLength:292,oldAudioLength:279,meditation:!0,activity:"COMPLETED_MINDFUL_SENSES",size:4989498,relaxCategory:"MINDFULNESS"},COMPLETED_MINDFUL_BREATHE:{name:"COMPLETED_MINDFUL_BREATHE",displayKey:"RELAX_ACTIVITY_MINDFUL_BREATHE",id:16,type:"relax",premium:!1,actionClass:"mindful-breathe",actionTitle:"COMPLETED_MINDFUL_BREATHE",isSkillActivity:!0,exercise:"Mindful: Breathe",audio:"mindfulbreathe.mp3",audioLength:195,oldAudioLength:177,meditation:!0,activity:"COMPLETED_MINDFUL_BREATHE",size:3353531,relaxCategory:"MINDFULNESS"},COMPLETED_MINDFUL_PRESENCE:{name:"COMPLETED_MINDFUL_PRESENCE",displayKey:"RELAX_ACTIVITY_MINDFUL_PRESENCE",id:46,type:"relax",premium:!1,actionClass:"mindful-presence",actionTitle:"COMPLETED_MINDFUL_PRESENCE",isSkillActivity:!0,exercise:"Mindful: Presence",audio:"mindfulpresence.mp3",audioLength:518,oldAudioLength:487,meditation:!0,activity:"COMPLETED_MINDFUL_PRESENCE",size:8857631,relaxCategory:"MINDFULNESS"},COMPLETED_MINDFUL_OBSERVE:{name:"COMPLETED_MINDFUL_OBSERVE",displayKey:"RELAX_ACTIVITY_MINDFUL_OBSERVE",id:17,type:"relax",premium:!0,actionClass:"mindful-observe",actionTitle:"COMPLETED_MINDFUL_OBSERVE",isSkillActivity:!0,exercise:"Mindful: Observe",audio:"mindfulobserve.mp3",audioLength:213,oldAudioLength:197,meditation:!0,activity:"COMPLETED_MINDFUL_OBSERVE",size:3728678,relaxCategory:"MINDFULNESS"},COMPLETED_MINDFUL_BODY_SCAN:{name:"COMPLETED_MINDFUL_BODY_SCAN",displayKey:"RELAX_ACTIVITY_MINDFUL_BODY_SCAN",id:18,type:"relax",premium:!0,actionClass:"mindful-body-scan",actionTitle:"COMPLETED_MINDFUL_BODY_SCAN",isSkillActivity:!0,exercise:"Mindful: Body Scan",audio:"mindfulbodyscan.mp3",audioLength:224,oldAudioLength:209,meditation:!0,activity:"COMPLETED_MINDFUL_BODY_SCAN",size:3826108,relaxCategory:"MINDFULNESS"},COMPLETED_MINDFUL_WALK:{name:"COMPLETED_MINDFUL_WALK",displayKey:"RELAX_ACTIVITY_MINDFUL_WALK",id:19,type:"relax",premium:!0,actionClass:"mindful-walk",actionTitle:"COMPLETED_MINDFUL_WALK",isSkillActivity:!0,exercise:"Mindful: Walk",audio:"mindfulwalk.mp3",audioLength:696,oldAudioLength:575,meditation:!0,activity:"COMPLETED_MINDFUL_WALK",size:12298261,relaxCategory:"MINDFULNESS"},COMPLETED_MINDFUL_EMOTIONS:{name:"COMPLETED_MINDFUL_EMOTIONS",displayKey:"RELAX_ACTIVITY_MINDFUL_EMOTIONS",id:48,type:"relax",premium:!0,actionClass:"mindful-emotions",actionTitle:"COMPLETED_MINDFUL_EMOTIONS",isSkillActivity:!0,exercise:"Mindful: Emotions",audio:"mindfulemotions.mp3",audioLength:684,oldAudioLength:637,meditation:!0,activity:"COMPLETED_MINDFUL_EMOTIONS",size:11813493,relaxCategory:"MINDFULNESS"},COMPLETED_MINDFUL_THOUGHTS:{name:"COMPLETED_MINDFUL_THOUGHTS",displayKey:"RELAX_ACTIVITY_MINDFUL_THOUGHTS",id:47,type:"relax",premium:!0,actionClass:"mindful-thoughts",actionTitle:"COMPLETED_MINDFUL_THOUGHTS",isSkillActivity:!0,exercise:"Mindful: Thoughts",audio:"mindfulthoughts.mp3",audioLength:565,oldAudioLength:523,meditation:!0,activity:"COMPLETED_MINDFUL_THOUGHTS",size:9748634,relaxCategory:"MINDFULNESS"},COMPLETED_EATING_MINDFULLY:{name:"COMPLETED_EATING_MINDFULLY",displayKey:"RELAX_ACTIVITY_EATING_MINDFULLY",id:55,type:"relax",premium:!0,actionClass:"eating-mindfully",actionTitle:"COMPLETED_EATING_MINDFULLY",isSkillActivity:!0,exercise:"Eating Mindfully",audio:"mindfuleating.mp3",audioLength:370,meditation:!0,activity:"COMPLETED_EATING_MINDFULLY",size:5913349,relaxCategory:"MINDFULNESS"},COMPLETED_SS_SOCIAL_SITUATIONS:{name:"COMPLETED_SS_SOCIAL_SITUATIONS",displayKey:"RELAX_ACTIVITY_SOCIAL_SITUATIONS",id:11,type:"relax",premium:!1,actionClass:"social-situations",actionTitle:"COMPLETED_SS_SOCIAL_SITUATIONS",isSkillActivity:!0,exercise:"Social Situations",audio:"ss-social-situations.mp3",audioLength:523,oldAudioLength:445,meditation:!0,activity:"COMPLETED_SS_SOCIAL_SITUATIONS",size:9284770,relaxCategory:"STRESSFUL_SITUATIONS"},COMPLETED_SCHOOL_STRESS:{name:"COMPLETED_SCHOOL_STRESS",displayKey:"RELAX_ACTIVITY_SCHOOL_STRESS",id:59,type:"relax",premium:!1,actionClass:"school-stress",actionTitle:"COMPLETED_SCHOOL_STRESS",isSkillActivity:!0,exercise:"School Stress",audio:"ss-school.mp3",audioLength:473,meditation:!0,activity:"COMPLETED_SCHOOL_STRESS",size:8802728,relaxCategory:"STRESSFUL_SITUATIONS"},COMPLETED_SS_FLYING:{name:"COMPLETED_SS_FLYING",displayKey:"RELAX_ACTIVITY_FLYING",id:12,type:"relax",premium:!0,actionClass:"flying",actionTitle:"COMPLETED_SS_FLYING",isSkillActivity:!0,exercise:"Flying",audio:"ss-flying.mp3",audioLength:395,oldAudioLength:478,meditation:!0,activity:"COMPLETED_SS_FLYING",size:7040170,relaxCategory:"STRESSFUL_SITUATIONS"},COMPLETED_SS_PUBLIC_SPEAKING:{name:"COMPLETED_SS_PUBLIC_SPEAKING",displayKey:"RELAX_ACTIVITY_PUBLIC_SPEAKING",id:13,type:"relax",premium:!0,actionClass:"public-speaking",actionTitle:"COMPLETED_SS_PUBLIC_SPEAKING",isSkillActivity:!0,exercise:"Public Speaking",audio:"ss-speaking.mp3",audioLength:585,oldAudioLength:556,meditation:!0,activity:"COMPLETED_SS_PUBLIC_SPEAKING",size:10431744,relaxCategory:"STRESSFUL_SITUATIONS"},COMPLETED_SS_PUBLIC_TRANSIT:{name:"COMPLETED_SS_PUBLIC_TRANSIT",displayKey:"RELAX_ACTIVITY_PUBLIC_TRANSIT",id:14,type:"relax",premium:!0,actionClass:"public-transit",actionTitle:"COMPLETED_SS_PUBLIC_TRANSIT",isSkillActivity:!0,exercise:"Public Transit",audio:"ss-public-transit.mp3",audioLength:531,oldAudioLength:435,meditation:!0,activity:"COMPLETED_SS_PUBLIC_TRANSIT",size:9469781,relaxCategory:"STRESSFUL_SITUATIONS"},COMPLETED_DIFFICULT_EXPERIENCE:{name:"COMPLETED_DIFFICULT_EXPERIENCE",displayKey:"RELAX_ACTIVITY_DIFFICULT_EXPERIENCE",id:26,type:"relax",premium:!0,actionClass:"difficult-experience",actionTitle:"COMPLETED_DIFFICULT_EXPERIENCE",isSkillActivity:!0,exercise:"Difficult Experience",audio:"difficultexperience.mp3",audioLength:442,oldAudioLength:393,meditation:!0,activity:"COMPLETED_DIFFICULT_EXPERIENCE",size:7721839,relaxCategory:"STRESSFUL_SITUATIONS"},COMPLETED_PANIC_EMERGENCY:{name:"COMPLETED_PANIC_EMERGENCY",displayKey:"RELAX_ACTIVITY_PANIC_EMERGENCY",id:22,type:"relax",premium:!0,actionClass:"panic-emergency",actionTitle:"COMPLETED_PANIC_EMERGENCY",isSkillActivity:!0,exercise:"Panic: Emergency",audio:"panicemergency.mp3",audioLength:288,oldAudioLength:274,meditation:!0,activity:"COMPLETED_PANIC_EMERGENCY",size:4891750,relaxCategory:"STRESSFUL_SITUATIONS"},COMPLETED_GOING_TO_WORK:{name:"COMPLETED_GOING_TO_WORK",displayKey:"RELAX_ACTIVITY_GOING_TO_WORK",id:58,type:"relax",premium:!0,actionClass:"going-to-work",actionTitle:"COMPLETED_GOING_TO_WORK",isSkillActivity:!0,exercise:"Going to Work",audio:"ss-work.mp3",audioLength:404,meditation:!0,activity:"COMPLETED_GOING_TO_WORK",size:7504172,relaxCategory:"STRESSFUL_SITUATIONS"},COMPLETED_GOING_TO_DOCTOR:{name:"COMPLETED_GOING_TO_DOCTOR",displayKey:"RELAX_ACTIVITY_GOING_TO_DOCTOR",id:62,type:"relax",premium:!0,actionClass:"ss-doctor",actionTitle:"COMPLETED_GOING_TO_DOCTOR",isSkillActivity:!0,exercise:"Going to Doctor",audio:"ss-doctor.mp3",audioLength:357,meditation:!0,activity:"COMPLETED_GOING_TO_DOCTOR",size:8583262,relaxCategory:"STRESSFUL_SITUATIONS"},COMPLETED_FOCUS_FOR_STUDYING:{name:"COMPLETED_FOCUS_FOR_STUDYING",displayKey:"RELAX_ACTIVITY_FOCUS_FOR_STUDYING",id:63,type:"relax",premium:!0,actionClass:"ss-studying",actionTitle:"COMPLETED_FOCUS_FOR_STUDYING",isSkillActivity:!0,exercise:"Focus for Studying",audio:"ss-studying.mp3",audioLength:508,meditation:!0,activity:"COMPLETED_FOCUS_FOR_STUDYING",size:12196537,relaxCategory:"STRESSFUL_SITUATIONS"},COMPLETED_SS_MORNING_DREAD:{name:"COMPLETED_SS_MORNING_DREAD",displayKey:"RELAX_ACTIVITY_MORNING_DREAD",id:64,type:"relax",premium:!0,actionClass:"morning-dread",actionTitle:"COMPLETED_SS_MORNING_DREAD",isSkillActivity:!0,exercise:"Morning Dread",audio:"ss-morning.mp3",audioLength:501,meditation:!0,activity:"COMPLETED_SS_MORNING_DREAD",size:8398792,relaxCategory:"STRESSFUL_SITUATIONS"},COMPLETED_SS_PROCESSING_GRIEF:{name:"COMPLETED_SS_PROCESSING_GRIEF",displayKey:"RELAX_ACTIVITY_PROCESSING_GRIEF",id:65,type:"relax",premium:!0,actionClass:"processing-grief",actionTitle:"COMPLETED_SS_PROCESSING_GRIEF",isSkillActivity:!0,exercise:"Processing Grief",audio:"ss-grief.mp3",audioLength:626,meditation:!0,activity:"COMPLETED_SS_PROCESSING_GRIEF",size:10349006,relaxCategory:"STRESSFUL_SITUATIONS"},COMPLETED_CALM_BREATHE:{name:"COMPLETED_CALM_BREATHE",displayKey:"RELAX_ACTIVITY_CALM_BREATHE",id:20,type:"relax",premium:!1,actionClass:"calm-breathe",actionTitle:"COMPLETED_CALM_BREATHE",isSkillActivity:!0,exercise:"Calm: Breathe",audio:"calmbreathe.mp3",audioLength:410,oldAudioLength:287,meditation:!0,activity:"COMPLETED_CALM_BREATHE",size:7380822,relaxCategory:"CALM_DOWN"},COMPLETED_ANGER:{name:"COMPLETED_ANGER",displayKey:"RELAX_ACTIVITY_DEFUSING_ANGER",id:54,type:"relax",premium:!0,actionClass:"defusing-anger",actionTitle:"COMPLETED_ANGER",isSkillActivity:!0,exercise:"Defusing Anger",audio:"anger.mp3",audioLength:349,meditation:!0,activity:"COMPLETED_ANGER",size:5591938,relaxCategory:"CALM_DOWN"},COMPLETED_SLEEP:{name:"COMPLETED_SLEEP",displayKey:"RELAX_ACTIVITY_SLEEP",id:23,type:"relax",premium:!0,actionClass:"sleep",actionTitle:"COMPLETED_SLEEP",isSkillActivity:!0,exercise:"Sleep",audio:"sleep.mp3",audioLength:338,oldAudioLength:321,meditation:!0,activity:"COMPLETED_SLEEP",size:5770785,relaxCategory:"CALM_DOWN"},COMPLETED_BEDTIME:{name:"COMPLETED_BEDTIME",displayKey:"RELAX_ACTIVITY_FALLING_ASLEEP",id:53,type:"relax",premium:!0,actionClass:"bedtime",actionTitle:"COMPLETED_BEDTIME",isSkillActivity:!0,exercise:"Falling Asleep",audio:"bedtime.mp3",audioLength:474,meditation:!0,activity:"COMPLETED_BEDTIME",size:8221513,relaxCategory:"CALM_DOWN"},COMPLETED_DEFUSION:{name:"COMPLETED_DEFUSION",displayKey:"RELAX_ACTIVITY_DEFUSION",id:28,type:"relax",premium:!0,actionClass:"intense-emotions",actionTitle:"COMPLETED_DEFUSION",isSkillActivity:!0,exercise:"Defusion",audio:"intenseemotions.mp3",audioLength:290,oldAudioLength:261,meditation:!0,activity:"COMPLETED_DEFUSION",size:5180341,relaxCategory:"CALM_DOWN"},COMPLETED_PAIN:{name:"COMPLETED_PAIN",displayKey:"RELAX_ACTIVITY_COPING_WITH_PHYSICAL_PAIN",id:50,type:"relax",premium:!0,actionClass:"pain",actionTitle:"COMPLETED_PAIN",isSkillActivity:!0,exercise:"Coping with Physical Pain",audio:"pain.mp3",audioLength:743,meditation:!0,activity:"COMPLETED_PAIN",size:11892673,relaxCategory:"CALM_DOWN"},COMPLETED_BECOMING_THE_TREE:{name:"COMPLETED_BECOMING_THE_TREE",displayKey:"RELAX_ACTIVITY_BECOME_TREE",id:25,type:"relax",premium:!1,actionClass:"becoming-the-tree",actionTitle:"COMPLETED_BECOMING_THE_TREE",isSkillActivity:!0,exercise:"Become Tree",audio:"becomingthetree.mp3",audioLength:602,oldAudioLength:483,meditation:!0,activity:"COMPLETED_BECOMING_THE_TREE",size:10814686,relaxCategory:"INNER_STRENGTH"},COMPLETED_INNER_CRITIC:{name:"COMPLETED_INNER_CRITIC",displayKey:"RELAX_ACTIVITY_QUIETING_THE_INNER_CRITIC",id:61,type:"relax",premium:!1,actionClass:"inner-critic",actionTitle:"COMPLETED_INNER_CRITIC",isSkillActivity:!0,exercise:"Quieting the Inner Critic",audio:"innercritic.mp3",audioLength:484,meditation:!0,activity:"COMPLETED_INNER_CRITIC",size:11630469,relaxCategory:"INNER_STRENGTH"},COMPLETED_POSITIVITY:{name:"COMPLETED_POSITIVITY",displayKey:"RELAX_ACTIVITY_BUILDING_POSITIVITY",id:51,type:"relax",premium:!0,actionClass:"building-positivity",actionTitle:"COMPLETED_POSITIVITY",isSkillActivity:!0,exercise:"Building Positivity",audio:"positivity.mp3",audioLength:472,meditation:!0,activity:"COMPLETED_POSITIVITY",size:7552167,relaxCategory:"INNER_STRENGTH"},COMPLETED_EMPATHY:{name:"COMPLETED_EMPATHY",displayKey:"RELAX_ACTIVITY_EMPATHY",id:31,type:"relax",premium:!0,actionClass:"empathy",actionTitle:"COMPLETED_EMPATHY",isSkillActivity:!0,exercise:"Empathy",audio:"empathy.mp3",audioLength:422,oldAudioLength:358,meditation:!0,activity:"COMPLETED_EMPATHY",size:7219650,relaxCategory:"INNER_STRENGTH"},COMPLETED_SELF_COMPASSION:{name:"COMPLETED_SELF_COMPASSION",displayKey:"RELAX_ACTIVITY_SELF_COMPASSION",id:27,type:"relax",premium:!0,actionClass:"self-compassion",actionTitle:"COMPLETED_SELF_COMPASSION",isSkillActivity:!0,exercise:"Self Compassion",audio:"selfcompassion.mp3",audioLength:387,oldAudioLength:340,meditation:!0,activity:"COMPLETED_SELF_COMPASSION",size:6724898,relaxCategory:"INNER_STRENGTH"},COMPLETED_MOTIVATION:{name:"COMPLETED_MOTIVATION",displayKey:"RELAX_ACTIVITY_GETTING_MOTIVATED",id:52,type:"relax",premium:!0,actionClass:"getting-motivated",actionTitle:"COMPLETED_MOTIVATION",isSkillActivity:!0,exercise:"Getting Motivated",audio:"motivation.mp3",audioLength:443,meditation:!0,activity:"COMPLETED_MOTIVATION",size:7921662,relaxCategory:"INNER_STRENGTH"},COMPLETED_GRATITUDE:{name:"COMPLETED_GRATITUDE",displayKey:"RELAX_ACTIVITY_GRATITUDE",id:24,type:"relax",premium:!0,actionClass:"gratitude",actionTitle:"COMPLETED_GRATITUDE",isSkillActivity:!0,exercise:"Gratitude",audio:"gratitude.mp3",audioLength:331,oldAudioLength:306,meditation:!0,activity:"COMPLETED_GRATITUDE",size:5691064,relaxCategory:"INNER_STRENGTH"},COMPLETED_START_YOUR_DAY:{name:"COMPLETED_START_YOUR_DAY",displayKey:"RELAX_ACTIVITY_START_YOUR_DAY",id:57,type:"relax",premium:!0,actionClass:"start-your-day",actionTitle:"COMPLETED_START_YOUR_DAY",isSkillActivity:!0,exercise:"Start Your Day",audio:"morning.mp3",audioLength:324,meditation:!0,activity:"COMPLETED_START_YOUR_DAY",size:5754891,relaxCategory:"INNER_STRENGTH"},COMPLETED_IGNORING_JUDGEMENT:{name:"COMPLETED_IGNORING_JUDGEMENT",displayKey:"RELAX_ACTIVITY_IGNORING_JUDGEMENT",id:56,type:"relax",premium:!0,actionClass:"ignoring-judgement",actionTitle:"COMPLETED_IGNORING_JUDGEMENT",isSkillActivity:!0,exercise:"Ignoring Judgement",audio:"focus.mp3",audioLength:520,meditation:!0,activity:"COMPLETED_IGNORING_JUDGEMENT",size:9499948,relaxCategory:"INNER_STRENGTH"},COMPLETED_CULTIVATING_RESILIENCE:{name:"COMPLETED_CULTIVATING_RESILIENCE",displayKey:"RELAX_ACTIVITY_CULTIVATING_RESILIENCE",id:60,type:"relax",premium:!0,actionClass:"cultivating-resilience",actionTitle:"COMPLETED_CULTIVATING_RESILIENCE",isSkillActivity:!0,exercise:"Cultivating Resilience",audio:"resilience.mp3",audioLength:530,meditation:!0,activity:"COMPLETED_CULTIVATING_RESILIENCE",size:12737234,relaxCategory:"INNER_STRENGTH"},COMPLETED_FINDING_PEACE:{name:"COMPLETED_FINDING_PEACE",displayKey:"RELAX_ACTIVITY_FINDING_PEACE",id:66,type:"relax",premium:!0,actionClass:"inner-critic",actionTitle:"COMPLETED_FINDING_PEACE",isSkillActivity:!0,exercise:"Finding Peace",audio:"peace.mp3",audioLength:608,meditation:!0,activity:"COMPLETED_FINDING_PEACE",size:10399518,relaxCategory:"INNER_STRENGTH"},COMPLETED_RELEASING_STRESS:{name:"COMPLETED_RELEASING_STRESS",displayKey:"RELAX_ACTIVITY_RELEASING_STRESS",id:67,type:"relax",premium:!0,actionClass:"inner-critic",actionTitle:"COMPLETED_RELEASING_STRESS",isSkillActivity:!0,exercise:"Releasing Stress",audio:"releasingstress.mp3",audioLength:520,meditation:!0,activity:"COMPLETED_RELEASING_STRESS",size:8690551,relaxCategory:"INNER_STRENGTH"},COMPLETED_CALM_MIND:{name:"COMPLETED_CALM_MIND",displayKey:"RELAX_ACTIVITY_CALM_MIND",id:21,type:"relax",premium:!0,actionClass:"calm-mind",actionTitle:"COMPLETED_CALM_MIND",isSkillActivity:!0,exercise:"Calm: Mind",audio:"calmmind.mp3",audioLength:522,oldAudioLength:267,meditation:!0,activity:"COMPLETED_CALM_MIND",size:8355903,relaxCategory:"MINDFULNESS"},POSTED_TO_COMMUNITY:{name:"POSTED_TO_COMMUNITY",displayKey:"COMPLETE_A_POSITIVE_THOUGHT_ENTRY",id:30,type:"social",premium:!1,actionClass:"social",actionTitle:"POSTED_TO_COMMUNITY",isSkillActivity:!0},SHARED_REPORT_WITH_SELF:{name:"SHARED_REPORT",displayKey:"SHARED_REPORT",id:34,type:"account",premium:!1},SHARED_REPORT_WITH_OTHER:{name:"SHARED_REPORT",displayKey:"SHARED_REPORT",id:35,type:"account",premium:!1},ADD_PICTURE_TO_HOPE_FEED:{name:"ADD_PICTURE_TO_HOPE_FEED",displayKey:"ADD_PICTURE_TO_HOPE_BOARD",id:36,type:"account",premium:!1,actionClass:"picture",isSkillActivity:!0},ADD_THOUGHT_TO_HOPE_FEED:{name:"ADD_THOUGHT_TO_HOPE_FEED",displayKey:"ADD_THOUGHT",id:37,type:"account",premium:!1,actionClass:"thought",isSkillActivity:!0},ADD_GOAL_TO_HOPE_FEED:{name:"ADD_GOAL_TO_HOPE_FEED",displayKey:"ADD_GOAL",id:38,type:"account",premium:!1,actionClass:"goal",isSkillActivity:!0},ADD_POST_TO_HOPE_FEED:{name:"ADD_POST_TO_HOPE_FEED",displayKey:"ADD_POST",id:68,type:"account",premium:!1,actionClass:"picture",isSkillActivity:!0},CREATED_EXPERIMENT:{name:"CREATED_EXPERIMENT",displayKey:"CREATED_EXPERIMENT",id:39,type:"goals",premium:!1,actionClass:"goal"},COMPLETED_ABC_PLUS_THOUGHT_RECORD:{name:"COMPLETED_ABC_PLUS_THOUGHT_RECORD",id:45,type:"thoughts",premium:!1,actionClass:"basic",actionTitle:"COMPLETED_ABC_PLUS_THOUGHT_RECORD",activityDisplay:"THOUGHTS_ACTIVITY_BASIC",isSkillActivity:!0},SHARED_PACIFICA_WITH_PRACITTIONER:{name:"SHARED_PACIFICA_WITH_PRACITTIONER",displayKey:"SHARED_PACIFICA",id:49,type:"account",premium:!1}},thoughtActivities:{basic:{activityId:40,activityName:"COMPLETED_ABC_THOUGHT_RECORD",thoughtType:"BASIC",description:"THOUGHTS_ACTIVITY_BASIC_DESC",completionTitle:"THOUGHTS_ACTIVITY_BASIC_SUMMARY",completionText:"THOUGHTS_ACTIVITY_BASIC_COMPLETED",completionRoute:"app.thought-completed",recordingOrder:["event","thoughts","feelings"],premium:!1,name:"COMPLETED_ABC_THOUGHT_RECORD",displayKey:"COMPLETE_A_BASIC_THOUGHT_ENTRY",descriptionDisplayKey:"THOUGHTS_ACTIVITY_BASIC_DESC",id:40,type:"thoughts",actionClass:"basic",actionTitle:"COMPLETED_ABC_THOUGHT_RECORD",activityDisplay:"THOUGHTS_ACTIVITY_BASIC",isSkillActivity:!0,options:[{name:"THE_CYCLE",value:"cycle",show:!0},{name:"THE_CYCLE_AND_EVIDENCE",value:"evidence",show:!0}],steps:[{type:"event",name:"THE_EVENT",description:"THE_EVENT_DESCRIPTION",byline:"THE_EVENT_BYLINE",example:"THE_EVENT_EXAMPLE",route:"app.generictextthoughts"},{type:"thoughts",name:"YOUR_THOUGHTS",description:"YOUR_THOUGHTS_DESCRIPTION",byline:"YOUR_THOUGHTS_BYLINE",example:"YOUR_THOUGHTS_EXAMPLE",route:"app.generictextthoughts"},{type:"feelings",name:"YOUR_FEELINGS",description:"YOUR_FEELINGS_DESCRIPTION",byline:"YOUR_FEELINGS_BYLINE",example:"YOUR_FEELINGS_EXAMPLE",route:"app.generictextthoughts"},{type:"feelings",name:"THE_EVIDENCE",description:"THE_EVIDENCE_DESCRIPTION",byline:"THE_EVIDENCE_BYLINE",forExample:"THE_EVIDENCE_FOR_EXAMPLE",againstExample:"THE_EVIDENCE_AGAINST_EXAMPLE",route:"app.evidencetextthoughts"}]},traps:{activityId:41,activityName:"COMPLETED_TRAPS_THOUGHT_RECORD",thoughtType:"TRAPS",description:"THOUGHTS_ACTIVITY_TRAPS_DESC",completionTitle:"THOUGHTS_ACTIVITY_TRAPS_SUMMARY",completionText:"THOUGHTS_ACTIVITY_TRAPS_COMPLETED",completionRoute:"app.traps-completed",recordingOrder:["thought","pattern"],premium:!1,name:"COMPLETED_TRAPS_THOUGHT_RECORD",displayKey:"COMPLETE_A_TRAPS_THOUGHT_ENTRY",descriptionDisplayKey:"THOUGHTS_ACTIVITY_TRAPS_DESC",id:41,type:"thoughts",actionClass:"traps",actionTitle:"COMPLETED_TRAPS_THOUGHT_RECORD",activityDisplay:"THOUGHTS_ACTIVITY_TRAPS",isSkillActivity:!0,steps:[{type:"thought",name:"THE_THOUGHT",description:"THE_THOUGHT_DESCRIPTION",byline:"THE_THOUGHT_BYLINE",example:"THE_THOUGHT_EXAMPLE",route:"app.generictextthoughts"},{type:"thought",name:"THE_THINKING_TRAP",description:"THE_THINKING_TRAP_DESCRIPTION",byline:"THE_THINKING_TRAP_BYLINE",example:"THE_THINKING_TRAP_EXAMPLE",route:"app.distortedtextthoughts",hints:{keys:["DISTORTED_TEXT_THOUGHT_HINT_ONE","DISTORTED_TEXT_THOUGHT_HINT_TWO","DISTORTED_TEXT_THOUGHT_HINT_THREE"]}},{type:"pattern",name:"THE_PATTERN",description:"THE_PATTERN_DESCRIPTION",byline:"THE_PATTERN_BYLINE",example:"THE_PATTERN_EXAMPLE",route:"app.distortedtextpatterns",recordingToAnalyze:"thought"}]},reframe:{activityId:4,activityName:"COMPLETED_RETHINK",thoughtType:"REFRAME",description:"THOUGHTS_ACTIVITY_REFRAME_DESC",completionTitle:"THOUGHTS_ACTIVITY_REFRAME_SUMMARY",completionText:"THOUGHTS_ACTIVITY_REFRAME_COMPLETED",completionRoute:"app.reframe-completed",recordingOrder:["thought","analysis"],premium:!1,name:"COMPLETED_RETHINK",displayKey:"COMPLETE_A_REFRAME_THOUGHT_ENTRY",descriptionDisplayKey:"THOUGHTS_ACTIVITY_REFRAME_DESC",id:4,type:"thoughts",actionClass:"reframe",actionTitle:"COMPLETED_REFRAME_THOUGHT_RECORD",activityDisplay:"THOUGHTS_ACTIVITY_REFRAME",isSkillActivity:!0,options:[{name:"INPUT_OPTION_TEXT",value:"text",show:!0},{name:"INPUT_OPTION_VOICE",value:"voice",show:!ionic.Platform.isAndroid()||5<+ionic.Platform.version()}],steps:[{type:"thought",name:"YOUR_THOUGHTS",description:"YOUR_THOUGHTS_DESCRIPTION",byline:"YOUR_THOUGHTS_BYLINE",example:"YOUR_THOUGHTS_EXAMPLE",route:"app.generictextthoughts"},{type:"thought",name:"THE_THINKING_TRAP",description:"THE_THINKING_TRAP_DESCRIPTION",byline:"THE_THINKING_TRAP_BYLINE",example:"THE_THINKING_TRAP_EXAMPLE",route:"app.distortedtextthoughts"},{type:"analysis",name:"REFRAME_THE_THOUGHT",description:"REFRAME_THE_THOUGHT_DESCRIPTION",byline:"REFRAME_THE_THOUGHT_BYLINE",example:"REFRAME_THE_THOUGHT_EXAMPLE",route:"app.textthoughts-rethink",hints:{keys:["REFRAME_THOUGHT_HINT_ONE","REFRAME_THOUGHT_HINT_TWO","REFRAME_THOUGHT_HINT_THREE"]}}]},positivity:{activityId:33,activityName:"COMPLETED_POSITIVITY_JOURNAL",thoughtType:"POSITIVITY",description:"THOUGHTS_POSITIVITY_DESCRIPTION",completionTitle:"THOUGHTS_ACTIVITY_POSITIVITY_SUMMARY",completionText:"THOUGHTS_ACTIVITY_POSITIVITY_COMPLETED",completionRoute:"app.thought-completed",recordingOrder:["journal"],premium:!0,name:"COMPLETED_POSITIVITY_JOURNAL",displayKey:"COMPLETE_A_POSITIVE_THOUGHT_ENTRY",descriptionDisplayKey:"THOUGHTS_POSITIVITY_DESCRIPTION",id:33,type:"thoughts",actionClass:"positivity",actionTitle:"COMPLETED_POSITIVITY_JOURNAL",activityDisplay:"THOUGHTS_ACTIVITY_POSITIVITY",isSkillActivity:!0,options:[{name:"INPUT_OPTION_TEXT",value:"text",show:!0},{name:"INPUT_OPTION_VOICE",value:"voice",show:!ionic.Platform.isAndroid()||5<+ionic.Platform.version()}],steps:[{type:"journal",name:"THOUGHTS_ACTIVITY_POSITIVITY",description:"THOUGHTS_POSITIVITY_DESCRIPTION",byline:"THOUGHTS_POSITIVITY_DESCRIPTION",example:"POSITIVITY_TEXT_PLACEHOLDER",route:"app.generictextthoughts"}]},gratitude:{activityId:32,activityName:"COMPLETED_GRATITUDE_JOURNAL",thoughtType:"GRATITUDE",description:"THOUGHTS_GRATITUDE_DESCRIPTION",completionTitle:"THOUGHTS_ACTIVITY_GRATITUDE_SUMMARY",completionText:"THOUGHTS_ACTIVITY_GRATITUDE_COMPLETED",completionRoute:"app.thought-completed",recordingOrder:["journal"],premium:!0,name:"COMPLETED_GRATITUDE_JOURNAL",displayKey:"COMPLETE_A_GRATITUDE_THOUGHT_ENTRY",descriptionDisplayKey:"THOUGHTS_GRATITUDE_DESCRIPTION",id:32,type:"thoughts",actionClass:"gratitude-journal",actionTitle:"COMPLETED_GRATITUDE_JOURNAL",activityDisplay:"THOUGHTS_ACTIVITY_GRATITUDE",isSkillActivity:!0,options:[{name:"INPUT_OPTION_TEXT",value:"text",show:!0},{name:"INPUT_OPTION_VOICE",value:"voice",show:!ionic.Platform.isAndroid()||5<+ionic.Platform.version()}],steps:[{type:"journal",name:"JOURNAL_GRATITUDE_HEADER",description:"THOUGHTS_GRATITUDE_DESCRIPTION",byline:"THOUGHTS_GRATITUDE_DESCRIPTION",example:"GRATITUDE_TEXT_PLACEHOLDER",route:"app.generictextthoughts"}]},journal:{activityId:9,activityName:"COMPLETED_JOURNAL",thoughtType:"JOURNAL",description:"THOUGHTS_JOURNAL_HEADER",completionTitle:"THOUGHTS_ACTIVITY_JOURNAL_SUMMARY",completionText:"THOUGHTS_ACTIVITY_JOURNAL_COMPLETED",completionRoute:"app.thought-completed",recordingOrder:["journal"],premium:!1,name:"COMPLETED_JOURNAL",displayKey:"COMPLETE_A_JOURNAL_ENTRY",descriptionDisplayKey:"THOUGHTS_JOURNAL_HEADER",id:9,type:"thoughts",actionClass:"journal",actionTitle:"COMPLETED_JOURNAL",activityDisplay:"THOUGHTS_ACTIVITY_JOURNAL",isSkillActivity:!0,options:[{name:"INPUT_OPTION_TEXT",value:"text",show:!0},{name:"INPUT_OPTION_VOICE",value:"voice",show:!ionic.Platform.isAndroid()||5<+ionic.Platform.version()}],steps:[{type:"journal",name:"THOUGHTS_ACTIVITY_JOURNAL",description:"THOUGHTS_JOURNAL_HEADER",byline:"THOUGHTS_JOURNAL_HEADER",example:"GRATITUDE_TEXT_PLACEHOLDER",route:"app.generictextthoughts"}]},blame:{activityId:42,activityName:"COMPLETED_BLAME_THOUGHT_RECORD",thoughtType:"BLAME",description:"THOUGHTS_ACTIVITY_BLAME_DESC",completionTitle:"THOUGHTS_ACTIVITY_BLAME_SUMMARY",completionText:"THOUGHTS_ACTIVITY_BLAME_COMPLETED",completionRoute:"app.contributingfactorscomplete",recordingOrder:["event"],premium:!0,name:"COMPLETED_BLAME_THOUGHT_RECORD",displayKey:"COMPLETED_A_BLAME_THOUGHT_ENTRY",descriptionDisplayKey:"THOUGHTS_ACTIVITY_BLAME_DESC",id:42,type:"thoughts",actionClass:"blame",actionTitle:"COMPLETED_BLAME_THOUGHT_RECORD",activityDisplay:"THOUGHTS_ACTIVITY_BLAME",isSkillActivity:!0,steps:[{type:"event",name:"EVENT_AND_OUTCOME",description:"EVENT_AND_OUTCOME_DESCRIPTION",byline:"EVENT_AND_OUTCOME_BYLINE",example:"EVENT_AND_OUTCOME_PLACEHOLDER",route:"app.generictextthoughts"},{type:"event",name:"CONTRIBUTING_FACTORS",description:"CONTRIBUTING_FACTORS_DESCRIPTION",byline:"CONTRIBUTING_FACTORS_BYLINE",example:"CONTRIBUTING_FACTORS_PLACEHOLDER",route:"app.contributingfactorstextthoughts",hints:{keys:["BLAME_TEXT_THOUGHT_HINT_ONE","BLAME_TEXT_THOUGHT_HINT_TWO","BLAME_TEXT_THOUGHT_HINT_THREE"]}}]},evidence:{activityId:43,activityName:"COMPLETED_EVIDENCE_THOUGHT_RECORD",thoughtType:"EVIDENCE",description:"THE_THOUGHT_EVIDENCE_DESCRIPTION",completionTitle:"THOUGHTS_ACTIVITY_EVIDENCE_SUMMARY",completionText:"THOUGHTS_ACTIVITY_EVIDENCE_COMPLETED",completionRoute:"app.evidence-completed",recordingOrder:["thought"],premium:!0,name:"COMPLETED_EVIDENCE_THOUGHT_RECORD",displayKey:"COMPLETE_AN_EVIDENCE_THOUGHT_ENTRY",descriptionDisplayKey:"THOUGHTS_ACTIVITY_EVIDENCE_DESC",id:43,type:"thoughts",actionClass:"evidence",actionTitle:"COMPLETED_EVIDENCE_THOUGHT_RECORD",activityDisplay:"THOUGHTS_ACTIVITY_EVIDENCE",isSkillActivity:!0,steps:[{type:"thought",name:"THE_THOUGHT",description:"THE_THOUGHT_DESCRIPTION",byline:"THE_THOUGHT_EVIDENCE_DESCRIPTION",example:"THE_THOUGHT_EVIDENCE_EXAMPLE",route:"app.generictextthoughts"},{type:"thought",name:"THE_EVIDENCE",description:"THE_EVIDENCE_EVIDENCE_DESCRIPTION",route:"app.evidencequestions"}]},beliefs:{activityId:44,activityName:"COMPLETED_BELIEFS_THOUGHT_RECORD",thoughtType:"BELIEFS",description:"THOUGHTS_ACTIVITY_BELIEFS_DESC",completionTitle:"THOUGHTS_ACTIVITY_BELIEFS_SUMMARY",completionText:"TTHOUGHTS_ACTIVITY_BELIEFS_COMPLETED",completionRoute:"app.beliefs-completed",recordingOrder:["thought","evidence"],premium:!0,name:"COMPLETED_BELIEFS_THOUGHT_RECORD",displayKey:"COMPLETED_A_BELIEFS_THOUGHT_ENTRY",descriptionDisplayKey:"THOUGHTS_ACTIVITY_BELIEFS_DESC",id:44,type:"thoughts",actionClass:"beliefs",actionTitle:"COMPLETED_BELIEFS_THOUGHT_RECORD",activityDisplay:"THOUGHTS_ACTIVITY_BELIEFS",isSkillActivity:!0,steps:[{type:"thought",name:"YOUR_THOUGHTS",description:"THE_THOUGHT_BELIEF_DESCRIPTION",byline:"THE_THOUGHT_BELIEF_BYLINE",example:"THE_THOUGHT_BELIEF_EXAMPLE",route:"app.generictextthoughts"},{type:"thought",name:"DRILL_DOWN",description:"CORE_BELIEF_DESCRIPTION",byline:"CORE_BELIEF_BYLINE",route:"app.corebeliefstextthoughts",hints:{keys:["CORE_BELIEFS_TEXT_THOUGHT_HINT_ONE","CORE_BELIEFS_TEXT_THOUGHT_HINT_TWO","CORE_BELIEFS_TEXT_THOUGHT_HINT_THREE"]}},{type:"evidence",name:"EVIDENCE_FOR_BELIEF",description:"EVIDENCE_FOR_BELIEF_DESCRIPTION",byline:"EVIDENCE_FOR_BELIEF_BYLINE",forExample:"THE_EVIDENCE_FOR_EXAMPLE",againstExample:"THE_EVIDENCE_AGAINST_EXAMPLE",route:"app.corebeliefevidence"}]}}};function d(e){r.setUserPreference("engagement_streak_count",e+""),1===e&&r.setUserPreference("last_completed_engagement_date",a.getTodayString())}return u.initFromLocalStorage=function(){e.getItem("offlineActivities",function(e){if(e){var t=JSON.parse(e);u.offlineActivities=t}}),e.getItem("activityContext",function(e){if(e){var t=JSON.parse(e);u.activityContext=t}})},u.updateLocalCompletedActivities=function(){var e=r.userPreferences.completed_activities;if(e&&0<e.length)for(var t=e.split(","),i=0;i<t.length;++i){var n=+t[i];0<n&&u.completedActivities.push(n)}},u.getRatedActivities=function(){return c.get(s.serverURL+"/activity/feedback")},u.getRateableActivity=function(a,r){var t,s=i.defer();return(t=i.defer(),u.ratedActivities?n(function(){t.resolve(u.ratedActivities)}):u.getRatedActivities().success(function(e){u.setRatedActivities(e),t.resolve(e)}),t.promise).then(function(e){var t=e,i=r.getTodaysActions(),n=_.filter(i,function(e){var t=moment().diff(moment(e.actionTimestamp),"hours")<=2,i=!_.includes(["social","mood"],e.actionClass);return t&&i}),o=_.find(n,function(e){return function(e,t){if("health"===e.actionClass)return 0===t.habitIds.length||!_.includes(t.habitIds,e.data.habitId);if(0===t.activityIds.length)return!0;if("goals"===e.actionClass)return!_.includes(t.activityIds,5);var i=a.getActivityByName(e.actionClass);return i?!_.includes(t.activityIds,i.activityId):!_.includes(t.activityIds,e.data.activityId)}(e,t)});s.resolve(o)}),s.promise},u.addUserTool=function(e,t){var i,n=[],o=r.getUserPreference("tools");if(o&&(n=o.split(",")),t)i="habits";else if(u.isHopePost(e))i="hope";else{var a=u.getActivityById(e);a&&a.type&&(i=a.type)}void 0!==i&-1==n.indexOf(i)&&(n.push(i),r.setUserPreference("tools",n.toString()))},u.recordActivity=function(e){var t=u.activityContext[e];t||(t=[],u.activityContext[e]=t);var i=u.getIdForActivity(e);if(t.push({recordedAt:new Date,recordedAtString:(new Date).toString(),activityId:i}),u.setActivityStreak(),r.canUseSiriNotifications()){var n=u.getActivityById(i);if(n)switch(n.type){case"relax":window.cordova.plugins.SiriShortcuts.donate({persistentIdentifier:"pacifica-meditate",title:o.instant("SIRI_MEDITATE_SHORTCUT_TITLE"),suggestedInvocationPhrase:o.instant("SIRI_MEDITATE_SHORTCUT_PHRASE"),isEligibleForSearch:!0,isEligibleForPrediction:!0}),console.log("donated meditation to Siri");break;case"thoughts":window.cordova.plugins.SiriShortcuts.donate({persistentIdentifier:"pacifica-thought",title:o.instant("SIRI_THOUGHT_SHORTCUT_TITLE"),suggestedInvocationPhrase:o.instant("SIRI_THOUGHT_SHORTCUT_PHRASE"),isEligibleForSearch:!0,isEligibleForPrediction:!0}),console.log("donated thought to Siri");break;case"goals":window.cordova.plugins.SiriShortcuts.donate({persistentIdentifier:"pacifica-goal",title:o.instant("SIRI_GOAL_SHORTCUT_TITLE"),suggestedInvocationPhrase:o.instant("SIRI_GOAL_SHORTCUT_PHRASE"),isEligibleForSearch:!0,isEligibleForPrediction:!0}),console.log("donated goal to Siri");break;case"account":if("ADD_PICTURE_TO_HOPE_FEED"===n.name){window.cordova.plugins.SiriShortcuts.donate({persistentIdentifier:"pacifica-hope",title:o.instant("SIRI_HOPE_SHORTCUT_TITLE"),suggestedInvocationPhrase:o.instant("SIRI_HOPE_SHORTCUT_PHRASE"),isEligibleForSearch:!0,isEligibleForPrediction:!0}),console.log("donated hope to Siri");break}}}u.updateLocalActivityContext(),u.addUserTool(i),s.isOnline()?c.post(s.serverURL+"/account/activity",e).success(function(){u.fireActivityCompletion(i)}):(u.offlineActivities.push({activity:e,timestamp:new Date}),u.updateLocalActivities()),i&&u.updateCompletedActivities(i),l.$broadcast("request:checkPathProgressActivity",e)},u.getActivityById=function(e){return u.activitiesById[e]},u.getCategoryForActivity=function(e){var t=u.activities[e];if(t)return t.type},u.getIdForActivity=function(e){var t=u.activities[e];if(t)return t.id},u.getDisplayForActivity=function(e){var t=u.activities[e];if(t){var i=t.displayKey;if(i)return o.instant(i)}},u.isActivityPremium=function(e){var t=u.activities[e];return!!t&&t.premium},u.updateLocalActivityContext=function(){e.setItem("activityContext",JSON.stringify(u.activityContext))},u.logout=function(){u.activityContext={},u.offlineActivities=[],u.completedActivities=[],u.updateLocalActivityContext(),u.updateLocalActivities()},u.hasCompletedActivity=function(e){for(var t=0;t<u.completedActivities.length;++t)if(u.completedActivities[t]==e)return!0;return!1},u.updateCompletedActivities=function(e){if(!u.hasCompletedActivity(e)){u.completedActivities.push(e);var t=u.completedActivities.join(",");r.setUserPreference("completed_activities",t)}},u.checkForBrokenStreak=function(){var e=r.getUserPreference("last_completed_engagement_date");e=moment(e).startOf("day");var t=1<moment().startOf("day").diff(e,"day"),i=parseInt(r.getUserPreference("engagement_streak_count"));t&&0!==i&&d(0)},u.setActivityStreak=function(){var e=r.getUserPreference("last_completed_engagement_date");if(!e)d(1);else{e=moment(e).startOf("day");var t=moment().startOf("day").diff(e,"day"),i=1==t,n=1<t;if(r.setUserPreference("last_completed_engagement_date",a.getTodayString()),n)d(1);else if(i){var o=r.getUserPreference("engagement_streak_count");r.setUserPreference("engagement_streak_count",parseInt(o)+1)}}},u.fireActivityCompletion=function(e,t){u.addUserTool(e,t),l.$broadcast("event:activityCompleted")},u.setActivityContext=function(e){u.activityContext=e.dailyActivities,u.updateLocalActivityContext()},u.getActivities=function(e){return u.activityContext[e]},u.getActivityContextV2=function(e,t){var i,n,o,a=(n=t,o="",(i=e)&&(o+="?startTime="+i.getTime()),n&&(0<o.length?o+="&":o+="?",o+="endTime="+n.getTime()),o);return c.get(s.serverURL+"/activity/contextV2"+a)},u.getActivityHistory=function(e,t){var i="";return e&&(i+="?startTime="+e.getTime()),t&&(0<i.length?i+="&":i+="?",i+="endTime="+t.getTime()),c.get(s.serverURL+"/activity/history"+i)},u.saveActivityFeedBack=function(e){return c.post(s.serverURL+"/activity/feedback",e)},u.refreshLocalActivities=function(){u.completedActivities=[],u.updateLocalCompletedActivities()},u.setRatedActivities=function(e){u.ratedActivities=e},u.updateLocalActivities=function(){e.setItem("offlineActivities",JSON.stringify(u.offlineActivities))},u.isHopePost=function(e){return _.includes([36,37,38,68],e)},u.getSuggestionsByMood=function(e,t,i){return"awful"==e?{relax:[{id:"COMPLETED_MOTIVATION",sort:t[i++],factoids:["RELAX_FACT_1","RELAX_FACT_2"]},{id:"COMPLETED_MINDFUL_BREATHE",sort:t[i++],factoids:["RELAX_FACT_3","RELAX_FACT_4"]},{id:"COMPLETED_ANGER",sort:t[i++],factoids:["RELAX_FACT_5","RELAX_FACT_6"]},{id:"COMPLETED_PANIC_EMERGENCY",sort:t[i++],factoids:["RELAX_FACT_7","RELAX_FACT_8"]},{id:"COMPLETED_CALM_BREATHE",sort:t[i++],factoids:["RELAX_FACT_5","RELAX_FACT_6"]},{id:"COMPLETED_MINDFUL_SENSES",sort:t[i++],factoids:["RELAX_FACT_3","RELAX_FACT_4"]}],habits:[{display:"SUGGESTED_ACTIVITY_GO_FOR_A_WALK",sort:t[i++],id:3,factoids:["HABITS_FACT_1","HABITS_FACT_2"]},{display:"SUGGESTED_ACTIVITY_FRIENDS",sort:t[i++],id:10,factoids:["HABITS_FACT_3","HABITS_FACT_4"]},{display:"SUGGESTED_ACTIVITY_FAMILY",sort:t[i++],id:9,factoids:["HABITS_FACT_5","HABITS_FACT_6"]},{display:"SUGGESTED_ACTIVITY_MUSIC",sort:t[i++],id:13,factoids:["HABITS_FACT_7","HABITS_FACT_8"]}],thoughts:[{id:"COMPLETED_RETHINK",sort:t[i++],factoids:["THOUGHTS_FACT_1","THOUGHTS_FACT_2"]},{id:"COMPLETED_EVIDENCE_THOUGHT_RECORD",sort:t[i++],factoids:["THOUGHTS_FACT_3","THOUGHTS_FACT_4"]}],goals:[{display:"SUGGESTED_ACTIVITY_NON_SOCIAL_GOALS",sort:t[i++],factoids:["GOALS_FACT_1","GOALS_FACT_2"]},{display:"SUGGESTED_ACTIVITY_ANY_GOALS",sort:t[i++],factoids:["GOALS_FACT_3","GOALS_FACT_4"]},{display:"SET_A_DAILY_CHALLENGE",sort:t[i++],factoids:["GOALS_FACT_5","GOALS_FACT_6"]}],hope:[{id:"ADD_PICTURE_TO_HOPE_FEED",sort:t[i++],factoids:["HOPE_FACT_11","HOPE_FACT_12","HOPE_FACT_13","HOPE_FACT_14","HOPE_FACT_15","HOPE_FACT_16"]}]}:"bad"==e?{relax:[{id:"COMPLETED_MINDFUL_THOUGHTS",sort:t[i++],factoids:["RELAX_FACT_3","RELAX_FACT_4"]},{id:"COMPLETED_DEFUSION",sort:t[i++],factoids:["RELAX_FACT_5","RELAX_FACT_6"]},{id:"COMPLETED_BECOMING_THE_TREE",sort:t[i++],factoids:["RELAX_FACT_9","RELAX_FACT_10"]},{id:"COMPLETED_MINDFUL_BREATHE",sort:t[i++],factoids:["RELAX_FACT_3","RELAX_FACT_4"]},{id:"COMPLETED_SELF_COMPASSION",sort:t[i++],factoids:["RELAX_FACT_11","RELAX_FACT_12"]},{id:"COMPLETED_MUSCLE_RELAXATION",sort:t[i++],factoids:["RELAX_FACT_13","RELAX_FACT_14"]}],habits:[{display:"SUGGESTED_ACTIVITY_OUTDOORS",sort:t[i++],id:8,factoids:["HABITS_FACT_9","HABITS_FACT_10"]},{display:"SUGGESTED_ACTIVITY_GET_SOME_EXERCISE",sort:t[i++],id:3,factoids:["HABITS_FACT_11","HABITS_FACT_12"]},{display:"SUGGESTED_ACTIVITY_HOBBY",sort:t[i++],id:13,factoids:["HABITS_FACT_13","HABITS_FACT_14"]}],thoughts:[{id:"COMPLETED_RETHINK",sort:t[i++],factoids:["THOUGHTS_FACT_1","THOUGHTS_FACT_2"]},{id:"COMPLETED_BLAME_THOUGHT_RECORD",sort:t[i++],factoids:["THOUGHTS_FACT_5","THOUGHTS_FACT_6"]}],goals:[{display:"SUGGESTED_ACTIVITY_SOCIAL_GOALS",sort:t[i++],factoids:["GOALS_FACT_7","GOALS_FACT_8"]},{display:"SET_A_DAILY_CHALLENGE",sort:t[i++],factoids:["GOALS_FACT_5","GOALS_FACT_6"]},{display:"SUGGESTED_ACTIVITY_ANY_GOALS",sort:t[i++],factoids:["GOALS_FACT_3","GOALS_FACT_4"]}],hope:[{id:"ADD_PICTURE_TO_HOPE_FEED",sort:t[i++],factoids:["HOPE_FACT_11","HOPE_FACT_12","HOPE_FACT_13","HOPE_FACT_14","HOPE_FACT_15","HOPE_FACT_16"]}]}:"notgood"==e?{relax:[{id:"COMPLETED_CALM_BREATHE",sort:t[i++],factoids:["RELAX_FACT_5","RELAX_FACT_6"]},{id:"COMPLETED_DIFFICULT_EXPERIENCE",sort:t[i++],factoids:["RELAX_FACT_7","RELAX_FACT_8"]},{id:"COMPLETED_SELF_COMPASSION",sort:t[i++],factoids:["RELAX_FACT_11","RELAX_FACT_12"]},{id:"COMPLETED_CULTIVATING_RESILIENCE",sort:t[i++],factoids:["RELAX_FACT_15","RELAX_FACT_16"]},{id:"COMPLETED_GRATITUDE",sort:t[i++],factoids:["RELAX_FACT_17","RELAX_FACT_18"]},{id:"COMPLETED_BREATHING",sort:t[i++],factoids:["RELAX_FACT_19","RELAX_FACT_20"]},{id:"COMPLETED_MINDFUL_THOUGHTS",sort:t[i++],factoids:["RELAX_FACT_3","RELAX_FACT_4"]}],habits:[{display:"SUGGESTED_ACTIVITY_SLEEP",sort:t[i++],id:2,factoids:["HABITS_FACT_15","HABITS_FACT_16"]},{display:"SUGGESTED_ACTIVITY_HOBBY",sort:t[i++],id:13,factoids:["HABITS_FACT_13","HABITS_FACT_14"]},{display:"SUGGESTED_ACTIVITY_EAT",sort:t[i++],id:4,factoids:["HABITS_FACT_17","HABITS_FACT_18"]}],thoughts:[{id:"COMPLETED_ABC_THOUGHT_RECORD",sort:t[i++],factoids:["THOUGHTS_FACT_7","THOUGHTS_FACT_8"]}],goals:[{display:"SUGGESTED_ACTIVITY_SOCIAL_GOALS",sort:t[i++],factoids:["GOALS_FACT_7","GOALS_FACT_8"]},{display:"SET_A_DAILY_CHALLENGE",sort:t[i++],factoids:["GOALS_FACT_5","GOALS_FACT_6"]},{display:"SUGGESTED_ACTIVITY_ANY_GOALS",sort:t[i++],factoids:["GOALS_FACT_3","GOALS_FACT_4"]}],hope:[{id:"ADD_PICTURE_TO_HOPE_FEED",sort:t[i++],factoids:["HOPE_FACT_11","HOPE_FACT_12","HOPE_FACT_13","HOPE_FACT_14","HOPE_FACT_15","HOPE_FACT_16"]}]}:"okay"==e?{relax:[{id:"COMPLETED_MINDFUL_PRESENCE",sort:t[i++],factoids:["RELAX_FACT_3","RELAX_FACT_4"]},{id:"COMPLETED_CALM_MIND",sort:t[i++],factoids:["RELAX_FACT_3","RELAX_FACT_4"]},{id:"COMPLETED_EMPATHY",sort:t[i++],factoids:["RELAX_FACT_21","RELAX_FACT_22"]},{id:"COMPLETED_CALM_BREATHE",sort:t[i++],factoids:["RELAX_FACT_23","RELAX_FACT_24"]},{id:"COMPLETED_POSITIVE_VISUALIZATION",sort:t[i++],factoids:["RELAX_FACT_25","RELAX_FACT_26"]},{id:"COMPLETED_UNGUIDED_MEDITATION",sort:t[i++],factoids:["RELAX_FACT_27","RELAX_FACT_28"]},{id:"COMPLETED_BECOMING_THE_TREE",sort:t[i++],factoids:["RELAX_FACT_21","RELAX_FACT_22"]},{id:"COMPLETED_BREATHING",sort:t[i++],factoids:["RELAX_FACT_29","RELAX_FACT_21"]},{id:"COMPLETED_MINDFUL_EMOTIONS",sort:t[i++],factoids:["RELAX_FACT_3","RELAX_FACT_4"]}],habits:[{display:"SUGGESTED_ACTIVITY_HOBBY",sort:t[i++],id:13,factoids:["HABITS_FACT_19","HABITS_FACT_20"]},{display:"SUGGESTED_ACTIVITY_GET_SOME_EXERCISE",sort:t[i++],id:3,factoids:["HABITS_FACT_21","HABITS_FACT_22"]},{display:"SUGGESTED_ACTIVITY_SLEEP",sort:t[i++],id:2,factoids:["HABITS_FACT_23","HABITS_FACT_24"]},{display:"SUGGESTED_ACTIVITY_OUTDOORS",sort:t[i++],id:8,factoids:["HABITS_FACT_25","HABITS_FACT_26"]}],thoughts:[{id:"COMPLETED_TRAPS_THOUGHT_RECORD",sort:t[i++],factoids:["THOUGHTS_FACT_9","THOUGHTS_FACT_10"]},{id:"COMPLETED_RETHINK",sort:t[i++],factoids:["THOUGHTS_FACT_11","THOUGHTS_FACT_12"]},{id:"COMPLETED_POSITIVITY_JOURNAL",sort:t[i++],factoids:["THOUGHTS_FACT_13","THOUGHTS_FACT_14"]},{id:"COMPLETED_JOURNAL",sort:t[i++],factoids:["THOUGHTS_FACT_15","THOUGHTS_FACT_16"]}],goals:[{display:"SUGGESTED_ACTIVITY_SOCIAL_GOALS",sort:t[i++],factoids:["GOALS_FACT_13","GOALS_FACT_14"]},{display:"SUGGESTED_ACTIVITY_ANY_GOALS",sort:t[i++],factoids:["GOALS_FACT_15","GOALS_FACT_16"]},{display:"SET_A_DAILY_CHALLENGE",sort:t[i++],factoids:["GOALS_FACT_9","GOALS_FACT_10"]},{display:"SUGGESTED_ACTIVITY_NON_SOCIAL_GOALS",sort:t[i++],factoids:["GOALS_FACT_11","GOALS_FACT_12"]}],hope:[{id:"ADD_PICTURE_TO_HOPE_FEED",sort:t[i++],factoids:["HOPE_FACT_6","HOPE_FACT_7","HOPE_FACT_8","HOPE_FACT_9","HOPE_FACT_10"]}]}:"good"==e?{relax:[{id:"COMPLETED_POSITIVE_VISUALIZATION",sort:t[i++],factoids:["RELAX_FACT_31","RELAX_FACT_32"]},{id:"COMPLETED_MINDFUL_SENSES",sort:t[i++],factoids:["RELAX_FACT_3","RELAX_FACT_4"]},{id:"COMPLETED_MINDFUL_BODY_SCAN",sort:t[i++],factoids:["RELAX_FACT_3","RELAX_FACT_4"]},{id:"COMPLETED_MUSCLE_RELAXATION",sort:t[i++],factoids:["RELAX_FACT_33","RELAX_FACT_34"]},{id:"COMPLETED_BREATHING",sort:t[i++],factoids:["RELAX_FACT_35","RELAX_FACT_36"]},{id:"COMPLETED_MOTIVATION",sort:t[i++],factoids:["RELAX_FACT_37","RELAX_FACT_38"]},{id:"COMPLETED_EMPATHY",sort:t[i++],factoids:["RELAX_FACT_37","RELAX_FACT_38"]}],habits:[{display:"SUGGESTED_ACTIVITY_GO_FOR_A_WALK",sort:t[i++],id:3,factoids:["HABITS_FACT_27","HABITS_FACT_28"]},{display:"SUGGESTED_ACTIVITY_GET_SOME_EXERCISE",sort:t[i++],id:3,factoids:["HABITS_FACT_29","HABITS_FACT_30"]},{display:"SUGGESTED_ACTIVITY_HOBBY",sort:t[i++],id:13,factoids:["HABITS_FACT_31","HABITS_FACT_32"]}],thoughts:[{id:"COMPLETED_JOURNAL",sort:t[i++],factoids:["THOUGHTS_FACT_17","THOUGHTS_FACT_18"]},{id:"COMPLETED_ABC_THOUGHT_RECORD",sort:t[i++],factoids:["THOUGHTS_FACT_19","THOUGHTS_FACT_20"]},{id:"COMPLETED_GRATITUDE_JOURNAL",sort:t[i++],factoids:["THOUGHTS_FACT_21","THOUGHTS_FACT_22"]}],goals:[{display:"SUGGESTED_ACTIVITY_NON_SOCIAL_GOALS",sort:t[i++],factoids:["GOALS_FACT_17","GOALS_FACT_18"]},{display:"SET_A_DAILY_CHALLENGE",sort:t[i++],factoids:["GOALS_FACT_19","GOALS_FACT_20"]},{display:"SUGGESTED_ACTIVITY_ANY_GOALS",sort:t[i++],factoids:["GOALS_FACT_21","GOALS_FACT_22"]}],hope:[{id:"ADD_PICTURE_TO_HOPE_FEED",sort:t[i++],factoids:["HOPE_FACT_1","HOPE_FACT_2","HOPE_FACT_3","HOPE_FACT_4","HOPE_FACT_5"]}]}:"verygood"==e?{relax:[{id:"COMPLETED_GRATITUDE",sort:t[i++],factoids:["RELAX_FACT_37","RELAX_FACT_38"]},{id:"COMPLETED_MINDFUL_PRESENCE",sort:t[i++],factoids:["RELAX_FACT_3","RELAX_FACT_4"]},{id:"COMPLETED_POSITIVITY",sort:t[i++],factoids:["RELAX_FACT_37","RELAX_FACT_38"]},{id:"COMPLETED_UNGUIDED_MEDITATION",sort:t[i++],factoids:["RELAX_FACT_39","RELAX_FACT_40"]},{id:"COMPLETED_EMPATHY",sort:t[i++],factoids:["RELAX_FACT_37","RELAX_FACT_38"]},{id:"COMPLETED_BECOMING_THE_TREE",sort:t[i++],factoids:["RELAX_FACT_37","RELAX_FACT_38"]}],habits:[{display:"SUGGESTED_ACTIVITY_OUTDOORS",sort:t[i++],id:8,factoids:["HABITS_FACT_33","HABITS_FACT_34"]},{display:"SUGGESTED_ACTIVITY_HOBBY",sort:t[i++],id:13,factoids:["HABITS_FACT_31","HABITS_FACT_32"]},{display:"SUGGESTED_ACTIVITY_GO_FOR_A_WALK",sort:t[i++],id:3,factoids:["HABITS_FACT_26","HABITS_FACT_27"]}],thoughts:[{id:"COMPLETED_POSITIVITY_JOURNAL",sort:t[i++],factoids:["THOUGHTS_FACT_23","THOUGHTS_FACT_24"]},{id:"COMPLETED_ABC_THOUGHT_RECORD",sort:t[i++],factoids:["THOUGHTS_FACT_19","THOUGHTS_FACT_20"]},{id:"COMPLETED_GRATITUDE_JOURNAL",sort:t[i++],factoids:["THOUGHTS_FACT_21","THOUGHTS_FACT_22"]}],goals:[{display:"SUGGESTED_ACTIVITY_ANY_GOALS",sort:t[i++],factoids:["GOALS_FACT_21","GOALS_FACT_22"]},{display:"SET_A_DAILY_CHALLENGE",sort:t[i++],factoids:["GOALS_FACT_19","GOALS_FACT_20"]},{display:"SUGGESTED_ACTIVITY_SOCIAL_GOALS",sort:t[i++],factoids:["GOALS_FACT_23","GOALS_FACT_24"]}],hope:[{id:"ADD_PICTURE_TO_HOPE_FEED",sort:t[i++],factoids:["HOPE_FACT_1","HOPE_FACT_2","HOPE_FACT_3","HOPE_FACT_4","HOPE_FACT_5"]}]}:{relax:[{id:"COMPLETED_MINDFUL_WALK",sort:t[i++],factoids:["RELAX_FACT_3","RELAX_FACT_4"]},{id:"COMPLETED_POSITIVITY",sort:t[i++],factoids:["RELAX_FACT_37","RELAX_FACT_38"]},{id:"COMPLETED_GRATITUDE",sort:t[i++],factoids:["RELAX_FACT_37","RELAX_FACT_38"]},{id:"COMPLETED_MINDFUL_SENSES",sort:t[i++],factoids:["RELAX_FACT_3","RELAX_FACT_4"]},{id:"COMPLETED_POSITIVE_VISUALIZATION",sort:t[i++],factoids:["RELAX_FACT_31","RELAX_FACT_32"]},{id:"COMPLETED_UNGUIDED_MEDITATION",sort:t[i++],factoids:["RELAX_FACT_39","RELAX_FACT_40"]}],habits:[{display:"SUGGESTED_ACTIVITY_GET_SOME_EXERCISE",sort:t[i++],id:3,factoids:["HABITS_FACT_29","HABITS_FACT_30"]},{display:"SUGGESTED_ACTIVITY_FRIENDS",sort:t[i++],id:10,factoids:["HABITS_FACT_35","HABITS_FACT_36"]},{display:"SUGGESTED_ACTIVITY_FAMILY",sort:t[i++],id:9,factoids:["HABITS_FACT_37","HABITS_FACT_38"]},{display:"SUGGESTED_ACTIVITY_EAT",sort:t[i++],id:4,factoids:["HABITS_FACT_39","HABITS_FACT_40"]}],thoughts:[{id:"COMPLETED_POSITIVITY_JOURNAL",sort:t[i++],factoids:["THOUGHTS_FACT_23","THOUGHTS_FACT_24"]},{id:"COMPLETED_ABC_THOUGHT_RECORD",sort:t[i++],factoids:["THOUGHTS_FACT_19","THOUGHTS_FACT_20"]},{id:"COMPLETED_BELIEFS_THOUGHT_RECORD",sort:t[i++],factoids:["THOUGHTS_FACT_25","THOUGHTS_FACT_26"]},{id:"COMPLETED_GRATITUDE_JOURNAL",sort:t[i++],factoids:["THOUGHTS_FACT_21","THOUGHTS_FACT_22"]}],goals:[{display:"SUGGESTED_ACTIVITY_ANY_GOALS",sort:t[i++],factoids:["GOALS_FACT_21","GOALS_FACT_22"]},{display:"SET_A_DAILY_CHALLENGE",sort:t[i++],factoids:["GOALS_FACT_19","GOALS_FACT_20"]},{display:"SUGGESTED_ACTIVITY_SOCIAL_GOALS",sort:t[i++],factoids:["GOALS_FACT_23","GOALS_FACT_24"]}],hope:[{id:"ADD_PICTURE_TO_HOPE_FEED",sort:t[i++],factoids:["HOPE_FACT_1","HOPE_FACT_2","HOPE_FACT_3","HOPE_FACT_4","HOPE_FACT_5"]}]}},l.$on("event:online",function(){0<u.offlineActivities.length&&s.isOnline()&&r.isLoggedIn()&&e.onceInitialized(function(){r.onceUserContextInitialized(function(){c.post(s.serverURL+"/account/offline",{activities:u.offlineActivities}).success(function(){u.offlineActivities.length=0,e.removeItem("offlineActivities")})})})}),l.$on("request:updateLocalCompletedActivities",u.updateLocalCompletedActivities),function(){for(var e in _.each(u.thoughtActivities,function(e,t){u.activities[e.name]=e,u.activitiesById[e.id]=e}),u.activities){var t=u.activities[e];u.activitiesById[t.id]=t}}(),u}]),(tokenModule=angular.module("pacificaAnalytics",[])).provider("$analytics",function(){var n=!1,o=!1,a={disable:function(){o=!0},initialize:function(e,t,i){window.ga&&!o?(console.log("Inititalizing analytics with GA Code: "+e),window.ga("create",e,{storage:"none",cookieDomain:"none",clientId:window.device?device.uuid:"abc123"}),window.ga("set","appName","Pacifica"),window.ga("set","appVersion",t),window.ga("set","checkProtocolTask",function(){}),window.ga("set","forceSSL",!0),window.ga("set","anonymizeIp",!0),n=!0,a.pageTrack(i)):console.log("No analytics provider.")},eventTrack:function(e,t){window.ga&&n&&!o&&window.ga("send","event",t.category,e,t.label),(t&&t.category&&"group"!=t.category||"communities"!=t.category)&&a.addEventAppsee(e,t.category,t.label)},pageTrack:function(e){window.ga&&n&&!o&&(window.ga("set","screenName",e),window.ga("send","screenview",{screenName:e}))},setUserId:function(e){window.ga&&n&&!o&&window.ga("set","&uid",""+e)},stopAppsee:function(){window.Appsee&&Appsee.pause()},resumeAppsee:function(){window.Appsee&&Appsee.resume()},startAppsee:function(e,t){window.Appsee&&(Appsee.start(t),a.appseeOptOut(!1),Appsee.setUserId(e))},setAppseeScreen:function(e){window.Appsee&&Appsee.startScreen(e)},finishAppseeSession:function(){window.Appsee&&(a.appseeOptOut(!0),Appsee.finishSession(!1,!0))},appseeScreenAction:function(e){window.Appsee&&Appsee.addScreenAction("tap-"+e)},appseeOptOut:function(e){window.Appsee&&Appsee.setOptOutStatus(e)},appseeDeleteUser:function(e,t){window.Appsee?Appsee.deleteCurrentUserData(e,t):e()},addEventAppsee:function(e,t,i){window.Appsee&&Appsee.addEventWithProperties(e,{category:t,label:i})}};return{disable:a.disable,eventTrack:a.eventTrack,initialize:a.initialize,setUserId:a.setUserId,$get:function(){return a}}}),(servicesModule=angular.module("assessmentService",[])).factory("AssessmentService",["authHttp","Environment","AccountService","$stateParams","$state","$filter","$translate","OverlayService",function(n,s,o,t,a,i,c,r){var l={assessmentRequests:[],assessments:[]},u=function(e){var t,i;return t=e,i=o.getAccountUser(),t.forEach(function(e){var t=_.find(o.getConnectionContext().practitioners,{id:e.requesterId});void 0===t?i.practitioner&&e.requesterId==i.practitioner.id?e.requesterFullName="Me":e.requesterFullName=c.instant("UNKNOWN"):e.requesterFullName=t.fullName}),e.forEach(function(e){var i;i=e,l.getAssessment(i.assessmentId,function(e){var t=!(i.questions=[]);i.userAssessment.answers||(i.userAssessment.answers=[],t=!0),e.parts.forEach(function(e){e.questions.forEach(function(e){i.questions.push(e),t&&i.userAssessment.answers.push(null)})})})}),e};return l.setAssessmentContext=function(e){l.assessmentRequests=u(e.requests)},l.getAssessmentRequests=function(){return l.assessmentRequests},l.getAssessmentRequest=function(e){return _.find(l.assessmentRequests,{id:e})},l.getAssessment=function(e,t){if(!(e<=0)){var i=_.find(l.assessments,{id:e});i?t(i):n.get(s.serverURL+"/assessments/"+e).success(function(e){i=e,l.assessments.push(i),t(i)}).error(function(e){console.log(e.data)})}},l.saveAnswers=function(t){var i=createPromise(),e=_.findIndex(l.assessmentRequests,{id:t.id});return-1!=e&&(l.assessmentRequests[e]=t),-1===_.indexOf(t.userAssessment.answers,null)?(t.userAssessment.finishedAt=Date.now(),t.userAssessment.status="COMPLETE"):t.userAssessment.status="INCOMPLETE",n.post(s.serverURL+"/assessments/"+t.assessmentId+"/request/"+t.id,t.userAssessment).then(function(e){console.log("Assessment answers saved!: ",e),"COMPLETE"==t.userAssessment.status&&(t.userAssessment.scores=e.data),i.successCallback&&i.successCallback()},function(e){i.errorCallback&&i.errorCallback()}),i},l.getAssessmentHistory=function(e,t){var i="";return e&&(i+="?startTime="+e.getTime()),t&&(0<i.length?i+="&":i+="?",i+="endTime="+t.getTime()),n.get(s.serverURL+"/assessments/requests"+i)},l.initializeAssessmentFunctionality=function(e,r,t){e.todaysAssessmentRequests=l.getAssessmentRequests(),e.todaysAssessmentRequests&&e.todaysAssessmentRequests.sort(function(e,t){return t.requestDate-e.requestDate}),e.takeAssessment=function(o){if(s.isOnline()){var a=_.indexOf(o.userAssessment.answers,_.find(o.userAssessment.answers,function(e){return null===e}));0<a?l.getAssessment(parseInt(o.assessmentId),function(e){var i=1,n=0;e.parts.some(function(e,t){return n+=e.questions.length,a<n&&(i=t+1,a==n-e.questions.length?r.go("app.assessment-intro",{assessmentId:o.assessmentId,assessmentRequestId:o.id,partId:i}):r.go("app.assessment-question",{assessmentId:o.assessmentId,assessmentRequestId:o.id,partId:i,questionId:a+1}),!0)})}):r.go("app.assessment-intro",{assessmentId:o.assessmentId,assessmentRequestId:o.id,partId:1})}else t.popup.alert({template:c.instant("ASSESSMENT_OFFLINE_WARNING"),okText:c.instant("OK_GOT_IT"),okType:"button-default"})},e.viewAssessmentResults=function(e){o.isStudyUser()||r.go("app.assessment-results-review",{assessmentId:e.assessmentId,assessmentRequestId:e.id})}},l.initializeIntroFunctionality=function(i){i.questionId=1,i.assessmentRequest=l.getAssessmentRequest(parseInt(t.assessmentRequestId)),i.partIndex=parseInt(t.partId)-1,i.startPart=function(){a.go("app.assessment-question",{assessmentId:t.assessmentId,assessmentRequestId:t.assessmentRequestId,partId:t.partId,questionId:i.questionId})};l.getAssessment(parseInt(t.assessmentId),function(e){i.assessment=e,i.assessment.parts.forEach(function(e,t){i.partIndex>t&&(i.questionId+=e.questions.length)}),i.goToPreviousPart=function(){a.go("app.assessment-question",{assessmentId:t.assessmentId,assessmentRequestId:t.assessmentRequestId,partId:parseInt(t.partId)-1,questionId:i.assessment.parts[i.partIndex].questions.length})}})},l.initializeQuestionFunctionality=function(i){i.submitting=!1,i.partIndex=parseInt(t.partId)-1,i.questionIndex=parseInt(t.questionId)-1,i.assessmentRequest=l.getAssessmentRequest(parseInt(t.assessmentRequestId));l.getAssessment(parseInt(t.assessmentId),function(e){i.assessment=e,i.questionCount=0,i.partRanges=[],i.assessment.parts.forEach(function(e){i.partRanges.push({min:i.questionCount,max:i.questionCount+e.questions.length}),i.questionCount+=e.questions.length}),i.hasInstructions=function(){return 0<c.instant(i.assessment.parts[i.partIndex].instructions).length},i.showHelp=function(){r.popup.alert({template:c.instant(i.assessment.parts[i.partIndex].description),okText:c.instant("OK_GOT_IT"),okType:"button-default"})},i.goBack=function(){var e=i.partRanges.find(function(e){if(e.min==i.questionIndex)return!0});void 0!==e?a.go("app.assessment-intro",{assessmentId:t.assessmentId,assessmentRequestId:t.assessmentRequestId,partId:i.partRanges.indexOf(e)+1}):a.go("app.assessment-question",{assessmentId:t.assessmentId,assessmentRequestId:t.assessmentRequestId,partId:t.partId,questionId:parseInt(t.questionId)-1})},i.toggleAnswer=function(e,t){i.assessmentRequest.userAssessment.answers[e]=t,i.$$phase||i.$apply()},i.saveAnswers=function(){s.isOnline()?(i.submitting=!0,l.saveAnswers(i.assessmentRequest).success(function(){"PHQ-9"===i.assessment.shortName&&8==i.questionIndex&&i.assessmentRequest.userAssessment.answers[i.questionIndex]!=i.assessmentRequest.questions[i.questionIndex].options[0].id&&i.showSupport(),t.partId==i.assessment.parts.length&&t.questionId==i.assessmentRequest.questions.length?i.preventAssessmentResults&&i.preventAssessmentResults()?i.done():a.go("app.assessment-results",{assessmentId:t.assessmentId,assessmentRequestId:t.assessmentRequestId}):t.questionId==i.assessment.parts[i.partIndex].questions.length?a.go("app.assessment-intro",{assessmentId:t.assessmentId,assessmentRequestId:t.assessmentRequestId,partId:parseInt(t.partId)+1}):a.go("app.assessment-question",{assessmentId:t.assessmentId,assessmentRequestId:t.assessmentRequestId,partId:t.partId,questionId:parseInt(t.questionId)+1})}).error(function(){i.submitting=!1,$analytics.addEventAppsee("errorTriggered","saveAssessmentAnswer"),r.popup.alert({template:c.instant("ASSESSMENT_QUESTION_ERROR"),okText:c.instant("OK_GOT_IT"),okType:"button-default"})})):r.popup.alert({template:c.instant("ASSESSMENT_OFFLINE_WARNING"),okText:c.instant("OK_GOT_IT"),okType:"button-default"})}}),i.showSupport=function(){r.popup.alert({template:c.instant("PHQ9_SCORE_Q9"),okText:c.instant("OK_GOT_IT"),okType:"button-default"})}},l.initializeResultsFunctionality=function(e){e.assessmentRequest=l.getAssessmentRequest(parseInt(t.assessmentRequestId)),e.translateData={finishTime:i("date")(e.assessmentRequest.userAssessment.finishedAt,"h:mma"),finishDate:i("date")(e.assessmentRequest.userAssessment.finishedAt,"M/d/yy")},e.done=function(){a.go("app.home")}},l}]),(servicesModule=angular.module("audioCardService",[])).factory("AudioCardService",["Environment",function(e){return{setupNotificationCard:function(e,t,i){window.MusicControls&&MusicControls.create({track:e,artist:"Pacifica",cover:"img/avatar/icon-pacifica.png",isPlaying:!0,dismissable:!1,hasPrev:!1,hasNext:!1,hasClose:!1,ticker:e},function(){MusicControls.subscribe(function(e){switch(e){case"music-controls-headset-unplugged":i()&&t();break;case"music-controls-pause":case"music-controls-play":t()}}),MusicControls.listen()},function(e){console.log("error")})},updateCardControl:function(e){window.MusicControls&&MusicControls.updateIsPlaying(e)},destroyNotificationCard:function(){window.MusicControls&&MusicControls.destroy()}}}]),(servicesModule=angular.module("audioService",[])).factory("AudioService",["$translate","authHttp","TokenService","Environment","StorageService",function(d,r,a,s,t){var i,p={audioContext:{},activeThoughtId:void 0,activeSources:{}};function c(){if(p.audioContext.thoughts&&10<p.audioContext.thoughts.length){var e=$.extend(!0,{},p.audioContext);e.thoughts.splice(10,e.thoughts.length-10),t.setItem("audioContext",JSON.stringify(e))}else t.setItem("audioContext",JSON.stringify(p.audioContext))}function l(e){if(e.tags){for(var t=0;t<e.tags.length;++t)e.tags[t].recordingId=e.id;return r.post(s.serverURL+"/audio/tag",{tags:e.tags})}}function n(t,e){var i={};if(i.title=t.title,i.type=t.type,i.duration=t.duration,i.thoughtId=e,t.localUrl){console.log("got fileEntry for upload");var n=new FileUploadOptions;n.fileKey="file",n.fileName=t.title,n.mimeType=t.title.endsWith(".mp4")?"audio/mp4":"audio/amr",n.params=i;var o={Session:a.getToken()};if(n.headers=o,console.log("uploading local url : "+t.localUrl),s.isOnline())if(window.FileTransfer)(new FileTransfer).upload(t.localUrl,encodeURI(s.serverURL+"/audio/upload"),function(e){console.log("Code = "+e.responseCode),console.log("Response = "+e.response),console.log("Sent = "+e.bytesSent),t.id=+e.response,l(t)},function(e){alert("An error has occurred: Code = "+e.code),console.log("upload error source "+e.source),console.log("upload error target "+e.target)},n);else console.log("WARNING: Can not upload file.");else console.log("Cannot handle offline upload yet.")}else i.notes=t.notes,r.post(s.serverURL+"/audio/postTextRecording",i).success(function(e){t.id=+e,l(t)}).error(function(e,t,i,n){console.log("Error posting recpoding: "+e)})}return p.setActiveThoughtId=function(e){p.activeThoughtId=e},p.clearActiveThoughtId=function(){p.setActiveThoughtId(void 0)},p.getActiveThoughtId=function(){return p.activeThoughtId},p.setActiveSource=function(e,t){p.activeSources[e]=t},p.getActiveSource=function(e){return p.activeSources[e]},p.initFromLocalStorage=function(){t.getItem("audioContext",function(e){e&&(p.audioContext=JSON.parse(e))})},p.setTextThoughtForReview=function(e){i=e},p.getTextThoughtForReview=function(){return i},p.setAudioContext=function(e){var t=[];if(p.audioContext.thoughts)for(var i=p.audioContext.thoughts.length-1;0<=i;--i){var n=p.audioContext.thoughts[i];isNumeric(n.id)||n.saving||t.push(n)}p.audioContext=e,p.audioContext.thoughts||(p.audioContext.thoughts=[]);for(var o=0;o<t.length;++o)p.audioContext.thoughts.push(t[o]);c()},p.logout=function(){p.audioContext={}},p.getThoughts=function(){return p.audioContext.thoughts},p.getThoughtCount=function(){return p.audioContext.totalThoughts},p.clearNonPersistedThoughts=function(){var e=0;if(p.audioContext.thoughts)for(var t=p.audioContext.thoughts.length-1;0<=t;--t){var i=p.audioContext.thoughts[t];isNumeric(i.id)||i.saving||i.id==p.activeThoughtId||(p.audioContext.thoughts.splice(t,1),++e)}p.audioContext.totalThoughts-=e,c()},p.getThought=function(e){if(p.audioContext.thoughts)for(var t=0;t<p.audioContext.thoughts.length;++t){var i=p.audioContext.thoughts[t];if(i.id==e||i.generatedId==e)return i}},p.createThought=function(e){p.clearNonPersistedThoughts();var t=e?d.instant(e):d.instant("THOUGHT_RECORD"),i=t.replace(/ /g,"\\s"),n=new RegExp(i+="\\s[0-9]*"),o=0;if(p.audioContext.thoughts)for(var a=0;a<p.audioContext.thoughts.length;++a){var r=p.audioContext.thoughts[a].title;if(n.test(r)){var s=r.split(" "),c=parseInt(s[s.length-1]);o<c&&(o=c)}}var l=t+" "+(o+1),u={id:generateGUID(),title:l,createdAt:(new Date).getTime(),createdAtString:(new Date).toString(),recordings:{}};return p.audioContext.thoughts||(p.audioContext.thoughts=[]),p.audioContext.thoughts.splice(0,0,u),++p.audioContext.totalThoughts,u},p.addRecording=function(e,t,i,n,o,a){var r={id:generateGUID(),title:t,type:i,duration:n,recordedAt:(new Date).getTime(),recordedAtString:(new Date).toString(),localUrl:e,url:t,notes:a};return p.getThought(o).recordings[i]=r},p.addTag=function(e,t,i,n,o,a){var r=e.recordings[t],s={tagString:i,tagTypeString:n,tagTime:o};a&&(s.tagSpan=a),r.tags?r.tags.push(s):r.tags=[s]},p.addDeprecatedTags=function(e,t){for(var i=e.recordings.thought,n=[],o=0;o<t.length;++o){var a=t[o];n.push({tagTypeString:a.positive?"positive":"negative",tagTime:a.tagTime,tagString:a.tags.join(",")})}i.tags?Array.prototype.push.apply(i.tags,n):i.tags=n},p.postThought=function(e,t){var i=p.getThought(e);i.thoughtType=t,i.saving=!0,r.post(s.serverURL+"/audio/createThoughtWithType",{title:i.title,thoughtType:t}).success(function(e){for(var t in i.generatedId=i.id,i.id=e,i.recordings){n(i.recordings[t],i.id)}})},p.archiveThought=function(e){var o=createPromise(),t=function(){--p.audioContext.totalThoughts,o.successCallback&&o.successCallback()},i=function(e,t,i,n){console.log("Error archiving thought: "+e),o.errorCallback&&o.errorCallback()};if(p.audioContext.thoughts)for(var n=0;n<p.audioContext.thoughts.length;++n){if(p.audioContext.thoughts[n].id==e){p.audioContext.thoughts.splice(n,1),r.post(s.serverURL+"/audio/archiveThought",e).success(t).error(i);break}}return o},p.updateThoughtTitle=function(e,t){if(p.audioContext.thoughts)for(var i=0;i<p.audioContext.thoughts.length;++i){var n=p.audioContext.thoughts[i];if(n.id==e){n.title=t,c(),r.post(s.serverURL+"/audio/updateThoughtTitle",{thoughtId:e,title:t});break}}},p.loadMoreThoughts=function(e,t){var a=createPromise();return r.get(s.serverURL+"/audio/thoughts?offset="+e+"&limit="+t).success(function(e){if(e){p.audioContext.thoughts||(p.audioContext.thoughts=[]);for(var t=0;t<e.length;++t){for(var i=e[t],n=!1,o=0;o<p.audioContext.thoughts.length;++o){if(p.audioContext.thoughts[o].id==i.id){n=!0;break}}n||p.audioContext.thoughts.push(i)}}a.successCallback&&a.successCallback()}).error(function(){a.errorCallback&&a.errorCallback()}),a},p}]),(servicesModule=angular.module("authService",[])).factory("authHttp",["$http","TokenService",function(o,a){var t={update:function(e){var t=e().session;if(t){var i=t.split(";"),n=i[0].split("=")[1],o=i[1].split("=")[1];a.update(n,o)}},removeSession:function(){a.clear()},addPlatform:function(e){window.device&&(e.headers.Platform=window.device.platform.toLowerCase())},addTimezone:function(e){e.headers=e.headers||{},e.headers.TimezoneLocale=t.activeTimezone},setActiveTimezone:function(e){t.activeTimezone=e}},r=function(e){e.headers=e.headers||{},e.headers.Session=a.getToken(),t.addPlatform(e),t.addTimezone(e)};return angular.forEach(["get","delete","head","jsonp"],function(i){t[i]=function(e,t){return r(t=t||{}),t.withCredentials=!0,o[i](e,t)}}),angular.forEach(["post","put"],function(n){t[n]=function(e,t,i){return r(i=i||{}),i.withCredentials=!0,o[n](e,t,i)}}),t}]),(servicesModule=angular.module("environmentService",[])).factory("Environment",["$rootScope","$ionicPlatform","$interval","$timeout",function(e,t,i,n){var o,a={};window.PACIFICA_DEV_SETTINGS&&(a=window.PACIFICA_DEV_SETTINGS);var r={online:!0,appVersion:"7.0.9"};function s(){console.log("ONLINE"),r.online=!0,e.$broadcast("event:online")}function c(){console.log("OFFLINE"),r.online=!1,e.$broadcast("event:offline")}function l(){o=i(a.checkOnlineStatus,300),(a.isWeb()||a.isWebDebug())&&u()}function u(){o&&(i.cancel(o),o=null)}return a.isDebug=function(){return!!a.isDebuggable},a.isWeb=function(){return!1},a.isWebDebug=function(){return!!window.webDebug&&window.webDebug},a.isStorageAllowed=function(){return a.storageAllowed},a.checkOnlineStatus=function(){var e;(navigator||navigator.connection)&&((e=a.isIos()?"none"!=navigator.connection.type:"none"!=navigator.connection.type||navigator.onLine)&&!r.online?s():!e&&r.online&&c())},l(),t.on("resume",function(){o||(l(),n(u,5e3))}),t.ready(function(){navigator&&navigator.connection&&(r.online="none"!=navigator.connection.type,r.online?s():c()),t.on("online",s),t.on("offline",c),n(u,5e3)}),a.isOnline=function(){return r.online},a.isDevelopment=function(){return a.development},a.isIos=function(){return window.device&&window.device.platform&&"ios"==window.device.platform.toLowerCase()},a.isIPad=function(){return window.device&&window.device.model&&0<=window.device.model.indexOf("iPad")},a.isIphoneX=function(){var e=window.devicePixelRatio&&3===window.devicePixelRatio,t=375===$(window).width()&&812===$(window).height();return a.isIos()&&e&&t},a.isAndroid=function(){return window.device&&window.device.platform&&"android"==window.device.platform.toLowerCase()},a.getAppVersion=function(){return r.appVersion},a.getGATrackingCode=function(){return a.gaTrackingCode},a}]),(servicesModule=angular.module("errorService",[])).factory("ErrorService",function(){return{errorMessage:null,setError:function(e){this.errorMessage=e},clear:function(){this.errorMessage=null}}}),servicesModule.factory("errorHttpInterceptor",["$q","$rootScope",function(t,i){return{responseError:function(e){return 401==e.status&&i.$broadcast("event:loginRequired"),t.reject(e)}}}]),servicesModule.config(["$httpProvider",function(e){e.interceptors.push("errorHttpInterceptor")}]),(servicesModule=angular.module("feedService",[])).factory("FeedService",["GeneralService","$translate","StorageService","authHttp","Environment",function(t,i,n,e,a){var r={settings:["NEVER","RARELY","SOMETIMES","OFTEN","ALWAYS"],dailyDownVotes:[],dailyUpVotes:[],feedSettings:{},feedContext:{}};function o(){var e={day:t.getTodayString(),dailyUpVotes:r.dailyUpVotes,dailyDownVotes:r.dailyDownVotes};n.setItem("feedVotes",JSON.stringify(e))}function s(e){r.settingDownVotedSuccess(),r.wasDownVoted(e)||(r.dailyDownVotes.push(e),o())}function c(e){r.settingUpVotedSuccess(),r.wasUpVoted(e)||(r.dailyUpVotes.push(e),o())}return r.setFeedContext=function(e){r.feedContext=e,n.setItem("feedContext",JSON.stringify(r.feedContext))},r.setDiscoverPreferences=function(t,i,n,o){e.post(a.serverURL+"/feed/prefs/"+t,{value:i}).success(function(e){r.getFeedPreferenceByPref(t).value=i,n&&n(e)}).error(function(e){o&&o(e)})},r.getFeedSettings=function(){e.get(a.serverURL+"/feed/prefs/").success(function(e){r.setUserFeedSettings(e)}).error(function(e){console.log(e)})},r.getFeedPreferenceByPref=function(e){var t=_.findIndex(r.feedSettings,{name:e});return r.feedSettings[t]},r.setUserFeedSettings=function(e){r.feedSettings=e},r.getUserFeedSettings=function(){return r.feedSettings},r.getFeedItems=function(){return r.feedContext.feedItems},r.getItemOfType=function(t){return _.find(r.feedContext.feedItems,function(e){return e.type===t})},r.hasItemOfType=function(e){return _.includes(r.getCurrentItemTypes(),e)},r.getCurrentItemTypes=function(){return _.map(r.feedContext.feedItems,function(e){return e.type})},r.voteLocalCommunityPost=function(e){var t="up"===e?1:-1,i=r.getItemOfType("community"),n=_.findIndex(r.feedContext.feedItems,i);r.feedContext.feedItems[n].post.score+=t,r.feedContext.feedItems[n].vote={up:"up"===e}},r.getPrefOptions=function(){return r.settings},r.settingUpVotedSuccess=function(){var e=i.instant("FEED_ITEM_UPVOTED");t.showToast(e,!0,"bottom")},r.settingDownVotedSuccess=function(){var e=i.instant("FEED_ITEM_DOWNVOTED");t.showToast(e,!0,"bottom")},r.upVote=function(t){var e=r.getFeedPreferenceByPref(t),i=r.settings.indexOf(e.value);i+1!=r.settings.length?r.setDiscoverPreferences(t,r.settings[i+1],function(){c(t)},function(e){c(t),console.log(e)}):r.settingUpVotedSuccess()},r.wasUpVoted=function(e){return-1<r.dailyUpVotes.indexOf(e)},r.wasDownVoted=function(e){var t=r.getUserFeedSettings(),i=t[_.findIndex(t,{name:e})];return!(!i||"NEVER"!=i.value)||-1<r.dailyDownVotes.indexOf(e)},r.downVote=function(t){var e=r.getFeedPreferenceByPref(t),i=r.settings.indexOf(e.value);r.setDiscoverPreferences(t,r.settings[i-1],function(){s(t)},function(e){s(t),console.log(e)})},r.initFromLocalStorage=function(){n.getItem("feedVotes",function(e){e&&((e=JSON.parse(e)).day==t.getTodayString()?(r.dailyUpVotes=e.dailyUpVotes,r.dailyDownVotes=e.dailyDownVotes):n.removeItem("feedVotes"))})},r.getMiloData=function(){return[{bgImageUrl:"./img/milo/milo_moody.png",titleKey:"WATCH_MILO_IS_MOODY",videoName:"milo-mood"},{bgImageUrl:"./img/milo/milo_stressed.png",titleKey:"WATCH_MILO_IS_STRESSED",videoName:"milo-relax"},{bgImageUrl:"./img/milo/milo_doubts.png",titleKey:"WATCH_MILO_HAS_DOUBTS",videoName:"milo-thoughts"},{bgImageUrl:"./img/milo/milo_scared.png",titleKey:"WATCH_MILO_IS_SCARED",videoName:"milo-goals"},{bgImageUrl:"./img/milo/milo_busy.png",titleKey:"WATCH_MILO_IS_BUSY",videoName:"milo-health"},{bgImageUrl:"./img/milo/milo_lost.png",titleKey:"WATCH_MILO_IS_LOST",videoName:"milo-community"}]},r.clearData=function(){r.dailyDownVotes=[],r.dailyUpVotes=[],r.feedContext={}},r}]);var servicesModule=angular.module("generalService",[]),EMAIL_REGEX=/^[a-zA-Z0-9.!#$%&’*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$/;servicesModule.factory("GeneralService",["$translate","Environment","$ionicScrollDelegate","$state","AccessibilityService",function(c,s,e,t,l){var n={COLORS:["#60d293","#5fe9c4","#5bdddf","#58caf6","#ffbe66","#ff9b73","#ff6669"],COLOR_NAMES:["green","turquoise","cyan","blue","yellow","orange","red"],STRESS_COLORS:["#60d293","#58caf6","#ffbe66","#ff9b73","#ff6669"],STRESS_COLOR_NAMES:["green","blue","yellow","orange","red"],MILLISECONDS_IN_HOUR:36e5,MILLISECONDS_IN_DAY:864e5};function i(e,t,i){e||(e=[0]),e=e.toLowerCase();var n=t.indexOf(e);return 0<=n?i[n]:i[0]}function u(e,t){return e?e<10&&!t?"0"+e:""+e:t?"0":"00"}return n.openInAppBrowserURL=function(e){"undefined"!=typeof cordova&&cordova.InAppBrowser&&cordova.InAppBrowser.open(e,"_system")},n.isEmailValid=function(e){return EMAIL_REGEX.test(e)},n.hideToast=function(){window.plugins&&window.plugins.toast&&window.plugins.toast.hide()},n.showToast=function(e,t,i,n){if(window.plugins&&window.plugins.toast){var o,a=window.devicePixelRatio;o=i?s.isAndroid()?-90*a:s.isIphoneX()?-80:-50:0;var r={message:e,duration:t?"short":6e3,position:"center"===i?"center":i&&"center"!=i?"bottom":"top",addPixelsY:o};l.onceInitialized(function(){l.usingScreenReader&&l.speak(e,1)}),window.plugins.toast.showWithOptions(r,function(e){e&&"touch"==e.event&&n&&n()})}},n.getStressColor=function(e){return i(e,n.STRESS_COLOR_NAMES,n.STRESS_COLORS)},n.getColor=function(e){return i(e,n.COLOR_NAMES,n.COLORS)},n.getDifferenceInDays=function(e,t){var i=Math.abs(t-e);return Math.floor(i/n.MILLISECONDS_IN_DAY)},n.getTodayString=function(){var e=new Date;return n.getDayString(e)},n.getDayString=function(e){var t=e.getDate(),i=e.getMonth()+1;return e.getFullYear()+"-"+(i<10?"0":"")+i+"-"+(t<10?"0":"")+t},n.getUTCDayString=function(e){var t=e.getUTCDate(),i=e.getUTCMonth()+1;return e.getUTCFullYear()+"-"+(i<10?"0":"")+i+"-"+(t<10?"0":"")+t},n.getDateDisplay=function(e){var t=""+e.getFullYear();return t=t.substring(2),e.getMonth()+1+"/"+e.getDate()+"/"+t},n.getMinuteDisplay=function(e){var t=e.getMinutes(),i=e.getHours(),n=i;return 0===n?n=12:12<n&&(n-=12),n+":"+(t<10?"0":"")+t+(12<=i?"PM":"AM")},n.toTitleCase=function(e){return e.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()})},n.getElapsedTimeDisplay=function(e,t){var i,n=moment(e),o=moment(t),a=moment.duration(n.diff(o)),r=Math.round(a.asMinutes());if(60<Math.abs(r)){var s=Math.round(a.asHours());return 1==Math.abs(s)?s<0?c.instant("ONE_HOUR_AGO"):c.instant("IN_ONE_HOUR"):(i=s<0?(s=-s,"XXX_HOURS_AGO"):"IN_XXX_HOURS",c.instant(i).replace("XXXHOURSXXX",s))}return i=r<0?(r=-r,"XXX_MINUTES_AGO"):"IN_XXX_MINUTES",c.instant(i).replace("XXXMINUTESXXX",r)},n.getTimeDisplay=function(e,t,i){var n=Math.floor(e/60),o=Math.floor(e-60*n),a=u(n,t),r=u(o,!1);return i?30<r?parseInt(a)+1:a:a+":"+r},n.timeUntil=function(e,t){var i=moment(e),n=moment();return i.diff(n,t)},n.timeSince=function(e,t){var i=moment(e);return moment().diff(i,t)},n.loadFile=function(t,i){window.LocalFileSystem&&window.requestFileSystem(LocalFileSystem.TEMPORARY,0,function(e){e.root.getFile(t,{create:!0,exclusive:!1},function(e){i(e)},function(){console.log("did not get file.")})},function(){console.log("failed getting filesystem")})},n.getUSStates=function(){return{AL:"Alabama",AK:"Alaska",AS:"American Samoa",AZ:"Arizona",AR:"Arkansas",CA:"California",CO:"Colorado",CT:"Connecticut",DE:"Delaware",DC:"District Of Columbia",FM:"Federated States Of Micronesia",FL:"Florida",GA:"Georgia",GU:"Guam",HI:"Hawaii",ID:"Idaho",IL:"Illinois",IN:"Indiana",IA:"Iowa",KS:"Kansas",KY:"Kentucky",LA:"Louisiana",ME:"Maine",MH:"Marshall Islands",MD:"Maryland",MA:"Massachusetts",MI:"Michigan",MN:"Minnesota",MS:"Mississippi",MO:"Missouri",MT:"Montana",NE:"Nebraska",NV:"Nevada",NH:"New Hampshire",NJ:"New Jersey",NM:"New Mexico",NY:"New York",NC:"North Carolina",ND:"North Dakota",MP:"Northern Mariana Islands",OH:"Ohio",OK:"Oklahoma",OR:"Oregon",PW:"Palau",PA:"Pennsylvania",PR:"Puerto Rico",RI:"Rhode Island",SC:"South Carolina",SD:"South Dakota",TN:"Tennessee",TX:"Texas",UT:"Utah",VT:"Vermont",VI:"Virgin Islands",VA:"Virginia",WA:"Washington",WV:"West Virginia",WI:"Wisconsin",WY:"Wyoming"}},n}]),(servicesModule=angular.module("goalsService",[])).factory("GoalsService",["$rootScope","$timeout","authHttp","Environment","GeneralService","StorageService","AccountService","ActivityService","PathService","$translate",function(n,s,c,l,r,e,a,u,d,o){var f={accountGoals:[],accountSubGoals:{},lastActiveTab:void 0};function T(){e.setItem("accountGoals",JSON.stringify(f.accountGoals))}function g(){e.setItem("accountSubGoals",JSON.stringify(f.accountSubGoals))}function p(e){isNumeric(e.id)&&isNumeric(e.goalId)&&e.achievedRecordedAtRequestUpdate&&m(e)}function m(e,t){if(e&&(f.achievedSubGoal(e)||(e.achievedRecordedAt=(new Date).getTime(),e.achievedRecordedAtString=(new Date).toString(),e.actualDifficulty=t,g(),u.recordActivity("COMPLETED_EXPERIMENT"))),l.isOnline())return c.post(l.serverURL+"/goals/account/achieveSubGoalWithDifficulty",{subGoalId:e.id,actualDifficulty:t});n.$on("event:online",function(){return c.post(l.serverURL+"/goals/account/achieveSubGoalWithDifficulty",{subGoalId:e.id,actualDifficulty:t})}),e.achievedRecordedAtRequestUpdate=!0;var i=createPromise();return s(function(){i.successCallback&&i.successCallback()}),i}return f.initFromLocalStorage=function(){e.getItem("accountGoals",function(e){e&&(f.accountGoals=JSON.parse(e))}),e.getItem("accountSubGoals",function(e){e&&(f.accountSubGoals=JSON.parse(e))})},n.$on("event:checkPathMotivationProgress",function(){d.checkPathMotivationProgress(f.getAccountSubGoals())}),f.logout=function(){f.accountGoals=[],f.accountSubGoals={}},f.getLastActiveTab=function(){return f.lastActiveTab},f.setLastActiveTab=function(e){f.lastActiveTab=e},f.updateGoalsContext=function(){c.get(l.serverURL+"/goals/account").success(function(e){f.setGoalContext(e)})},f.setGoalContext=function(e){var t=f.accountGoals,i=f.accountSubGoals;f.accountGoals=e.accountGoals,f.accountSubGoals=e.accountSubGoals;for(var n=0;n<t.length;++n){var o=t[n];if(o.createdOffline&&!isNumeric(o.createdOffline)){for(var a=!1,r=0;r<f.accountGoals.length;++r)if(f.accountGoals[r].id==o.id){a=!0;break}a||f.accountGoals.push(o)}}for(var s in i)for(var c=i[s],l=0;l<c.length;++l){var u=c[l];if(u.createdOffline&&!isNumeric(u.id)){for(var d=!1,p=f.accountSubGoals[s],m=0;m<c;++m)if(p[m].id==u.id){d=!0;break}d||(f.accountSubGoals[s]||(f.accountSubGoals[s]=[]),f.accountSubGoals[s].push(u))}}T(),g()},f.setOnboardingGoals=function(e){var o=createPromise(),t={lang:a.getLocale(),goals:e};return c.post(l.serverURL+"/account/setGoals",t).success(function(e){if(e)for(var t=0;t<e.length;++t){var i=e[t];f.accountGoals.push(i)}T(),o.successCallback&&o.successCallback(e)}).error(function(e,t,i,n){console.log("Error creating onboarding goals: "+e),o.errorCallback&&o.errorCallback()}),o},f.getAccountGoals=function(){return _.each(f.accountGoals,function(e){f.getGoalKey(e)}),f.accountGoals},f.getAccountSubGoals=function(){return f.accountSubGoals},f.getGoal=function(e){for(var t,i=f.accountGoals,n=0;n<i.length;++n)if(i[n].id==e){t=i[n];break}return t},f.getSubGoalById=function(e){for(var t in f.accountSubGoals)for(var i=f.accountSubGoals[t],n=0;n<i.length;++n){var o=i[n];if(o.id==e)return o}},f.getSubGoal=function(e,t){var i,n=f.accountSubGoals[e];if(n)for(var o=0;o<n.length;++o)if(n[o].id==t){i=n[o];break}return i},f.getTodaysAchievedGoals=function(){var e=[],t=f.accountSubGoals;for(var i in t)for(var n=t[i],o=0;o<n.length;++o){var a=n[o];f.achievedOrSetSubGoalToday(a,!0)&&e.push(a)}return e},f.achievedSubGoal=function(e){return null!==e.achievedRecordedAt&&void 0!==e.achievedRecordedAt},f.achievedOrSetSubGoalToday=function(e,t){if(f.achievedSubGoal(e)){var i=new Date(e.achievedRecordedAtString);return r.getDayString(i)==r.getTodayString()}if(t){var n=new Date(e.createdAtString);return r.getDayString(n)==r.getTodayString()}return!1},n.$on("event:online",function(){!function(){function e(i){i.id&&isNumeric(i.id)||c.post(l.serverURL+"/goals/account/addGoal",{title:i.title,color:i.color}).success(function(e){var t=i.id;i.id=+e,function(e,i){function t(t){isNumeric(t.id)||t.goalId!=e?p(t):(t.goalId=i,g(),c.post(l.serverURL+"/goals/account/addSubGoal",t).success(function(e){t.id=+e,g(),p(t)}).error(function(e,t,i,n){console.log("Error posting goal: "+e)}))}var n=f.accountSubGoals;for(var o in n)for(var a=n[o],r=0;r<a.length;++r){var s=a[r];t(s)}}(t,i.id),T()}).error(function(e,t,i,n){console.log("Error posting goal: "+e)})}!function(){function e(o){o.createdOffline&&!isNumeric(o.id)&&isNumeric(o.goalId)&&(o.createdOffline=!1,c.post(l.serverURL+"/goals/account/addSubGoal",o).success(function(e){o.id=+e,g(),d.checkPathGoalProgress(f.accountSubGoals),u.recordActivity("CREATED_EXPERIMENT"),p(o)}).error(function(e,t,i,n){o.createdOffline=!1,console.log("Error posting goal: "+e)}))}var t=f.accountSubGoals;for(var i in t)for(var n=t[i],o=0;o<n.length;++o){var a=n[o];e(a)}}();for(var t=f.accountGoals,i=0;i<t.length;++i){var n=t[i];e(n)}}()}),f.addGoal=function(e,t){var i={title:e,color:t,createdAt:(new Date).getTime()};f.accountGoals.push(i),T();var o=createPromise();return l.isOnline()?c.post(l.serverURL+"/goals/account/addGoal",{title:e,color:t}).success(function(e){i.id=+e,T(),o.successCallback&&o.successCallback(e)}).error(function(e,t,i,n){console.log("Error posting goal: "+e),o.errorCallback&&o.errorCallback()}):(i.id=generateGUID(),i.createdOffline=!0,T(),s(function(){void 0})),o},f.archiveGoal=function(e){for(var t=f.accountGoals,i=0;i<t.length;++i)if(t[i].id==e){for(var n in t.splice(i,1),T(),f.accountSubGoals)for(var o=f.accountSubGoals[n],a=o.length-1;0<=a;--a){o[a].goalId==e&&o.splice(a,1)}g();break}return c.post(l.serverURL+"/goals/account/archiveGoal",e)},f.updateGoal=function(e,t,i){var n=f.getGoal(e);if(n)return n.title=t,n.color=i,T(),l.isOnline()?c.post(l.serverURL+"/goals/account/updateGoal",{goalId:n.id,title:n.title,color:n.color}):{success:function(e){e&&e()}}},f.addSubGoal=function(e,t,i,n){var o={goalId:e,title:t,day:i,difficulty:n,createdAt:(new Date).getTime()},a=f.accountSubGoals[i];a||(a=[],f.accountSubGoals[i]=a),a.push(o),g();var r=createPromise();return l.isOnline()?c.post(l.serverURL+"/goals/account/addSubGoal",o).success(function(e){o.id=+e,g(),d.checkPathGoalProgress(f.accountSubGoals),u.recordActivity("CREATED_EXPERIMENT"),r.successCallback&&r.successCallback()}).error(function(e,t,i,n){console.log("Error posting goal: "+e),r.errorCallback&&r.errorCallback(e,t,i,n)}):(o.id=generateGUID(),o.createdOffline=!0,g(),s(function(){r.successCallback&&r.successCallback()})),r},f.achieveSubGoal=function(e,t){return m(f.getSubGoalById(e),t)},f.archiveSubGoal=function(e,t){console.log("Archive subGoal day:",e);var i="number"==typeof e?r.getUTCDayString(new Date(e)):e,n=f.accountSubGoals[i];if(n){var o=f.getSubGoal(i,t),a=n.indexOf(o);if(0<=a)return n.splice(a,1),g(),c.post(l.serverURL+"/goals/account/archiveSubGoal",t)}},f.updateSubGoal=function(e,t,i,n,o){var a=f.getSubGoal(n,e);if(a&&(a.goalId=t,a.day=n,a.title=i,a.difficulty=o,g(),l.isOnline()))return c.post(l.serverURL+"/goals/account/updateSubGoal",{subGoalId:e,goalId:t,title:i,day:n,difficulty:o});var r=createPromise();return s(function(){r.successCallback&&r.successCallback()}),r},f.getGoalKey=function(e){var t=f.getNuxGoals();for(i=0;i<t.length;i++)if(o.instant(t[i],{},void 0,"en")==e.title){e.displayKey=t[i];break}e.displayKey||(e.displayKey=e.title)},f.getNuxGoals=function(){return["NUX_GOAL_DEPRESSION","NUX_GOAL_CONFIDENCE","NUX_GOAL_SOCIAL","NUX_GOAL_HEALTH","NUX_GOAL_GAD","NUX_GOAL_THOUGHTS","NUX_GOAL_MEDITATION","NUX_GOAL_HOPE"]},f.getCategoryOrder=function(){return["GOAL_LIST_CATEGORY_WORK_SCHOOL","GOAL_LIST_CATEGORY_FRIENDS_FAMILY","GOAL_LIST_CATEGORY_ROMANCE","GOAL_LIST_CATEGORY_STRANGERS","GOAL_LIST_CATEGORY_EATING","GOAL_LIST_CATEGORY_DESTINATIONS","GOAL_LIST_CATEGORY_PERFORMING","GOAL_LIST_CATEGORY_TRANSPORTATION","GOAL_LIST_CATEGORY_RELAX","GOAL_LIST_CATEGORY_WILDCARDS","GOAL_LIST_CATEGORY_LIFE_STEPS","GOAL_LIST_CATEGORY_PLEASANT_ACTIVITIES"]},f.getSubGoalKeys=function(){return[["GOAL_LIST_WORK_SCHOOL_1","GOAL_LIST_WORK_SCHOOL_2","GOAL_LIST_WORK_SCHOOL_3","GOAL_LIST_WORK_SCHOOL_4","GOAL_LIST_WORK_SCHOOL_5","GOAL_LIST_WORK_SCHOOL_6","GOAL_LIST_WORK_SCHOOL_7","GOAL_LIST_WORK_SCHOOL_8","GOAL_LIST_WORK_SCHOOL_9","GOAL_LIST_WORK_SCHOOL_10","GOAL_LIST_WORK_SCHOOL_11","GOAL_LIST_WORK_SCHOOL_12","GOAL_LIST_WORK_SCHOOL_13"],["GOAL_LIST_FRIENDS_FAMILY_1","GOAL_LIST_FRIENDS_FAMILY_2","GOAL_LIST_FRIENDS_FAMILY_3","GOAL_LIST_FRIENDS_FAMILY_4","GOAL_LIST_FRIENDS_FAMILY_5","GOAL_LIST_FRIENDS_FAMILY_6","GOAL_LIST_FRIENDS_FAMILY_7"],["GOAL_LIST_ROMANCE_1","GOAL_LIST_ROMANCE_2","GOAL_LIST_ROMANCE_3","GOAL_LIST_ROMANCE_4","GOAL_LIST_ROMANCE_5","GOAL_LIST_ROMANCE_6","GOAL_LIST_ROMANCE_7"],["GOAL_LIST_STRANGERS_1","GOAL_LIST_STRANGERS_2","GOAL_LIST_STRANGERS_3","GOAL_LIST_STRANGERS_4","GOAL_LIST_STRANGERS_5","GOAL_LIST_STRANGERS_6","GOAL_LIST_STRANGERS_7"],["GOAL_LIST_EATING_1","GOAL_LIST_EATING_2","GOAL_LIST_EATING_3","GOAL_LIST_EATING_4","GOAL_LIST_EATING_5"],["GOAL_LIST_DESTINATIONS_1","GOAL_LIST_DESTINATIONS_2","GOAL_LIST_DESTINATIONS_3","GOAL_LIST_DESTINATIONS_4","GOAL_LIST_DESTINATIONS_5","GOAL_LIST_DESTINATIONS_6","GOAL_LIST_DESTINATIONS_7","GOAL_LIST_DESTINATIONS_8","GOAL_LIST_DESTINATIONS_9","GOAL_LIST_DESTINATIONS_10","GOAL_LIST_DESTINATIONS_11","GOAL_LIST_DESTINATIONS_12","GOAL_LIST_DESTINATIONS_13","GOAL_LIST_DESTINATIONS_14","GOAL_LIST_DESTINATIONS_15","GOAL_LIST_DESTINATIONS_16","GOAL_LIST_DESTINATIONS_17","GOAL_LIST_DESTINATIONS_18","GOAL_LIST_DESTINATIONS_19","GOAL_LIST_DESTINATIONS_20","GOAL_LIST_DESTINATIONS_21","GOAL_LIST_DESTINATIONS_22","GOAL_LIST_DESTINATIONS_23","GOAL_LIST_DESTINATIONS_24","GOAL_LIST_DESTINATIONS_25","GOAL_LIST_DESTINATIONS_26"],["GOAL_LIST_PERFOMING_1","GOAL_LIST_PERFOMING_2","GOAL_LIST_PERFOMING_3","GOAL_LIST_PERFOMING_4","GOAL_LIST_PERFOMING_5","GOAL_LIST_PERFOMING_6","GOAL_LIST_PERFOMING_7","GOAL_LIST_PERFOMING_8","GOAL_LIST_PERFOMING_9","GOAL_LIST_PERFOMING_10","GOAL_LIST_PERFOMING_11"],["GOAL_LIST_TRANSPORTATION_1","GOAL_LIST_TRANSPORTATION_2","GOAL_LIST_TRANSPORTATION_3","GOAL_LIST_TRANSPORTATION_4","GOAL_LIST_TRANSPORTATION_5","GOAL_LIST_TRANSPORTATION_6","GOAL_LIST_TRANSPORTATION_7","GOAL_LIST_TRANSPORTATION_8","GOAL_LIST_TRANSPORTATION_9","GOAL_LIST_TRANSPORTATION_10"],["GOAL_LIST_RELAX_1","GOAL_LIST_RELAX_2","GOAL_LIST_RELAX_3","GOAL_LIST_RELAX_4","GOAL_LIST_RELAX_5","GOAL_LIST_RELAX_6","GOAL_LIST_RELAX_7","GOAL_LIST_RELAX_8","GOAL_LIST_RELAX_9","GOAL_LIST_RELAX_10","GOAL_LIST_RELAX_11","GOAL_LIST_RELAX_12","GOAL_LIST_RELAX_13","GOAL_LIST_RELAX_14","GOAL_LIST_RELAX_15","GOAL_LIST_RELAX_16","GOAL_LIST_RELAX_17"],["GOAL_LIST_WILDCARDS_1","GOAL_LIST_WILDCARDS_2","GOAL_LIST_WILDCARDS_3","GOAL_LIST_WILDCARDS_4","GOAL_LIST_WILDCARDS_5","GOAL_LIST_WILDCARDS_6","GOAL_LIST_WILDCARDS_7","GOAL_LIST_WILDCARDS_8","GOAL_LIST_WILDCARDS_9","GOAL_LIST_WILDCARDS_10","GOAL_LIST_WILDCARDS_11","GOAL_LIST_WILDCARDS_12","GOAL_LIST_WILDCARDS_13","GOAL_LIST_WILDCARDS_14","GOAL_LIST_WILDCARDS_15","GOAL_LIST_WILDCARDS_16","GOAL_LIST_WILDCARDS_17"],["GOAL_LIST_LIFE_STEPS_1","GOAL_LIST_LIFE_STEPS_2","GOAL_LIST_LIFE_STEPS_3","GOAL_LIST_LIFE_STEPS_4","GOAL_LIST_LIFE_STEPS_5","GOAL_LIST_LIFE_STEPS_6","GOAL_LIST_LIFE_STEPS_7","GOAL_LIST_LIFE_STEPS_8","GOAL_LIST_LIFE_STEPS_9","GOAL_LIST_LIFE_STEPS_10","GOAL_LIST_LIFE_STEPS_11","GOAL_LIST_LIFE_STEPS_12","GOAL_LIST_LIFE_STEPS_13","GOAL_LIST_LIFE_STEPS_14","GOAL_LIST_LIFE_STEPS_15","GOAL_LIST_LIFE_STEPS_16"],["GOAL_LIST_PLEASANT_ACTIVITIES_1","GOAL_LIST_PLEASANT_ACTIVITIES_2","GOAL_LIST_PLEASANT_ACTIVITIES_3","GOAL_LIST_PLEASANT_ACTIVITIES_4","GOAL_LIST_PLEASANT_ACTIVITIES_5","GOAL_LIST_PLEASANT_ACTIVITIES_6","GOAL_LIST_PLEASANT_ACTIVITIES_7","GOAL_LIST_PLEASANT_ACTIVITIES_8","GOAL_LIST_PLEASANT_ACTIVITIES_9","GOAL_LIST_PLEASANT_ACTIVITIES_10","GOAL_LIST_PLEASANT_ACTIVITIES_11","GOAL_LIST_PLEASANT_ACTIVITIES_12","GOAL_LIST_PLEASANT_ACTIVITIES_13","GOAL_LIST_PLEASANT_ACTIVITIES_14","GOAL_LIST_PLEASANT_ACTIVITIES_15","GOAL_LIST_PLEASANT_ACTIVITIES_16"]]},f}]),(servicesModule=angular.module("groupsService",[])).factory("GroupsService",["$timeout","authHttp","Environment","AccountService","GeneralService","StorageService","FeedService","$q","$translate","$ionicModal","ActivityService","OverlayService","$analytics",function(r,s,c,l,u,d,n,e,p,t,m,f,T){var g={userGroupContext:void 0,publicGroupContext:void 0,publicGroupsById:{},profileLikes:void 0,profileShares:void 0,profileComments:void 0,lastActiveTab:void 0,nextAllowedPosts:{},nextAllowedComments:{},nextUserGroupUpdate:void 0,nextPublicGroupUpdate:void 0,nextProfileSharesUpdate:void 0,lastProfileSharesOffset:0,nextProfileLikesUpdate:void 0,lastProfileLikesOffset:0,nextProfileCommentsUpdate:void 0,nextProfileCommentsOffset:0,logout:function(){g.userGroupContext=void 0,g.publicGroupContext=void 0,g.publicGroupsById={},g.profileLikes=void 0,g.profileShares=void 0,g.nextUserGroupUpdate=void 0,g.nextPublicGroupUpdate=void 0,g.nextProfileSharesUpdate=void 0,g.lastProfileSharesOffset=0,g.nextProfileLikesUpdate=void 0,g.lastProfileLikesOffset=0,g.nextProfileCommentsUpdate=void 0,g.nextProfileCommentsOffset=0,g.lastActiveTab=void 0}},i=function(e){e&&(g.nextAllowedPosts=JSON.parse(e))};g.initFromLocalStorage=function(){d.getItem("userGroupContext",function(e){e&&(g.userGroupContext=e)}),c.isStorageAllowed()?d.getItem("nextAllowedPosts",i):d.getInsecureItem("nextAllowedPosts",i),d.getItem("nextAllowedComments",function(e){e&&(g.nextAllowedComments=JSON.parse(e))}),d.getItem("lastActiveGroupsTab",function(e){e&&(g.lastActiveTab=e)})},g.getLastActiveTab=function(){return g.lastActiveTab},g.setLastActiveTab=function(e){g.lastActiveTab=e,d.setItem("lastActiveGroupsTab",e),e},g.findPublicGroupName=function(e){var t=g.publicGroupsById[e];return t?t.name:void 0},g.findPublicGroups=function(e){var o=createPromise();return e||!g.publicGroupContext||!g.nextPublicGroupUpdate||g.nextPublicGroupUpdate<new Date?s.get(c.serverURL+"/groups/public").success(function(e){if(g.publicGroupContext=e,g.publicGroupContext.publicGroups)for(var t=0;t<g.publicGroupContext.publicGroups.length;++t){var i=g.publicGroupContext.publicGroups[t];g.publicGroupsById[i.id]=i}g.publicGroupContext.nextAllowedPostStr&&(g.nextAllowedPost=new Date(g.publicGroupContext.nextAllowedPostStr)),g.nextPublicGroupUpdate=new Date((new Date).getTime()+3e5),o.successCallback&&o.successCallback(e)}).error(function(e,t,i,n){T.addEventAppsee("errorTriggered","findPublicGroups"),console.log("Error retrieving communities: "+e),o.errorCallback&&o.errorCallback()}):r(function(){o.successCallback&&o.successCallback(g.publicGroupContext)}),o},g.getCachedUserGroups=function(){return g.userGroupContext},g.findUserGroups=function(e){var o=createPromise();return e||!g.userGroupContext||!g.nextUserGroupUpdate||g.nextUserGroupUpdate<new Date?s.get(c.serverURL+"/groups/user").success(function(e){g.userGroupContext=e,g.nextUserGroupUpdate=new Date((new Date).getTime()+6e4),console.log("got user group context:"),console.log(e),o.successCallback&&o.successCallback(e)}).error(function(e,t,i,n){T.addEventAppsee("errorTriggered","findUserGroups"),console.log("Error retrieving user groups: "+e),o.errorCallback&&o.errorCallback()}):(r(function(){o.successCallback&&o.successCallback(g.userGroupContext)}),s.get(c.serverURL+"/groups/invites").success(function(e){g.userGroupContext&&(g.userGroupContext.pendingInvites.length=0,g.userGroupContext.pendingInvites.push.apply(g.userGroupContext.pendingInvites,e))}).error(function(e,t,i,n){console.log("Error retrieving user invites: "+e)})),o};var o,a={},A={};function E(){var e=l.getUserNotification();if(e.groupNotificationCount=0,e.communityNotificationCount=0,e){if(e.postNotifications)for(var t in e.postNotifications){var i=e.postNotifications[t];i&&(e.communityNotificationCount+=i.actions)}if(e.groupNotifications)for(var n in e.groupNotifications){var o=e.groupNotifications[n];o&&(e.groupNotificationCount+=o.actions)}}}function I(e,t,i){var n=e.curatedGroups[t];n||(n=[],e.curatedCategories.push(t),e.curatedGroups[t]=n),n.push(i)}g.storeCachedPost=function(e,t,i){a[e.id]=e,A=t,o=i},g.getCachedPost=function(e){return a[e]},g.getCachedPostData=function(e){return A?A[e]:void 0},g.getCachedUserVotes=function(){return o},g.setUserGroupsContext=function(e){var t;(g.userGroupContext=e)&&d.setItem("userGroupContext",JSON.stringify(t))},g.getGroupImmediate=function(e){for(var t=g.userGroupContext.userGroups,i=0;i<t.length;++i){var n=t[i];if(n.id==e)return n}for(var o=0;o<g.publicGroupContext.publicGroups.length;++o){var a=g.publicGroupContext.publicGroups[o];if(a.id==e)return a}},g.getGroup=function(n){var o=createPromise();function t(){var e=g.userGroupContext.userGroups;if(e)for(var t=0;t<e.length;++t){var i=e[t];if(i.id==n){o.successCallback&&o.successCallback(i);break}}}function i(){for(var e=0;e<g.publicGroupContext.publicGroups.length;++e){var t=g.publicGroupContext.publicGroups[e];if(t.id==n){o.successCallback&&o.successCallback(t);break}}}return g.userGroupContext?r(t):g.findUserGroups().success(function(e){t()}).error(function(){o.errorCallback&&o.errorCallback()}),g.publicGroupContext&&g.publicGroupContext.publicGroups?r(i):g.findPublicGroups().success(function(e){i()}).error(function(){o.errorCallback&&o.errorCallback()}),o},g.getClinicianChatGroup=function(n){var o=e.defer();return g.findUserGroups().success(function(e){var t=e.userGroups,i=_.first(_.filter(t,function(e){var t="CLIENT"===e.groupType,i=e.creatorId===n.userId;return t&&i}));o.resolve(i)}).error(function(){o.reject("failed to retrieve user groups")}),o.promise},g.getGroupPost=function(e){return s.get(c.serverURL+"/groups/post?postId="+e)},g.findGroupPostComments=function(e,t,i,n){return s.get(c.serverURL+"/groups/posts/comments/?postId="+e+"&order="+t+"&limit="+i+"&offset="+n)},g.findGroupPosts=function(e,t,i,n){return s.get(c.serverURL+"/groups/posts?groupId="+e.id+"&order="+t+"&limit="+i+"&offset="+n)},g.findHopePosts=function(){var n=e.defer();return g.findUserGroups().success(function(e){var t=e.userGroups,i=_.filter(t,function(e){return"Hope Feed"==e.name})[0];g.findGroupPosts(i,null,100,0).success(function(e){n.resolve(e)})}),n.promise},g.completedHopePostToday=function(e){var t=new Date(e.createdAt);return u.getDayString(t)==u.getTodayString()},g.findNewerPosts=function(e,t){return s.get(c.serverURL+"/groups/posts/newer?groupId="+e.id+"&lastTime="+t.getTime())},g.canCreatePublicGroupPost=function(e){var t=g.nextAllowedPosts[e.id];return"string"==typeof t&&(t=new Date(t)),!t||new Date>t},g.canCreatePublicComment=function(e){var t=g.nextAllowedComments[e];return"string"==typeof t&&(t=new Date(t)),!t||new Date>t},g.getBinaryURL=function(e){return s.get(c.serverURL+"/groups/binaryPostURL?type="+e)},g.editComment=function(e,t){var o=createPromise(),i={postCommentId:e,title:t};return s.post(c.serverURL+"/groups/post/comment",i).success(function(e){o.successCallback&&o.successCallback(e)}).error(function(e,t,i,n){T.addEventAppsee("errorTriggered","editComment"),o.errorCallback&&o.errorCallback()}),o},g.postComment=function(e,n,t){var o=createPromise(),i={postId:e,groupId:n,title:t};return s.post(c.serverURL+"/groups/post/comment",i).success(function(e){var t,i;t=n,i=new Date((new Date).getTime()+3e5),g.nextAllowedComments[t]=i,d.setItem("nextAllowedComments",JSON.stringify(g.nextAllowedComments)),o.successCallback&&o.successCallback(e)}).error(function(e,t,i,n){T.addEventAppsee("errorTriggered","postComment"),o.errorCallback&&o.errorCallback()}),o},g.createGroupPost=function(i,e,t,n){var a=createPromise(),o={groupId:i,title:e,postData:t||[]};return n&&(o.postId=n),s.post(c.serverURL+"/groups/post",o).success(function(e){var t=g.getGroupImmediate(i);t.private||"PERSONAL"===t.groupType||(g.publicGroupContext.userShares++,g.profileShares=void 0,function(e){var t=new Date((new Date).getTime()+9e5);g.nextAllowedPosts[e.id]=t;var i=JSON.stringify(g.nextAllowedPosts);c.isStorageAllowed()?d.setItem("nextAllowedPosts",i):d.storeInsecureItem("nextAllowedPosts",i)}(t),"COMMUNITY"==t.groupType&&m.recordActivity("POSTED_TO_COMMUNITY")),a.successCallback&&a.successCallback(e)}).error(function(e,t,i,n){var o;"undefined"!=typeof group&&group.groupType&&(o=group.groupType),T.addEventAppsee("errorTriggered","errorCreatingGroupPost",o),a.errorCallback&&a.errorCallback()}),a},g.archiveComment=function(e){return s.post(c.serverURL+"/groups/post/comment/archive",{postCommentId:e})},g.archivePost=function(e){var o=createPromise();return s.post(c.serverURL+"/groups/post/archive",{postId:e}).success(function(e){g.profileShares=void 0,o.successCallback&&o.successCallback(e)}).error(function(e,t,i,n){T.addEventAppsee("errorTriggered","archivePost"),o.errorCallback&&o.errorCallback()}),o},g.reportPost=function(e,t,i){var o=createPromise();return s.post(c.serverURL+"/groups/post/report",{postId:e,reason:t,refer:i}).success(function(e){g.profileLikes=void 0,o.successCallback&&o.successCallback(e)}).error(function(e,t,i,n){T.addEventAppsee("errorTriggered","reportPostError"),o.errorCallback&&o.errorCallback(e)}),o},g.reportComment=function(e,t,i){return s.post(c.serverURL+"/groups/post/comment/report",{postCommentId:e,reason:t,refer:i})},g.archiveGroup=function(t){var o=createPromise();return s.post(c.serverURL+"/groups/archive",{groupId:t}).success(function(){if(g.userGroups)for(var e=0;e<g.userGroups.length;++e){if(g.userGroups[e].id==t){g.userGroups.splice(e,1);break}}o.successCallback&&o.successCallback()}).error(function(e,t,i,n){T.addEventAppsee("errorTriggered","archiveGroup"),console.log("Error editing group: "+e),o.errorCallback&&o.errorCallback()}),o},g.editGroup=function(t,i,n,o,a){var r=createPromise();return s.post(c.serverURL+"/groups/edit",{groupId:t,name:i,nickname:n,description:o,searchable:a}).success(function(){var e=g.getGroupImmediate(t);e.name=i,e.nickname=n,e.description=o,e.searchable=a,r.successCallback&&r.successCallback(e)}).error(function(e,t,i,n){console.log("Error editing group: "+e),r.errorCallback&&r.errorCallback(e,t,i,n)}),r},g.editGroupNickname=function(t,i){var o=createPromise();return s.post(c.serverURL+"/groups/editNickname",{groupId:t,nickname:i}).success(function(){var e=g.getGroupImmediate(t);e.nickname=i,o.successCallback&&o.successCallback(e)}).error(function(e,t,i,n){console.log("Error editing nickname: "+e),o.errorCallback&&o.errorCallback(e,t,i,n)}),o},g.createGroup=function(e,t,i,n){var o=createPromise();return s.post(c.serverURL+"/groups/create",{name:e,nickname:t,description:i,searchable:n}).success(function(e){g.userGroupContext.userGroups||(g.userGroupContext.userGroups=[]),g.userGroupContext.userGroups.push(e),o.successCallback&&o.successCallback(e)}).error(function(e,t,i,n){console.log("Error creating group: "+e),o.errorCallback&&o.errorCallback(e,t,i,n)}),o},g.isFeaturedInFeed=function(e){return e&&n.hasItemOfType("community")&&n.getItemOfType("community").post.id===e.id},g.removeVote=function(e){var t=createPromise();return s.post(c.serverURL+"/groups/post/removeVote",{postId:e.id}).success(function(){g.profileLikes=void 0,n.hasItemOfType("community")&&n.getItemOfType("community").post.id===e.id&&n.voteLocalCommunityPost("remove"),t.successCallback&&t.successCallback()}).error(function(){t.errorCallback&&t.errorCallback()}),t},g.voteUp=function(e,t){var i=createPromise();return s.post(c.serverURL+"/groups/post/voteUp",{postId:e,groupId:t}).success(function(){g.profileLikes=void 0,n.hasItemOfType("community")&&n.getItemOfType("community").post.id===e&&n.voteLocalCommunityPost("up"),i.successCallback&&i.successCallback()}).error(function(){i.errorCallback&&i.errorCallback()}),i},g.clearAllPostNotifications=function(){var e=l.getUserNotification();e&&e.postNotifications&&s.post(c.serverURL+"/groups/post/clearAllNotifications").success(function(){e.postNotifications.cleared=!0}).error(function(){console.log("error clearing all post notification")})},g.clearPostNotification=function(e){var t=l.getUserNotification();t&&t.postNotifications&&(t.postNotifications[e]&&s.post(c.serverURL+"/groups/post/clearNotification",{postId:e}).success(function(){delete t.postNotifications[e],E()}).error(function(){console.log("error clearing post notification")}))},g.clearAllGroupNotifications=function(){var e=l.getUserNotification();e&&e.groupNotifications&&s.post(c.serverURL+"/groups/group/clearAllNotifications").success(function(){e.groupNotifications.cleared=!0}).error(function(){console.log("error clearing group notification")})},g.clearGroupNotification=function(e,t){var i=l.getUserNotification();i&&i.groupNotifications&&(i.groupNotifications[e]&&s.post(c.serverURL+"/groups/group/clearNotification",{groupId:e}).success(function(){delete i.groupNotifications[e],E(),t&&t()}).error(function(){console.log("error clearing group notification")}))},g.hasPostNotification=function(e){return 0<g.getPostNotificationCount(e)},g.getPostNotificationCount=function(e){var t=l.getUserNotification();if(t.postNotifications){if(!e){if(t.postNotifications.cleared)return 0;var i=0;for(var n in t.postNotifications){i+=t.postNotifications[n].actions}return i}var o=t.postNotifications[e];if(o)return o.actions}return 0},g.hasGroupNotification=function(e){var t=l.getUserNotification();return!!t.groupNotifications&&!!t.groupNotifications[e]},g.getGroupNotificationCount=function(e){var t=l.getUserNotification();if(t.groupNotifications){if(!e){if(t.groupNotifications.cleared)return 0;var i=0,n=_.filter(t.groupNotifications,function(e){var t=e.groupId;return"CLIENT"!=g.getGroupImmediate(t).groupType});for(var o in n){var a=t.groupNotifications[o];a&&(i+=a.actions)}return i}var r=t.groupNotifications[e];if(r)return r.actions}return 0},g.removeCommentVote=function(e){return s.post(c.serverURL+"/groups/post/comment/removeVote",{postCommentId:e.id})},g.voteCommentUp=function(e,t,i){return s.post(c.serverURL+"/groups/post/comment/voteUp",{postCommentId:e,postId:t,groupId:i})},g.inviteExistingUser=function(e,t,i){return s.post(c.serverURL+"/groups/inviteExistingUser",{groupId:e,userId:t,text:i})},g.sendInvites=function(e,t,i){return s.post(c.serverURL+"/groups/sendInvites",{groupId:e,emails:t,text:i})},g.acceptInvite=function(e,t){return s.post(c.serverURL+"/groups/acceptInvite",{groupId:e,nickname:t})},g.joinGroup=function(e,t){return s.post(c.serverURL+"/groups/joinGroup",{groupCode:e,nickname:t})},g.joinRandomGroup=function(e,t){return s.post(c.serverURL+"/groups/joinRandomGroup",{goal:e,language:t})},g.deleteInvite=function(e,t){var i={groupId:e};return t&&(i.email=t),s.post(c.serverURL+"/groups/deleteInvite",i)},g.leaveGroup=function(t){var o=createPromise();return s.post(c.serverURL+"/groups/leave",{groupId:t}).success(function(){if(g.userGroupContext.userGroups)for(var e=0;e<g.userGroupContext.userGroups.length;++e){if(g.userGroupContext.userGroups[e].id==t){g.userGroupContext.userGroups.splice(e,1);break}}o.successCallback&&o.successCallback()}).error(function(e,t,i,n){T.addEventAppsee("errorTriggered","leaveGroup"),console.log("Error editing group: "+e),o.errorCallback&&o.errorCallback()}),o},g.getShares=function(e,t,i){var o=createPromise();if(i||!g.profileShares||g.lastProfileSharesOffset!=t||!g.nextProfileSharesUpdate||g.nextProfileSharesUpdate<new Date){g.lastProfileSharesOffset=t;var n=c.serverURL+"/groups/shares?limit="+e+"&offset="+t;i&&(n+="&userId="+i),s.get(n).success(function(e){i||(g.profileShares=e,g.nextProfileSharesUpdate=new Date((new Date).getTime()+3e5)),o.successCallback&&o.successCallback(e)}).error(function(e,t,i,n){T.addEventAppsee("errorTriggered","getShares"),console.log("Error retrieving user groups: "+e),o.errorCallback&&o.errorCallback()})}else r(function(){o.successCallback&&o.successCallback(g.profileShares)});return o},g.getUserLikes=function(e){if(!e||0===e.length)return createPromise();for(var t=c.serverURL+"/groups/userLikes?ids=",i=0;i<e.length;++i)0<i&&(t+="&ids="),t+=e[i].id;return s.get(t)},g.getUserCommentLikes=function(e){if(!e||0===e.length)return createPromise();for(var t=c.serverURL+"/groups/userCommentLikes?ids=",i=0;i<e.length;++i)0<i&&(t+="&ids="),t+=e[i].id;return s.get(t)},g.getLikes=function(e,t,i){var o=createPromise();if(i||!g.profileLikes||g.lastProfileLikesOffset!=t||!g.nextProfileLikesUpdate||g.nextProfileLikesUpdate<new Date){g.lastProfileLikesOffset=t;var n=c.serverURL+"/groups/likes?limit="+e+"&offset="+t;i&&(n+="&userId="+i),s.get(n).success(function(e){i||(g.profileLikes=e,g.nextProfileLikesUpdate=new Date((new Date).getTime()+6e4)),o.successCallback&&o.successCallback(e)}).error(function(e,t,i,n){T.addEventAppsee("errorTriggered","getLikes"),console.log("Error retrieving user groups: "+e),o.errorCallback&&o.errorCallback()})}else r(function(){o.successCallback&&o.successCallback(g.profileLikes)});return o},g.getComments=function(e,t,i,n){var o=createPromise();if(n||i||!g.profileComments||g.lastProfileCommentsOffset!=t||!g.nextProfileCommentsUpdate||g.nextProfileCommentsUpdate<new Date){g.lastProfileCommentsOffset=t;var a=c.serverURL+"/groups/comments?limit="+e+"&offset="+t;i&&(a+="&userId="+i),s.get(a).success(function(e){i||(g.profileComments=e,g.nextProfileCommentsUpdate=new Date((new Date).getTime()+6e4)),o.successCallback&&o.successCallback(e)}).error(function(e,t,i,n){T.addEventAppsee("errorTriggered","getComments"),console.log("Error retrieving user groups: "+e),o.errorCallback&&o.errorCallback()})}else r(function(){o.successCallback&&o.successCallback(g.profileComments)});return o},g.getGroupUsers=function(e){return s.get(c.serverURL+"/groups/users?groupId="+e)},g.removeUser=function(e,t){return s.post(c.serverURL+"/groups/removeUser",{groupId:e,userId:t})},g.findCuratedGroups=function(){return s.get(c.serverURL+"/groups/curated")},g.initializeCuratedGroups=function(e,t){e.curatedGroups=void 0,e.curatedCategories=[];var i=g.userGroupContext?g.userGroupContext.userGroups:void 0;if(t&&0<t.length){e.curatedGroups={};for(var n=0;n<t.length;++n){var o=t[n],a=!1;if(i)for(var r=0;r<i.length;++r)if(i[r].id==o.id){a=!0;break}if(!a)if(o.curatedCategories){var s=o.curatedCategories.split(";");if(0<s.length)for(var c=0;c<s.length;++c)I(e,s[c],o)}else I(e,"Other",o)}if(0<e.curatedCategories.length)for(var l in e.curatedCategories.sort(),e.curatedGroups){e.curatedGroups[l].sort(function(e,t){return e.name.localeCompare(t.name)})}}};var v=0;function S(e,t){var i=$("#groupName").val();i&&(i=i.trim());var n=$("#groupNickname").val();return n&&(n=n.trim()),!t||i&&0!==i.length?n&&0!==n.length?!/^[a-z0-9]+$/i.test(n)&&(e.groupError=p.instant("LOGIN_ERROR_ALPHANUMERIC_NAME"),!0):(e.groupError=p.instant("CREATE_GROUP_NO_NICKNAME"),!0):(e.groupError=p.instant("CREATE_GROUP_NO_NAME"),!0)}return g.searchForGroup=function(e){++v;var o=createPromise();return s.get(c.serverURL+"/groups/search?query="+e+"&searchId="+v).success(function(e){e.searchId==v&&o.successCallback&&o.successCallback(e.groups)}).error(function(e,t,i,n){T.addEventAppsee("errorTriggered","groupsSearch"),console.log("Error searching for groups: "+e),o.errorCallback&&o.errorCallback()}),o},g.initInviteFunctionality=function(r,s){r.sendingInvites=!1,r.closeInviteModal=function(){f.modal.close(r.inviteModal).then(function(e){r.inviteModal=e})},r.sendInvite=function(){var e=$("#inviteEmails").val().trim(),t=$("#inviteText").val().trim();if(e&&0!==e.length)if(t&&0!==t.length){for(var i=s.getAccountUser().user.email,n=e.split(","),o=0;o<n.length;++o){var a=n[o].trim();if(!u.isEmailValid(a)||a==i)return void(r.inviteError=p.instant("INVITE_ERROR_INVALID_EMAIL"));n[o]=a}r.sendingInvites=!0,g.sendInvites(r.group.id,n,t).success(function(){if(s.setUserPreference("sent_group_invitation","true"),r.sendingInvites=!1,r.closeInviteModal(),r.pendingInvites)for(var e=0;e<n.length;++e)r.pendingInvites.push({userGroup:r.group,email:n[e],createdAtStr:(new Date).toString()});f.popup.alert({template:p.instant("SEND_INVITE_SUCCESS"),okText:p.instant("OK_GOT_IT"),okType:"button-default"})}).error(function(){r.sendingInvites=!1,T.addEventAppsee("errorTriggered","groupInvite");f.popup.alert({template:p.instant("SEND_INVITE_ERROR"),okText:p.instant("OK_GOT_IT"),okType:"button-default"})})}else r.inviteError=p.instant("INVITE_ERROR_MISSING_TEXT");else r.inviteError=p.instant("INVITE_ERROR_MISSING_EMAIL")},r.showInvite=function(){r.mobile?f.actionSheet.show({buttons:[{text:p.instant("INVITE_VIA_EMAIL")},{text:p.instant("INVITE_VIA_SMS")}],titleText:p.instant("INVITE_TO_GROUP_TITLE"),cancelText:p.instant("CANCEL"),cancel:function(){},buttonClicked:function(e){var t=p.instant("INVITE_TEXT")+" "+r.group.code+".",i=p.instant("DOWNLOAD_PACIFICA");return 0===e?window.plugins.socialsharing.shareViaEmail(t+"\n\n"+i,p.instant("INVITE_EMAIL_SUBJECT"),null,null,null,null,function(e){console.log("ok: "+e)},function(e){T.addEventAppsee("errorTriggered","emailInvite"),f.popup.alert({template:p.instant("INVITE_EMAIL_ERROR"),okText:p.instant("OK_GOT_IT"),okType:"button-default"})}):1==e&&window.plugins.socialsharing.shareViaSMS(t+" "+i,null,function(e){console.log("ok: "+e)},function(e){T.addEventAppsee("errorTriggered","smsInvite"),f.popup.alert({template:p.instant("INVITE_SMS_ERROR"),okText:p.instant("OK_GOT_IT"),okType:"button-default"})}),!0}}):window.location="mailto:?subject="+p.instant("INVITE_EMAIL_SUBJECT")+"&body="+p.instant("INVITE_TEXT")+" "+r.group.code+"."},r.selectGroupForInvite=function(e){r.selectedGroupForInvite=e},r.isGroupSelectedForInvite=function(e){return r.selectedGroupForInvite==e},r.closeSelectGroupForInviteModal=function(){f.modal.close(r.selectGroupModal).then(function(e){r.selectGroupModal=e})},r.checkSelectGroupForInvite=function(){r.selectedGroupForInvite?(r.inviteExistingError=void 0,r.showInviteExistingUser()):r.inviteExistingError=p.instant("SELECT_GROUP_MISSING")},r.inviteExistingUser=function(){var e=$("#inviteText").val().trim();e&&0!==e.length?(r.sendingInvites=!0,g.inviteExistingUser(r.selectedGroupForInvite.id,r.invitingUserId,e).success(function(){s.setUserPreference("sent_group_invitation","true"),r.sendingInvites=!1,r.closeInviteExistingUserModal();f.popup.alert({template:p.instant("SEND_INVITE_SUCCESS"),okText:p.instant("OK_GOT_IT"),okType:"button-default"})}).error(function(){r.sendingInvites=!1,T.addEventAppsee("errorTriggered","inviteExisting");f.popup.alert({template:p.instant("SEND_INVITE_ERROR"),okText:p.instant("OK_GOT_IT"),okType:"button-default"})})):r.inviteError=p.instant("INVITE_ERROR_MISSING_TEXT")},r.closeInviteExistingUserModal=function(){f.modal.close(r.inviteExistingUserModal).then(function(e){r.inviteExistingUserModal=e})},r.showInviteExistingUser=function(){r.selectGroupModal&&r.closeSelectGroupForInviteModal(),f.modal.open({modalId:"InviteExistingUserModal",templateUrl:"views/groups/groups.inviteExistingUser.modal.html",scope:r,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){r.inviteExistingUserModal=e})}},g.initEditFunctionality=function(s){s.closeEditGroupModal=function(){f.modal.close(s.editGroupModal).then(function(e){s.editGroupModal=e})},s.editGroup=function(){var o=s.isOwnerById(s.editGroupId);if(!S(s,o)){s.groupError=void 0;var a=s.newGroupData.name,r=s.newGroupData.nickname,e=s.newGroupData.searchable,t=e?s.newGroupData.description:void 0;a=a.trim(),r=r.trim(),t&&""===t.trim()&&(t=void 0);var i=function(){s.editingGroup=!1;var e=g.getGroupImmediate(s.editGroupId);if(o&&(e.name=a),e.nickname=r,s.groupPosts)for(var t=l.getAccountUser().user,i=0;i<s.groupPosts.length;++i){var n=s.groupPosts[i];n.creatorId==t.id&&(n.creatorNickname=r)}s.closeEditGroupModal()},n=function(e,t,i,n){s.editingGroup=!1,409==t?f.popup.alert({template:p.instant("GROUP_CONFLICT_ERROR"),okText:p.instant("OK_GOT_IT"),okType:"button-default"}):(T.addEventAppsee("errorTriggered","updateGroup"),f.popup.alert({template:p.instant("UPDATE_GROUP_ERROR"),okText:p.instant("OK_GOT_IT"),okType:"button-default"}))};s.editingGroup=!0,o?g.editGroup(s.editGroupId,a,r,t,e).success(i).error(n):g.editGroupNickname(s.editGroupId,r).success(i).error(n)}},s.showEditGroup=function(e,t){var i;(e.stopPropagation(),e.preventDefault(),s.checkOfflineMode())||(s.newGroupData={nickname:t.nickname,name:t.name,description:t.description,searchable:t.searchable},s.editGroupId=t.id,s.groupError=void 0,i=s.mobile?"views/groups/groups.editGroup.modal.html":"templates/groups/groups.editGroup.modal.html",f.modal.open({modalId:"EditGroupModal",templateUrl:i,scope:s,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){s.editGroupModal=e}))}},g.initEditNicknameFunctionality=function(r){r.closeNicknameModal=function(){f.modal.close(r.nicknameModal).then(function(e){r.nicknameModal=e})},r.updatePublicNickname=function(){var a=$("#updateUserNickname").val().trim();a&&0!==a.length?/^[a-z0-9]+$/i.test(a)?(r.nicknameError=void 0,r.updatingNickname=!0,l.setPublicNickname(a).success(function(){r.updatingNickname=!1,r.user&&!r.viewingOtherUser&&(r.user.publicName=a),l.updateLocalPublicNickname(a);var e=l.getAccountUser().user.id;if(r.group&&r.groupPosts&&"COMMUNITY"==r.group.groupType)for(var t=0;t<r.groupPosts.length;++t){var i=r.groupPosts[t];i.creatorId==e&&(i.creatorNickname=a)}if(r.shares)for(var n=0;n<r.shares.length;++n){var o=r.shares[n];o.creatorId==e&&(o.creatorNickname=a)}r.attemptingCommunityPost&&r.showCreatePost(),r.closeNicknameModal()}).error(function(e,t,i,n){r.updatingNickname=!1,r.nicknameError=p.instant("UPDATE_NICKNAME_ERROR")})):r.nicknameError=p.instant("LOGIN_ERROR_ALPHANUMERIC_NAME"):r.nicknameError=p.instant("LOGIN_ERROR_MISSING_NAME")},r.showUpdateNickname=function(){var e;r.nicknameModal||(l.setUserPreference("viewed_communities_popup",!0),r.originalNickname=l.getAccountUser().user.publicName,e=r.mobile?"views/groups/groups.updateNickname.modal.html":"templates/community/community.updateNickname.modal.html",f.modal.open({modalId:"UpdateNicknameModal",templateUrl:e,scope:r,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){r.nicknameModal=e}))}},g.initValidateEmailFunctionality=function(i){i.closeEmailValidationPopup=function(){f.modal.close(i.emailValidationModal).then(function(e){i.emailValidationModal=e})},i.checkRemoteEmailValidation=function(t){l.checkRemoteEmailValidation().success(function(e){e.validated?l.getAccountUser().user.emailVerifiedAt=new Date:i.showEmailValidationPopup(),t&&t(e.validated)}).error(function(){T.addEventAppsee("errorTriggered","checkRemoteEmailValidation"),f.popup.alert({template:p.instant("GENERIC_ERROR"),okText:p.instant("OK_GOT_IT"),okType:"button-default"})})},i.showEmailValidationPopup=function(){var e;e=i.mobile?($("#postText").blur(),"views/groups/groups.validateEmail.modal.html"):"templates/groups/groups.validateEmail.modal.html",f.modal.open({modalId:"EmailValidationModal",templateUrl:e,scope:i,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){i.emailValidationModal=e})},i.isUserEmailValidated=function(){return l.isEmailValidated()},i.resendValidationEmail=function(){l.resendValidationEmail().success(function(){i.closeEmailValidationPopup(),r(function(){f.popup.alert({template:p.instant("VALIDATION_EMAIL_SENT"),okText:p.instant("OK_GOT_IT"),okType:"button-default"})},500)}).error(function(e,t,i,n){T.addEventAppsee("errorTriggered","resendValidationEmail");f.popup.alert({template:p.instant("GENERIC_ERROR"),okText:p.instant("OK_GOT_IT"),okType:"button-default"})})}},g.initCreateGroupFunctionality=function(o){o.closeCreateGroupModal=function(){f.modal.close(o.createGroupModal).then(function(e){o.createGroupModal=e})},o.isNewGroupPublic=function(){return o.newGroupData.searchable},o.createGroup=function(){if(!S(o,!0)){var e=o.newGroupData.name,t=o.newGroupData.nickname,i=o.newGroupData.searchable,n=i?o.newGroupData.description:void 0;e=e.trim(),t=t.trim(),n&&""===n.trim()&&(n=void 0),o.groupError=void 0,o.creatingGroup=!0,g.createGroup(e,t,n,i).success(function(e){o.creatingGroup=!1,o.userGroups=void 0,o.loadGroups&&o.loadGroups(!0),o.closeCreateGroupModal(),o.invitingUserId&&(o.selectedGroupForInvite=e,o.showInviteExistingUser())}).error(function(e,t,i,n){o.creatingGroup=!1,409==t?f.popup.alert({template:p.instant("GROUP_CONFLICT_ERROR"),okText:p.instant("OK_GOT_IT"),okType:"button-default"}):(T.addEventAppsee("errorTriggered","createGroupEr"),f.popup.alert({template:p.instant("CREATE_GROUP_ERROR"),okText:p.instant("OK_GOT_IT"),okType:"button-default"}))})}},o.closeChooseRandomGroupModal=function(){f.modal.close(o.chooseRandomGroupModal).then(function(e){o.chooseRandomGroupModal=e})},o.joinRandomGroup=function(e){o.chooseRandomGroupModal&&("depression"==e?e=p.instant("NUX_GOAL_DEPRESSION"):"gad"==e?e=p.instant("NUX_GOAL_GAD"):"social"==e?e=p.instant("NUX_GOAL_SOCIAL"):"health"==e&&(e=p.instant("NUX_GOAL_HEALTH")),o.closeChooseRandomGroupModal()),g.joinRandomGroup(e,l.getUserPreference("preferred_locale")).success(function(e){o.userGroups=void 0,o.loadGroups(!0)}).error(function(){f.popup.alert({template:p.instant("ERROR_JOINING_RANDOM_GROUP"),okText:p.instant("OK_GOT_IT"),okType:"button-default"})})}},g}]);servicesModule=angular.module("habitsService",[]);var MILLISECONDS_IN_HOUR=36e5,MILLISECONDS_IN_DAY=24*MILLISECONDS_IN_HOUR;servicesModule.factory("HabitsService",["$rootScope","$timeout","$translate","authHttp","Environment","GeneralService","AccountService","StorageService","PathService","ActivityService","OverlayService","$analytics",function(e,l,u,d,p,T,m,f,g,A,i,o){var E=!1,n=!1,I={accountHabits:[],accountHabitValues:[],potentialHabits:[],habitData:{},offlineHabitData:[],recentFeelings:[],MOOD_HABIT_ID:1,SLEEP_HABIT_ID:2,EXERCISE_HABIT_ID:3,EATING_HABIT_ID:4,WATER_HABIT_ID:5,CAFFEINE_HABIT_ID:6,ALCOHOL_HABIT_ID:7,OUTDOORS_HABIT_ID:8,FAMILY_HABIT_ID:9,FRIENDS_HABIT_ID:10,HOBBIES_HABIT_ID:13,STRESS_HABIT_ID:19,MENSTRUATION_HABIT_ID:20,activeDate:void 0},a=!1;I.requiresHabitDataReload=function(){return a},I.clearHabitDataReload=function(){a=!1};var t=m.getUserPreference("viewed_remove_habit_tooltip"),r=!t||"false"==t,s=!1;I.showRemoveHabitTooltip=function(){return r&&s};var c=!(I.dismissRemoveHabitTooltip=function(){m.setUserPreference("viewed_remove_habit_tooltip","true"),r=!1});function v(){I.accountHabitValues=[];for(var e=0;e<I.accountHabits.length;++e)for(var t=I.accountHabits[e].habitValues,i=0;i<t.length;++i){var n=t[i];I.accountHabitValues[n.id]=n}}function S(){f.setItem("accountHabits",JSON.stringify(I.accountHabits))}function C(){f.setItem("habitData",JSON.stringify(I.habitData))}function h(){f.setItem("offlineHabitData",JSON.stringify(I.offlineHabitData))}function O(){f.setItem("recentFeelings",JSON.stringify(I.recentFeelings))}function y(){0<I.offlineHabitData.length&&p.isOnline()&&m.isLoggedIn()&&f.onceInitialized(function(){m.onceUserContextInitialized(function(){!function(){for(var e=[],t=0;t<I.offlineHabitData.length;++t){var i=I.offlineHabitData[t],n=I.getHabitValueById(i.habitValueId),o={habitId:I.getAccountHabitById(n.habitId).id,habitValueId:n.id,habitSubValueIds:i.subValueIds,experiencedAt:i.experiencedAt,notes:i.notes};i.update&&(o.habitDataId=i.id,o.update=!0),e.push(o)}d.post(p.serverURL+"/habits/offline",{data:e}).success(function(e){if(e)for(var t=0;t<e.length;++t)U(e[t]);I.offlineHabitData.length=0,f.removeItem("offlineHabitData")})}()})})}I.setIsEditingHabits=function(e){c=e},I.isEditingHabits=function(){return c},I.removeMoodHabit=function(e){e.habits&&(e.habits=e.habits.slice(0));for(var t=e.habits.length-1;0<=t;--t)e.habits[t].id==I.MOOD_HABIT_ID?e.habits.splice(t,1):e.habits[t].id==I.STRESS_HABIT_ID&&e.habits.splice(t,1)},I.initFromLocalStorage=function(){f.getItem("accountHabits",function(e){e&&(I.accountHabits=JSON.parse(e),v())}),f.getItem("habitData",function(e){e&&(I.habitData=JSON.parse(e))}),f.getItem("offlineHabitData",function(e){e&&(I.offlineHabitData=JSON.parse(e))}),f.getItem("recentFeelings",function(e){e&&(I.recentFeelings=JSON.parse(e))})},I.setActiveDate=function(e){I.activeDate=e},I.getActiveDate=function(){return I.activeDate},I.getHabitSubValueName=function(e,t){for(var i=I.accountHabits[e],n=0;n<i.habitSubValues.length;++n){var o=i.habitSubValues[n];if(o.id==t)return o.display.toLowerCase()}},I.getHabitSubValue=function(e,t){var i;if(e)if(Array.isArray(e))for(var n=0;n<e.length;++n){var o=e[n];o.id==t&&(i=o.valueString)}else{var a=e[t];a&&(i=a.valueString)}if(i||(i=I.getHabitSubValueName(0,t)),i){var r=u.instant(i.toUpperCase());return r==i.toUpperCase()?i.toLowerCase():r.toLowerCase()}return u.instant("UNKNOWN").toUpperCase()},I.updateMoodHabitSubValues=function(e){if(e)for(var t=I.accountHabits[0],i=0;i<e.length;++i){for(var n=e[i],o=!1,a=0;a<t.habitSubValues.length;++a){if(t.habitSubValues[a].id==n.id){o=!0;break}}o||t.habitSubValues.push(n)}},I.getHabitSubValues=function(e){for(var t=createPromise(),i="",n=0;n<e.length;++n)0<n&&(i+="&"),i+="ids="+e[n];return d.get(p.serverURL+"/habits/habitSubValues?"+i).success(function(e){I.updateMoodHabitSubValues(e),t.successCallback&&t.successCallback()}).error(function(){t.errorCallback&&t.errorCallback()}),t},e.$on("event:online",y),e.$on("event:userContextInitialized",y),I.logout=function(){I.accountHabits=[],I.accountHabitValues=[],I.potentialHabits=[],I.habitData={},E=!1,I.recentFeelings=[],f.removeItem("accountHabits"),f.removeItem("habitData"),f.removeItem("offlineHabitData"),f.removeItem("recentFeelings"),s=!1},I.findHabitData=function(e,t){var i=new Date(t.getTime()+MILLISECONDS_IN_DAY);return d.get(p.serverURL+"/habits/habitData?startDate="+T.getDayString(e)+"&endDate="+T.getDayString(i))},I.findPotentialAccountHabits=function(){return d.get(p.serverURL+"/habits/account/potential")},I.setPotentialAccountHabits=function(e){for(var t=0;t<e.length;++t){for(var i=e[t],n=!1,o=0;o<I.potentialHabits.length;++o)if(I.potentialHabits[o].id==i.id){n=!0;break}n||I.potentialHabits.push(i)}},I.getPotentialAccountHabits=function(){return I.potentialHabits},I.getPotentialAccountHabitById=function(e){return _.find(I.getPotentialAccountHabits(),{id:e})},I.setHabitContext=function(e){var t=e.habitValues;I.accountHabits=t,v(),I.accountHabits.sort(function(e,t){return e.ordinate-t.ordinate});for(var i=0;i<I.accountHabits.length;++i)I.ordinate=i;var n=e.habitData;I.habitData={},I.addHabitData(n),E=!0;for(var o=0;o<I.offlineHabitData.length;++o){var a,r=I.offlineHabitData[o],s=I.getHabitValueById(r.habitValueId),c=I.getAccountHabitById(s.habitId);if(s&&c)a="number"==typeof r.experiencedAt||"string"==typeof r.experiencedAt?new Date(r.experiencedAt):r.experiencedAt,I.setLocalHabitData(c,s.ordinate,r.subValueIds,r.update,a,r.notes,r)}f.setItem("accountHabits",JSON.stringify(I.accountHabits)),C()},I.getTodaysLastMoodEntryClass=function(){var e=I.getTodaysLastMoodEntry();return e="?"!=e?e.replace(" ",""):""},I.getStressClass=function(e){return e?I.getAccountHabitValues("Stress").habitValues[e.valueInt-1].valueString.replace(/ /g,""):""},I.getMoodClass=function(e){if(!e)return"";var t=I.getAccountHabitValues("Mood").habitValues;return t[t.length-e.valueInt].valueString.replace(" ","")},I.getMoodClassFromData=function(e){var t=I.getHabitValueById(e.habitValueId);if(t)return I.getMoodClass(t)},I.getTodaysLastMoodEntry=function(){var e=T.getTodayString(),t=I.habitData[e];return t&&(t=t[1])&&0!==t.length?(t.sort(function(e,t){return new Date(t.recordedAt)-new Date(e.recordedAt)}),I.getHabitValueById(t[0].habitValueId).valueString):"?"},I.isCustomHabit=function(e){return 1!=e.creatorId},I.addHabitData=function(e){for(var t=0;t<e.length;++t){var i=e[t],n=T.getDayString(new Date(i.experiencedAt)),o=I.getHabitValueById(i.habitValueId);if(o){var a=I.getAccountHabitById(o.habitId),r=I.habitData[n];r||(r=I.habitData[n]={});var s=r[a.id];s||(s=r[a.id]=[]);for(var c=!1,l=0;l<s.length;++l)if(s[l].id==i.id){c=!0;break}c||s.push(i)}else console.log("WARNING: Could not find habit value for habit data.")}},I.hasHabitContext=function(){return E},I.getAccountHabitValues=function(e){for(var t in I.accountHabits)if(I.accountHabits[t].name==e)return I.accountHabits[t]},I.getAccountHabitValuesById=function(e){for(var t in I.accountHabits)if(I.accountHabits[t].id==e)return I.accountHabits[t]},I.getAccountHabits=function(){return I.accountHabits},I.getAccountHabitById=function(e){for(var t,i=0;i<I.accountHabits.length;++i)if(I.accountHabits[i].id==e){t=I.accountHabits[i];break}return t};var L,R=[];function D(e){new Date;e.update=!1,I.offlineHabitData.push(e),h(),P(e)}function b(e,t){for(var i=e.habitValues.length-1;0<=i;--i){if(t>=e.habitValues[i].valueInt)return i}return 0}function P(e){moment(e.recordedAt).startOf("day").valueOf()==moment().startOf("day").valueOf()&&A.setActivityStreak()}function N(e){for(var t=!1,i=0;i<I.offlineHabitData.length;++i){var n=I.offlineHabitData[i],o=I.getHabitValueById(n.habitValueId),a=I.getAccountHabitById(o.habitId),r=I.getHabitValueById(e.habitValueId),s=I.getAccountHabitById(r.habitId);if(n.experiencedAt.getDate||(n.experiencedAt=new Date(n.experiencedAt)),e.experiencedAt.getDate||(e.experiencedAt=new Date(e.experiencedAt)),a.id==s.id&&T.getDayString(n.experiencedAt)==T.getDayString(e.experiencedAt)){n.habitValueId=e.habitValueId,n.habitSubValueIds=e.subValueIds,n.notes=e.notes,t=!0;break}}t||(e.update="number"==typeof e.id,I.offlineHabitData.push(e)),h()}function M(e){var t=[];for(var i in I.habitData)t.push(i);t.sort(function(e,t){return new Date(t)-new Date(e)});for(var n=0,o=!1,a=0;a<t.length&&!o;++a){var r=t[a],s=I.habitData[r][1];if(s)for(var c=0;c<s.length;++c){var l=s[c];if(!e(I.getHabitValueById(l.habitValueId).valueInt)){o=!0;break}if(5<=++n){o=!0;break}}}return 5<=n}function G(e){var t=e.experiencedAt;"number"!=typeof t&&"string"!=typeof t||(t=new Date(t));var i=I.getHabitValueById(e.habitValueId),n=I.getAccountHabitById(i.habitId);I.getHabitDataList(n,t,!0).splice(0,0,e),C()}function U(e){var t=e.experiencedAt;"number"!=typeof t&&"string"!=typeof t||(t=new Date(t));var i=I.getHabitValueById(e.habitValueId),n=I.getAccountHabitById(i.habitId),o=I.getHabitDataList(n,t,!0);o[0]?(o[0]=e,C()):console.log("ERROR: existing habitData MUST exist for this call.")}function H(e){for(var t=0;t<I.recentFeelings.length;++t)if(I.recentFeelings[t].id==e.id)return;I.recentFeelings.splice(0,0,e)}function k(u,e){var t=new Date,i=new Date(t.getTime()-e*MILLISECONDS_IN_DAY);i.setHours(0,0,0,0);var n=new Date(i.getTime()-6*MILLISECONDS_IN_HOUR),d=new Date(i.getTime()+12*MILLISECONDS_IN_HOUR);console.log("start: "+n),console.log("end: "+d),window.plugins.healthkit.querySampleType({startDate:n,endDate:d,sampleType:"HKCategoryTypeIdentifierSleepAnalysis",ascending:"YES"},function(e){if(e&&0<e.length){console.log("received sleep results:"),console.log(e);var t=0;for(var i in e){var n=e[i],o=1===n.value?"Sleeping":"In Bed";if("Sleeping"==o){var a=moment(n.endDate).diff(n.startDate,"minutes"),r=moment(n.endDate).diff(n.startDate,"hours");console.log("Entry got "+a+" minutes "+o),console.log("Entry got "+r+" hours "+o),t+=a}}if(0===t)return;var s=Math.floor(t/60),c=b(u,s);console.log("hours: "+s+", index: "+c);var l=I.getHabitDataByHabitId(d,I.SLEEP_HABIT_ID);if(l)c>I.getHabitValueById(l.habitValueId).ordinate&&I.updateHabitData(u,l,c,void 0,d);else I.recordHabitData(u,c,void 0,d)}})}function x(c,l,u){return function(e){if(e&&0<e.length){var t,i=0;for(var n in e){var o=e[n];t||(t=moment(o.startDate).toDate()),i+=o.quantity}var a=Math.floor(i/u),r=b(c,a),s=I.getHabitDataByHabitId(t,l);s?r>(i=I.getHabitValueById(s.habitValueId)).ordinate&&I.updateHabitData(c,s,r,void 0,t):I.recordHabitData(c,r,void 0,t)}}}return I.getCreatedHabits=function(){return R},I.clearCreatedHabits=function(){R.length=0},I.getHabitsToAdd=function(){return L},I.setHabitsToAdd=function(e){L=e},I.clearHabitsToAdd=function(){L=void 0},I.createHabit=function(e,t){var i=createPromise();return d.post(p.serverURL+"/habits/create",e).success(function(e){t?I.addHabit(e.id).success(function(){I.addLocalHabit(e),i.successCallback&&i.successCallback(e)}).error(function(){i.errorCallback&&i.errorCallback(e)}):(R.push(e),I.potentialHabits.splice(0,0,e),i.successCallback&&i.successCallback(e))}).error(function(){o.addEventAppsee("errorTriggered","createHabit"),i.errorCallback&&i.errorCallback()}),i},I.editHabit=function(i){var n=createPromise();return d.post(p.serverURL+"/habits/edit",i).success(function(e){var t=0;for(t=0;t<I.accountHabits.length;++t){if(I.accountHabits[t].id==i.id)break}I.accountHabits.splice(t,1,e),v(),n.successCallback&&n.successCallback(e)}).error(function(){o.addEventAppsee("errorTriggered","editHabit"),n.errorCallback&&n.errorCallback()}),n},I.getHabitValueById=function(e,t){var i;if((i="object"==typeof e?I.accountHabitValues[t]:I.accountHabitValues[e])&&i.active)return i},I.getHabitDisplayById=function(e,t){var i=I.getHabitValueById(e,t);return I.getHabitDisplayFromValue(e,i)},I.getHabitName=function(e){if(I.isCustomHabit(e))return e.name;var t=u.instant(e.name.toUpperCase());return t==e.name.toUpperCase()?e.name:t},I.getHabitDisplay=function(e,t){var i=e.habitValues[t];return I.getHabitDisplayFromValue(e,i)},I.getHabitIdFromData=function(e){var t=I.getHabitValueById(e.habitValueId);if(t){var i=I.getAccountHabitById(t.habitId);if(i)return i.id}return-1},I.getHabitDisplayFromData=function(e){var t=I.getHabitValueById(e.habitValueId);if(t){var i=I.getAccountHabitById(t.habitId);return I.getHabitDisplayFromValue(i,t)}return u.instant("NO_DATA")},I.getHabitDisplayFromValue=function(e,t){if(t){if(I.isCustomHabit(e))return t.valueString;var i;if(e.id==I.MOOD_HABIT_ID)return i=(i="MOOD_"+t.valueString).replace(" ","_"),u.instant(i);if(e.id==I.STRESS_HABIT_ID||t.valueString&&t.valueInt<0){i=(i="HABITS_VALUES_"+t.valueString).replace(/ /g,"_").toUpperCase();var n=u.instant(i);return n&&n!=i||(n=t.valueString),n}var o="HABITS_VALUES_"+t.display;o=o.replace(/ /g,"_").toUpperCase();var a=u.instant(o);return a&&a!=o||(a=t.display),(t.valueString?t.valueString:t.valueInt)+" "+(a||"")}return u.instant("NO_DATA")},I.hasHabitData=function(e){var t=T.getDayString(e);return void 0!==I.habitData[t]},I.getAllMoodHabitData=function(){var e=[];for(var t in I.habitData){var i=I.habitData[t][I.accountHabits[0].id];if(i)for(var n=0;n<i.length;++n)e.push(i[n])}return e},I.canSubmitMood=function(){var e,t=I.getAccountHabitValues("Mood"),i=new Date,n=I.getHabitDataByHabitId(i,t.id);if(n&&(e="object"==typeof n.experiencedAt?n.experiencedAt.getTime():new Date(n.experiencedAt).getTime(),i.getTime()-9e5<e))return!1;return!0},I.metGoalWithHabitData=function(e){var t=I.getHabitValueById(e.habitValueId),i=I.getAccountHabitById(t.habitId);return I.metGoal(i,t.ordinate)},I.metGoal=function(e,t){return e.goalMinimized?t<=e.goalOrdinal:t>=e.goalOrdinal},I.getHabitDataByHabitId=function(e,t){var i=I.getAccountHabitById(t);if(i){var n=T.getDayString(e),o=I.habitData[n];if(o){var a=o[i.id];if(a)return a[0]}}},I.reorderHabits=function(e){for(var t=[],i=0;i<e.length;++i){var n=e[i];if(n.id!=I.MOOD_HABIT_ID&&n.id!=I.STRESS_HABIT_ID){n.ordinate=i+1;var o={habitId:n.id,ordinate:i+1};t.push(o);for(var a=0;a<I.accountHabits.length;++a){var r=I.accountHabits[a];if(r.id==n.id){r.ordinate=n.ordinate;break}}}}return I.accountHabits.sort(function(e,t){return e.ordinate-t.ordinate}),S(),d.post(p.serverURL+"/habits/account/reorder",t)},I.addHabit=function(e,t){return t&&(s=!0),a=!0,d.post(p.serverURL+"/habits/account/add",e)},I.addHabits=function(e,t){return t&&(s=!0),a=!0,d.post(p.serverURL+"/habits/account/addHabits",e)},I.addLocalHabitFromId=function(e){for(var t=0;t<I.accountHabits.length;++t)if(I.accountHabits[t].id==e)return;for(var i,n=0;n<I.potentialHabits.length;++n)if(I.potentialHabits[n].id==e){i=I.potentialHabits[n];break}I.addLocalHabit(i)},I.addLocalHabit=function(e){for(var t=0;t<I.accountHabits.length;++t){if(I.accountHabits[t].id==e.id)return void console.log("Adding incorrect habit")}I.accountHabits.push(e),v(),e.ordinate=I.accountHabits.length-1;for(var i=0;i<I.potentialHabits.length;++i)if(I.potentialHabits[i].id==e.id){I.potentialHabits.splice(i,1);break}S()},I.removeHabit=function(e){return a=!0,d.post(p.serverURL+"/habits/account/remove",e)},I.deleteCustomHabit=function(t){var i=createPromise();return d.post(p.serverURL+"/habits/account/delete",t).success(function(){for(var e=0;e<I.potentialHabits.length;++e)if(I.potentialHabits[e].id==t){I.potentialHabits.splice(e,1);break}i.successCallback&&i.successCallback()}).error(function(){o.addEventAppsee("errorTriggered","deleteCustomHabit"),i.errorCallback&&i.errorCallback()}),i},I.removeLocalHabit=function(e){for(var t,i=0;i<I.accountHabits.length;++i){var n=I.accountHabits[i];if(n.id==e){t=n,I.accountHabits.splice(i,1),I.potentialHabits.push(t);break}}for(var o=0;o<I.accountHabits.length;++o)I.accountHabits[o].ordinate=o;S()},I.deleteHabitData=function(r){var s=createPromise();return d.post(p.serverURL+"/habits/deleteHabitData",{habitDataId:r.id}).success(function(){var e=!1;for(var t in I.habitData){var i=I.habitData[t];for(var n in i){for(var o=i[n],a=0;a<o.length;++a){if(o[a].id==r.id){o.splice(a,1),e=!0,0===o.length&&delete i[n];break}}if(e)break}if(e)break}s.successCallback&&s.successCallback()}).error(function(){s.errorCallback&&s.errorCallback()}),s},I.updateHabitDataNotes=function(e,t){return d.post(p.serverURL+"/habits/updateNotes",{habitDataId:e,notes:t})},I.buildMultiHabitDataArray=function(e,t,i,n,o,a,r){var s={habitId:t.id,habitValueId:t.habitValues[i].id,experiencedAt:n,goalMet:1<t.id&&!!r,notes:a};o&&(s.habitSubValueIds=o),e.push(s)},I.recordMultiHabitData=function(e){var t,i,n=createPromise();if(p.isOnline()){for(i=0;i<e.length;++i)(t=e[i]).habitId==I.MOOD_HABIT_ID?g.checkPathMoodProgress():t.habitId!=I.STRESS_HABIT_ID&&g.checkPathHealthProgress();d.post(p.serverURL+"/habits/multiRecord",e).success(function(e){1!=e[0].habitId&&A.fireActivityCompletion(null,!0);new Date;if(e)for(i=0;i<e.length;++i)G(t=e[i]),P(t);n.successCallback&&n.successCallback(e)}).error(function(){n.errorCallback&&n.errorCallback()})}else{for(i=0;i<e.length;++i){t=e[i];var o=I.getAccountHabitById(t.habitId),a=I.getHabitValueById(t.habitValueId);D(I.setLocalHabitData(o,a.ordinate,t.habitSubValueIds,!1,t.experiencedAt,t.notes,t))}n.success=function(e){return l(e),n}}return n},I.recordHabitData=function(e,t,i,n,o,a){var r=[];return I.buildMultiHabitDataArray(r,e,t,n,i,o,a),I.recordMultiHabitData(r)},I.buildMultiHabitDataUpdateArray=function(e,t,i,n,o,a,r,s){var c={habitDataId:i.id,habitId:t.id,habitValueId:t.habitValues[n].id,experiencedAt:o,goalMet:1<t.id&&!!s,notes:r};a&&(c.habitSubValueIds=a),e.push(c)},I.updateMultiHabitData=function(t){m.canUseSiriNotifications()&&(window.cordova.plugins.SiriShortcuts.donate({persistentIdentifier:"pacifica-habit",title:u.instant("SIRI_HABIT_SHORTCUT_TITLE"),suggestedInvocationPhrase:u.instant("SIRI_HABIT_SHORTCUT_PHRASE"),isEligibleForSearch:!0,isEligibleForPrediction:!0}),console.log("donated habit to Siri"));for(var e,o=createPromise(),i=[],n=0;n<t.length;++n){e=t[n];var a=I.getAccountHabitById(e.habitId),r=I.getHabitValueById(a,e.habitValueId),s=I.setLocalHabitData(a,r.ordinate,e.habitSubValueIds,!0,e.experiencedAt,e.notes,e);i.push(s),e.habitId==I.MOOD_HABIT_ID?g.checkPathMoodProgress():e.habitId!=I.STRESS_HABIT_ID&&g.checkPathHealthProgress()}if(p.isOnline())d.post(p.serverURL+"/habits/multiUpdate",t).success(function(){A.fireActivityCompletion(null,!0),o.successCallback&&o.successCallback();for(var e=0;e<t.length;++e)habitDataToCheck=t[e],P(habitDataToCheck)}).error(function(e,t,i,n){o.errorCallback&&o.errorCallback()});else{for(var c=0;c<i.length;++c)N(e=i[c]);o.success=function(e){return l(e),o}}return o},I.updateHabitData=function(e,t,i,n,o,a,r){var s=[];return I.buildMultiHabitDataUpdateArray(s,e,t,i,o,n,a,r),I.updateMultiHabitData(s)},I.has5BadConsecutiveMoodRatings=function(){return M(function(e){return e<=3})},I.has5GoodConsecutiveMoodRatings=function(){return M(function(e){return 5<=e})},I.getLocaHabitById=function(e){for(var t in I.habitData){var i=I.habitData[t][1];if(i)for(var n=0;n<i.length;++n){var o=i[n];if(o.localId&&o.localId==e)return o}}},I.getHabitDataList=function(e,t,i){var n=T.getDayString(t),o=I.habitData[n];o||(o=[],I.habitData[n]=o);var a=o[e.id];return!a&&i&&(a=[],o[e.id]=a),a},I.setLocalHabitData=function(e,t,i,n,o,a,r){var s,c=e.habitValues[t],l=new Date,u=o||l,d=I.getHabitDataList(e,u,!0);if(n&&d.length){if(r)for(var p=0;p<d.length;++p){var m=d[p];if(m.habitDataId&&m.habitDataId==r.habitDataId||m.id&&m.id==r.habitDataId){s=m;break}}s||(s=d[0])}else s={experiencedAt:u},d.splice(0,0,s);return s.localId||s.id||(s.localId=generateGUID()),s.habitValueId=c.id,s.habitSubValueIds=i,s.recordedAt=l.getTime(),void 0===a&&void 0===s.habitDataNotes||(s.habitDataNotes?s.habitDataNotes.notes=a:s.habitDataNotes={notes:a}),"object"==typeof s.experiencedAt&&(s.experiencedAtStr=s.experiencedAt.toString()),C(),s},I.updateGoalOrdinal=function(e){var t=createPromise();return d.post(p.serverURL+"/habits/account/updateGoal",{habitId:e.id,goalOrdinal:e.goalOrdinal}).success(function(){I.getAccountHabitById(e.id).goalOrdinal=e.goalOrdinal,S(),t.successCallback&&t.successCallback()}).error(function(){t.errorCallback&&t.errorCallback()}),t},I.getRecentFeelings=function(){return I.recentFeelings},I.saveCustomFeelings=function(e){for(var i=createPromise(),t=[],n=0;n<e.length;++n)t.push({valueString:e[n]});return d.post(p.serverURL+"/habits/createSubValues",t).success(function(e){for(var t=0;t<e.length;++t){H(e[t])}O(),I.updateMoodHabitSubValues(e),i.successCallback&&i.successCallback(e)}).error(function(){o.addEventAppsee("errorTriggered","createSubValues"),i.errorCallback&&i.errorCallback()}),i},I.saveCustomFeeling=function(e,t){var i=createPromise();return d.post(p.serverURL+"/habits/createSubValue",{valueString:e}).success(function(e){H(e),O(),I.updateMoodHabitSubValues([e]),i.successCallback&&i.successCallback(e)}).error(function(){i.errorCallback&&i.errorCallback()}),i},I.saveMindfulMinutes=function(e,t,i){if(window.plugins&&window.plugins.healthkit){var n=device.version,o=n.indexOf(".");if(0<o&&(n=n.substring(0,o)),10<=(n=+n)){if(I.getIsRequestingHealthkit())return;I.setIsRequestingHealthkit(),window.plugins.healthkit.requestAuthorization({readTypes:["HKCategoryTypeIdentifierSleepAnalysis","HKQuantityTypeIdentifierDietaryCaffeine","workoutType"],writeTypes:["HKCategoryTypeIdentifierMindfulSession"]},function(){I.unsetIsRequestingHealthkit(),window.plugins.healthkit.saveMindfulMinutes({value:e}),t&&t()},function(e){I.unsetIsRequestingHealthkit(),i&&i()})}}},window.readHealthKitData=function(){var f;!function(){var e=I.getAccountHabitById(I.SLEEP_HABIT_ID);if(e)for(var t=0;t<7;++t)k(e,t)}(),function(){var e=I.getAccountHabitById(I.CAFFEINE_HABIT_ID);if(e)for(var t=0;t<7;++t){var i=new Date,n=new Date(i.getTime()-t*MILLISECONDS_IN_DAY);n.setHours(0,0,0,0);var o=new Date(n.getTime()+MILLISECONDS_IN_DAY);window.plugins.healthkit.querySampleType({startDate:n,endDate:o,sampleType:"HKQuantityTypeIdentifierDietaryCaffeine",unit:"mg"},x(e,I.CAFFEINE_HABIT_ID,100))}}(),(f=I.getAccountHabitById(I.EXERCISE_HABIT_ID))&&window.plugins.healthkit.findWorkouts({},function(e){console.log("got workouts:"),console.log(e);var t={};if(e&&0<e.length)for(var i=0;i<e.length;++i){var n=e[i],o=moment(n.endDate).toDate(),a=n.duration/60,r=moment(o),s=moment().subtract(1,"w").startOf("d");if(r.isAfter(s)){var c=T.getDayString(o),l=t[c];l?l.value+=a:(l={value:a,date:o},t[c]=l)}}for(var u in t){var d=t[u],p=b(f,d.value),m=I.getHabitDataByHabitId(d.date,I.EXERCISE_HABIT_ID);m?p>I.getHabitValueById(m.habitValueId).ordinate&&I.updateHabitData(f,m,p,void 0,d.date):I.recordHabitData(f,p,void 0,d.date)}},function(e){console.log("failed getting workouts:"),console.log(e)})},I.checkHealthKitAuth=function(e,t){window.plugins&&window.plugins.healthkit?window.plugins.healthkit.checkAuthStatus({type:"HKCategoryTypeIdentifierMindfulSession"},e,t):l(function(){e&&e(!1)})},I.unsetIsRequestingHealthkit=function(){I.isRequestingHealthkit=void 0},I.setIsRequestingHealthkit=function(){I.isRequestingHealthkit=!0},I.getIsRequestingHealthkit=function(){return I.isRequestingHealthkit},I.initHealthKit=function(e,t){window.plugins&&window.plugins.healthkit&&window.plugins.healthkit.available(function(){I.getIsRequestingHealthkit()||(I.setIsRequestingHealthkit(),window.plugins.healthkit.requestAuthorization({readTypes:["HKCategoryTypeIdentifierSleepAnalysis","HKQuantityTypeIdentifierDietaryCaffeine","workoutType"],writeTypes:["HKCategoryTypeIdentifierMindfulSession"]},function(){I.unsetIsRequestingHealthkit(),readHealthKitData(),e&&e()},function(e){I.unsetIsRequestingHealthkit(),t&&t()}))},function(){console.log("healthkit not available")})},I.getHabitData=function(){return I.habitData},I.updateLocalHabitValue=function(i){var e=new Date(i.experiencedAt),t=T.getDayString(e);if(I.habitData[t]){var n=I.habitData[t];_.each(n,function(e){_.each(e,function(e){if(i.id==e.id){var t=I.getHabitValueById(i.habitValueId);e.valueInt=t.valueInt,e.valueString=t.valueString}})})}},I.confirmLeaveMood=function(t){n||(o.appseeScreenAction("cancelMood"),i.popup.confirm({template:u.instant("THOUGHTS_GO_BACK_PROMPT"),cancelText:u.instant("CANCEL"),cancelType:"button-default",okText:u.instant("CONFIRM"),okType:"button-default"}).then(function(e){n=!1,e&&t()}),n=!0)},I}]),(servicesModule=angular.module("homeworkService",[])).factory("HomeworkService",["authHttp","$translate","Environment","$rootScope","ActivityService",function(i,n,e,o,t){var a={homeworkRequests:[],annotateRequests:function(e){return _.each(e,function(e){e.reminderDate=e.reminderDate?moment(e.reminderDate):e.reminderDate,e.completedAt=e.finishedAt?moment(e.finishedAt):e.finishedAt,e.activityId&&(e.activity=a.getActivityById(e.activityId))}),e},addRequest:function(e){a.homeworkRequests.push(e);var t=a.annotateRequests([e]);o.$broadcast("event:homeworkAdded",t[0])},setHomeworkContext:function(e){a.homeworkRequests=a.annotateRequests(e)},getHomeworkRequests:function(){return a.homeworkRequests},getActivityById:function(e){return t.getActivityById(e)},getActivityCategory:function(e){return t.getCategoryForActivity(e.activity.name)},getCategoryName:function(e){var t;if(e.activityId){if("relax"==(t=a.getActivityCategory(e)))return n.instant("RELAX_ACTIVITY")}else t=e.activityCategory;return"goals"==t.toLowerCase()?n.instant("GOALS"):"thoughts"==t.toLowerCase()?n.instant("THOUGHT_ENTRY"):"relax"==t.toLowerCase()?n.instant("RELAX_ACTIVITY"):n.instant("HEALTH_HABIT")},getHomeworkScreenshot:function(e){if(void 0!==e&&void 0!==e.type){if("goal"===e.type.type)return"/img/homework-screenshots/goal/any-goal.png";if("health"===e.type.type&&e.exercise&&20<e.exercise.habitId)return"/img/homework-screenshots/health/any-health-habit.png";var t=e.type.type+"/",i=n.instant(e.exercise.displayKey)||e.exercise.title;return i||(i=n.instant(e.exercise.activityDisplay)),"/img/homework-screenshots/"+t+(i.split(" ").join("-").toLowerCase().replace(".","")+".png")}},cancelHomework:function(e,t){return i.delete("/app/practitioner/client/"+e+"/homework/"+t)},getUserHomework:function(){return i.get(e.serverURL+"/account/homework")},checkForCompletedHomework:function(){a.homeworkRequests.length&&a.getUserHomework().success(function(e){_.each(e,function(e){if(e.finishedAt){var t=_.find(a.homeworkRequests,{id:e.id});t.finishedAt=e.finishedAt,t.completedAt=t.finishedAt?moment(t.finishedAt):t.finishedAt}})}).error(function(e){console.log("error refreshing hw: "+e)})}};return a}]),(servicesModule=angular.module("httpTimeoutService",[])).factory("HttpTimeoutService",function(){return{}}),servicesModule.factory("timeoutHttpIntercept",[function(){return{request:function(e){return e.timeout=1e4,e}}}]),servicesModule.config(["$httpProvider",function(e){e.interceptors.push("timeoutHttpIntercept")}]);var mod=angular.module("mediaService",[]);mod.factory("MediaService",["$rootScope","$timeout","$translate","authHttp","AccountService","Environment",function(s,c,e,t,o,l){var u="",d={downloadedFiles:{},downloadingFiles:{}};function n(e){console.log("Could not find directory files.")}function i(t,i){window.resolveLocalFileSystemURL(u,function(e){e.getDirectory(i,{create:!1,exclusive:!1},function(e){console.log("got directory: "),console.log(e),e.createReader().readEntries(function(e){!function(e){for(var t=0;t<e.length;t++){var i=e[t];i.isFile&&(console.log("Found file: "+i.name),d.downloadedFiles[i.name]={filename:i.name,location:i.fullPath,nativeURL:i.nativeURL})}}(e),"backgrounds"==i&&d.initializeBackgroundVideo()},n)},function(){console.log("did not get "+i+" directory."),console.log(t.root)})})}function a(e){i(e,"meditations"),i(e,"backgrounds")}function r(e){console.log("Could not find persistent file system.")}d.getBackgroundVideos=function(){return[{name:e.instant("BG_VIDEO_MOUNTAIN_PEAK"),code:"mountain-peak",filename:"mountainpeak.mp4",blurMethod:"dark",free:!0},{name:e.instant("BG_VIDEO_FOREST_CREEK"),code:"forest-creek",filename:"forestcreek.mp4",blurMethod:"dark",free:!0},{name:e.instant("BG_VIDEO_OVER_EARTH"),code:"over-earth",filename:"overearth.mp4",blurMethod:"light",free:!0},{name:e.instant("BG_VIDEO_NIGHT_SKY"),code:"night-sky",filename:"nightsky.mp4",blurMethod:"light",free:!0},{name:e.instant("BG_VIDEO_CITY_LIGHTS"),code:"city-lights",filename:"citylights.mp4",blurMethod:"light",free:!0},{name:e.instant("BG_VIDEO_TROPICAL"),code:"tropical",filename:"tropical.mp4",bgAudio:"Ocean",blurMethod:"dark",free:!0},{name:e.instant("BG_VIDEO_OCEAN_BLUE"),code:"ocean2",filename:"ocean2.mp4",bgAudio:"Ocean",blurMethod:"light",free:!0},{name:e.instant("BG_VIDEO_OCEAN_SUNSET"),code:"ocean",filename:"ocean.mp4",bgAudio:"Ocean",blurMethod:"light",free:!0},{name:e.instant("BG_VIDEO_STREAM"),code:"stream",filename:"forest.mp4",bgAudio:"ForestMorning",blurMethod:"light",free:!1},{name:e.instant("BG_VIDEO_CLOUDS"),code:"clouds",filename:"clouds.mp4",bgAudio:"Pinknoise",blurMethod:"dark",free:!1},{name:e.instant("BG_VIDEO_CAMPFIRE"),code:"campfire",filename:"campfire.mp4",bgAudio:"campfire",blurMethod:"light",free:!1},{name:e.instant("BG_VIDEO_MOUNTAINS"),code:"mountains",filename:"mountains.mp4",bgAudio:"ForestMorning",blurMethod:"dark",free:!1},{name:e.instant("BG_VIDEO_WATER"),code:"water",filename:"pond.mp4",bgAudio:"Bach",blurMethod:"light",free:!1},{name:e.instant("BG_VIDEO_SUNSET"),code:"sunset",filename:"summernight.mp4",bgAudio:"SummerNight",blurMethod:"light",free:!1},{name:e.instant("BG_VIDEO_WATERFALL"),code:"waterfall",filename:"waterfall.mp4",bgAudio:"Stream",blurMethod:"light",free:!1},{name:e.instant("BG_VIDEO_LIGHTNING"),code:"thunderstorm",filename:"thunderstorm.mp4",bgAudio:"Thunderstorm",blurMethod:"light",free:!1},{name:e.instant("BG_VIDEO_FIELD"),code:"field",filename:"field.mp4",bgAudio:"SummerNight",blurMethod:"light",free:!1},{name:e.instant("BG_VIDEO_LAKE"),code:"lake",filename:"lake.mp4",bgAudio:"ForestMorning",blurMethod:"light",free:!1},{name:e.instant("BG_VIDEO_REEF"),code:"reef",filename:"reef.mp4",bgAudio:"Pinknoise",blurMethod:"light",free:!1},{name:e.instant("BG_VIDEO_FLOWERS"),code:"flowers",filename:"flowers.mp4",bgAudio:"ForestMorning",blurMethod:"light",free:!1}]};var p=!(d.initializeBackgroundVideo=function(){var e=d.getBackgroundVideos(),t=o.getUserPreference("background_video");t||(t=e[0].code);for(var i=0;i<e.length;++i){var n=e[i];if(n.code==t){d.isDownloaded(n.filename)&&(o.isPremiumEnabled()||n.free)||(n=e[0]),d.setBackgroundVideo(n.filename,n.blurMethod);break}}});window.checkExistingFiles=function(){var e=!1;return(!l.isOnline()||window.LocalFileSystem&&!p)&&(p=e=!0,l.isAndroid()?cordova.plugins.diagnostic.getExternalStorageAuthorizationStatus(function(e){e===cordova.plugins.diagnostic.permissionStatus.GRANTED&&window.requestFileSystem(LocalFileSystem.PERSISTENT,0,a,r)},function(e){console.error("The following error occurred: "+e)}):window.requestFileSystem(LocalFileSystem.PERSISTENT,0,a,r)),e},s.$on("event:userContextInitialized",function(e,t){!l.isIos()&&t&&t.creatingAccount||(window.checkExistingFiles()||d.initializeBackgroundVideo())}),d.getStorageLocation=function(){return u};var m={playAudioWhenScreenIsLocked:!(d.initStorageLocation=function(){window.cordova&&(u=l.isIos()?("cdvfile://localhost/library-nosync/","cdvfile://localhost/documents-nosync/"):cordova.file.dataDirectory),l.isOnline()||window.checkExistingFiles()})};function f(e,n,o,a,r){d.downloadingFiles[o]={filename:o,progress:0,complete:!1},t.get(l.serverURL+e+"?filename="+o).success(function(e){if(console.log("Got url: "+e.url),window.cordova){var t=u+n+o,i=new FileTransfer;i.onprogress=function(e){if(e.lengthComputable){var t={filename:o,progress:e.loaded/e.total,complete:!1};d.downloadingFiles[o]=t,s.$broadcast("event:downloadProgress",t)}},i.download(e.url,t,function(e){console.log("download complete: "),console.log(e),delete d.downloadingFiles[o],d.downloadedFiles[o]={filename:o,location:t,nativeURL:e.nativeURL},s.$broadcast("event:downloadProgress",{filename:o,progress:1,complete:!0}),a&&a()},function(e){console.log("download error source "+e.source),console.log("download error target "+e.target),console.log("upload error code"+e.code),r&&r()})}}).error(function(e,t,i,n){console.log("Error downloading file: "+e)})}function T(t,i,n,o,a){d.downloadingFiles[n]?console.log("Currently downloading file: "+n):(d.downloadedFiles[n]&&console.log("Already downloaded file: "+n),l.isAndroid()&&cordova.plugins.diagnostic?cordova.plugins.diagnostic.requestRuntimePermission(function(e){switch(e){case cordova.plugins.diagnostic.runtimePermissionStatus.GRANTED:console.log("Permission granted to store files."),f(t,i,n,o,a);break;case cordova.plugins.diagnostic.runtimePermissionStatus.NOT_REQUESTED:console.log("Permission to store files has not been requested yet");break;case cordova.plugins.diagnostic.runtimePermissionStatus.DENIED:console.log("Permission denied to store files."),a&&a();break;case cordova.plugins.diagnostic.runtimePermissionStatus.DENIED_ALWAYS:console.log("Permission permanently denied to store files"),a&&a()}},function(e){console.error("The following error occurred: "+e)},cordova.plugins.diagnostic.runtimePermission.WRITE_EXTERNAL_STORAGE):f(t,i,n,o,a))}function g(e,t){window.resolveLocalFileSystemURL(e,function(e){e?e.remove(function(e){delete d.downloadedFiles[t],s.$broadcast("event:downloadRemoved",t),console.log("File removed!")},function(){console.log("error deleting the file "+error.code)}):console.log("file does not exist")})}return d.isNative=function(){return void 0!==window.Media},d.loadMeditationMedia=function(t,e,i){if(window.Media)return e&&(t=(l.isAndroid(),u+t),window.resolveLocalFileSystemURL(t,function(e){if(e){var t=e.toInternalURL();console.log("actual url: "+t)}})),new Media(t,function(){console.log("Loaded Media: "+t)},function(e){console.log("Failed Loading Media: "+t+", Error: "),console.log(e)},i)},d.loadMedia=function(t,e,i){var n="";if(!t.startsWith("http")&&window.device&&window.device.platform&&"android"==window.device.platform.toLowerCase()&&(n="/android_asset/www/"),window.Media)return new Media(n+t,function(){console.log("Loaded Media: "+t)},function(e){console.log("Failed Loading Media: "+t+", Error: "),console.log(e)},i)},d.loadRecording=function(t,e,i,n,o){var a,r,s,c=function(t){n[i]=new Media(t,function(e){console.log("Created media: "+t)},function(e){console.log("Could not create media ["+t+"] "+e.code+", "+e.message)},o),n[i].setVolume(1)};a=LocalFileSystem.TEMPORARY,r=e,s=function(e){t.isAndroid()?c(e.nativeURL):c(e.fullPath)},window.LocalFileSystem&&window.requestFileSystem(a,0,function(e){e.root.getFile(r,{create:!0,exclusive:!1},function(e){s(e)},function(){console.log("did not get file.")})},function(){console.log("failed getting filesystem")})},d.setVolume=function(e,t){e&&(e.setVolume?e.setVolume(t):e.volume=t)},d.fadeIn=function(t,i){if(t){var n=100,o=0,a=d.isNative();!function e(){a?t.setVolume(i*(o/n)):t.volume=i*(o/n),o<n?(c(e,3e3/n),++o):o=0}()}},d.fadeOut=function(t,i,n,e){if(t){var o=e||3e3,a=100,r=0,s=d.isNative();!function e(){s?t.setVolume(i*((a-r)/a)):t.volume=i*((a-r)/a),r<a?(c(e,o/a),++r):(r=0,n&&n())}()}},d.replayMedia=function(e,t){d.isNative()?(t||(t=m),e.play(t)):(e.load(),e.play())},d.isDownloaded=function(e){return!!d.downloadedFiles[e]},d.isDownloading=function(e){return!!d.downloadingFiles[e]},d.getDownloadPercentage=function(e){var t=d.downloadingFiles[e];return t?Math.round(100*t.progress):0},d.requestFileSystemPermission=function(){l.isAndroid()&&cordova.plugins.diagnostic.getExternalStorageAuthorizationStatus(function(e){if(e!==cordova.plugins.diagnostic.permissionStatus.GRANTED){var t=angular.noop,i=angular.noop;cordova.plugins.diagnostic.requestExternalStorageAuthorization(t,i)}},function(e){console.error("The following error occurred: "+e)})},d.getStreamingMeditationURL=function(e){return t.get(l.serverURL+"/media/meditationStream?filename="+e)},d.getStreamingAppMeditationURL=function(e){return t.get(l.serverURL+"/media/meditationURL?filename="+e)},d.getStreamingBackgroundURL=function(e){return t.get(l.serverURL+"/media/backgroundStream?filename="+e)},d.downloadBackgroundVideo=function(e,t,i){T("/media/backgroundVideoURL","backgrounds/",e,t,i)},d.setBackgroundVideo=function(e,t){if("mountainpeak.mp4"==e)window.plugins&&window.plugins.bgVideo&&window.plugins.bgVideo.setVideo(void 0);else{if(!d.isDownloaded(e))return void console.log("File is not downloaded: ["+e+"], can not set as video.");if(window.plugins&&window.plugins.bgVideo){var i=d.downloadedFiles[e].nativeURL;0===i.indexOf("file")&&(i=i.substring(7)),window.plugins.bgVideo.setVideo(i,t)}}},d.downloadMeditationFile=function(e,t,i){T("/media/meditationURL","meditations/",e,t,i)},d.removeMeditationFile=function(e){var t="meditations/"+e;g(t=u+t,e)},d.removeBackgroundVideo=function(e){var t="backgrounds/"+e;g(t=u+t,e)},d}]),(servicesModule=angular.module("notificationService",[])).factory("NotificationService",["$rootScope","$translate","Environment","AccountService","HabitsService","GeneralService","StorageService",function(n,a,r,o,s,c,l){var u={push:void 0,registrationId:void 0,onboardingNotificationsSet:!1};function e(){var e=a.instant("ONBOARDING_PROMPT_1"),t=a.instant("ONBOARDING_PROMPT_2"),i=new Date,n=new Date,o=new Date;r.isDevelopment()?(n.setMinutes(i.getMinutes()+3),o.setMinutes(i.getMinutes()+6)):(n.setHours(i.getHours()+24),o.setHours(i.getHours()+96)),u.onboardingNotificationsSet||(u.scheduleReminder(3e3,e,n,!1,function(e){!0===e&&(u.onboardingNotificationsSet=!0),console.log(e)}),u.scheduleReminder(4e3,t,o,!1,function(e){!0===e&&(u.onboardingNotificationsSet=!0),console.log(e)}))}return u.registerDevice=function(){var t;u.registrationId?r.isAndroid()?o.registerGCMToken(u.registrationId,function(e){409==e.status&&(console.log("Server rejected reg token ",u.registrationId),u.push.unregister(function(){u.push=void 0,u.registerNotifications()},function(){console.log("Unable to unregister")}))}):o.registerAPNSToken(u.registrationId):t=l.getItem("notificationRegistrationId",function(e){t&&(u.registrationId=t,u.registerDevice())})},u.registerNotifications=function(t,i){u.push?(o.isLoggedIn()&&u.registerDevice(),t&&t()):window.PushNotification&&!u.push&&(u.push=PushNotification.init({android:{senderID:"435361669565",icon:"notif",iconColor:"#1ac88d",clearNotifications:"false"},ios:{alert:"true",badge:"true",sound:"true",clearBadge:"true"}}),u.push.on("registration",function(e){console.log("received registration:",e),u.registrationId=e.registrationId,o.isLoggedIn()?u.registerDevice():l.setItem("notificationRegistrationId",u.registrationId),t&&t()}),u.push.on("notification",function(e){console.log("received notification: ",e),e.additionalData&&(e.additionalData.foreground?(c.showToast(a.instant("RECEIVED")+": "+e.message,!1),e.additionalData.refresh&&n.$broadcast("event:userContextRefreshRequest")):e.additionalData.url&&(localStorage.setItem("externalLoadURL",e.additionalData.url),window.checkExternalURL())),r.isIos()&&e.additionalData["content-available"]&&u.push.finish(function(){console.log("processing of push data is finished")})}),u.push.on("error",function(e){console.log("There was an error registering notifications.",e),i&&i()}))},u.queryForReminder=function(e,r,s){window.cordova&&window.cordova.plugins&&window.cordova.plugins.notification&&window.cordova.plugins.notification.local&&cordova.plugins.notification.local.get(e,function(e){var t,i,n,o,a;e&&"string"!=typeof e?(console.log("got notification: "+e.text),e.at&&3e3!=e.id&&4e3!=e.id?(i=r,n=(t=e).text,o=t.id,a=new Date(1e3*t.at),u.cancelReminder(o,function(){u.scheduleReminder(o,n,a,!0,function(){u.queryForReminder(o,i)})})):r&&r(e)):s&&s()})},u.queryForRelaxReminder=function(e){u.queryForReminder(2e3,e)},u.queryForHabitReminder=function(e,t){var i=1e3+e.id;u.queryForReminder(i,t)},u.setOnboardingReminders=function(){u.queryForReminder(3e3,function(e){new Date(e.trigger.at)<new Date?(u.cancelOnboardingReminders(u.setOnboardingReminders),console.log("notifications already fired, reset")):console.log("onboarding notifications already set")},e)},u.cancelOnboardingReminders=function(e){u.onboardingNotificationsSet=!1,u.cancelReminder(3e3,function(){u.cancelReminder(4e3,e)})},u.cancelReminder=function(e,t){window.cordova&&window.cordova.plugins&&window.cordova.plugins.notification&&window.cordova.plugins.notification.local&&cordova.plugins.notification.local.cancel(e,function(){console.log("canceled reminder for: "+e),t&&t()})},u.cancelRelaxReminder=function(e){u.cancelReminder(2e3,e)},u.cancelHabitReminder=function(e,t){var i=1e3+e.id;u.cancelReminder(i,t)},u.scheduleReminder=function(e,t,i,n,o){var a;a=n?{every:{hour:i.getHours(),minute:i.getMinutes()}}:{at:i},window.cordova&&window.cordova.plugins&&window.cordova.plugins.notification&&window.cordova.plugins.notification.local&&cordova.plugins.notification.local.schedule({id:e,text:t,trigger:a,smallIcon:"res://drawable/notif.png",color:"2BC78E"},function(e){console.log("data ",e),o&&o(e)})},u.queryForActivityReminder=function(e,t){u.queryForReminder(5e3,e,t)},u.cancelActivityReminder=function(e){u.cancelReminder(5e3,e)},u.scheduleActivityReminder=function(e,t){var i=a.instant("ACTIVITY_REMINDER_TEXT");u.scheduleReminder(5e3,i,e,!1,t)},u.scheduleRelaxReminder=function(e,t){var i=a.instant("RELAX_REMINDER_TEXT");u.scheduleReminder(2e3,i,e,!0,t)},u.scheduleHabitReminder=function(e,t,i){var n=1e3+e.id,o=a.instant("HABIT_REMINDER_TEXT").replace("XXXREPLACEXXX",s.getHabitName(e));u.scheduleReminder(n,o,t,!0,i)},u}]),(servicesModule=angular.module("overlayService",[])).factory("OverlayService",["$ionicPopup","$ionicActionSheet","$timeout","AccessibilityService","$ionicLoading","$ionicModal","$translate","Environment","$analytics","$q",function(t,o,a,r,i,n,s,c,l,u){var d={popup:{},actionSheet:{},showingActionSheet:!1,closeActionSheet:angular.noop,showingLoading:!1,loading:{},modal:{instances:{},stack:[]}};function p(e){return"<focus-on-open tabindex='0'>"+e.template+"</focus-on-open>"}return d.popup.alert=function(e){return c.isAndroid()&&c.checkOnlineStatus(),e.template&&(e.template=p(e)),t.alert(e)},d.popup.confirm=function(e){return e.template&&(e.template=p(e)),t.confirm(e)},d.popup.show=function(e){return e.template&&(e.template=p(e)),t.show(e)},d.actionSheet.show=function(e){var t=e.buttonClicked;e.buttonClicked=function(e){d.showingActionSheet=!1,d.closeActionSheet(),d.closeActionSheet=angular.noop,t(e)};var i=e.cancel;if(e.cancel=function(){d.showingActionSheet=!1,d.closeActionSheet=angular.noop,a(function(){$(".overflow-scroll .scroll").hide().show(0)},750),i()},!d.showingActionSheet){var n=o.show(e);return d.showingActionSheet=!0,r.onceInitialized(function(){r.usingScreenReader&&a(function(){$(".action-sheet").find("button")[0].focus()},750)}),d.closeActionSheet=n}},d.loading.show=function(e){d.showingLoading||(e?i.show({template:e}):(i.show(),e=s.instant("LOADING")),r.onceInitialized(function(){r.usingScreenReader&&r.speak(e,1)}),d.showingLoading=!0)},d.loading.hide=function(){i.hide(),d.showingLoading=!1},d.modal.open=function(e){var t=u.defer();return e.modalId in d.modal.instances?(a(function(){t.reject(void 0)}),t.promise):(e.ignoreStatusBar||window.StatusBar&&c.isIos()&&StatusBar.styleDefault(),d.modal.instances[e.modalId]="Modal is opening...",c.isAndroid()&&c.checkOnlineStatus(),n.fromTemplateUrl(e.templateUrl,e).then(function(t){return t.show().then(function(){if(d.modal.instances[t.modalId]=t,d.modal.stack.push(t),t.recordAppseeEvent){var e="open"+t.modalId;l.appseeScreenAction(e)}return t})}))},d.modal.close=function(e){function t(){var e=u.defer();return a(function(){e.resolve(void 0)}),e.promise}if(void 0===e){if(void 0===(e=d.modal.stack.pop())||!1===e.hardwareBackButtonClose)return t();d.modal.stack.push(e)}if(!(_.has(e,"modalId")&&e.modalId in d.modal.instances))return t();window.StatusBar&&!e.leaveStatusBar&&StatusBar.styleLightContent();var i=e.hide();return i.then(function(){return $(".overflow-scroll .scroll").hide().show(0),$(".activity-row").hide().show(0),$(window).trigger("modal.animateOutComplete"),d.modal.stack.pop(),delete d.modal.instances[e.modalId],e.remove(),e=void 0}),i},d}]),(servicesModule=angular.module("pathService",[])).factory("PathService",["$http","$rootScope","$timeout","$translate","$ionicModal","$analytics","StorageService","AccountService","GeneralService","FeedService","Environment","authHttp","ActivityService","OverlayService",function(e,g,o,n,t,a,r,d,p,A,E,s,I,c){var v={pathContext:{},pathDayBackState:null};function l(e){for(var t=v.pathContext.paths,i=0;i<t.length;++i){if(t[i].id==e.pathId){for(var n=t[i].pathDays,o=0;o<n.length;++o){var a=n[o];if(a.id==e.pathDayId){for(var r=a.pathDayActivities,s=0;s<r.length;++s){var c=r[s];if(c.id==e.pathDayActivityId){c.complete=!0;break}}break}}break}}}function u(){var e=v.pathContext;if(e.pathProgress){for(var t=0;t<e.pathProgress.length;++t){l(e.pathProgress[t])}m(),g.$broadcast("event:reloadPathData")}}function m(){for(var e=v.pathContext.paths,t=0;t<e.length;++t){for(var i=!1,n=e[t],o=n.pathDays,a=0;a<o.length;++a){for(var r=!1,s=o[a],c=s.pathDayActivities,l=0;l<c.length;++l){if(!c[l].complete){r=!0;break}}if(r){i=!0;break}s.complete=!0}i||(n.complete=!0)}}function S(e){var t=g.$new();t.day=e,d.setUserPreference("last_completed_path_date",p.getTodayString()),d.setUserPreference("last_completed_path_day_id",e.id),t.getTitle=function(){return n.instant("DAY")+" "+(t.day.ordinal+1)+" "+n.instant("COMPLETE")},t.close=function(){c.modal.close(t.modal).then(function(e){t.modal=e})},c.modal.open({modalId:"PathDayCompleteModal",templateUrl:"views/paths/day.complete.modal.html",scope:t,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!0}).then(function(e){t.modal=e})}return v.updatePathProgress=m,v.initFromLocalStorage=function(){r.getItem("pathContext",function(e){if(e)try{var t=JSON.parse(e);v.pathContext=t,u()}catch(e){console.log("There was an error parsing the path context: "+e)}})},v.checkPathGoalProgress=function(e){var t=0;for(var i in e)for(var n=e[i],o=0;o<n.length;++o)++t;5<=t&&v.checkPathProgress("GOAL_SETTING")},v.checkPathMotivationProgress=function(){"true"==d.getUserPreference("set_goal_motivation")&&v.checkPathProgress("SET_MOTIVATION")},v.checkPathMoodProgress=function(){v.checkPathProgress("MOOD")},v.checkPathHealthProgress=function(){v.checkPathProgress("HEALTH")},v.checkPathProgress=function(e,t,i){if(!E.isWeb()){for(var n,o,a=v.pathContext.paths,r=0;r<a.length;++r){var s=a[r];if(!s.complete)for(var c=s.pathDays,l=0;l<c.length;++l){var u=c[l];if(!u.complete){for(var d=u.pathDayActivities,p=0;p<d.length;++p){var m=d[p];if(!m.complete){if(m.type==e){var f=!1;if("ACTIVITY"==m.type){var T=I.getIdForActivity(t);if(!T)return;m.activityId==T&&(f=!0)}else f=!0;if(f&&(v.completePathActivity(s.id,u.id,m.id),p==d.length-1))return S(u),n=u,o=void 0,void((o=A.getItemOfType("path"))&&o.pathDay.pathId==n.pathId&&(o.complete=!0,g.$broadcast("event:pathFeedItemCompleted")))}break}}break}}}i||("COMPLETED_ABC_THOUGHT_RECORD"==t?v.checkPathProgress(e,"COMPLETED_ABC_PLUS_THOUGHT_RECORD",!0):"COMPLETED_ABC_PLUS_THOUGHT_RECORD"==t&&v.checkPathProgress(e,"COMPLETED_ABC_THOUGHT_RECORD",!0))}},v.isPathDayLocked=function(e){var t=1===e.pathId,i=d.isPremiumEnabled();return!t&&!i},v.getPathDaySuggestion=function(e){var t=-1,i=d.getUserPreference("last_completed_path_date");if(!e&&i&&i==p.getTodayString()){var n=+d.getUserPreference("last_completed_path_day_id");n&&0<n&&(t=n)}var o=v.pathContext;if(o&&o.paths)for(var a=v.pathContext.paths,r=0;r<a.length;++r){var s=a[r];if(!s.complete)for(var c=s.pathDays,l=0;l<c.length;++l){var u=c[l];if(u.id==t)return u;if(!u.complete)return u}}},v.getPathDayById=function(e){var t,n,o;for(i=0;i<v.pathContext.paths.length;i++)if(t=v.pathContext.paths[i],-1<(n=_.findIndex(t.pathDays,{id:e}))){o=t.pathDays[n];break}return o},v.getPathDayActivityClass=function(e){for(var t=0;t<e.pathDayActivities.length;++t){var i=e.pathDayActivities[t];if("ACTIVITY"==i.type){var n=I.getActivityById(i.activityId);if(n)return n.actionClass}else if("LESSON"!=i.type)return i.type.toLowerCase()}},v.goToPathSuggestion=function(e,t){var i=v.getPathDaySuggestion();if(i){if(v.isPathDayLocked(i))return void t();$state.go("app.path-day",{pathId:i.pathId,dayId:i.id,backState:"app.discover"})}},v.setPathContext=function(e){v.pathContext=e,r.setItem("pathContext",JSON.stringify(v.pathContext)),u()},v.completePathActivity=function(e,t,i){if(!_.find(v.pathContext.pathProgress,{pathDayActivityId:i})){var n={userId:d.getAccountUser().user.id,pathId:e,pathDayId:t,pathDayActivityId:i,state:"COMPLETE",updatedAt:(new Date).getTime()};return v.pathContext.pathProgress.push(n),l(n),m(),o(function(){v.checkPathMotivationProgress()}),s.post(E.serverURL+"/paths/completeActivity",{pathId:e,pathDayId:t,pathDayActivityId:i})}},v.isPathDayComplete=function(e){var t=v.getPathContext(),i=_.findIndex(t.paths,{id:e.pathId}),n=t.paths[i],o=_.findIndex(n.pathDays,{id:e.id});return n.pathDays[o].complete},v.getPathContext=function(){return v.pathContext},v.getPathDayBackState=function(){return v.pathDayBackState},v.setPathDayBackState=function(e){v.pathDayBackState=e},v.unsetPathDayBackState=function(){v.pathDayBackState=null},g.$on("request:checkPathProgressActivity",function(e,t){v.checkPathProgress("ACTIVITY",t)}),v}]);servicesModule=angular.module("payService",[]);var currencyMap={AED:{symbol:"AED",symbol_native:"د.إ.‏",decimal_digits:2,rounding:0,code:"AED"},AFN:{symbol:"AFN",symbol_native:"؋",decimal_digits:0,rounding:0,code:"AFN"},ALL:{symbol:"ALL",symbol_native:"Lek",decimal_digits:0,rounding:0,code:"ALL"},AMD:{symbol:"AMD",symbol_native:"դր.",decimal_digits:0,rounding:0,code:"AMD"},AOA:{symbol:"AOA",symbol_native:"Kz",decimal_digits:2,rounding:0,code:"AOA"},ARS:{symbol:"ARS",symbol_native:"$",decimal_digits:2,rounding:0,code:"ARS"},AUD:{symbol:"AU$",symbol_native:"$",decimal_digits:2,rounding:0,code:"AUD"},AWG:{symbol:"AWG",symbol_native:"Afl.",decimal_digits:2,rounding:0,code:"AWG"},AZN:{symbol:"AZN",symbol_native:"ман.",decimal_digits:2,rounding:0,code:"AZN"},BAM:{symbol:"BAM",symbol_native:"KM",decimal_digits:2,rounding:0,code:"BAM"},BBD:{symbol:"BBD",symbol_native:"$",decimal_digits:2,rounding:0,code:"BBD"},BDT:{symbol:"BDT",symbol_native:"৳",decimal_digits:2,rounding:0,code:"BDT"},BGN:{symbol:"BGN",symbol_native:"лв.",decimal_digits:2,rounding:0,code:"BGN"},BHD:{symbol:"BHD",symbol_native:"د.ب.‏",decimal_digits:3,rounding:0,code:"BHD"},BIF:{symbol:"BIF",symbol_native:"FBu",decimal_digits:0,rounding:0,code:"BIF"},BMD:{symbol:"BMD",symbol_native:"$",decimal_digits:2,rounding:0,code:"BMD"},BND:{symbol:"BND",symbol_native:"$",decimal_digits:2,rounding:0,code:"BND"},BOB:{symbol:"BOB",symbol_native:"Bs",decimal_digits:2,rounding:0,code:"BOB"},BRL:{symbol:"R$",symbol_native:"R$",decimal_digits:2,rounding:0,code:"BRL"},BWP:{symbol:"BWP",symbol_native:"P",decimal_digits:2,rounding:0,code:"BWP"},BYR:{symbol:"BYR",symbol_native:"BYR",decimal_digits:0,rounding:0,code:"BYR"},BZD:{symbol:"BZD",symbol_native:"$",decimal_digits:2,rounding:0,code:"BZD"},CAD:{symbol:"CA$",symbol_native:"$",decimal_digits:2,rounding:0,code:"CAD"},CDF:{symbol:"CDF",symbol_native:"FrCD",decimal_digits:2,rounding:0,code:"CDF"},CHF:{symbol:"CHF",symbol_native:"CHF",decimal_digits:2,rounding:.05,code:"CHF"},CLP:{symbol:"CLP",symbol_native:"$",decimal_digits:0,rounding:0,code:"CLP"},CNY:{symbol:"CN¥",symbol_native:"CN¥",decimal_digits:2,rounding:0,code:"CNY"},COP:{symbol:"COP",symbol_native:"$",decimal_digits:0,rounding:0,code:"COP"},CRC:{symbol:"CRC",symbol_native:"₡",decimal_digits:0,rounding:0,code:"CRC"},CVE:{symbol:"CVE",symbol_native:"CVE",decimal_digits:2,rounding:0,code:"CVE"},CZK:{symbol:"CZK",symbol_native:"Kč",decimal_digits:2,rounding:0,code:"CZK"},DJF:{symbol:"DJF",symbol_native:"Fdj",decimal_digits:0,rounding:0,code:"DJF"},DKK:{symbol:"DKK",symbol_native:"kr",decimal_digits:2,rounding:0,code:"DKK"},DOP:{symbol:"DOP",symbol_native:"$",decimal_digits:2,rounding:0,code:"DOP"},DZD:{symbol:"DZD",symbol_native:"د.ج.‏",decimal_digits:2,rounding:0,code:"DZD"},EGP:{symbol:"EGP",symbol_native:"ج.م.‏",decimal_digits:2,rounding:0,code:"EGP"},ERN:{symbol:"ERN",symbol_native:"Nfk",decimal_digits:2,rounding:0,code:"ERN"},ETB:{symbol:"ETB",symbol_native:"ብር",decimal_digits:2,rounding:0,code:"ETB"},EUR:{symbol:"€",symbol_native:"€",decimal_digits:2,rounding:0,code:"EUR"},GBP:{symbol:"£",symbol_native:"£",decimal_digits:2,rounding:0,code:"GBP"},GEL:{symbol:"GEL",symbol_native:"GEL",decimal_digits:2,rounding:0,code:"GEL"},GHS:{symbol:"GHS",symbol_native:"GHS",decimal_digits:2,rounding:0,code:"GHS"},GNF:{symbol:"GNF",symbol_native:"FG",decimal_digits:0,rounding:0,code:"GNF"},GTQ:{symbol:"GTQ",symbol_native:"Q",decimal_digits:2,rounding:0,code:"GTQ"},GYD:{symbol:"GYD",symbol_native:"GYD",decimal_digits:0,rounding:0,code:"GYD"},HKD:{symbol:"HK$",symbol_native:"$",decimal_digits:2,rounding:0,code:"HKD"},HNL:{symbol:"HNL",symbol_native:"L",decimal_digits:2,rounding:0,code:"HNL"},HRK:{symbol:"HRK",symbol_native:"kn",decimal_digits:2,rounding:0,code:"HRK"},HUF:{symbol:"HUF",symbol_native:"Ft",decimal_digits:0,rounding:0,code:"HUF"},IDR:{symbol:"IDR",symbol_native:"Rp",decimal_digits:0,rounding:0,code:"IDR"},ILS:{symbol:"₪",symbol_native:"₪",decimal_digits:2,rounding:0,code:"ILS"},INR:{symbol:"₹",symbol_native:"₹",decimal_digits:2,rounding:0,code:"INR"},IQD:{symbol:"IQD",symbol_native:"د.ع.‏",decimal_digits:0,rounding:0,code:"IQD"},IRR:{symbol:"IRR",symbol_native:"﷼",decimal_digits:0,rounding:0,code:"IRR"},ISK:{symbol:"ISK",symbol_native:"kr",decimal_digits:0,rounding:0,code:"ISK"},JMD:{symbol:"JMD",symbol_native:"$",decimal_digits:2,rounding:0,code:"JMD"},JOD:{symbol:"JOD",symbol_native:"د.أ.‏",decimal_digits:3,rounding:0,code:"JOD"},JPY:{symbol:"¥",symbol_native:"￥",decimal_digits:0,rounding:0,code:"JPY"},KES:{symbol:"KES",symbol_native:"Ksh",decimal_digits:2,rounding:0,code:"KES"},KHR:{symbol:"KHR",symbol_native:"៛",decimal_digits:2,rounding:0,code:"KHR"},KMF:{symbol:"KMF",symbol_native:"CF",decimal_digits:0,rounding:0,code:"KMF"},KRW:{symbol:"₩",symbol_native:"₩",decimal_digits:0,rounding:0,code:"KRW"},KWD:{symbol:"KWD",symbol_native:"د.ك.‏",decimal_digits:3,rounding:0,code:"KWD"},KZT:{symbol:"KZT",symbol_native:"₸",decimal_digits:2,rounding:0,code:"KZT"},LBP:{symbol:"LBP",symbol_native:"ل.ل.‏",decimal_digits:0,rounding:0,code:"LBP"},LKR:{symbol:"LKR",symbol_native:"රු.",decimal_digits:2,rounding:0,code:"LKR"},LRD:{symbol:"LRD",symbol_native:"$",decimal_digits:2,rounding:0,code:"LRD"},LTL:{symbol:"LTL",symbol_native:"Lt",decimal_digits:2,rounding:0,code:"LTL"},LVL:{symbol:"LVL",symbol_native:"Ls",decimal_digits:2,rounding:0,code:"LVL"},LYD:{symbol:"LYD",symbol_native:"د.ل.‏",decimal_digits:3,rounding:0,code:"LYD"},MAD:{symbol:"MAD",symbol_native:"د.م.‏",decimal_digits:2,rounding:0,code:"MAD"},MDL:{symbol:"MDL",symbol_native:"MDL",decimal_digits:2,rounding:0,code:"MDL"},MGA:{symbol:"MGA",symbol_native:"MGA",decimal_digits:0,rounding:0,code:"MGA"},MKD:{symbol:"MKD",symbol_native:"MKD",decimal_digits:2,rounding:0,code:"MKD"},MMK:{symbol:"MMK",symbol_native:"K",decimal_digits:0,rounding:0,code:"MMK"},MOP:{symbol:"MOP",symbol_native:"MOP",decimal_digits:2,rounding:0,code:"MOP"},MUR:{symbol:"MUR",symbol_native:"MUR",decimal_digits:0,rounding:0,code:"MUR"},MXN:{symbol:"MX$",symbol_native:"$",decimal_digits:2,rounding:0,code:"MXN"},MYR:{symbol:"MYR",symbol_native:"RM",decimal_digits:2,rounding:0,code:"MYR"},MZN:{symbol:"MZN",symbol_native:"MTn",decimal_digits:2,rounding:0,code:"MZN"},NAD:{symbol:"NAD",symbol_native:"$",decimal_digits:2,rounding:0,code:"NAD"},NGN:{symbol:"NGN",symbol_native:"₦",decimal_digits:2,rounding:0,code:"NGN"},NIO:{symbol:"NIO",symbol_native:"C$",decimal_digits:2,rounding:0,code:"NIO"},NOK:{symbol:"NOK",symbol_native:"kr",decimal_digits:2,rounding:0,code:"NOK"},NPR:{symbol:"NPR",symbol_native:"नेरू",decimal_digits:2,rounding:0,code:"NPR"},NZD:{symbol:"NZ$",symbol_native:"$",decimal_digits:2,rounding:0,code:"NZD"},OMR:{symbol:"OMR",symbol_native:"ر.ع.‏",decimal_digits:3,rounding:0,code:"OMR"},PAB:{symbol:"PAB",symbol_native:"B/.",decimal_digits:2,rounding:0,code:"PAB"},PEN:{symbol:"PEN",symbol_native:"S/.",decimal_digits:2,rounding:0,code:"PEN"},PHP:{symbol:"PHP",symbol_native:"₱",decimal_digits:2,rounding:0,code:"PHP"},PKR:{symbol:"PKR",symbol_native:"₨",decimal_digits:0,rounding:0,code:"PKR"},PLN:{symbol:"PLN",symbol_native:"zł",decimal_digits:2,rounding:0,code:"PLN"},PYG:{symbol:"PYG",symbol_native:"₲",decimal_digits:0,rounding:0,code:"PYG"},QAR:{symbol:"QAR",symbol_native:"ر.ق.‏",decimal_digits:2,rounding:0,code:"QAR"},RON:{symbol:"RON",symbol_native:"RON",decimal_digits:2,rounding:0,code:"RON"},RSD:{symbol:"RSD",symbol_native:"дин.",decimal_digits:0,rounding:0,code:"RSD"},RUB:{symbol:"RUB",symbol_native:"руб.",decimal_digits:2,rounding:0,code:"RUB"},RWF:{symbol:"RWF",symbol_native:"FR",decimal_digits:0,rounding:0,code:"RWF"},SAR:{symbol:"SAR",symbol_native:"ر.س.‏",decimal_digits:2,rounding:0,code:"SAR"},SDG:{symbol:"SDG",symbol_native:"SDG",decimal_digits:2,rounding:0,code:"SDG"},SEK:{symbol:"SEK",symbol_native:"kr",decimal_digits:2,rounding:0,code:"SEK"},SGD:{symbol:"SGD",symbol_native:"$",decimal_digits:2,rounding:0,code:"SGD"},SOS:{symbol:"SOS",symbol_native:"SOS",decimal_digits:0,rounding:0,code:"SOS"},STD:{symbol:"STD",symbol_native:"Db",decimal_digits:0,rounding:0,code:"STD"},SYP:{symbol:"SYP",symbol_native:"ل.س.‏",decimal_digits:0,rounding:0,code:"SYP"},THB:{symbol:"฿",symbol_native:"฿",decimal_digits:2,rounding:0,code:"THB"},TND:{symbol:"TND",symbol_native:"د.ت.‏",decimal_digits:3,rounding:0,code:"TND"},TOP:{symbol:"TOP",symbol_native:"T$",decimal_digits:2,rounding:0,code:"TOP"},TRY:{symbol:"TRY",symbol_native:"TL",decimal_digits:2,rounding:0,code:"TRY"},TTD:{symbol:"TTD",symbol_native:"$",decimal_digits:2,rounding:0,code:"TTD"},TWD:{symbol:"NT$",symbol_native:"NT$",decimal_digits:2,rounding:0,code:"TWD"},TZS:{symbol:"TZS",symbol_native:"TSh",decimal_digits:0,rounding:0,code:"TZS"},UAH:{symbol:"UAH",symbol_native:"₴",decimal_digits:2,rounding:0,code:"UAH"},UGX:{symbol:"UGX",symbol_native:"USh",decimal_digits:0,rounding:0,code:"UGX"},USD:{symbol:"$",symbol_native:"$",decimal_digits:2,rounding:0,code:"USD"},UYU:{symbol:"UYU",symbol_native:"$",decimal_digits:2,rounding:0,code:"UYU"},UZS:{symbol:"UZS",symbol_native:"UZS",decimal_digits:0,rounding:0,code:"UZS"},VEF:{symbol:"VEF",symbol_native:"Bs.F.",decimal_digits:2,rounding:0,code:"VEF"},VND:{symbol:"₫",symbol_native:"₫",decimal_digits:0,rounding:0,code:"VND"},XAF:{symbol:"FCFA",symbol_native:"FCFA",decimal_digits:0,rounding:0,code:"XAF"},XOF:{symbol:"CFA",symbol_native:"CFA",decimal_digits:0,rounding:0,code:"XOF"},YER:{symbol:"YER",symbol_native:"ر.ي.‏",decimal_digits:0,rounding:0,code:"YER"},ZAR:{symbol:"ZAR",symbol_native:"R",decimal_digits:2,rounding:0,code:"ZAR"},ZMK:{symbol:"ZMK",symbol_native:"ZK",decimal_digits:0,rounding:0,code:"ZMK"}};servicesModule.factory("PayService",["$sce","$rootScope","$timeout","$analytics","$translate","$ionicModal","Environment","AccountService","OverlayService",function(n,o,a,r,s,e,c,l,u){var t=c.isAndroid()?"pacifica_yearly_subscription_54_new":"Pacifica_Yearly_Subscription_v3_53_99",d=t,p=c.isAndroid()?"pacifica_monthly_subscription_8_99":"Pacifica_Monthly_Subscription_v3_8_99",m=p,f=c.isAndroid()?"pacifica_lifetime_subscription_199_99":"Pacifica_Lifetime_Subscription_199_99",T="unlimited_tracking",i="paid subscription",g="non consumable",A={iOS:[{id:"Pacifica_Yearly_Subscription_v3_53_99",alias:"Yearly Subscription 53.99",type:i},{id:"Pacifica_Yearly_Subscription_35_99",alias:"Yearly Subscription 35.99",type:i},{id:"Pacifica_Yearly_Subscription",alias:"Yearly Subscription 29.99",type:i},{id:"Pacifica_Monthly_Subscription_v3_8_99",alias:"Monthly Subscription 8.99",type:i},{id:"Pacifica_Monthly_Subscription_5_99",alias:"Monthly Subscription 5.99",type:i},{id:"Pacifica_Monthly_Subscription",alias:"Monthly Subscription 3.99",type:i},{id:"Pacifica_Lifetime_Subscription_199_99",alias:"Lifetime Subscription 199.99",type:g},{id:"unlimited_tracking",alias:"Unlimited Tracking 1.99",type:g}],Android:[{id:"pacifica_yearly_subscription_54",alias:"Yearly Subscription 53.99",type:i},{id:"pacifica_yearly_subscription_54_new",alias:"Yearly Subscription 53.99",type:i},{id:"pacifica_yearly_subscription_36",alias:"Yearly Subscription 35.99",type:i},{id:"pacifica_yearly_subscription_30",alias:"Yearly Subscription 29.99",type:i},{id:"pacifica_monthly_subscription_8_99",alias:"Monthly Subscription 8.99",type:i},{id:"pacifica_monthly_subscription_5_99",alias:"Monthly Subscription 5.99",type:i},{id:"pacifica_monthly_subscription_3_99",alias:"Monthly Subscription 3.99",type:i},{id:"pacifica_lifetime_subscription_199_99",alias:"Lifetime Subscription 199.99",type:g},{id:"unlimited_tracking",alias:"Unlimited Tracking 1.99",type:g}]},E={monthly:"Pacifica_Monthly_Subscription_v3_8_99",yearly:"Pacifica_Yearly_Subscription_v3_53_99",lifetime:"Pacifica_Lifetime_Subscription_199_99",tracking:"unlimited_tracking"},I={monthly:"pacifica_monthly_subscription_8_99",yearly:"pacifica_yearly_subscription_54_new",lifetime:"pacifica_lifetime_subscription_199_99",tracking:"unlimited_tracking"},v={subscribed:!1,products:{},productVerificationAttempts:{},initializedStore:!1,loadingError:!1,verifyingPayment:!1,isShowingModal:!1,currentErrorPopup:void 0,isPurchasing:!1};function S(e){var t=v.products[e];return t?t.title:c.isOnline()?s.instant("UNKNOWN"):"["+s.instant("OFFLINE")+"]"}function C(e){var t=v.products[e];return t?t.price:c.isOnline()?s.instant("UNKNOWN"):s.instant("OFFLINE")}function h(e){return e==d?s.instant("ONE_YEAR"):s.instant("ONE_MONTH")}function O(e){var t=v.products[e];t?(v.isPurchasing=!0,store.order(t.id).error(function(e){console.log("got error in product."),u.loading.hide(),v.currentErrorPopup&&v.currentErrorPopup.close(),r.addEventAppsee("errorTriggered","purchaseError"),v.currentErrorPopup=u.popup.alert({title:"Error",template:s.instant("ACCOUNT_UPGRADE_PURCHASE_ERROR")+"<br><br>Code: "+e.code+"<br>Message: "+e.message,okText:s.instant("OK_GOT_IT"),okType:"button-default"}),v.currentErrorPopup.then(function(e){v.currentErrorPopup=void 0})})):(v.currentErrorPopup&&v.currentErrorPopup.close(),r.addEventAppsee("errorTriggered","purchaseError"),v.currentErrorPopup=u.popup.alert({title:"Error",template:s.instant("ACCOUNT_UPGRADE_PRODUCT_ERROR"),okText:s.instant("OK_GOT_IT"),okType:"button-default"}),v.currentErrorPopup.then(function(e){v.currentErrorPopup=void 0}))}v.setOverrides=function(e){if(e&&e.yearlyProductId&&e.monthlyProductId){var t;d=e.yearlyProductId,m=e.monthlyProductId,e.lifetimeProductId&&(f=e.lifetimeProductId),e.trackingProductId&&(T=e.trackingProductId),t=c.isAndroid()?A.Android:A.iOS;for(var i=!1,n=0;n<t.length;++n){var o=t[n];if(o.id==e.yearlyProductId||o.id==e.monthlyProductId){i=!0;break}}i||(store.register({id:e.monthlyProductId,alias:"Monthly Override",type:store.PAID_SUBSCRIPTION}),store.register({id:e.monthlyProductId,alias:"Yearly Override",type:store.PAID_SUBSCRIPTION}))}else T=c.isAndroid()?(d=I.yearly,m=I.monthly,f=I.lifetime,I.tracking):(d=E.yearly,m=E.monthly,f=E.lifetime,E.tracking)},v.getCurrency=function e(){return e()},v.getYearlyProductName=function(){return S(d)},v.getYearlyProductPrice=function(){return C(d)},v.getOriginalYearlyProductPrice=function(){return C(t)},v.getYearlyProductPricePerMonth=function(){var e,t=function(e){var t=v.products[e];if(t){if(t.currency)return t.currency;for(var i in currencyMap){var n=currencyMap[i];if(0<=t.price.indexOf(n.symbol))return i}}return"$"}(d);e=currencyMap[t]?currencyMap[t].symbol:"";var i,n,o=(i=d,(n=v.products[i])?parseFloat(n.numericPrice):0);if(o){o=Math.floor(o/12*100)/100;var a=v.getShortTermProductPrice()+"",r=0<=a.indexOf(".")?".":",";return o=(o+"").replace(".",r),0===a.indexOf(e)?e+o.toLocaleString():o.toLocaleString()+e}},v.getYearlyProductDuration=function(){return h(d)},v.purchaseYearlySubscription=function(){O(d)},v.getShortTermProductName=function(){return S(m)},v.getShortTermProductPrice=function(){return C(m)},v.getOriginalShortTermProductPrice=function(){return C(p)},v.getShortTermProductDuration=function(){return h(m)},v.purchaseShortTermSubscription=function(){O(m)},v.getLifetimeProductPrice=function(){return C(f)},v.purchaseLifetime=function(){O(f)},v.getTrackingProductName=function(){return S(T)},v.getTrackingProductPrice=function(){return C(T)},v.purchaseTracking=function(){O(T)},v.isStoreLoaded=function(){return v.products[d]||v.isLoadingError()},v.isLoadingError=function(){return v.loadingError},v.isVerifyingPayment=function(){return 0<v.verifyingPayments},v.manualRefreshStore=function(){l.canUpgrade()&&(u.loading.show(s.instant("ACCOUNT_UPGRADE_ATTEMPTING_REFRESH")+"..."),store.refresh(),a(function(){u.loading.hide()},2e3))},v.refreshStore=function(){l.canUpgrade()?(console.log("refreshing store."),v.initializedStore||v.initStore()):console.log("Skipping store refresh, user is premium.")},o.$on("event:refreshStore",v.manualRefreshStore);var y=function(e){v.isShowingModal&&u.loading.show(s.instant("ACCOUNT_UPGRADE_PURCHASE_APPROVED")+"...")};function L(t,e,i){store.register({id:t,alias:e,type:i}),store.when(e).approved(function(e){y(e),console.log(t+" attempting verify"),e.verify()}),store.when(e).verified(function(e){console.log(t+" verified"),e.finish()}),store.when(e).unverified(function(e){console.log(t+" unverified")}),store.when(e).initiated(function(e){u.loading.show(s.instant("ACCOUNT_UPGRADE_INITIATING_PURCHASE")+"...")}),store.when(e).cancelled(function(e){u.loading.hide(),u.popup.alert({title:"Error",template:s.instant("ACCOUNT_UPGRADE_PURCHASE_CANCELED"),okText:s.instant("OK_GOT_IT"),okType:"button-default"})}),store.when(e).updated(function(e){console.log("Product updated: "+e.id),console.log(e),v.products[e.id]=e,o.$broadcast("event:storeUpdated")})}return v.initStore=function(){if(!window.store)return console.log("Store not available"),void(v.loadingError=!0);if(console.log("Initializing Store."),!v.initializedStore){var e;v.initializedStore=!0,store.verbosity=store.DEBUG,store.validator=function(t,i){console.log("Calling validator with product: "),console.log(t),l.canUpgrade()&&t.transaction&&(++v.verifyingPayments,l.enablePremiumFeatures(t.transaction,t.id,t.price,function(e){--v.verifyingPayment,u.loading.hide(),"false"==e?(i(!1,{error:{code:store.PURCHASE_EXPIRED,message:s.instant("ACCOUNT_UPGRADE_EXPIRED_MESSAGE")}}),v.productVerificationAttempts[t.transaction.id]=!1):(v.productVerificationAttempts[t.transaction.id]=!0,i(!0,{}),o.$broadcast("event:purchased"),v.isShowingModal&&(u.loading.show(s.instant("ACCOUNT_UPGRADE_PURCHASE_VERIFIED")),a(function(){u.loading.hide()},2e3)))}))},e=c.isAndroid()?A.Android:A.iOS;for(var t=0;t<e.length;++t){var i=e[t];L(i.id,i.alias,i.type)}store.error(function(e){u.loading.hide(),console.log("ERROR "+e.code+": "+e.message),e.code!=store.ERR_PURCHASE&&v.isShowingModal&&(v.loadingError=!0,v.currentErrorPopup||(r.addEventAppsee("errorTriggered","purchaseError"),v.currentErrorPopup=u.popup.alert({title:"Error",template:s.instant("ACCOUNT_UPGRADE_STORE_ERROR")+"<br><br>Code: "+e.code+"<br>Message: "+e.message,okText:s.instant("OK_GOT_IT"),okType:"button-default"}),v.currentErrorPopup.then(function(e){v.currentErrorPopup=void 0})))}),l.canUpgrade()&&store.refresh()}},v.showPremiumModal=function(t,e,i){"account"===e&&(e="relax"),t.categoryMap={relax:0,paths:1,habits:2,thoughts:3,mood:4,backgrounds:5,therapy:6},t.getSlideInstructions=function(e,t){return s.instant("ARIA_SLIDE_INSTRUCTIONS").replace("x",e).replace("y",t)},t.categoryToSlideIndex=function(e){return t.categoryMap.hasOwnProperty(e)?t.categoryMap[e]:0},t.slideIndexToCategory=function(e){return _.invert(t.categoryMap)[e]},t.currentSlideCategory=t.slideIndexToCategory(t.categoryToSlideIndex(e)),t.sliderOptions={loop:!1,effect:"slide",speed:350,initialSlide:t.categoryToSlideIndex(e),slidesPerView:"auto",a11y:{enabled:!0,prevSlideMessage:"Previous slide",nextSlideMessage:"Next slide"}},t.getYearlyProductName=function(){return v.getYearlyProductName()},t.getYearlyProductPrice=function(){return v.getYearlyProductPrice()},t.getOriginalYearlyProductPrice=function(){return v.getOriginalYearlyProductPrice()},t.getYearlyProductPricePerMonth=function(){return v.getYearlyProductPricePerMonth()},t.getYearlyProductDuration=function(){return v.getYearlyProductDuration()},t.showYearlyPricePerMonth=function(){return v.isStoreLoaded()&&0<t.getYearlyProductPricePerMonth()},t.getShortTermProductName=function(){return v.getShortTermProductName()},t.getShortTermProductPrice=function(){return v.getShortTermProductPrice()},t.getOriginalShortTermProductPrice=function(){return v.getOriginalShortTermProductPrice()},t.getShortTermProductDuration=function(){return v.getShortTermProductDuration()},t.getLifetimeProductPrice=function(){return v.getLifetimeProductPrice()},t.getMonthlyTrialText=function(){var e=s.instant("ACCOUNT_UPGRADE_MONTHLY_INCLUDES_TRIAL");return n.trustAsHtml(e)},t.isDiscountActive=function(){return p!=m},t.closePremiumModal=function(){v.isShowingModal=!1,u.modal.close(t.premiumModal).then(function(e){t.premiumModal=e})},t.purchaseYearly=function(){r.appseeScreenAction("purchaseYearly"),v.purchaseYearlySubscription()},t.purchaseShortTerm=function(){r.appseeScreenAction("purchaseShortTerm"),v.purchaseShortTermSubscription()},t.purchaseLifetime=function(){r.appseeScreenAction("purchaseLifetime"),v.purchaseLifetime()},t.manualRefreshStore=function(){v.manualRefreshStore()},function(n,e,t){n.modalData={showThanks:!1},n.refreshStore=function(){v.refreshStore()},n.$on("event:storeUpdated",function(){n.$$phase||n.$apply()}),n.closePremiumModal=function(){v.isShowingModal=!1,u.modal.close(n.premiumModal).then(function(e){n.premiumModal=e})},n.$on("event:purchased",function(){v.isPurchasing&&(o.$broadcast("event:userContextRefreshRequest"),u.loading.hide(),n.modalData.showThanks=!0,v.isPurchasing=!1)}),n.$on("event:storeUpdated",function(){n.$$phase||n.$apply()}),n.$on("$ionicSlides.sliderInitialized",function(e,t){n.slider=t.slider}),n.$on("$ionicSlides.slideChangeEnd",function(e,t){if(0!==t.slider.activeIndex&&6!==t.slider.activeIndex||a(function(){$("ion-content").hide().show()},0),n.currentSlideCategory=n.slideIndexToCategory(t.slider.activeIndex),n.$apply(),o.isUsingScreenReader){var i="#upgrade-focus-"+(t.slider.activeIndex+1);a(function(){ionic.DomUtil.blurAll(),$(i).focus()},0)}}),r.eventTrack("premiumWall",{category:e,label:t});var i=0;n.waitForStore=function(){v.isStoreLoaded()?(v.isVerifyingPayment()||u.loading.hide(),v.isLoadingError()?(r.addEventAppsee("errorTriggered","storeLoadingError"),u.popup.alert({title:"Error",template:s.instant("ACCOUNT_UPGRADE_LOADING_STORE_ERROR"),okText:s.instant("OK_GOT_IT"),okType:"button-default"})):l.isPremiumEnabled()&&!l.canUpgrade()&&n.closePremiumModal()):(u.loading.show(s.instant("ACCOUNT_UPGRADE_REFRESHING")+"..."),20<=++i?(u.loading.hide(),r.addEventAppsee("errorTriggered","storeRefreshTimeout"),u.popup.alert({title:"Error",template:s.instant("ACCOUNT_UPGRADE_REFRESH_TIMEOUT_ERROR"),okText:s.instant("OK_GOT_IT"),okType:"button-default"})):c.isWebDebug()||a(n.waitForStore,500))}}(t,e,i),u.modal.open({modalId:"UpgradeModal",templateUrl:"views/account/account.upgrade.modal.html",scope:t,animation:"slide-in-up",ignoreStatusBar:!0,recordAppseeEvent:!0}).then(function(e){t.premiumModal=e,v.isShowingModal=!0}),v.isStoreLoaded()||t.waitForStore()},v}]);var tokenModule,service=angular.module("practitionerSearchService",[]);servicesModule.factory("PractitionerSearchService",["authHttp","Environment","$ionicModal","$ionicScrollDelegate","$state","$timeout","$q","$translate","AccountService","PractitionerService","GeneralService","$analytics","OverlayService",function(l,u,e,r,t,s,d,p,o,m,a,f,c){var T={RESULTS_LIMIT:25,markers:{}};T.geoOptions={timeout:u.isWebDebug()?2e4:7e3,maximumAge:6e4,enableHighAccuracy:!1},T.showPractitionerDetails=function(e,t,i,n){i.showAllConsultations=t,i.hideConsultationSlots=n,i.selectedPractitioner=e,i.openFacebookUsername=function(e){a.openInAppBrowserURL("https://facebook.com/"+e)},i.openTwitterUsername=function(e){a.openInAppBrowserURL("https://twitter.com/"+e)},i.showAllConsults=function(){i.showAllConsultations=!0},i.getConsultationDisplay=T.getConsultationDisplay,i.practitionerVerified=T.isPractitionerVerified(e),i.closePractitionerDetailsModal=function(){c.modal.close(i.therapistDetailsModal).then(function(e){i.therapistDetailsModal=e,i.selectedPractitioner=void 0})},i.isUserConnected=function(e){return o.isUserConnected(e)},c.modal.open({modalId:"TherapistDetailsModal",templateUrl:"views/therapy/therapy.therapist-details.modal.html",scope:i,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!0}).then(function(e){i.therapistDetailsModal=e})},T.getConsultationDisplay=function(e){var t=moment.tz(moment.tz.guess()).zoneAbbr();return moment(e.startTime).calendar()+" "+t},T.isPractitionerVerified=function(e){return!!e&&0!==e.userId},T.initializeSearchFunctionality=function(g,c){g.loadPractitioners=function(e){var i=d.defer();c.loading.show(),g.currentSearchMode=e.mode,"geo"===e.mode?(e.position=T.getPosition(),g.filterData.location=p.instant("MY_LOCATION")):"location"===e.mode&&(e.location=g.filterData.location),g.filterData.teletherapy&&(e.therapyType="teletherapy");var t,n,o,a,r=(t=e,n=u.serverURL,"location"===t.mode?n+"/find-a-therapist/loc/"+t.location:"geo"===t.mode?n+"/find-a-therapist/geo/"+t.position.lat+","+t.position.lng:void 0),s=(a={},(o=e)&&o.page&&(a.page=o.page),o&&o.distance&&"auto"!=o.distance&&"state"!=o.distance&&(a.radius=o.distance),o&&o.therapyType&&"teletherapy"==o.therapyType&&(a.therapyType="teletherapy"),o&&(o.therapyType&&"teletherapy"==o.therapyType||o.stateOnly)&&(a.stateOnly=!0),("state"==o.distance||100==o.distance)&&(a.radius=100),a);return l.get(r,{params:s}).success(function(e,t){204===t?g.results[g.page]=[]:200===t&&(g.results[g.page]=T.createRepeatingConsultations(e)),c.loading.hide(),i.resolve(g.results[g.page])}).error(function(e){console.log("Error loading clinicians",e),c.loading.hide(),i.reject(e)}),i.promise},g.getConsultationDisplay=function(e){return T.getConsultationDisplay(e)},g.showHasConsultationWithClinicianAlert=function(){c.popup.alert({template:p.instant("ALREADY_HAVE_CONSULTATION_WITH_CLINICIAN"),okText:p.instant("OK_GOT_IT"),okType:"button-default"})},g.showMaxConsultationsAlert=function(){c.popup.alert({template:p.instant("MAX_CONSULTATIONS_ALERT"),okText:p.instant("OK_GOT_IT"),okType:"button-default"})},g.showClaimConsultation=function(e,t,i){if(i&&i.stopPropagation(),g.hasConsultationWithClinician(e))g.showHasConsultationWithClinicianAlert();else if(g.upcomingConsultations&&3<=g.upcomingConsultations.length)g.showMaxConsultationsAlert();else{var a=g.$new();if(a.updating=!1,a.getUserPhoneNumber=function(){return o.getAccountUser().user.phone},a.getUserEmailAddress=function(){return o.getAccountUser().user.email},a.getUserFirstName=function(){return o.getAccountUser().account.firstName},a.getUserLastName=function(){return o.getAccountUser().account.lastName},!o.isPhoneValidated()||!o.isEmailValidated())return a.validation={phone:a.getUserPhoneNumber(),phoneValidated:o.isPhoneValidated(),code:void 0,email:a.getUserEmailAddress(),emailValidated:o.isEmailValidated()},a.checkValidations=function(){a.validation.phoneValidated&&a.validation.emailValidated&&(a.closeValidateContactModal(),s(function(){g.showClaimConsultation(e,t)},250))},a.sendPhoneValidationCode=function(){window.plugins&&window.Keyboard&&window.Keyboard.hide(),!a.updating&&a.validation.phone&&(a.updating=!0,o.setPhoneNumber(a.validation.phone,!0).success(function(){c.popup.alert({template:p.instant("VALIDATION_SMS_SENT"),okText:p.instant("OK_GOT_IT"),okType:"button-default"}),a.updating=!1}).error(function(e,t,i,n){f.addEventAppsee("errorTriggered","setPhoneNumberError");c.popup.alert({template:p.instant("GENERIC_ERROR"),okText:p.instant("OK_GOT_IT"),okType:"button-default"});a.updating=!1}))},a.checkPhoneValidation=function(){window.plugins&&window.Keyboard&&window.Keyboard.hide(),a.updating=!0,o.validatePhone(a.validation.code).success(function(e){e.validated&&(a.validation.phoneValidated=!0,a.updating=!1,a.checkValidations())}).error(function(e,t,i,n){f.addEventAppsee("errorTriggered","phoneValidationError");c.popup.alert({template:p.instant("GENERIC_ERROR"),okText:p.instant("OK_GOT_IT"),okType:"button-default"});a.updating=!1})},a.sendEmailValidation=function(){a.updating=!0,a.validation.email!=a.getUserEmailAddress()?o.setEmailAddress(a.validation.email).success(function(){c.popup.alert({template:p.instant("VALIDATION_EMAIL_SENT"),okText:p.instant("OK_GOT_IT"),okType:"button-default"})}).error(function(e,t,i,n){f.addEventAppsee("errorTriggered","emailAddressError");c.popup.alert({template:p.instant("GENERIC_ERROR"),okText:p.instant("OK_GOT_IT"),okType:"button-default"});a.updating=!1}):o.resendValidationEmail().success(function(){c.popup.alert({template:p.instant("VALIDATION_EMAIL_SENT"),okText:p.instant("OK_GOT_IT"),okType:"button-default"}),a.updating=!1}).error(function(e,t,i,n){f.addEventAppsee("errorTriggered","emailValidationResend");c.popup.alert({template:p.instant("GENERIC_ERROR"),okText:p.instant("OK_GOT_IT"),okType:"button-default"});a.updating=!1})},a.checkEmailValidation=function(){o.checkRemoteEmailValidation().success(function(e){e.validated&&(o.getAccountUser().user.emailVerifiedAt=new Date,a.validation.emailValidated=!0,a.checkValidations()),a.updating=!1}).error(function(e,t,i,n){f.addEventAppsee("errorTriggered","checkEmailValidation");c.popup.alert({template:p.instant("GENERIC_ERROR"),okText:p.instant("OK_GOT_IT"),okType:"button-default"});a.updating=!1})},a.closeValidateContactModal=function(){g.validateContactModal.leaveStatusBar=!!g.therapistDetailsModal,c.modal.close(g.validateContactModal).then(function(e){g.validateContactModal=e})},a.phoneFocus=function(e){e.target.setSelectionRange(0,0)},void c.modal.open({modalId:"ValidateContactModal",templateUrl:"views/therapy/therapy.validate-contact.modal.html",scope:a,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!0}).then(function(e){g.validateContactModal=e});a.consultation=t,a.practitioner=e,a.claim={firstName:a.getUserFirstName(),lastName:a.getUserLastName()},a.updating=!0,a.claimConsultation=function(){a.claim.firstName?a.claim.lastName?o.claimConsultation(a.claim.firstName,a.claim.lastName,t).success(function(){a.updating=!1,a.closeClaimConsultationModal(),s(function(){c.popup.alert({template:p.instant("CLAIM_CONSULTATION_SUCCESS"),okText:p.instant("OK_GOT_IT"),okType:"button-default"})},500)}).error(function(e,t,i,n){f.addEventAppsee("errorTriggered","claimConsultation");var o=p.instant("GENERIC_ERROR");e&&e.message&&(o=e.message),c.popup.alert({template:o,okText:p.instant("OK_GOT_IT"),okType:"button-default"}),a.updating=!1}):a.errorMessage=p.instant("PLEASE_ENTER_LAST_NAME"):a.errorMessage=p.instant("PLEASE_ENTER_FIRST_NAME")},a.closeClaimConsultationModal=function(){c.modal.close(g.claimConsultationModal).then(function(e){g.claimConsultationModal=e})},c.modal.open({modalId:"ClaimConsultationModal",templateUrl:"views/therapy/therapy.claim-consultation.modal.html",scope:a,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!0}).then(function(e){g.claimConsultationModal=e})}},g.isLocationRequired=function(){return void 0===T.getPosition()&&!g.filterData.location||""===g.filterData.location},g.resetFilters=function(){g.filterData={distance:"auto"}},g.filterFocusCallback=function(){r.$getByHandle("clinician-filter-modal").scrollTop(!0)},g.isFilterModalRendered=function(){return g.filterModalRendered},g.showFilterOptions=function(){g.filterModalRendered=!1,c.modal.open({modalId:"TherapistFilterModal",templateUrl:"views/therapy/therapy.therapist-filter.modal.html",scope:g,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!0}).then(function(e){g.therapistFilterModal=e,g.previousFilterData=angular.copy(g.filterData),g.$on("modal.shown",function(e,t){g.therapistFilterModal&&t.scope.$id==g.therapistFilterModal.scope.$id&&(g.filterModalRendered=!0)})})},g.closeFilterOptionsModal=function(e){g.filterModalRendered=!1,g.searchResults=[],g.filterErrorMessage=null,e.save||(g.filterData=g.previousFilterData),c.modal.close(g.therapistFilterModal).then(function(e){g.therapistFilterModal=e,g.isLocationRequired()&&!g.results[1]&&t.go("app.therapy"),g.closeFilterCallback&&g.closeFilterCallback()})},g.toggleTeletherapy=function(){g.filterData.teletherapy=!g.filterData.teletherapy,g.$$phase||g.$apply()},g.applyFilters=function(){if(!g.isLocationRequired()){var t={};if(t.mode=g.filterData.location!==p.instant("MY_LOCATION")&&g.filterData.location?"location":"geo",g.searchResults=[],g.applyingFilter=!0,"geo"==t.mode)T.getCurrentPosition().then(function(e){t.position=e,T.storePosition(e),o()}).catch(function(e){g.filterData.location?g.filterErrorMessage="Your location could not be determined, please enter one.":g.filterData.location||(g.filterErrorMessage="Your location could not be determined, please enter one.")}).finally(function(){g.applyingFilter=!1});else if("location"==t.mode){if("state"!=g.filterData.distance){var e=_.map(a.getUSStates(),function(e,t){return t.toLowerCase()}),i=_.map(a.getUSStates(),function(e,t){return e.toLowerCase()}),n=g.filterData.location.toLowerCase();(_.includes(e,n)||_.includes(i,n))&&(t.distance=100,t.stateOnly=!0,g.filterData.distance="state")}o()}}function o(){g.results={},g.page=1,t.page=g.page,t.distance=g.filterData.distance,g.filterData.location&&"undefined"!=typeof plugin&&plugin.google.maps.Geocoder&&"geo"!==t.mode&&plugin.google.maps.Geocoder.geocode({address:g.filterData.location},function(e){e.length&&T.storePosition(e[0].position)}),g.loadPractitioners(t).then(function(){g.resize(),g.filterErrorMessage=null,g.closeFilterOptionsModal({save:!0})}).catch(function(){f.addEventAppsee("errorTriggered","searchLoadPractitioners"),c.popup.alert({template:p.instant("GENERIC_ERROR"),okText:p.instant("OK_GOT_IT"),okType:"button-default"})}).finally(function(){g.applyingFilter=!1})}},g.showPractitionerDetails=function(e,t){g.preventDetailsModal||T.showPractitionerDetails(e,t,g)},g.seesSpecificAgeGroups=function(e){return!(!e||!e.ageGroups)&&_.some(_.values(e.ageGroups))},g.pageHasLoaded=function(e){return _.has(g.results,e)};var e=function(e){var t=d.defer();return g.pageHasLoaded(e)?s(function(){g.clinicians=g.results[e],g.resize(),t.resolve()}):g.loadPractitioners({page:e,distance:g.filterData.distance,mode:g.currentSearchMode,teletherapy:g.filterData.teletherapy,stateOnly:"state"==g.filterData.distance}).then(function(){g.resize(),t.resolve()}),t.promise};g.resize=function(){var e=g.results[g.page];if(e&&0<e.length){var t=300*(e.length-1)+$(window).width()+(1<g.page?45:0)+(g.canLoadMore()?45:0);$("#horizontal-scroller .scroll").width(t)}r.$getByHandle("list-scroller").resize(),r.$getByHandle("list-scroller").scrollTop(),r.$getByHandle("horizontal-scroller").resize(),r.$getByHandle("horizontal-scroller").scrollTo(0,0,!1)},g.canLoadMore=function(){if(g.results&&g.results[g.page]&&0<g.results[g.page].length){var e=g.results[g.page][0].resultCount;return(1<g.page?T.RESULTS_LIMIT*(g.page-1):0)+g.results[g.page].length<e}return!1},g.loadNextPage=function(){return g.page+=1,e(g.page)},g.loadPreviousPage=function(){return g.page-=1,e(g.page)},g.boundsToZoomLevel=function(e){var t=256,i=256;if(!g.mapDim){var n=$(window).height(),o=$(window).width(),a=$(".filter-summary").parent().height(),r=n-$("ion-header-bar")[0].clientHeight-a-120;g.mapDim={height:r,width:o}}function s(e){var t=Math.sin(e*Math.PI/180),i=Math.log((1+t)/(1-t))/2;return Math.max(Math.min(i,Math.PI),-Math.PI)/2}function c(e,t,i){return Math.floor(Math.log(e/t/i)/Math.LN2)}var l=e.northeast,u=e.southwest,d=(s(l.lat)-s(u.lat))/Math.PI,p=l.lng-u.lng,m=(p<0?p+360:p)/360,f=c(g.mapDim.height,t,d),T=c(g.mapDim.width,i,m);return Math.min(f,T,21)},g.getLatLng=function(e){return new plugin.google.maps.LatLng(e.location.latitude,e.location.longitude)},g.getLatLngBounds=function(e){return new plugin.google.maps.LatLngBounds(_.map(e,g.getLatLng))},g.getMapIconUrl=function(e){return"/img/pins/"+(e.index+1)+"-"+(e.selected?"on":"off")+".png"},g.getClinicianById=function(t){var e=g.results[g.page];return _.filter(e,function(e){return t===e.id})[0]},g.highlightClinician=function(e,t){if(!g.selectedMarker||g.selectedMarker.get("params").index!==e){var i=void 0!==t?t:T.markers[e];if(g.selectedMarker){var n=g.selectedMarker.get("params").clinicianId,o=g.getClinicianById(n),a=_.findIndex(g.results[g.page],o),r=g.getMapIconUrl({index:a,selected:!1});g.selectedMarker.setIcon({url:r,size:{width:20,height:32}})}g.selectedMarker=i;var s=g.getMapIconUrl({index:e,selected:!0});g.selectedMarker.setIcon({url:s,size:{width:20,height:32}})}},g.highlightScrolledClinician=_.throttle(function(){var e=1<Object.keys(T.markers).length;if("undefined"!=typeof plugin&&plugin.google.maps&&"map"===g.mode&&e&&!g.preventScrollTrigger){var t=r.$getByHandle("horizontal-scroller").getScrollPosition().left-(1<g.page?45:0),i=Math.floor(t/300);-1<i&&i<25&&g.highlightClinician(i)}},125),g.addClinicianToMap=function(e){var t=_.findIndex(g.results[g.page],e),i=g.getMapIconUrl({index:t,selected:!1});g.map.addMarker({position:{lat:e.location.latitude,lng:e.location.longitude},icon:{url:i,size:{width:20,height:32}}},function(a){a.set("params",{index:t,clinician:e,clinicianId:e.id}),(T.markers[t]=a).on(plugin.google.maps.event.MARKER_CLICK,function(e){var t=a.get("params").clinicianId,i=g.getClinicianById(t),n=_.findIndex(g.results[g.page],i),o=300*n+(1<g.page?45:0);g.highlightClinician(n,a),g.preventScrollTrigger=!0,r.$getByHandle("horizontal-scroller").scrollTo(o,0,!0),s(function(){g.preventScrollTrigger=!1},500)})})};var i,n=0;g.displaySuggestions=function(t){++n;var e=u.serverURL+"/find-a-therapist/suggestions",i={searchVal:t,remoteCallId:n};l.get(e,{params:i}).success(function(e){e.remoteCallId<n||(g.searchResults=e.suggestions,-1!=p.instant("MY_LOCATION").toLowerCase().indexOf(t.toLowerCase())&&g.searchResults.unshift({category:"MYLOCATION",title:p.instant("MY_LOCATION")}))}).error(function(e){})},g.setSearchLocation=function(e){g.searchResults=[],g.filterData.location=e,g.hideResults=!0},g.clearSearch=function(){g.searchResults=[],g.filterData.location=""},g.$watch("filterData.location",function(e,t){i&&s.cancel(i),g.hideResults?g.hideResults=!1:e&&2<e.length&&e!=p.instant("MY_LOCATION")&&(i=s(function(){var e=g.filterData.location;g.displaySuggestions(e)},350))})},T.storePosition=function(e){T.position=e,T.position.recordedAt=moment()},T.getPosition=function(){return T.position};var g=function(e){var t=moment().add(4,"h");u.isDevelopment()&&(t=moment());var i=t.clone().add(4,"w");return e.isAfter(t)&&e.isBefore(i)};return T.createRepeatingConsultations=function(e){var t=[],s=[],c=[],l=[];return e.forEach(function(r){if(s=[],0===r.openConsultations.length)t.push(r);else{r.openConsultations.forEach(function(e,t){if(l=[],e.repeating){var i=function(e){var t=moment().add(4,"h");u.isDevelopment()&&(t=moment());var i=moment(e.startTime).clone();if(t.isAfter(i)){var n=t.diff(i,"d"),o=Math.ceil(n/e.intervalDays);return 0===o&&(o=1),i.clone().add(o*e.intervalDays,"d")}return i.clone()}(e);for(moment(e.startTime).isSame(i)||c.push(t);g(i)&&(!e.cancelTime||!i.isAfter(e.cancelTime));){var n=m.evaluateException(e,i);if(moment(e.startTime).isSame(i)||n){if(moment(e.startTime).isSame(i)&&n){var o=_.findIndex(r.openConsultations,{id:e.id});c.push(o)}}else{var a=angular.copy(e);a.startTime=i,l.push(a)}i=i.clone().add(e.intervalDays,"d")}}else g(moment(e.startTime))||c.push(t);l.length&&(s=s.concat(l))});for(var e=angular.copy(r);c.length;)e.openConsultations.splice(c.pop(),1);e.openConsultations=e.openConsultations.concat(s),e.openConsultations=_.sortBy(e.openConsultations,"startTime"),t.push(e)}}),t},T.getCurrentPosition=function(){var i=d.defer();return navigator&&navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(e){var t={lat:e.coords.latitude,lng:e.coords.longitude};i.resolve(t)},function(e){i.reject(e)},T.geoOptions),i.promise},T}]),(service=angular.module("practitionerService",[])).factory("PractitionerService",["authHttp","AccountService","HabitsService","GeneralService","AssessmentService","$ionicModal","$translate","$ionicPopup","$rootScope","$timeout","$state","$sce","Environment","OverlayService","$analytics",function(c,l,m,f,t,e,h,i,T,n,o,r,a,s,u){var g={cachedClients:void 0,hasConnectedToSelf:function(){if(l.getAccountUser().user&&g.cachedClients)for(var e=l.getAccountUser().user.id,t=0;t<g.cachedClients.length;++t){if(g.cachedClients[t].clientId==e)return!0}return!1},clientNotificationCount:function(t){var e=l.getUserNotification(),i=_.filter(e.groupNotifications,function(e){return!_.isEmpty(e)}),n=0;return i&&t&&_.each(i,function(e){e.groupId===t.clientGroupId&&(n+=e.actions)}),n},clearConsultationNotifications:function(){return c.post("/app/practitioner/appointments/clearAllNotifications")},updateDirectoryVisibility:function(e){var t=l.getAccountUser();return t.practitioner.publicDirectory=e,c.post("app/practitioner/account",t.practitioner)},presignURL:function(e){return c.get("/app/practitioner/presignURL?type="+e)},setPhotoURL:function(e){return c.post("/app/practitioner/setPhotoURL",e)},hasInvitedOther:function(){if(l.getAccountUser().user&&g.cachedInvites)for(var e=l.getAccountUser().user.email,t=0;t<g.cachedInvites.length;++t){if(g.cachedInvites[t].email!=e)return!0}return!1},getCachedClients:function(){return g.cachedClients},getClients:function(){var t=createPromise();return c.get("/app/practitioner/clients").success(function(e){g.cachedClients=e,t.successCallback&&t.successCallback(e)}).error(function(){t.errorCallback&&t.errorCallback()}),t},testClient:function(){return c.post("/app/practitioner/democlient")},inviteClient:function(e){return c.post("/app/practitioner/client",e)},updateClient:function(e){return c.put("/app/practitioner/client",e)},disconnectClient:function(e){return c.delete("/app/practitioner/client/"+e.account.id)},resendInvite:function(e){return c.post("/app/practitioner/resendInvite",e)},deleteAllForClient:function(e){return c.post("/app/practitioner/cancelupcoming/"+e)},getUserContext:function(e){var t={clientId:e};return c.get("/app/practitioner/usercontext",{params:t})},getUserActivity:function(e,t,i){var n={clientId:e};return t&&(n.startTime=t.getTime()),i&&(n.endTime=i.getTime()),c.get("/app/practitioner/useractivity",{params:n})},getUser:function(e){return c.get("/app/practitioner/client/"+e)},getAssessments:function(){return c.get("/app/assessments")},getAssessment:function(e){return c.get("/app/assessments/"+e)},getAssessmentRequests:function(e){var t={accountId:e};return c.get("/app/practitioner/assessmentrequests",{params:t})},editAssessmentRequest:function(e,t,i,n,o,a){var r={accountId:e,requestDate:n,repeating:o,intervalDays:a};return c.put("/app/assessments/"+t+"/request/"+i,r)},cancelAssessmentRequest:function(e,t){return c.delete("/app/assessments/"+e+"/request/"+t)},getAssessmentResults:function(e,t){return c.get("/app/assessments/"+e+"/request/"+t)},downloadPDF:function(e,t){return c.get("/app/assessments/"+e+"/request/"+t+"/report.pdf",{responseType:"blob"})},requestAssessment:function(e,t,i,n,o,a){var r={accountId:e,requestDate:i,repeating:n,intervalDays:o};l.setUserPreference("practitioner_completed_postupgrade",!0);var s={};return!0===a&&(s={params:{force:"true"}}),c.post("/app/assessments/"+t+"/request",r,s)},baaSigned:function(){return c.post("/app/practitioner/setBaaSigned")},getAppointmentsForClient:function(e){return c.get("/app/practitioner/appointments?clientId="+e)},getAppointments:function(e,t){var i={};return e&&(i.startTime=e.getTime()),t&&(i.endTime=t.getTime()),c.get("/app/practitioner/appointments",{params:i})},newAppointment:function(e){return c.post("/app/practitioner/appointments",e)},editAppointment:function(e){return c.put("/app/practitioner/appointments/"+e.id,e)},cancelAppointment:function(e){return c.delete("/app/practitioner/appointments/"+e.id)},createAppointmentException:function(e){var t=e.exceptionTime?e.exceptionTime:e.startTime;return c.delete("/app/practitioner/appointments/"+e.id+"?startTime="+t)},newRoom:function(e){return c.post("/app/practitioner/rooms",e)},initClientFunctionality:function(v){v.dismissCopyConfirmation=function(){v.codeCopied=void 0},v.codeCopiedCallback=function(e){v.codeCopied=e,v.$$phase||v.$apply(),n(function(){v.codeCopied=void 0},1500)},v.closeEditClientModal=function(){s.modal.close(v.editClientModal).then(function(e){v.editClientModal=e,v.showClientConfirmationModal=!1})},v.newClient=function(e){v.editClientModal||(v.client=void 0,v.editClient={account:{firstName:e?e.firstName:void 0,lastName:e?e.lastName:void 0,email:e?e.email:void 0},message:"",sendEmail:!!e},v.showTestDrive=function(){return a.isDevelopment()||0===clients.length},s.modal.open({modalId:"EditClientModal",templateUrl:"templates/practitioner/edit-client.html",scope:v,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){v.editClientModal=e}))},v.updateClient=function(e){e&&(v.client=e),v.editClient={account:{firstName:e.account.firstName,lastName:e.account.lastName,email:e.account.email},message:"",sendEmail:!1,emailEditable:e.emailEditable},s.modal.open({modalId:"EditClientModal",templateUrl:"templates/practitioner/edit-client.html",scope:v,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){v.editClientModal=e})};var S=["#E77D8D","#AB8FBF","#48A3B6","#4BA578","#919640","#C77C4A"];var C=function(e){v.graphAssessment.id=e,t.getAssessment(v.graphAssessment.id,function(e){v.clientAssessments&&(v.clientAssessments.title.text="All Time "+e.shortName),v.thirtyDayAssessments&&(v.thirtyDayAssessments.title.text="30 Day "+e.shortName)})};v.graphAssessment={id:-1};var e=l.getUserPreference("practitioner_last_overview_assessment");function p(){return'<span style="font-size: 10px">'+moment(this.x).format("MMM DD, YYYY h:mm a")+'</span><br/><span class="mood '+this.points[0].point.moodClass+'">'+m.getHabitDisplayFromData(this.points[0].point.moodEntry)+"</span>"}e&&C(e=+e),v.updateClientAssessmentGraph=function(e,t){var i,n,o={};if(v.clientAssessments||(v.clientAssessments={}),_.merge(v.clientAssessments,{chart:{type:"spline",height:240,width:500},title:{text:"All Time Assessments"},legend:{enabled:!1},yAxis:{min:0,max:24,ceiling:24,tickInterval:10,labels:{enabled:!0},title:{text:null}},xAxis:{min:0,showEmpty:!0,labels:{enabled:!0},title:{text:"Days From First Assessment"}},series:[],plotOptions:{series:{cursor:"pointer",point:{events:{click:function(){v.goToClientTab(this.client.clientId,"assessments")}}}}},tooltip:{useHTML:!0,style:{pointerEvents:"auto"},formatter:function(){return'<span style="font-size: 10px">'+moment(this.point.finishedAt).format("MMM DD, YYYY h:mm a")+"</span><br/><strong>"+this.point.client.account.firstName+" "+this.point.client.account.lastName.substring(0,1)+".</strong>, "+h.instant(this.point.scoreType)+": "+this.y+"<br>"+this.x+" Days"}}}),v.clientAssessments.series.length=0,v.clientAssessments.series.push({name:"Fake Series",data:[]}),void 0===v.clientAssessments.iteration?v.clientAssessments.iteration=0:++v.clientAssessments.iteration,e){for(var a=0;a<e.length;++a){var r=e[a];if(r.lastAssessment=void 0,r.firstAssessment=void 0,i={},r.assessmentRequests&&0<r.assessmentRequests.length)for(var s=0;s<r.assessmentRequests.length;++s){var c=r.assessmentRequests[s].userAssessment;if(o[c.assessmentId]=c.assessmentId,!t||t<=0?(t=c.assessmentId,C(t)):v.graphAssessment.id<=0&&C(t),(!t||c.assessmentId==t)&&"COMPLETE"==c.status){(!r.lastAssessment||c.finishedAt>r.lastAssessment.userAssessment.finishedAt)&&(r.lastAssessment=r.assessmentRequests[s]),r.firstAssessment||(r.firstAssessment=c.finishedAt);for(var l=0;l<c.scores.length;++l){var u=c.scores[l],d=i[u.name];d||(d=i[u.name]=[]),d.push({x:Math.floor((c.finishedAt-r.firstAssessment)/864e5),y:u.score,finishedAt:c.finishedAt,scoreType:u.name,client:r}),u.maxScore>v.clientAssessments.yAxis.max&&(v.clientAssessments.yAxis.max=v.clientAssessments.yAxis.ceiling=u.maxScore)}}}for(var p in i){var m=i[p],f=r.account.firstName+" "+r.account.lastName.substring(0,1)+". ";v.clientAssessments.series.push({name:f,data:m,color:(n=a,S[n%S.length])})}C(v.graphAssessment.id)}v.thirtyDayAssessments?v.thirtyDayAssessments.series.length=0:v.thirtyDayAssessments={},_.merge(v.thirtyDayAssessments,v.clientAssessments);var T=new Date;T.setHours(0,0,0,0);var g=new Date(T.getTime()-2592e6);v.thirtyDayAssessments.title.text="30 Day Assessments",v.thirtyDayAssessments.xAxis.min=g.getTime(),v.thirtyDayAssessments.xAxis.max=(new Date).getTime(),v.thirtyDayAssessments.xAxis.title.text="Past 30 Days",v.thirtyDayAssessments.xAxis.labels.enabled=!0,v.thirtyDayAssessments.xAxis.labels.formatter=function(){return moment(this.value).format("MMM D")},v.thirtyDayAssessments.tooltip.formatter=function(){return'<span style="font-size: 10px">'+moment(this.point.finishedAt).format("MMM DD, YYYY h:mm a")+"</span><br/><strong>"+this.point.client.account.firstName+" "+this.point.client.account.lastName.substring(0,1)+".</strong>, "+h.instant(this.point.scoreType)+": "+this.y};for(var A=0;A<v.thirtyDayAssessments.series.length;++A){i=v.thirtyDayAssessments.series[A].data;for(var E=0;E<i.length;++E){var I=i[E];I.x=I.finishedAt}}for(t in v.availableClientAssessmentIds=[],o)v.availableClientAssessmentIds.push(+t)}},v.refreshClients=function(d){g.getClients().success(function(e){if(v.clients=e,v.clients)for(var t=0;t<v.clients.length;++t){var i=v.clients[t];if(i.moodData){i.moodData.sort(function(e,t){return e.experiencedAt-t.experiencedAt});var n=new Date;n.setHours(0,0,0,0);var o=n.getTime(),a=o+864e5;o-=5184e5;for(var r=[],s=0;s<8;++s)r.push(o+864e5*s);var c=[];i.moodChart={chart:{height:40},yAxis:{max:8,min:0},xAxis:{min:o,max:a,tickPositions:r},series:[{data:c,pointStart:1}],tooltip:{formatter:p}};for(var l=0;l<i.moodData.length;++l){var u=i.moodData[l];u.experiencedAt>o&&c.push({x:u.experiencedAt,y:u.valueInt,moodEntry:u,moodClass:m.getMoodClassFromData(u),color:f.COLORS[7-u.valueInt]})}}}v.hasActiveClients=!1,v.clients.forEach(function(e){"DISCONNECTED"!=e.status&&(v.hasActiveClients=!0)}),T.$broadcast("event:clientsLoaded"),d&&d()}).error(function(){v.clients=[]})},v.testDrive=function(){g.testClient().success(function(e){v.closeEditClientModal(),v.refreshClients()})},v.saveClient=function(){if(v.submittingClient=!0,v.errorMessage=void 0,!v.editClient.account.firstName)return v.errorMessage="First name required",void(v.submittingClient=!1);if(!v.editClient.account.lastName)return v.errorMessage="Last name required",void(v.submittingClient=!1);var t=v.client&&v.client.id,e=g.inviteClient;t&&(e=g.updateClient,v.editClient.id=v.client.id,v.editClient.account.id=v.client.account.id),e(v.editClient).success(function(e){t?(v.closeEditClientModal(),v.client.account.firstName=v.editClient.account.firstName,v.client.account.lastName=v.editClient.account.lastName,v.client.account.email=v.editClient.account.email):(v.clientInviteCode=e.inviteCode,v.downloadPrompt=h.instant("CLIENT_ADDED_DOWNLOAD_PROMPT"),v.showClientConfirmationModal=!0),v.submittingClient=!1,v.refreshClients()}).error(function(e,t,i,n){v.submittingClient=!1,409==t?s.popup.alert({template:h.instant("INVITE_CLIENT_CONFLICT"),okText:h.instant("OK_GOT_IT"),okType:"button-default"}):(u.addEventAppsee("errorTriggered","inviteClient"),s.popup.alert({template:h.instant("INVITE_CLIENT_ERROR"),okText:h.instant("OK_GOT_IT"),okType:"button-default"}))})},v.toggleSendEmail=function(){v.editClient.sendEmail=!v.editClient.sendEmail},T.$on("event:appointmentsUpdated",function(){v.refreshClients()})},getFirstRecurringInstance:function(e,t){"object"!=typeof e.startTime&&(e.startTime=moment(e.startTime));var i=t.diff(e.startTime,"d"),n=Math.ceil(i/e.intervalDays);return n<=0?e.startTime.clone():e.startTime.clone().add(e.intervalDays*n,"d")},evaluateException:function(e,t){var i=!1;return e.exceptions&&e.exceptions.forEach(function(e){t.isSame(e.startTime)&&(i=!0)}),i},createClientGroup:function(n){var o=createPromise();return c.put("/app/practitioner/client/"+n+"/group").success(function(e){var t=g.getCachedClients(),i=_.find(t,function(e){return e.id==n});i&&(i.clientGroupId=e),o.successCallback&&o.successCallback(e)}).error(function(){o.errorCallback&&o.errorCallback()}),o},initAppointmentFunctionality:function(o){function e(e,t){var i=moment().tz(l.getUserTimeZone()).format("z"),n=moment();return{startTime:n=o.roundUpToNearestFiveMinutes(n),duration:t,intervalDays:7,set:!1,tz:i,appointmentType:e,clientId:void 0}}function i(){s.modal.open({modalId:"EditAppointmentModal",templateUrl:"templates/practitioner/edit-appointment.html",scope:o,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){o.editAppointmentModal=e})}function n(){o.reschedule=!1,o.appointmentModalError=null,o.appointmentModalErrorMsg=null,o.showTeletherapyExplainer=!1,o.client=void 0}o.closeEditAppointmentModal=function(){s.modal.close(o.editAppointmentModal).then(function(e){o.editAppointmentModal=e,o.showAppointmentConfirmation=!1})},o.clientSelected=function(e){o.showTeletherapyExplainer=!1,o.showClientDropdown=!0,o.client=_.find(o.clients,function(e){return e.account.id==o.editAppointment.clientId}),"INVITED"==o.client.status&&(o.editAppointment.appointmentType="IN_PERSON")},o.getFormattedApptTime=function(e){var t="";return o.canStartAppointment(e)?t+="Now, "+moment(e.startTime).format("M/D")+" at ":t+=moment(e.startTime).format("dddd, M/D")+" at ",t+=moment(e.startTime).format("h:mmA z")+" ("+e.duration+"m)"},o.viewClient=function(e){o.goToClient(e),o.closeEditAppointmentModal()},o.updateAppointment=function(e,t,i){o.appointmentModalError=null,o.appointmentModalErrorMsg=null,o.newClientRibbon=r.trustAsHtml(h.instant("FIND_NEW_CLIENTS_RIBBON")),o.showTeletherapyExplainer=!1,o.reschedule=t,o.minDate=moment().subtract(5,"minutes"),o.editAppointment=angular.copy(e),o.editAppointment.exceptionTime=angular.copy(o.editAppointment.startTime),o.editAppointment.disallowCancel=i,o.editAppointment.duration=""+o.editAppointment.duration,"CONSULTATION"==o.editAppointment.appointmentType&&(o.minDate=moment().subtract(5,"minutes"));var n=moment().tz(l.getUserTimeZone()).format("z");o.editAppointment.tz=n,s.modal.open({modalId:"EditAppointmentModal",templateUrl:"templates/practitioner/edit-appointment.html",scope:o,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){o.editAppointmentModal=e})},o.checkExplainerStatus=function(){o.showTeletherapyExplainer=!1,o.client&&"CONNECTED"!=o.client.status&&(o.editAppointment.appointmentType="IN_PERSON",o.showTeletherapyExplainer=!0)},o.isPremiumEnabled=function(){return l.isPremiumEnabled()},o.isViewingPersonalAccount=function(){return o.practitionerUserId==+o.userId},o.getRecurringDislpay=function(e){return _.find(o.recurringOptions,{value:e}).display},o.setConsultation=function(e){"15"!=e.duration&&"20"!=e.duration&&(e.duration="15"),e.clientId=void 0},o.newConsultation=function(){l.isPremiumEnabled()?(n(),o.minDate=moment().subtract(5,"minutes"),o.newClientRibbon=r.trustAsHtml(h.instant("FIND_NEW_CLIENTS_RIBBON")),o.editAppointment=e("CONSULTATION","20"),i()):o.showClinicianPremiumModal()},o.getCreateButtonLabel=function(){return o.isConsultation()?h.instant("SCHEDULE_CONSULTATION"):h.instant("SCHEDULE_APPOINTMENT")},o.isConsultation=function(){return"CONSULTATION"==o.editAppointment.appointmentType},o.newAppointment=function(t){n(),o.isPremiumEnabled()||o.isViewingPersonalAccount()||t&&t.account.premium?(o.minDate=moment().subtract(5,"minutes"),o.editAppointment=e("IN_PERSON","50"),t&&o.clients&&(o.client=_.find(o.clients,function(e){return e.id==t.id}),o.editAppointment.client=t,"CONNECTED"!=o.client.status&&(o.editAppointment.appointmentType="IN_PERSON")),i()):o.showClinicianPremiumModal()},o.saveAppointment=function(e,t){if(e)o.editAppointment.repeating=0<o.editAppointment.intervalDays,g.editAppointment(o.editAppointment).success(function(){o.appointmentModalError=!1,o.appointmentModalErrorMsg=null,void 0!==o.editAppointmentModal&&(o.showAppointmentConfirmation=!0),T.$broadcast("event:appointmentsUpdated")}).error(function(e){e.message?o.appointmentModalErrorMsg=e.message:(u.addEventAppsee("errorTriggered","appointmentSave"),o.appointmentModalErrorMsg=h.instant("APPOINTMENT_SAVE_ERROR")),o.appointmentModalError=!0,console.log("There was an error creating appointment.")});else{var i={practitionerId:o.practitionerId,clientId:"CONSULTATION"!=o.editAppointment.appointmentType?o.client?o.client.account.id:o.editAppointment.clientId:void 0,description:"Test Appointment",startTime:o.editAppointment.startTime,duration:+o.editAppointment.duration,appointmentType:o.editAppointment.appointmentType,intervalDays:o.editAppointment.intervalDays,repeating:0<o.editAppointment.intervalDays};i.repeating=0<i.intervalDays,g.newAppointment(i).success(function(e){o.appointmentModalError=!1,o.appointmentModalErrorMsg=null,t&&t(),o.showAppointmentConfirmation=!0,T.$broadcast("event:appointmentsUpdated")}).error(function(e){e.message?o.appointmentModalErrorMsg=e.message:(u.addEventAppsee("errorTriggered","appointmentSave"),o.appointmentModalErrorMsg=h.instant("APPOINTMENT_SAVE_ERROR")),o.appointmentModalError=!0})}},o.scheduleRecurringException=function(e){o.editAppointment.intervalDays=0,o.editAppointment.repeating=!1,o.saveAppointment(!1)},o.rescheduleRecurringAppointment=function(){o.createException(o.editAppointment,o.scheduleRecurringException)};var a=function(e,t){g.createAppointmentException(e).success(function(){T.$broadcast("event:appointmentCancelled",{appointment:e}),o.refreshClients(),t?t():void 0!==o.editAppointmentModal&&o.closeEditAppointmentModal()}).error(function(){console.log("an error occurred creating this exception")})};o.createException=function(t,e){if(e)a(t,e);else{var i="",n="";n="CONSULTATION"==t.appointmentType?(i=h.instant("CANCEL_CONSULTATION_TEXT"),h.instant("YES_CANCEL_CONSULTATION")):(i=h.instant("CANCEL_APPOINTMENT_TEXT"),h.instant("YES_CANCEL_APPOINTMENT")),s.popup.confirm({template:i,cancelText:h.instant("NO_CANCEL_APPOINTMENT"),cssClass:"cancel-appointment",cancelType:"button-default",title:h.instant("CANCEL_APPOINTMENT"),okText:n,okType:"button-default"}).then(function(e){e&&a(t)})}},o.cancelAppointment=function(t,e){var i;i="CONSULTATION"==t.appointmentType?(yesState=h.instant("YES_CANCEL_CONSULTATION"),t.repeating?h.instant("CANCEL_REPEATING_CONSULTATION_TEXT"):h.instant("CANCEL_CONSULTATION_TEXT")):(yesState=h.instant("YES_CANCEL_APPOINTMENT"),t.repeating?h.instant("CANCEL_REPEATING_APPOINTMENT_TEXT"):h.instant("CANCEL_APPOINTMENT_TEXT")),s.popup.confirm({template:i,cancelText:h.instant("NO_CANCEL_APPOINTMENT"),cssClass:"cancel-appointment",cancelType:"button-default",title:h.instant("CANCEL_APPOINTMENT"),okText:yesState,okType:"button-default"}).then(function(e){e&&g.cancelAppointment(t).success(function(){T.$broadcast("event:appointmentCancelled",{appointment:t,repeating:t.repeating}),o.refreshClients(),void 0!==o.editAppointmentModal&&(o.closeEditAppointmentModal(),o.refreshClients())})})},o.getPhoneDisplay=function(e){},o.getAppointmentTypeDisplay=function(e){return"TELETHERAPY"==e?h.instant("TELETHERAPY"):"IN_PERSON"==e?h.instant("IN_PERSON"):void 0},o.joinSessionModalClick=function(e){o.closeConsultConfirmModal(),o.goToStartConsult(e)},o.closeConsultConfirmModal=function(){s.modal.close(o.consultConfirmModal).then(function(e){o.consultConfirmModal=e})},o.showConsultConfirmation=function(e){o.consult=e,s.modal.open({modalId:"ConsultConfirmModal",templateUrl:"templates/practitioner/consult-confirm.html",scope:o,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){o.consultConfirmModal=e})}},checkForAgreements:function(t){t.closeAgreementsModal=function(){s.modal.close(t.agreementsModal).then(function(e){t.agreementsModal=e})},t.checkForAgreementsModal=function(){if(t.showSignTOS=!t.hasSignedTOS(),t.showBAA=!t.hasSignedBAA(),t.showSignTOS||t.showBAA){t.agreements={medProfChecked:!t.showSignTOS,baaChecked:!t.showBAA};var e=-1<o.current.name.indexOf("practitioner");!t.agreementsModal&&e&&s.modal.open({modalId:"AgreementsModal",templateUrl:"templates/practitioner/agreements.html",scope:t,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){t.agreementsModal=e})}else t.agreementsModal&&t.closeAgreementsModal()},t.submitAgreements=function(){t.agreements.baaChecked&&t.agreements.medProfChecked&&g.baaSigned().success(function(){t.hasSignedTOS()?t.retrieveUserContext():l.setUserPreference("signed_supplemental_tos",!0).success(function(){t.retrieveUserContext()})})},t.checkForAgreementsModal()},initAssessmentFunctionality:function(o){o.closeEditAssessmentRequestModal=function(){o.showAssessmentConfirmation=!1,s.modal.close(o.editAssessmentRequestModal).then(function(e){o.editAssessmentRequestModal=e})},o.newAssessmentRequest=function(e){if(o.isPremiumEnabled()||o.isViewingPersonalAccount()||e&&e.account.premium){var t=new Date((new Date).getTime()-3e5);o.minDate=moment(t);var i=moment();i=o.roundUpToNearestFiveMinutes(i);var n=moment().tz(l.getUserTimeZone()).format("z");e&&o.clients&&(o.client=_.find(o.clients,{id:e.id})),o.editAssessmentRequest={assessmentId:1,requestDate:i,intervalDays:7,set:!1,tz:n},o.$watch("editAssessmentRequest.assessmentId",function(e,t){var i=_.find(o.assessments,{id:e});null!==i.feeCode?o.assessmentModalInfo=!0:o.assessmentModalInfo=!1,o.assessmentModalInfoMsg="Note: The requested assessment will be billed to your account for "+i.price}),s.modal.open({modalId:"EditAssessmentRequestModal",templateUrl:"templates/practitioner/edit-assessment-request.html",scope:o,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){o.editAssessmentRequestModal=e,o.assessmentModalError=!1})}else o.showClinicianPremiumModal()},o.editAssessment=function(e){if(!o.editAssessmentRequestModal){o.editAssessmentRequest=angular.copy(e);var t=moment().tz(l.getUserTimeZone()).format("z");o.editAssessmentRequest.tz=t,s.modal.open({modalId:"EditAssessmentRequestModal",templateUrl:"templates/practitioner/edit-assessment-request.html",scope:o,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){o.editAssessmentRequestModal=e})}};var t=function(e){return _.find(o.assessments,{id:e}).longName};o.saveAssessmentRequest=function(){var e=!1;!0===o.assessmentModalError&&(e=!0),o.submittingAssessmentRequest||(o.submittingAssessmentRequest=!0,g.requestAssessment(o.client.account.id,o.editAssessmentRequest.assessmentId,o.editAssessmentRequest.requestDate,!!o.editAssessmentRequest.intervalDays,o.editAssessmentRequest.intervalDays,e).success(function(){o.submittingAssessmentRequest=!1,o.confirmationAssessmentName=t(o.editAssessmentRequest.assessmentId),o.showAssessmentConfirmation=!0,T.$broadcast("event:assessmentsUpdated")}).error(function(e){o.submittingAssessmentRequest=!1,o.assessmentModalError=!0,o.assessmentModalErrorMsg=e.message}))},o.updateAssessmentRequest=function(){o.submittingAssessmentRequest||(o.submittingAssessmentRequest=!0,g.editAssessmentRequest(o.client.account.id,o.editAssessmentRequest.assessmentId,o.editAssessmentRequest.id,o.editAssessmentRequest.requestDate,!!o.editAssessmentRequest.intervalDays,o.editAssessmentRequest.intervalDays).success(function(){o.submittingAssessmentRequest=!1,o.confirmationAssessmentName=t(o.editAssessmentRequest.assessmentId),o.showAssessmentConfirmation=!0,o.loadAssessmentRequests()}).error(function(e){o.submittingAssessmentRequest=!1}))},o.loadAssessments=function(){o.loadingAssessments=!0,g.getAssessments().success(function(e){o.assessments=e,o.assessments.forEach(function(e){e.longName=h.instant(e.name)+" ("+e.shortName+")"}),o.loadingAssessments=!1}).error(function(){console.log("There was an error loading assessments."),o.loadingAssessments=!1})}},getClientHabits:function(e){return c.get("/app/practitioner/client/"+e.clientId+"/habits")},saveHomeworkInternal:function(e,t,i,n,o,a){var r="/app/practitioner/client/"+e+"/homework",s={activityId:i,auxiliaryId:n,activityCategory:t,newSubGoal:o,reminderDate:a};return c.put(r,s)},getClientGoalContext:function(e){return c.get("/app/practitioner/client/"+e+"/goalContext")},disableCommunities:function(e,t){var i="/app/practitioner/client/"+e+"/disableCommunities";return c.post(i,{preference:"communitiesIneligible",value:t})}};return g}]),(servicesModule=angular.module("relaxService",[])).factory("RelaxService",["$translate","Environment","AccountService","HabitsService","GeneralService","$state","$timeout","MediaService","ActivityService","$ionicHistory",function(n,a,c,e,r,i,s,l,t,o){var u={playOptions:{playAudioWhenScreenIsLocked:!0},bgPlayOptions:{playAudioWhenScreenIsLocked:!0,numberOfLoops:1e3},bgAudioSources:["Ocean","SummerNight","Campfire","ForestMorning","Stream","RooftopRain","City","Thunderstorm","Bach","Pinknoise","none"],bgAudioText:["Ocean Waves","Summer Night","Campfire","Forest Morning","Stream","Rooftop Rain","City","Thunderstorm","Bach Cello Suite #1","White Noise","No Sound"],categoryOrder:["BASICS","MINDFULNESS","STRESSFUL_SITUATIONS","CALM_DOWN","INNER_STRENGTH"],breathingValues:[.007,.008,.009,.01,.011,.012,.013,.015,.016,.018,.02,.022,.024,.027,.029,.032,.036,.039,.043,.047,.052,.057,.063,.069,.076,.083,.091,.1,.109,.119,.13,.142,.154,.168,.182,.198,.214,.231,.25,.269,.289,.31,.332,.354,.378,.401,.426,.45,.475,.5,.525,.55,.574,.599,.622,.646,.668,.69,.711,.731,.75,.769,.786,.802,.818,.832,.846,.858,.87,.881,.891,.9,.909,.917,.924,.931,.937,.943,.948,.953,.957,.961,.964,.968,.971,.973,.976,.978,.98,.982,.984,.985,.987,.988,.989,.99,.991,.992,.993,.993],relaxExercises:[],relaxExercisesAudio:[],relaxExerciseLengths:[],relaxExerciseOldLengths:[]};return u.breathingValueMaxIndex=u.breathingValues.length-1,u.getExerciseObject=function(e){for(var t in u.getRelaxCategories())for(var i=u.getRelaxCategories()[t].exercises,n=0;n<i.length;++n){var o=i[n];if(o.exercise==e)return o}},u.setConfigBackState=function(e){u.configBackState=e},u.clearConfigBackState=function(){u.configBackState=void 0},u.hasConfigBackState=function(){return void 0!==u.configBackState},u.goToConfigBackState=function(){var e=u.configBackState;e?(u.clearConfigBackState(),i.go("app.home").then(function(){i.go(e)})):o.goBack()},u.setExitState=function(e,t){u.exitState=e,u.exitParams=t},u.clearExitState=function(){u.exitState=void 0,u.exitParams=void 0},u.hasExitState=function(){return void 0!==u.exitState},u.goToExitState=function(){var e=u.exitState,t=u.exitParams;u.exitState?(u.clearExitState(),i.go("app.home").then(function(){i.go(e,t)})):openURL("/home")},u.setMainBackState=function(e){u.mainBackState=e},u.getMainBackState=function(){return u.mainBackState},u.getExerciseObjectByAudio=function(e){for(var t in u.getRelaxCategories())for(var i=u.getRelaxCategories()[t].exercises,n=0;n<i.length;++n){var o=i[n];if(o.audio==e)return o}},u.getExerciseObjectByActivityId=function(e){var t=u.getRelaxCategories();for(var i in t)for(var n=t[i].exercises,o=0;o<n.length;++o){var a=n[o];if(a.activity==e)return a}},u.initRelaxExercises=function(){var e=0;for(var t in u.getRelaxCategories())for(var i=u.getRelaxCategories()[t].exercises,n=0;n<i.length;++n){var o=i[n];u.relaxExercises[e]=o.exercise,u.relaxExercisesAudio[e]=o.audio,u.relaxExerciseLengths[e]=o.audioLength,u.relaxExerciseOldLengths[e]=o.oldAudioLength?o.oldAudioLength:null,++e}},u.initializeBackgroundAudio=function(t,e){if("none"!=t.bgAudioSource){var i=t.bgAudioSource;a.isAndroid()?i+=".ogg":i+=".aifc",t.bgAudio=l.loadMedia("img/background-sounds/"+i,"bgAudio",e),l.setVolume(t.bgAudio,0),t.volumeData={bgVolume:.2};var n,o=c.getUserPreference("soundscape_volume");o&&(t.volumeData.bgVolume=+o),t.bgVolumeChanged=function(){n&&(s.cancel(n),n=void 0),n=s(function(){c.setUserPreference("soundscape_volume",t.volumeData.bgVolume)},500),t.started&&t.bgAudio&&l.setVolume(t.bgAudio,t.volumeData.bgVolume)},t.initializeVolumeValue=function(){var e=t.volumeData.bgVolume;t.volumeData.bgVolume=0,s(function(){t.$apply(function(){t.volumeData.bgVolume=e})},1)}}},u.getBreathingValue=function(e){return 1<e?e=1:e<0&&(e=0),u.breathingValues[Math.floor(e*u.breathingValueMaxIndex)]},u.replaceExerciseCharacters=function(e){return e.replace(/ /g,"_").replace(/\+/g,"").replace(/-/g,"").replace(/:/g,"").replace(/__/g,"_")},u.getRelaxCategories=function(){var e=_.filter(t.activities,function(e){return"relax"===e.type});return{BASICS:{descriptionKey:"RELAX_BASICS_DESC",exercises:_.filter(e,function(e){return"BASICS"===e.relaxCategory})},CALM_DOWN:{descriptionKey:"RELAX_CALM_DOWN_DESC",exercises:_.filter(e,function(e){return"CALM_DOWN"===e.relaxCategory})},STRESSFUL_SITUATIONS:{descriptionKey:"RELAX_STRESSFUL_SITUATIONS_DESC",exercises:_.filter(e,function(e){return"STRESSFUL_SITUATIONS"===e.relaxCategory})},MINDFULNESS:{descriptionKey:"RELAX_MINDFULNESS_DESC",exercises:_.filter(e,function(e){return"MINDFULNESS"===e.relaxCategory})},INNER_STRENGTH:{descriptionKey:"RELAX_INNER_STRENGTH_DESC",exercises:_.filter(e,function(e){return"INNER_STRENGTH"===e.relaxCategory})}}},u.getRelaxExerciseDisplay=function(e){var t="RELAX_ACTIVITY_"+e;return t=u.replaceExerciseCharacters(t).toUpperCase(),n.instant(t)},u.getBreathingDuration=function(){var e=c.getUserPreference("breathe_cycle_length");return 8*(e=e?+e:8)},u.getMeditationDuration=function(){var e=c.getUserPreference("meditation_length");return 60*(e=e?+e:10)},u.getExerciseTimeDisplay=function(e){var t=u.relaxExercises.indexOf(e),i=u.relaxExerciseLengths[t];if(0<i)return r.getTimeDisplay(i,!0,!0);if("Deep Breathing"==e||"Visualization"==e){var n=u.getBreathingDuration();return r.getTimeDisplay(n,!0,!0)}if("Soundscape Mode"!=e)return"";var o=u.getMeditationDuration();return r.getTimeDisplay(o,!0,!0)},u.getExerciseMinuteDisplay=function(e){var t,i=u.getExerciseObject(e);return 0<(t="Deep Breathing"==i.exercise||"Visualization"==i.exercise?u.getBreathingDuration():"Soundscape Mode"==i.exercise?u.getMeditationDuration():i.audioLength)?(t=Math.round(t/60))+" "+(1<t?n.instant("HABITS_VALUES_MINUTES"):n.instant("HABITS_VALUES_MINUTE")):""},u.getRelaxExerciseDescription=function(e){var t="RELAX_ACTIVITY_"+e+"_DESCRIPTION";return t=u.replaceExerciseCharacters(t).toUpperCase(),n.instant(t)},u.initializeBreatheParams=function(e){e.bgAudioSources=u.bgAudioSources,e.soundOptions={options:u.bgAudioText,soundOptionOrdinal:0},e.cycleOptions={options:[5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25],cycleOptionOrdinal:1},e.lengthOptions={options:[5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30],lengthOptionOrdinal:1},e.breathingOptions={options:[!0,!1],breathingOptionOrdinal:0},e.continueOptions={options:["Return","Continue Sounds"],continueOptionOrdinal:0},e.bellOptions={options:[!0,!1],bellOptionOrdinal:0},e.enableMeditationMode=!1,e.affirmationOptions={options:["Record my own","I am calm","I am strong","I am","I believe in myself","I can accomplish anything","I can handle whatever comes my way","I love myself","This too shall pass"],affirmationOptionOrdinal:0};var t=c.getUserPreference("bg_audio_src");t&&(0<=e.bgAudioSources.indexOf(t)&&(e.soundOptions.soundOptionOrdinal=e.bgAudioSources.indexOf(t)));e.bgAudioSource=e.bgAudioSources[e.soundOptions.soundOptionOrdinal];var i=c.getUserPreference("breathe_cycle_length");e.cycleLength=i?parseInt(i):8,e.cycleOptions.cycleOptionOrdinal=e.cycleOptions.options.indexOf(e.cycleLength);var n=c.getUserPreference("meditation_length");e.meditationLength=n?parseInt(n):10,e.lengthOptions.lengthOptionOrdinal=e.lengthOptions.options.indexOf(e.meditationLength);var o=c.getUserPreference("disable_breathing_sounds");e.breathingSoundsOn=!o||"false"==o,e.breathingOptions.breathingOptionOrdinal=e.breathingOptions.options.indexOf(e.breathingSoundsOn);var a=c.getUserPreference("enable_meditation_mode");a&&"true"==a&&(e.continueOptions.continueOptionOrdinal=1,e.enableMeditationMode=!0);var r=c.getUserPreference("meditation_bell");e.bellOptions.bellOptionOrdinal="false"==r?(e.playBell=!1,1):(e.playBell=!0,0);var s=c.getUserPreference("affirmation");e.affirmation=s?(e.affirmationOptions.affirmationOptionOrdinal=e.affirmationOptions.options.indexOf(s),s):e.affirmationOptions.options[e.affirmationOptions.affirmationOptionOrdinal]},u}]),(servicesModule=angular.module("skillsService",[])).factory("SkillsService",["$translate","$timeout","authHttp","Environment","AccountService","HabitsService","GoalsService","StorageService","$state","ActivityService",function(i,n,o,a,e,u,r,s,c,l){var d={skillContext:void 0,todaysActions:[],todaysActionDate:new Date,suggestedActivityId:void 0};function p(e,t,i,n){if(!i||u.metGoalWithHabitData(t)){var o,a={actionClass:"health",skillSubClass:e.name.toLowerCase(),actionTitle:u.getHabitName(e),actionTimestamp:t.experiencedAt,data:t};e.id==u.MOOD_HABIT_ID?(o=u.getHabitValueById(t.habitValueId),a.actionClass=e.name.toLowerCase(),a.skillSubClass=u.getMoodClass(o),a.actionTitle=u.getHabitDisplayById(e,t.habitValueId)):e.id==u.STRESS_HABIT_ID&&(o=u.getHabitValueById(t.habitValueId),a.actionClass=e.name.toLowerCase(),a.skillSubClass=u.getStressClass(o),a.actionTitle=u.getHabitDisplayById(e,t.habitValueId)),n.push(a)}}function m(e,t,i,n){n.push({actionClass:i.actionClass,actionTitle:i.actionTitle,actionTimestamp:t,data:e})}function f(e){for(var t=0;t<e.length;++t){var i=e[t];i.actionTimestamp=new Date(i.actionTimestamp)}e.sort(function(e,t){return t.actionTimestamp-e.actionTimestamp});for(var n=!1,o=0;o<e.length;++o){var a=e[o];n="mood"!=a.actionClass||(0===o&&(a.showActionButton=!0),n&&(a.moodRespondedTo=!0),!1)}}function T(e){var t=_.chain(l.activities).filter(function(e){return e.isSkillActivity}).map(function(e){return e.activityName=i.instant(e.actionTitle),e}).keyBy("name").value();return e&&(t.COMPLETED_EXPERIMENT={activityName:"COMPLETED_EXPERIMENT",actionClass:"goals",actionTitle:i.instant("COMPLETED_GOAL")}),t}return d.initFromLocalStorage=function(){s.getItem("skillContext",function(e){if(e){var t=JSON.parse(e);d.skillContext=t}})},d.logout=function(){d.skillContext=void 0,d.todaysActions=[],d.todaysActionDate=new Date,d.suggestedActivityId=void 0},d.getSuggestedActivityId=function(){return d.suggestedActivityId},d.unsetSuggestedActivityId=function(){d.suggestedActivityId=void 0},d.setSuggestedActivityId=function(e){d.suggestedActivityId=e},d.getTodaysActions=function(){return d.todaysActions},d.completedDailyActivity=function(){return _.find(d.todaysActions,function(e){return"mood"!=e.actionClass})},d.getTodaysLastMoodEntryTime=function(){var e=_.sortBy(_.filter(d.todaysActions,{actionClass:"mood"}),"actionTimestamp");return e.length?moment(e[e.length-1].actionTimestamp):null},d.isDayCompleted=function(){return completedDaily=d.completedDailyActivity(),todaysLastMoodEntry=d.getTodaysLastMoodEntryTime(),void 0!==completedDaily&&null!==todaysLastMoodEntry},d.setSkillContext=function(e){var t=function(e){var t=d.skillContext,i=[];e&&t&&(e.goalsLevel>t.goalsLevel&&i.push({type:"goals",level:e.goalsLevel}),e.habitsLevel>t.habitsLevel&&i.push({type:"habits",level:e.habitsLevel}),e.relaxLevel>t.relaxLevel&&i.push({type:"relax",level:e.relaxLevel}),e.socialLevel>t.socialLevel&&i.push({type:"social",level:e.socialLevel}),e.thoughtsLevel>t.thoughtsLevel&&i.push({type:"thoughts",level:e.thoughtsLevel}));return i.length}(e);return d.skillContext=e,d.skillContext&&s.setItem("skillContext",JSON.stringify(d.skillContext)),t},d.getSkillLevel=function(e){var t=d.skillContext;return t?"goals"==e?t.goalsLevel:"health"==e?t.habitsLevel:"relax"==e?t.relaxLevel:"thoughts"==e?t.thoughtsLevel:"social"==e?t.socialLevel:0:0},d.createActionsWithData=function(e,t){var i=[];if(e)for(var n=0;n<e.length;++n){var o=e[n],a=u.getHabitValueById(o.habitValueId);p(u.getAccountHabitById(a.habitId),o,!1,i)}var r=T(!0);if(t)for(var s=0;s<t.length;++s){var c=t[s],l=r[c.activityName];l&&m(c,c.date,l,i)}return f(i),i},d.recreateTodaysActions=function(){var a=new Date;d.todaysActions=[],d.todaysActionDate=a,function(){for(var e=u.getAccountHabits(),t=0;t<e.length;++t){var i=e[t],n=u.getHabitDataList(i,a);if(n)for(var o=0;o<n.length;++o)p(i,n[o],!1,d.todaysActions)}}(),function(){var e=r.getTodaysAchievedGoals();if(e)for(var t=0;t<e.length;++t){var i=e[t];d.todaysActions.push({actionClass:"goals",actionTitle:i.title,actionTimestamp:i.achievedRecordedAt})}}(),function(){var e=T(!1);for(var t in e){var i=e[t],n=l.getActivities(i.name);if(n)for(var o=0;o<n.length;++o){var a=n[o];m(a,a.recordedAt,i,d.todaysActions)}}}(),f(d.todaysActions)},d.checkForLevelUp=function(i,e){(function(){var t=createPromise();a.isOnline()?o.get(a.serverURL+"/skills/context").success(function(e){t.successCallback&&t.successCallback(e)}).error(function(){t.errorCallback&&t.errorCallback()}):n(function(){t.successCallback&&t.successCallback(d.skillContext)});return t})().success(function(e){var t=d.setSkillContext(e);i&&i(t)}).error(function(){e&&e()})},d.clearThoughtsBackState=function(){d.thoughtsBackState=void 0,d.thoughtsBackParams=void 0},d.setThoughtsBackState=function(e,t){d.thoughtsBackState=e,d.thoughtsBackParams=t},d.goToThoughtsBackState=function(){var e=d.thoughtsBackState,t=d.thoughtsBackParams;e?(d.clearThoughtsBackState(),c.go("app.home").then(function(){c.go(e,t)})):c.go("app.home")},d}]),(servicesModule=angular.module("storageService",[])).factory("StorageService",["Environment","$rootScope","$cordovaNativeStorage",function(a,t,e){var r=!1,s={initComplete:!1,canEncrpyt:!1,secureStorage:void 0,keys:{},initKeys:[],retrievedKeys:[]};function c(e,t){u(e);var i=localStorage.getItem(e);l(e),t(i)}function o(e,t){localStorage.setItem(e,t)}function i(){s.trackingInit||s.retrievedKeys.length!=s.initKeys.length||(s.initComplete=!0,t.$broadcast("event:initializedFromStorage"))}function l(e){-1==s.retrievedKeys.indexOf(e)&&s.retrievedKeys.push(e),i()}function u(e){s.trackingInit&&-1==s.initKeys.indexOf(e)&&s.initKeys.push(e)}function d(e){if(!e)return e;return e.replace(/\u2028/g," ").replace(/\u2029/g," ")}return s.isInitComplete=function(){return s.initComplete},s.setFirstRun=function(){e.setItem("firstRun","true").then(function(e){return!0},function(e){console.log("error setting first run"),console.log(e)})},s.checkForFirstRun=function(t,i){e.getItem("firstRun").then(function(e){t()},function(e){i()})},s.trackInit=function(){s.trackingInit=!0},s.stopTracking=function(){s.trackingInit=!1,i()},s.storeInsecureItem=function(e,t){o(e,d(t))},s.getInsecureItem=function(e,t){c(e,t)},s.clear=function(){if(a.isStorageAllowed())if(r)if(s.canEncrpyt)for(var e in s.keys)s.removeItem(e),console.log("StorageService removing ["+e+"]."),delete s[e];else localStorage.clear();else console.log("Cannot clear, Storage has not been initialized.")},s.getItem=function(i,t,n,o){a.isStorageAllowed()&&(r?s.canEncrpyt?(u(i),s.secureStorage.get(function(e){l(i),t(e)},function(e){console.log("StorageService Error Retrieving ["+i+"]:"+e);var t=!0;o&&o.preventRetrievalFailureRecording&&(t=!1),t&&l(i),n&&n(e)},i)):c(i,t):console.log("Cannot retrieve item ["+i+"]. Storage has not been initialized."))},s.setItem=function(t,e,i){if(a.isStorageAllowed())if(console.log("StorageService setting ["+t+"]"),r){var n=d(e);s.canEncrpyt?s.secureStorage.set(function(e){s.keys[e]=e,i&&i(e)},function(e){console.log("StorageService Error Setting ["+t+"]: "+e)},t,n):o(t,n)}else console.log("Cannot set item ["+t+"]. Storage has not been initialized.")},s.removeItem=function(e){var t;a.isStorageAllowed()&&(console.log("StorageService removing ["+e+"]"),r&&(s.canEncrpyt?s.secureStorage.remove(function(e){},function(e){console.log("StorageService Error, "+e)},e):(t=e,localStorage.removeItem(t))))},s.isKeyguardSecure=function(e,t){a.isWeb()||a.isWebDebug()?e(!0):s.secureStorage?s.secureStorage.isKeyguardSecure(e,t):t()},s.initialize=function(t){r||(window.cordova&&window.cordova.plugins&&window.cordova.plugins.SecureStorage?s.secureStorage=new cordova.plugins.SecureStorage(function(){a.isAndroid()?s.isKeyguardSecure(function(e){r=!0,s.canEncrpyt=!!e,console.log("Created SecureStorage"),t&&t()}):(r=!0,s.canEncrpyt=!0,console.log("Created SecureStorage"),t&&t())},function(e){r=!0,s.canEncrpyt=!1,t&&t(),console.log("The SecureStorage plugin could not be inititalized: "+e)},"pacifica"):(r=!0,console.log("WARNING: SecureStorage is not available on this platform."),t&&t()))},s.onceInitialized=function(e){s.isInitComplete()?e():once(t,"event:initializedFromStorage",e)},s}]),(servicesModule=angular.module("thoughtsService",[])).factory("ThoughtsService",["$ionicHistory","$state","$translate","Environment","ActivityService","OverlayService",function(t,i,n,o,a,r){var s={recordingId:0,mediaCache:{}};function c(e){r.popup.alert({title:"",template:"<div>"+(e?n.instant("THOUGHTS_MIC_ACCESS_PROMPT_SETTINGS"):n.instant("THOUGHTS_MIC_ACCESS_PROMPT"))+"</div>",okText:n.instant("OK_GOT_IT"),okType:"button-default"}).then(function(){"app.rethink-record"!=i.current.name&&"app.breathe-record"!=i.current.name&&"app.muscles-record"!=i.current.name||t.goBack()})}return s.getThoughtActivities=function(){return a.thoughtActivities},s.getThoughtType=function(e){return("TEXT_DISTORTIONS"==e.thoughtType||"AUDIO_DISTORTIONS"==e.thoughtType?"REFRAME":"AUDIO_JOURNAL"==e.thoughtType||"TEXT_JOURNAL"==e.thoughtType?"JOURNAL":e.thoughtType).toLowerCase()},s.getActivityByConstantName=function(e){return a.activities[e]},s.getActivityByName=function(e){return"gratitude-journal"==e&&(e="gratitude"),s.getThoughtActivities()[e]},s.checkMicAccess=function(){cordova.plugins.diagnostic&&cordova.plugins.diagnostic.getMicrophoneAuthorizationStatus(function(e){e===cordova.plugins.diagnostic.permissionStatus.GRANTED?console.log("Microphone use is authorized"):e===cordova.plugins.diagnostic.permissionStatus.DENIED||e===cordova.plugins.diagnostic.permissionStatus.NOT_REQUESTED?cordova.plugins.diagnostic.requestMicrophoneAuthorization(function(e){e!==cordova.plugins.diagnostic.permissionStatus.GRANTED&&c(e===cordova.plugins.diagnostic.permissionStatus.DENIED_ALWAYS)},function(){c(!1)}):e===cordova.plugins.diagnostic.permissionStatus.DENIED_ALWAYS&&c(!0)},function(e){c(!1)})},s.getRecordingTagDisplay=function(e,t){var i="";return 0<=e.indexOf("catastrophizing")&&(i+=n.instant("THOUGHTS_EMOTIONS_CATASTROPHIZING")),0<=e.indexOf("emotional_reasoning")&&(0<i.length&&(i+=", "),i+=n.instant("THOUGHTS_EMOTIONS_EMOTIONAL_REASONING")),0<=e.indexOf("mind_reading")&&(0<i.length&&(i+=", "),i+=n.instant("THOUGHTS_EMOTIONS_MIND_READING")),0<=e.indexOf("fortune_telling")&&(0<i.length&&(i+=", "),i+=n.instant("THOUGHTS_EMOTIONS_FORTUNE_TELLING")),0<=e.indexOf("extreme_words")&&(0<i.length&&(i+=", "),i+=n.instant("THOUGHTS_EMOTIONS_PRESSURIZED")),0<=e.indexOf("judging")&&(0<i.length&&(i+=", "),i+=n.instant("THOUGHTS_EMOTIONS_LABELLING")),0<=e.indexOf("personalization")&&(0<i.length&&(i+=", "),i+=n.instant("THOUGHTS_EMOTIONS_PERSONALIZATION")),0<=e.indexOf("overgeneralizing")&&(0<i.length&&(i+=", "),i+=n.instant("THOUGHTS_EMOTIONS_GENERALIZING")),0<=e.indexOf("negative_filtering")&&(0<i.length&&(i+=", "),i+=n.instant("THOUGHTS_EMOTIONS_NEGATIVE")),0<=e.indexOf("notsure")&&(0<i.length&&(i+=", "),i+=n.instant("NEGATIVE_THOUGHT")),0===i.length&&(i="negative"==t?n.instant("NEGATIVE_THOUGHT"):n.instant("POSITIVE_THOUGHT")),i},s.getRecordingId=function(){return s.recordingId},s.incrementRecordingId=function(){s.recordingId++},s.loadFile=function(t,i){window.LocalFileSystem&&window.requestFileSystem(LocalFileSystem.TEMPORARY,0,function(e){e.root.getFile(t,{create:!0,exclusive:!1},function(e){i(e)},function(){console.log("did not get file.")})},function(){console.log("failed getting filesystem")})},s.loadMedia=function(e,i,n){if(s.mediaCache[e])i.mediaRec=s.mediaCache[e],i.elapsedTime=i.mediaRec.__elapsedTime,i.elapsedTime||(i.elapsedTime=0);else{var t=function(t){console.log("Creating media: "+t),i.mediaRec=new Media(t,function(e){console.log("Created media: "+t)},function(e){console.log("Could not create media ["+t+"] "+e.code+", "+e.message)},n),i.mediaRec.setVolume(1),s.clearMediaCache(),s.mediaCache[e]=i.mediaRec};s.loadFile(e,function(e){o.isAndroid()?(i.nativeSrc=e.nativeURL,t(i.nativeSrc)):(i.nativeSrc=e.nativeURL,t(e.fullPath))})}},s.clearMediaCache=function(){for(var e in s.mediaCache)s.mediaCache[e].release(),delete s.mediaCache[e]},s.clearRethinkState=function(){localStorage.removeItem("rethinkReplayState")},s.getUniqueDistortions=function(e){for(var t=[],i=0;i<e.length;++i)for(var n=e[i].tagString.split(/[,;]/),o=0;o<n.length;++o){var a=n[o];t.indexOf(a)<0&&t.push(a)}return t},s}]),(tokenModule=angular.module("tokenProvider",[])).provider("Token",function(){var t={token:void 0,setToken:function(e){t.token=e},getToken:function(){return t.token},hasToken:function(){return window.Cookies?!!Cookies.get("SessionExpires"):!!t.token}};return{setToken:function(e){t.setToken(e)},getToken:function(){return t.getToken()},hasToken:function(){return t.hasToken()},$get:function(){return t}}}),tokenModule.factory("TokenService",["$rootScope","StorageService","Token","Environment",function(e,i,n,t){var o={},a=5;return o.initFromLocalStorage=function(){t.isWeb()||i.getItem("token",function(e){e&&n.setToken(e),console.log("TOKEN RETRIEVED: "+e)},function(){1<=--a&&o.initFromLocalStorage()},{preventRetrievalFailureRecording:1<a})},o.getToken=function(){return n.getToken()},o.hasToken=function(){return n.hasToken()},o.update=function(e,t){n.setToken(e),i.setItem("token",e)},o.clear=function(){n.setToken(void 0),i.removeItem("token"),window.Cookies&&(Cookies.remove("SessionExpires"),t.isDevelopment()?document.cookie='SessionExpires="";Max-Age=0;domain=.dev.thinkpacifica.com':document.cookie='SessionExpires="";Max-Age=0;domain=.www.thinkpacifica.com')},o}]),(servicesModule=angular.module("webappEnvironmentService",[])).factory("Environment",[function(){var e={serverURL:"/app",websocketURL:"wss://"+window.location.host.toString()+"/app",gaTrackingCode:"UA-55091509-7"},t="5.3";return e.isOnline=function(){return!0},e.isDebug=function(){return window.location.host.indexOf("www.thinkpacifica.com")<0},e.isIos=function(){return!1},e.isAndroid=function(){return!1},e.isWeb=function(){return!0},e.isWebDebug=function(){return!0},e.isDevelopment=function(){return window.location.host.indexOf("www.thinkpacifica.com")<0},e.isStorageAllowed=function(){return!1},e.setStorageAllowed=function(e){},e.getAppVersion=function(){return t},e.getGATrackingCode=function(){return e.gaTrackingCode},e}]);