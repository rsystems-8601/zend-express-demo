angular.module("accountCtrl",[]).controller("AccountCtrl",["$scope","$rootScope","$sce","$controller","$state","$http","$timeout","$ionicPopup","$ionicModal","$translate","AccountService","Token","Environment","OverlayService",function(a,e,t,n,o,i,r,s,c,u,l,d,p,g){if(l.isLoggedIn()){a.isPractitioner=function(){return l.isPractitioner()},a.editingEmail=!1,a.editingName=!1,a.editingLanguage=!1,a.showingLogout=!1,a.connectPractitioner=!1,a.enteringInvite=!0,a.submittingInvite=!1,a.practitionerData={inviteCode:"",practitioner:""},a.accountData={name:""},a.insecureEmail={checked:!1},a.insecurePushes={checked:!1};var m=l.getUserPreference("receive_phi_in_email");void 0!==m&&(a.insecureEmail.checked="true"==m);var f=l.getUserPreference("receive_phi_in_pushes");void 0!==f&&(a.insecurePushes.checked="true"==f),a.getAuthorizationText=function(){if(a.practitionerData.practitioner){var e=u.instant("CONNECT_TO_PRACTITIONER_DESC");return e=e.replace("XXXPRACTITIONER_NAMEXXX",a.getPractitionerName(a.practitionerData.practitioner)),t.trustAsHtml(e)}return""},a.cancelConnectPractitioner=function(){a.connectPractitioner=!1,a.enteringInvite=!0},a.getPractitionerName=function(e){var t="";return e.title&&(t+=e.title+" "),t+=e.firstName+" "+e.lastName,e.credentials&&(t+=" "+e.credentials),t},a.getPractitionerDetails=function(e){if(!e)return"";var t=a.getPractitionerName(e);return t+=", "+e.location.address+", "+e.location.city+", "+e.location.state},a.useInviteCode=function(){a.enteringInvite?l.getPractitionerInvite(a.practitionerData.inviteCode).success(function(e){a.practitionerData.practitioner=e,a.enteringInvite=!1}).error(function(e,t,n,o){404==t?s.alert({template:u.instant("CONNECT_PRACTITIONER_INVALID_CODE"),okText:u.instant("OK_GOT_IT"),okType:"button-default"}):s.alert({template:u.instant("CONNECT_PRACTITIONER_ERROR"),okText:u.instant("OK_GOT_IT"),okType:"button-default"})}):(a.submittingInvite=!0,l.connectPractitioner(a.practitionerData.inviteCode).success(function(e){a.submittingInvite=!1,a.connectPractitioner=!1,a.practitionerConnections.push(e),void 0===l.getUserPreference("receive_phi_in_email")&&g.modal.open({modalId:"InsecureEmailModal",templateUrl:"templates/account.insecureEmail.modal.html",scope:a,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){a.insecureEmailModal=e}),l.setUserPreference("receive_phi_in_email",!1),l.setUserPreference("receive_phi_in_pushes",!1)}).error(function(e,t,n,o){var i;a.submittingInvite=!1,i=404==t?u.instant("CONNECT_PRACTITIONER_INVALID_CODE"):409==t?u.instant("CONNECT_TO_PRACTITIONER_CONFLICT"):u.instant("CONNECT_PRACTITIONER_ERROR"),s.alert({template:i,okText:u.instant("OK_GOT_IT"),okType:"button-default"})}))},a.disconnectPractitioner=function(t){s.confirm({template:"<div>"+u.instant("DISCONNECT_PRACTITIONER_POPUP")+"</div>",cancelText:u.instant("CANCEL"),cancelType:"button-default",okText:u.instant("DISCONNECT"),okType:"button-default"}).then(function(e){e&&l.disconnectPractitioner(t).success(function(){var e=a.practitionerConnections.indexOf(t);0<=e&&a.practitionerConnections.splice(e,1)}).error(function(e,t,n,o){s.alert({template:u.instant("DISCONNECT_PRACTITIONER_ERROR"),okText:u.instant("OK_GOT_IT"),okType:"button-default"})})})},a.closeInsecureEmailModal=function(){g.modal.close(a.insecureEmailModal).then(function(e){a.insecureEmailModal=e})},a.updateInsecureEmailPreference=function(){a.insecureEmail.checked?l.setUserPreference("receive_phi_in_email",!0):l.setUserPreference("receive_phi_in_email",!1)},a.updateInsecurePushPreference=function(){a.insecurePushes.checked?l.setUserPreference("receive_phi_in_pushes",!0):l.setUserPreference("receive_phi_in_pushes",!1)},a.showInsecureEmailPreference=function(){return void 0!==l.getUserPreference("receive_phi_in_email")||a.practitionerConnections&&0<a.practitionerConnections.length},h(),e.$on("event:pacificaReady",h),a.accountData.locale=l.getUserPreference("preferred_locale"),void 0===a.accountData.locale?a.accountData.locale="en-us":a.accountData.locale=a.accountData.locale.toLowerCase(),a.showUpdateName=function(){a.accountData.name=a.accountUser.user.name,a.editingName=!0},a.cancelUpdateName=function(){a.editingName=!1},a.updateName=function(){var e=a.accountData.name;e&&0!==e.length?(a.nicknameError=void 0,a.updatingName=!0,l.setNickname(e).success(function(){a.accountUser.user.name=e,a.updatingName=!1,a.editingName=!1}).error(function(e,t,n,o){a.updatingName=!1,a.nicknameError$translate.instant("UPDATE_NICKNAME_ERROR")})):a.nicknameError=u.instant("LOGIN_ERROR_MISSING_NAME")},a.isEmailValidated=function(){return l.isEmailValidated()},a.updateEmail=function(){l.setEmailAddress(a.accountUser.user.email).success(function(){s.alert({template:u.instant("CHECK_EMAIL_UPDATE_EMAIL"),okText:u.instant("OK_GOT_IT"),okType:"button-default"})}).error(function(e,t,n,o){a.emailError=u.instant("UPDATE_EMAIL_ERROR"),a.updatingEmail=!1})},a.changeLanguage=function(){a.editingLanguage=!0},a.stopEditingLanguage=function(){a.editingLanguage=!1},a.setLanguage=function(e){l.setLocale(e).success(function(){a.accountData.locale=e,a.languageUpdated=!0,a.editingLanguage=!1,r(function(){a.languageUpdated=!1},3e3)})},a.isLanguageActive=function(e){return a.accountData.locale==e},a.isPremium=function(){return l.isPremiumEnabled()},a.getPremiumExpiration=function(){return l.getPremiumExpiration()},a.isWebSubscription=function(){return a.isPremium()&&!a.subscriptionCancelled&&"WEB"==l.getAccountUser().account.paymentPlatform&&"PURCHASE"==l.getAccountUser().account.paymentType},a.hasDownloadedGiftCodes=function(){return"true"==l.getUserPreference("has_purchased_gift_codes")},a.downloadGiftCodes=function(){l.getDownloadGiftCodeToken().success(function(e){window.open(p.serverURL+"/payment/giftCodes.csv?token="+e,"_blank")}).error(function(){window.alert("There was an error loading the gift codes.")})},a.cancelSubscription=function(){l.cancelSubscription().success(function(){s.alert({template:u.instant("SUBSCRIPTION_CANCEL_SUCCESS"),okText:u.instant("OK_GOT_IT"),okType:"button-default"}).then(function(){a.subscriptionCancelled=!0})}).error(function(){s.alert({template:u.instant("SUBSCRIPTION_CANCEL_ERROR"),okText:u.instant("OK_GOT_IT"),okType:"button-default"})})},a.getAccountType=function(){if(a.accountUser&&a.accountUser.account){var e="";return l.isPremiumEnabled()?e+=u.instant("ACCOUNT_TYPE_FULL_ACCESS")+" - "+u.instant(a.accountUser.account.paymentType):e+=u.instant("ACCOUNT_TYPE_BASIC"),e}},a.showLogout=function(){a.showingLogout=!0},a.hideLogout=function(){a.showingLogout=!1},a.showConfirmDelete=function(){a.deleteModal=l.showConfirmDeleteModal("templates/account.delete.modal.html",a)},a.confirmDelete=function(){l.validateDeleteText(a.confirmData,a.deleteModal,a.socialLogout)?a.closeDeleteModal():a.confirmError=!0},a.closeDeleteModal=function(){g.modal.close(a.deleteModal).then(function(e){a.deleteModal=e})}}else o.go("app.login");function h(){if(a.accountUser=l.getAccountUser(),a.accountUser&&a.accountUser.user){a.isPractitioner()&&o.go("practitioner.account"),a.accountData.name=a.accountUser.user.name,a.accountData.email=a.accountUser.user.email,a.practitionerConnections=l.getConnectionContext();var e=l.getUserPreference("receive_phi_in_email");void 0!==e&&(a.insecureEmail.checked="true"==e)}a.practitionerConnections?a.practitionerConnections=a.practitionerConnections.practitioners:a.practitionerConnections=[]}}]),angular.module("assessmentIntroCtrl",[]).controller("AssessmentIntroCtrl",["$scope","AssessmentService","$state","$rootScope",function(e,t,n,o){e.setShowSidebar(!1),e.isAppReady()&&t.initializeIntroFunctionality(e),e.$on("event:pacificaReady",function(){t.initializeIntroFunctionality(e)}),e.closeAssessment=function(){e.setShowSidebar(!0),n.go("app.therapist")}}]),angular.module("assessmentQuestionCtrl",[]).controller("AssessmentQuestionCtrl",["$scope","AssessmentService","$rootScope","$controller","$state","$stateParams",function(e,t,n,o,i,a){function r(){t.initializeQuestionFunctionality(e),"COMPLETE"==e.assessmentRequest.userAssessment.status&&i.go("app.assessment-results",{assessmentId:a.assessmentId,assessmentRequestId:a.assessmentRequestId})}o("AssessmentIntroCtrl",{$scope:e}),e.isAppReady()&&r(),e.$on("event:pacificaReady",function(){r()})}]),angular.module("assessmentResultsCtrl",[]).controller("AssessmentResultsCtrl",["$scope","AssessmentService","$rootScope","$state",function(e,t,n,o){e.isReview=o.current.data.review,e.setShowSidebar(!1),e.exitResults=function(){e.setShowSidebar(!0),o.go("app.therapist")},e.isAppReady()&&t.initializeResultsFunctionality(e),e.$on("event:pacificaReady",function(){t.initializeResultsFunctionality(e)})}]),angular.module("habitsCtrl",[]).controller("HabitsCtrl",["$scope","$rootScope","$controller","$state","$timeout","$http","$translate","$analytics","$ionicPopup","AccountService","HabitsService","GeneralService","Environment","OverlayService",function(c,n,e,o,u,t,i,a,r,s,l,d,p,g){function m(){c.habits=l.getAccountHabits(),c.potentialHabits=l.getPotentialAccountHabits(),l.removeMoodHabit(c)}function f(e,t){var n=e.habitValues;e.goalOrdinal>=n.length&&(e.goalOrdinal=n.length-1);var o,i=!1,a=!!n[e.goalOrdinal].valueString;if(t&&!c.editingGoals){var r=l.getHabitValueById(t.habitValueId);r&&(i=!0,o=r.ordinate+1)}i||(o=c.editingGoals?e.goalOrdinal+1:0),c.todaysData[e.id]||(c.todaysData[e.id]={habit:e});var s=c.todaysData[e.id];s.hasData=i,s.habitData=i?t:void 0,s.isString=a,s.updated=!1,s.options||(s.options={}),s.options.floor=0,s.options.ceil=n.length,s.options.step=1,s.options.value=o}function h(){m();for(var e=0;e<c.habits.length;++e){var t=c.habits[e];f(t,c.getHabitData(t.id))}++c.redraw}if(c.todaysData={},c.updating=!1,void(c.redraw=0)===c.editingGoals&&(c.editingGoals=!1),m(),c.date=new Date,c.getDateString=function(){var e=d.getDayString(c.date);if(e==d.getDayString(new Date))return i.instant("TODAY");var t=(new Date).addDays(-1);return e==d.getDayString(t)?i.instant("YESTERDAY"):(c.date.getDay(),c.date.getMonth(),moment(c.date).format("dddd, MMMM Do YYYY"))},c.previousDay=function(){if(c.canGoBackwards()){c.postHabits(),c.date=c.date.addDays(-1);var e=l.hasHabitData(c.date);if(console.log("has data: "+e),!e){var t=c.date.addDays(-6);c.loadingData=!0,l.findHabitData(t,c.date).success(function(e){c.loadingData=!1,l.addHabitData(e)}).error(function(e,t,n,o){c.loadingData=!1,console.log("habit data error")}),a.eventTrack("previousDay",{category:"habits"})}h()}},c.nextDay=function(){c.canGoForward()&&(c.postHabits(),c.date=c.date.addDays(1),a.eventTrack("nextDay",{category:"habits"}),h())},c.canGoBackwards=function(){var e=s.getAccountUser();if(!e||!e.user)return!1;var t=new Date(c.date.getFullYear(),c.date.getMonth(),c.date.getDate()),n=new Date(e.user.createdAtStr);return new Date(n.getFullYear(),n.getMonth(),n.getDate())<t},c.canGoForward=function(){var e=(new Date).addDays(-1);return c.date<e},c.getHabitName=function(e){return l.getHabitName(e)},c.getEditHabitText=function(e){return c.editingGoals&&c.canEditHabit(e)?"("+i.instant("TAP_TO_EDIT")+")":""},c.getTodaysHabitsClass=function(){var e=0,t=c.habits;for(var n in t){var o=t[n];1!=o.id&&19!=o.id&&++e}var i=100*c.getCurrentlyCompletedHabits()/e;return 0===e?"zero":0===i?"zero":0<i&&i<10?"one":10<=i&&i<20?"two":20<=i&&i<30?"three":30<=i&&i<40?"four":40<=i&&i<50?"five":50<=i&&i<60?"six":60<=i&&i<70?"seven":70<=i&&i<80?"eight":80<=i&&i<90?"nine":90<=i&&i<100?"ten":"eleven"},c.getCurrentlyCompletedHabits=function(){for(var e=c.habits,t=0,n=0;n<e.length;++n){var o=e[n];if(1!=o.id&&19!=o.id){var i=c.todaysData[o.id].options.value;(c.editingGoals||0<i&&l.metGoal(o,i-1))&&++t}}return t},c.removeHabit=function(t){l.removeHabit(t.id).success(function(){for(var e in l.removeLocalHabit(t.id),c.todaysData)if(c.todaysData[t.id].habit.id==t.id){delete c.todaysData[t.id];break}m(),u(function(){n.$broadcast("reCalcViewDimensions")})}).error(function(e,t,n,o){window.alert(i.instant("HABITS_REMOVING_ACTIVITY_ERROR"))})},c.addHabit=function(e){l.addHabit(e.id,!0).success(function(){l.addLocalHabit(e),m(),c.stopAddingActivity(),h()}).error(function(e,t,n,o){window.alert(i.instant("HABITS_ERROR_ADDING_HABIT"))})},c.moveHabit=function(e,t,n){console.log("moving "+e.name+" from "+t+" to "+n),c.habits.splice(t,1),c.habits.splice(n,0,e),l.reorderHabits(c.habits)},c.isGoalMet=function(e){if(c.editingGoals)return!0;var t=c.todaysData[e.id];return 0!==t.options.value&&l.metGoal(e,t.options.value-1)},c.hasEntry=function(e){return 0<c.todaysData[e.id].options.value},c.getRangeBackgroundStyle=function(e){var t=100/(e.habitValues.length+1),n=(e.goalOrdinal+1)*t,o=e.goalMinimized?"green":"red",i=e.goalMinimized?"red":"green";return"background: repeating-linear-gradient(90deg, grey 0%, grey "+t+"%, "+o+" "+t+"%, "+o+" "+n+"%, "+i+" "+n+"%, "+i+" 100%)"},c.editGoals=function(){c.postHabits(),c.editingGoals=!c.editingGoals,h(),c.date=new Date},c.stopEditingGoals=function(){c.editingGoals=!1,h()},c.showAddActivity=function(){c.canAddHabits()?(c.postHabits(),c.addingActivity=!0):r.alert({template:i.instant("UNLIMITED_TRACKING_WEB_ERROR"),okText:i.instant("OK_GOT_IT"),okType:"button-default"})},c.stopAddingActivity=function(){c.addingActivity=!1,h(),u(function(){++c.redraw})},c.canAddHabits=function(){return!(3<=c.habits.length&&!s.hasUnlockedTracking())},c.hasPotentialHabits=function(){return 0<c.potentialHabits.length},c.isHabitDisabled=function(e){return c.canEditHabit(e)&&!s.isPremiumEnabled()},c.canEditHabit=function(e){var t=s.getAccountUser();return t&&t.user&&e.creatorId==t.user.id},c.editHabit=function(e,t){c.canEditHabit(e)&&(c.editingGoals||t)&&(l.setIsEditingHabits(!0),o.go("app.habits-create",{habitId:e.id}))},c.getHabitData=function(e){return l.getHabitDataByHabitId(c.date,e)},c.getTodaysData=function(e){if(c.todaysData[e.id])return c.todaysData[e.id]},c.getTodaysDataDisplay=function(e){if(c.todaysData[e.id])return 0===c.todaysData[e.id].options.value?i.instant("NO_DATA"):l.getHabitDisplay(e,c.todaysData[e.id].options.value-1)},c.habitCallbacks={valueUpdated:function(e){var t=c.getTodaysData(e);t&&(t.updated=!0)},disabledInteraction:function(){c.showPremiumModal()}},c.finishEditingGoals=function(){c.postHabits(),c.stopEditingGoals()},c.postHabits=function(e,t){c.editingGoals?function(e,t){for(var n=0;n<c.habits.length;++n){var o=c.habits[n],i=c.todaysData[o.id];i.updated&&(o.goalOrdinal=i.habit.goalOrdinal=i.options.value-1,l.updateGoalOrdinal(o).success(e).error(t))}h()}(e,t):function(e,i){var t=[],n=[];for(var o in c.todaysData){var a=c.todaysData[o],r=+a.options.value;if(0<r&&a.updated){var s=a.habitData;s?l.buildMultiHabitDataUpdateArray(n,a.habit,s,r-1,c.date):l.buildMultiHabitDataArray(t,a.habit,r-1,c.date)}}0<t.length&&(c.updating=!0,l.recordMultiHabitData(t).success(function(){h(),0<n.length?l.updateMultiHabitData(n).success(function(){h(),c.updating=!1,e&&e()}).error(function(e,t,n,o){c.updating=!1,i&&i()}):(c.updating=!1,e&&e())}).error(function(e,t,n,o){c.updating=!1,i&&i()})),0<n.length&&0===t.length&&l.updateMultiHabitData(n).success(function(){h(),c.updating=!1,e&&e()}).error(function(e,t,n,o){c.updating=!1,i&&i()}),0===n.length&&0===t.length&&e&&u(e)}(e,t)},c.initializeHabits=function(){h()},c.closeHealthKitModal=function(){s.setUserPreference("integrate_with_healthkit","true"),l.initHealthKit(),g.modal.close(c.healthKitModal).then(function(e){c.healthKitModal=e})},h(),l.requiresHabitDataReload()){var T=c.date.addDays(-6);l.findHabitData(T,c.date).success(function(e){c.loadingData=!1,l.addHabitData(e),l.clearHabitDataReload()}).error(function(e,t,n,o){c.loadingData=!1,console.log("habit data error")})}}]),function(){var e=angular.module("homeCtrl",[]);e.controller("HomeCtrl",["$scope","$rootScope","$controller","$state","$http","$timeout","$translate","AccountService","HabitsService",function(a,e,t,n,o,i,r,s,c){if(a.homeRenderReady=!1,s.isLoggedIn()){var u=function(){if(a.isShowingClientView())a.homeRenderReady=!0;else{s.getAccountUser().user;s.isPractitioner()?window.location.hash="#/practitioner/clients":a.homeRenderReady=!0}};a.isAppReady()&&(u(),a.showAgreement()),a.$on("event:pacificaReady",function(){u(),a.showAgreement()}),t("MoodCtrl",{$scope:a}),t("HabitsCtrl",{$scope:a}),t("RelaxCtrl",{$scope:a}),a.activeSection=void 0,a.showingMoodHelp=!1,a.showingHealthHelp=!1,a.showingRelaxHelp=!1,a.isSectionActive=function(e){return e==a.activeSection},a.isAnySectionAction=function(){return void 0!==a.activeSection},a.setSectionActive=function(e){if("mood"==(a.activeSection=e))a.initializeMoodData(),(t=s.getUserPreference("completed_mood_intro"))&&"true"==t||(a.showMoodHelp(),s.setUserPreference("completed_mood_intro","true"));else if("relax"==e){(t=s.getUserPreference("completed_relax_intro"))&&"true"==t||(a.showRelaxHelp(),s.setUserPreference("completed_relax_intro","true"))}else if("health"==e){var t;a.initializeHabits(),(t=s.getUserPreference("completed_habits_intro"))&&"true"==t||(a.showHealthHelp(),s.setUserPreference("completed_habits_intro","true"))}i(function(){++a.redraw,window.scrollTo(0,0)})},a.clearActiveSection=function(){a.activeSection=void 0,i(function(){window.scrollTo(0,0)})},a.updateMood=function(){a.postMoodData()},a.getCompletedHabits=function(){for(var e=c.getAccountHabits(),t=0,n=0;n<e.length;++n){var o=e[n];if(1!=o.id&&19!=o.id){var i=c.getHabitDataByHabitId(a.date,o.id);i&&c.metGoalWithHabitData(i)&&++t}}return t},a.getCurrentMoodClass=function(){return a.isSectionActive("mood")?a.getMoodClass():c.getTodaysLastMoodEntryClass()},a.$watch(a.getCurrentMoodClass,function(e,t){if(e!==t&&a.moodHabit){var n=_.map(a.moodHabit.habitValues,function(e){return e.display.split(" ").join("")});$("#mood-column").removeClass(n.join(" ")),a.currentMoodClass=e}}),a.getCurrentStressClass=function(){return a.getStressClass()},a.getTodaysHabitsClass=function(){var e=0,t=c.getAccountHabits();for(var n in t){var o=t[n];1!=o.id&&19!=o.id&&++e}var i=100*(a.isSectionActive("health")?a.getCurrentlyCompletedHabits():a.getCompletedHabits())/e;return 0===e?"zero":0===i?"zero":i<=25?"one":i<=44?"two":i<=55?"three":i<=74?"four":i<=99?"five":"six"},a.showMoodHelp=function(){a.showingMoodHelp=!0},a.hideMoodHelp=function(){a.showingMoodHelp=!1,i(function(){++a.redraw})},a.showHealthHelp=function(){a.showingHealthHelp=!0},a.hideHealthHelp=function(){a.showingHealthHelp=!1,i(function(){++a.redraw})},a.showRelaxHelp=function(){a.showingRelaxHelp=!0},a.hideRelaxHelp=function(){a.showingRelaxHelp=!1},a.getMoodTitle=function(){return r.instant("MOOD")},a.getHabitsHelpLine1=function(){return r.instant("HABITS_HELP_LINE_1")},a.getHabitsHelpLine2=function(){return r.instant("HABITS_HELP_LINE_2")},a.homeUpdateHabits=function(){a.updatingHabitData=!0,a.postHabits(function(){a.clearActiveSection(),a.updatingHabitData=!1},function(e,t,n,o){console.log("Error updating habit data:"+e),a.updatingHabitData=!1})},a.exitCurrentRelaxScreen=function(){a.showRelaxOptions?a.hideRelaxOptions():a.clearActiveSection()},$(document).ready(function(){$(".col-md-4").css("min-height",window.innerHeight)})}else n.go("app.login")}]),e.controller("MobileCtrl",["$scope","$rootScope","$controller","$state","$http","$translate","AccountService","HabitsService",function(e,t,n,o,i,a,r,s){}])}(),function(){var e=angular.module("loginCtrl",[]);e.controller("LoginCtrl",["$scope","$rootScope","$state","$stateParams","$http","$translate","$timeout","AccountService","HabitsService","GoalsService","AudioService","GeneralService","TokenService","Environment","AssessmentService","ActivityService","PathService","$ionicModal","$location","$sce","OverlayService",function(i,o,e,t,n,a,r,s,c,u,l,d,p,g,m,f,h,T,v,E,I){function _(){if(i.loginData.keepLoggedIn)return 288e5}function y(){return!i.signUpData.agreed&&(i.errorMessage=a.instant("YOU_MUST_ACCEPT_TERMS"),i.loginError=!0)}"true"==t.showDataDisclaimer&&I.modal.open({modalId:"DeleteDataDisclaimerModal",templateUrl:"templates/account.deleteDataDisclaimer.modal.html",scope:i,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){i.deleteDataDisclaimer=e}),i.closeDeleteDataDisclaimer=function(){I.modal.close(i.deleteDataDisclaimer).then(function(e){i.deleteDataDisclaimer=e}),v.search("showDataDisclaimer",null)},$("html").addClass("background-container"),$("html").addClass("outside"),i.removePractitionerClass(),i.loginData={},i.signUpData={},i.showingForgotPassword=!1,i.forgotPasswordSuccess=!1,i.facebookSignIn=function(n){!i.isLogin()&&y()||FB.login(function(e){if(e.authResponse){var t=e.authResponse.accessToken;i.loginError=!1,i.errorMessage="",i.loading=!0,n?s.signUpWithFacebook(t,_()).success(A).error(C):s.loginWithFacebook(t,_()).success(A).error(C)}else console.log("User cancelled login or did not fully authorize.")},{scope:"public_profile,email"})},i.googleSignIn=function(n){!i.isLogin()&&y()||i.googleAuth.signIn().then(function(e){var t=e.getAuthResponse().id_token;i.loginError=!1,i.errorMessage="",i.loading=!0,n?s.signUpWithGoogle(t,_()).success(A).error(C):s.loginWithGoogle(t,_()).success(A).error(C)})};var O=function(){$("html").removeClass("outside"),s.isPractitioner()&&!i.isShowingClientView()?e.go("practitioner.clients"):o.returnToState?e.go(o.returnToState.name,o.returnToParams,{location:"replace"}):e.go("app.home",{},{location:"replace"})};function S(){return i.loginData.email?!!d.isEmailValid(i.loginData.email)||(i.errorMessage=a.instant("LOGIN_ERROR_INVALID_EMAIL"),r(function(){$("#loginEmail").focus()}),!1):(i.errorMessage=a.instant("LOGIN_ERROR_MISSING_EMAIL"),r(function(){$("#loginEmail").focus()}),!1)}i.hasBeenLoggedOut()&&(i.loginError=!0,a("LOGGED_OUT_MESSAGE").then(function(e){i.errorMessage=e})),s.isLoggedIn()&&"true"!=t.reset&&O(),i.loggingIn=!0,"true"==t.create&&(i.loggingIn=!1),"true"==t.reset&&(i.showingForgotPassword=!0),i.toggleLogin=function(){i.loggingIn=!i.loggingIn,i.errorMessage=void 0},i.isLogin=function(){return i.loggingIn},i.toggleForgotPassword=function(){i.showingForgotPassword=!i.showingForgotPassword},i.getLoginTosHTML=function(){return E.trustAsHtml(a.instant("SIGNUP_AGREEMENT"))},i.clickedAgreement=function(e){i.signUpData.agreed?i.signUpData.agreed=!1:(e.preventDefault(),I.modal.open({modalId:"AgreementModal",templateUrl:"templates/agreement.modal.html",scope:i,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){i.agreementModal=e}))},i.closeAgreement=function(){I.modal.close(i.agreementModal).then(function(e){i.agreementModal=e})},i.agreeToAgreement=function(){i.signUpData.agreed=!0,i.errorMessage=null,i.loginError=!1,i.closeAgreement()},i.useSuggestedEmail=function(){i.signUpData.email=i.suggestedEmail,i.signup(!0)},i.signup=function(e){i.loginError=!1,i.errorMessage="",i.signUpData.name?i.signUpData.email?d.isEmailValid(i.signUpData.email)?i.signUpData.password?i.signUpData.password.length<8?(i.errorMessage=a.instant("LOGIN_ERROR_PASSWORD_LENGTH"),document.getElementById("createUserPassword").focus()):i.signUpData.agreed||(i.errorMessage=a.instant("YOU_MUST_ACCEPT_TERMS")):(i.errorMessage=a.instant("LOGIN_ERROR_MISSING_PASSWORD"),document.getElementById("createUserPassword").focus()):(i.errorMessage=a.instant("LOGIN_ERROR_INVALID_EMAIL"),document.getElementById("createUserEmail").focus()):(i.errorMessage=a.instant("LOGIN_ERROR_MISSING_EMAIL"),document.getElementById("createUserEmail").focus()):(i.errorMessage=a.instant("LOGIN_ERROR_MISSING_NAME"),document.getElementById("createUserName").focus()),""===i.errorMessage?e?(i.loading=!0,s.createAccount(i.signUpData.email,i.signUpData.password,i.signUpData.name,i.signUpData.referralCode,i.userGoal,i.groupCode,_()).success(A).error(function(e,t,n,o){i.loading=!1,i.loginError=!0,i.errorMessage=a.instant("LOGIN_ERROR_CREATING_USER"),409==t&&(i.errorMessage=a.instant("LOGIN_ERROR_EMAIL_IN_USE"))})):Mailcheck.run({email:i.signUpData.email,suggested:function(e){i.suggestedEmail=e.full},empty:function(){i.signup(!0)}}):i.loginError=!0},i.resetPassword=function(){i.loginError=!1,i.errorMessage="",S()?(i.loading=!0,s.resetPassword(i.loginData.email).success(function(){i.loading=!1,i.forgotPasswordSuccess=!0}).error(function(e,t,n,o){i.loading=!1,i.loginError=!0,i.errorMessage=a.instant("LOGIN_ERROR_RESET_PASSWORD")})):i.loginError=!0};var A=function(e,t,n){i.loading=!1,s.updateToken(n),i.appRenderReady=!1,o.$on("event:userContextInitialized",O),i.initializeUserContext(e,o,s,c,u,l,g,m,f,h)},C=function(e,t){i.loading=!1,i.loginError=!0,i.errorMessage=400==t?a.instant("LOGIN_ERROR_OAUTH_EMAIL_REQUIRED"):401==t?a.instant("LOGIN_ERROR_INVALID_CREDENTIALS"):403==t?a.instant("LOGIN_ERROR_ACCOUNT_LOCKED"):409==t?a.instant("LOGIN_ERROR_EMAIL_IN_USE"):a.instant("LOGIN_ERROR_GENERIC")};i.login=function(){i.loginError=!1,i.errorMessage="",S()?(i.loginData.password||(i.errorMessage=a.instant("LOGIN_ERROR_MISSING_PASSWORD"),$("#loginPassword").focus()),""===i.errorMessage?(i.loading=!0,localStorage.clear(),s.login(i.loginData.email,i.loginData.password,_()).success(A).error(C)):i.loginError=!0):i.loginError=!0}}])}(),angular.module("moodCtrl",[]).controller("MoodCtrl",["$sce","$scope","$rootScope","$timeout","$controller","$state","$http","$translate","AccountService","HabitsService","GeneralService","Token",function(e,l,t,n,o,i,a,d,r,p,s,c){l.initialized=!1,l.selectedSubValues=[];var u,g=[],m=[],f="",h=[],T={};function v(){f=void 0,h=[],T={}}function E(){var e;if(!f&&((e=l.moodData.notes)&&(e=(e=e.replace(/&nbsp;/gm,"")).replace(/<(?:.|\n)*?>/gm,"")),T={},f=e)){h=f.split(" ");for(var t=0;t<h.length;++t){var n=h[t];0===n.indexOf("#")&&(n=(n=(n=n.substring(1)).replace(/\W+/g,"")).toLowerCase(),T[n]=n)}}}function I(e){var t="HABITS_VALUES_"+e;return t=t.replace(/ /g,"_").toUpperCase(),d.instant(t)}function _(e){for(var t=l.moodData.value-1,n=[],o=0;o<e.length;++o)n.push(e[o].id);l.moodData.hasRecentData?(p.updateHabitData(l.moodHabit,l.moodData.data,t,n,new Date,f),l.stressHabit&&p.updateHabitData(l.stressHabit,scope.stressData.data,l.stressData.value-1,void 0,new Date,void 0)):(p.recordHabitData(l.moodHabit,t,n,new Date,f),l.stressHabit&&p.recordHabitData(l.stressHabit,l.stressData.value-1,void 0,new Date,void 0)),l.savingMoodData=!1,l.clearActiveSection()}function y(){r.isLoggedIn()?(g=p.getAccountHabits(),l.moodHabit=g[0],l.stressHabit=p.getAccountHabitById(p.STRESS_HABIT_ID),l.moodHabit.habitValues,m=l.moodHabit.habitSubValues,u&&u.atwho("destroy"),function(){var e,t,n,o=p.getRecentFeelings();if(l.recentFeelingText=[],o)for(var i=0;i<o.length;++i){var a=o[i];l.recentFeelingText.push(a.valueString)}for(var r=0;r<m.length;++r){var s=(e=m[r],t=e.valueString.toUpperCase(),(n=d.instant(t))!=t?n:e.valueString);l.recentFeelingText.push(s)}}(),u=$("#moodNotes").atwho({at:"#",data:l.recentFeelingText,insertTpl:"<strong>${atwho-at}${name}</strong>",callbacks:{afterMatchFailed:function(e,t){if("#"==e){t.text().trim().slice(1);var n=this.$el.find(".cur"),o=t.text().trim(),i=this.view.context.getOpt("insertTpl"),a={"atwho-at":o,"atwho-at-query":o,name:""},r=this.view.context.callbacks("tplEval").call(this.view.context,i,a,"onInsert");return this.view.context.query.text="",this.insert(this.view.context.callbacks("beforeInsert").call(this.view.context,r,n),{data:function(){return a}}),!1}}}}),l.initializeMoodData(),l.initialized=!0):i.go("app.login")}l.initializeMoodData=function(){l.moodData||(l.moodData={},l.stressData={});var e=!1,t=new Date,n=p.getHabitDataByHabitId(t,l.moodHabit.id),o=p.getHabitDataByHabitId(t,p.STRESS_HABIT_ID);if(n&&("object"==typeof n.experiencedAt?n.experiencedAt.getTime():new Date(n.experiencedAt).getTime())>t.getTime()-3e4&&(e=!0),e){var i=p.getHabitValueById(n.habitValueId);if(l.moodData.value=i.ordinate+1,l.moodData.data=n,o){var a=p.getHabitValueById(o.habitValueId);l.stressData.value=a.ordinate+1,l.stressData.data=o}}else l.moodData.value=1,l.stressData.value=1;l.moodData.lastValue=l.moodData.value,e?n.habitDataNotes&&(l.moodData.notes=n.habitDataNotes.notes,l.moodData.notes=l.moodData.notes.replace(/#(\S*)/g,'<span class="atwho-inserted" data-atwho-at-query="#$1"><strong>#$1</strong></span>')):l.moodData.notes="",l.moodData.hasRecentData=e,l.moodData.options={floor:0,ceil:l.moodHabit.habitValues.length-1,step:1,hideLimitLabels:!0,showSelectionBar:!0,id:l.moodHabit.name+"_val",updateOrdinal:function(e){this.valueOrdinal=e},onChange:function(){l.moodData.updated=!0,(l.moodData.value<=3&&3<l.moodData.lastValue||4==l.moodData.value&&4!=l.moodData.lastValue||5<=l.moodData.value&&l.moodData.lastValue<5)&&(l.selectedSubValues.length=0),l.moodData.lastValue=l.moodData.value},getSelectionBarColor:function(e){return s.COLORS[e]}},l.stressData.options={floor:0,ceil:l.stressHabit?l.stressHabit.habitValues.length-1:1,step:1,hideLimitLabels:!0,showSelectionBar:!0,updateOrdinal:function(e){this.valueOrdinal=e},getSelectionBarColor:function(e){return s.STRESS_COLORS[e]}},v()},l.notesChanged=function(){v(),u&&u.atwho("reposition")},l.subValueIsActive=function(e){for(var t=0;t<l.selectedSubValues.length;++t)if(l.selectedSubValues[t].valueString==e)return!0;return E(),!!T[e.toLowerCase()]},l.setSelectedSubValue=function(e){for(var t=0;t<l.moodHabit.habitSubValues.length;++t){var n=l.moodHabit.habitSubValues[t];if(n.valueString==e){var o=l.selectedSubValues.indexOf(n);0<=o?l.selectedSubValues.splice(o,1):l.selectedSubValues.push(n);break}}},l.getMoodClass=function(){if(!l.initialized)return"";var e=l.moodHabit.habitValues[l.moodData.value-1].display;return e=e.replace(" ","")},l.getMoodValue=function(){return l.initialized?I(l.moodHabit.habitValues[l.moodData.value-1].display):""},l.getStressClass=function(){if(!l.initialized||!l.stressHabit)return"";var e=l.stressHabit.habitValues[l.stressData.value-1].display;return e=e.replace(/ /g,"")},l.getStressValue=function(){return l.initialized&&l.stressHabit?I(l.stressHabit.habitValues[l.stressData.value-1].display):""},l.showSubValueSection=function(e){if(!l.initialized)return!1;for(var t=l.moodData.value-1,n=0;n<l.moodHabit.habitSubValues.length;++n){var o=l.moodHabit.habitSubValues[n];if(o.valueString==e)return t>=o.minHabitValueOrdinate&&t<=o.maxHabitValueOrdinate}},l.postMoodData=function(){l.savingMoodData=!0,v(),E();var n=[],e=[];for(var t in T){for(var o=!1,i=0;i<m.length;++i){var a=m[i];if(a.valueString.toLowerCase()==t){n.push(a),o=!0;break}}o||e.push(t)}for(i=0;i<l.selectedSubValues.length;++i){for(var r=l.selectedSubValues[i],s=!1,c=0;c<n.length;++c){var u=n[c];if(r.id==u.id){s=!0;break}}s||n.push(r)}0<e.length?p.saveCustomFeelings(e).success(function(e){for(var t=0;t<e.length;++t)n.push(e[t]);_(n)}).error(function(){window.alert(d.instant("SAVE_CUSTOM_FEELING_ERROR")),l.savingMoodData=!1}):_(n)},l.isAppReady()?y():l.$on("event:pacificaReady",y)}]),function(){var e=angular.module("progressCtrl",[]);var Ie={basic:{activityId:40,activityName:"COMPLETED_ABC_THOUGHT_RECORD",thoughtType:"BASIC",name:"THOUGHTS_ACTIVITY_BASIC",description:"THOUGHTS_ACTIVITY_BASIC_DESC",completionTitle:"THOUGHTS_ACTIVITY_BASIC_SUMMARY",completionText:"THOUGHTS_ACTIVITY_BASIC_COMPLETED",completionRoute:"app.thought-completed",recordingOrder:["event","thoughts","feelings"],premium:!1,options:[{name:"THE_CYCLE",value:"cycle",show:!0},{name:"THE_CYCLE_AND_EVIDENCE",value:"evidence",show:!0}],steps:[{type:"event",name:"THE_EVENT",description:"THE_EVENT_DESCRIPTION",byline:"THE_EVENT_BYLINE",example:"THE_EVENT_EXAMPLE",route:"app.generictextthoughts"},{type:"thoughts",name:"YOUR_THOUGHTS",description:"YOUR_THOUGHTS_DESCRIPTION",byline:"YOUR_THOUGHTS_BYLINE",example:"YOUR_THOUGHTS_EXAMPLE",route:"app.generictextthoughts"},{type:"feelings",name:"YOUR_FEELINGS",description:"YOUR_FEELINGS_DESCRIPTION",byline:"YOUR_FEELINGS_BYLINE",example:"YOUR_FEELINGS_EXAMPLE",route:"app.generictextthoughts"},{type:"feelings",name:"THE_EVIDENCE",description:"THE_EVIDENCE_DESCRIPTION",byline:"THE_EVIDENCE_BYLINE",forExample:"THE_EVIDENCE_FOR_EXAMPLE",againstExample:"THE_EVIDENCE_AGAINST_EXAMPLE",route:"app.evidencetextthoughts"}]},traps:{activityId:41,activityName:"COMPLETED_TRAPS_THOUGHT_RECORD",thoughtType:"TRAPS",name:"THOUGHTS_ACTIVITY_TRAPS",description:"THOUGHTS_ACTIVITY_TRAPS_DESC",completionTitle:"THOUGHTS_ACTIVITY_TRAPS_SUMMARY",completionText:"THOUGHTS_ACTIVITY_TRAPS_COMPLETED",completionRoute:"app.traps-completed",recordingOrder:["thought","pattern"],premium:!1,steps:[{type:"thought",name:"THE_THOUGHT",description:"THE_THOUGHT_DESCRIPTION",byline:"THE_THOUGHT_BYLINE",example:"THE_THOUGHT_EXAMPLE",route:"app.generictextthoughts"},{type:"thought",name:"THE_THINKING_TRAP",description:"THE_THINKING_TRAP_DESCRIPTION",byline:"THE_THINKING_TRAP_BYLINE",example:"THE_THINKING_TRAP_EXAMPLE",route:"app.distortedtextthoughts",hints:{keys:["DISTORTED_TEXT_THOUGHT_HINT_ONE","DISTORTED_TEXT_THOUGHT_HINT_TWO","DISTORTED_TEXT_THOUGHT_HINT_THREE"]}},{type:"pattern",name:"THE_PATTERN",description:"THE_PATTERN_DESCRIPTION",byline:"THE_PATTERN_BYLINE",example:"THE_PATTERN_EXAMPLE",route:"app.distortedtextpatterns",recordingToAnalyze:"thought"}]},reframe:{activityId:4,activityName:"COMPLETED_RETHINK",thoughtType:"REFRAME",name:"THOUGHTS_ACTIVITY_REFRAME",description:"THOUGHTS_ACTIVITY_REFRAME_DESC",completionTitle:"THOUGHTS_ACTIVITY_REFRAME_SUMMARY",completionText:"THOUGHTS_ACTIVITY_REFRAME_COMPLETED",completionRoute:"app.reframe-completed",recordingOrder:["thought","analysis"],premium:!1,options:[{name:"INPUT_OPTION_TEXT",value:"text",show:!0},{name:"INPUT_OPTION_VOICE",value:"voice",show:!ionic.Platform.isAndroid()||5<+ionic.Platform.version()}],steps:[{type:"thought",name:"YOUR_THOUGHTS",description:"YOUR_THOUGHTS_DESCRIPTION",byline:"YOUR_THOUGHTS_BYLINE",example:"YOUR_THOUGHTS_EXAMPLE",route:"app.generictextthoughts"},{type:"thought",name:"THE_THINKING_TRAP",description:"THE_THINKING_TRAP_DESCRIPTION",byline:"THE_THINKING_TRAP_BYLINE",example:"THE_THINKING_TRAP_EXAMPLE",route:"app.distortedtextthoughts"},{type:"analysis",name:"REFRAME_THE_THOUGHT",description:"REFRAME_THE_THOUGHT_DESCRIPTION",byline:"REFRAME_THE_THOUGHT_BYLINE",example:"REFRAME_THE_THOUGHT_EXAMPLE",route:"app.textthoughts-rethink",hints:{keys:["REFRAME_THOUGHT_HINT_ONE","REFRAME_THOUGHT_HINT_TWO","REFRAME_THOUGHT_HINT_THREE"]}}]},positivity:{activityId:33,activityName:"COMPLETED_POSITIVITY_JOURNAL",thoughtType:"POSITIVITY",name:"THOUGHTS_ACTIVITY_POSITIVITY",description:"THOUGHTS_POSITIVITY_DESCRIPTION",completionTitle:"THOUGHTS_ACTIVITY_POSITIVITY_SUMMARY",completionText:"THOUGHTS_ACTIVITY_POSITIVITY_COMPLETED",completionRoute:"app.thought-completed",recordingOrder:["journal"],premium:!0,options:[{name:"INPUT_OPTION_TEXT",value:"text",show:!0},{name:"INPUT_OPTION_VOICE",value:"voice",show:!ionic.Platform.isAndroid()||5<+ionic.Platform.version()}],steps:[{type:"journal",name:"THOUGHTS_ACTIVITY_POSITIVITY",description:"THOUGHTS_POSITIVITY_DESCRIPTION",byline:"THOUGHTS_POSITIVITY_DESCRIPTION",example:"POSITIVITY_TEXT_PLACEHOLDER",route:"app.generictextthoughts"}]},gratitude:{activityId:32,activityName:"COMPLETED_GRATITUDE_JOURNAL",thoughtType:"GRATITUDE",name:"THOUGHTS_ACTIVITY_GRATITUDE",description:"THOUGHTS_GRATITUDE_DESCRIPTION",completionTitle:"THOUGHTS_ACTIVITY_GRATITUDE_SUMMARY",completionText:"THOUGHTS_ACTIVITY_GRATITUDE_COMPLETED",completionRoute:"app.thought-completed",recordingOrder:["journal"],premium:!0,options:[{name:"INPUT_OPTION_TEXT",value:"text",show:!0},{name:"INPUT_OPTION_VOICE",value:"voice",show:!ionic.Platform.isAndroid()||5<+ionic.Platform.version()}],steps:[{type:"journal",name:"JOURNAL_GRATITUDE_HEADER",description:"THOUGHTS_GRATITUDE_DESCRIPTION",byline:"THOUGHTS_GRATITUDE_DESCRIPTION",example:"GRATITUDE_TEXT_PLACEHOLDER",route:"app.generictextthoughts"}]},journal:{activityId:9,activityName:"COMPLETED_JOURNAL",thoughtType:"JOURNAL",name:"THOUGHTS_ACTIVITY_JOURNAL",description:"THOUGHTS_JOURNAL_HEADER",completionTitle:"THOUGHTS_ACTIVITY_JOURNAL_SUMMARY",completionText:"THOUGHTS_ACTIVITY_JOURNAL_COMPLETED",completionRoute:"app.thought-completed",recordingOrder:["journal"],premium:!0,options:[{name:"INPUT_OPTION_TEXT",value:"text",show:!0},{name:"INPUT_OPTION_VOICE",value:"voice",show:!ionic.Platform.isAndroid()||5<+ionic.Platform.version()}],steps:[{type:"journal",name:"THOUGHTS_ACTIVITY_JOURNAL",description:"THOUGHTS_JOURNAL_HEADER",byline:"THOUGHTS_JOURNAL_HEADER",example:"GRATITUDE_TEXT_PLACEHOLDER",route:"app.generictextthoughts"}]},blame:{activityId:42,activityName:"COMPLETED_BLAME_THOUGHT_RECORD",thoughtType:"BLAME",name:"THOUGHTS_ACTIVITY_BLAME",description:"THOUGHTS_ACTIVITY_BLAME_DESC",completionTitle:"THOUGHTS_ACTIVITY_BLAME_SUMMARY",completionText:"THOUGHTS_ACTIVITY_BLAME_COMPLETED",completionRoute:"app.contributingfactorscomplete",recordingOrder:["event"],premium:!0,steps:[{type:"event",name:"EVENT_AND_OUTCOME",description:"EVENT_AND_OUTCOME_DESCRIPTION",byline:"EVENT_AND_OUTCOME_BYLINE",example:"EVENT_AND_OUTCOME_PLACEHOLDER",route:"app.generictextthoughts"},{type:"event",name:"CONTRIBUTING_FACTORS",description:"CONTRIBUTING_FACTORS_DESCRIPTION",byline:"CONTRIBUTING_FACTORS_BYLINE",example:"CONTRIBUTING_FACTORS_PLACEHOLDER",route:"app.contributingfactorstextthoughts",hints:{keys:["BLAME_TEXT_THOUGHT_HINT_ONE","BLAME_TEXT_THOUGHT_HINT_TWO","BLAME_TEXT_THOUGHT_HINT_THREE"]}}]},evidence:{activityId:43,activityName:"COMPLETED_EVIDENCE_THOUGHT_RECORD",thoughtType:"EVIDENCE",name:"THOUGHTS_ACTIVITY_EVIDENCE",description:"THE_THOUGHT_EVIDENCE_DESCRIPTION",completionTitle:"THOUGHTS_ACTIVITY_EVIDENCE_SUMMARY",completionText:"THOUGHTS_ACTIVITY_EVIDENCE_COMPLETED",completionRoute:"app.evidence-completed",recordingOrder:["thought"],premium:!0,steps:[{type:"thought",name:"THE_THOUGHT",description:"THE_THOUGHT_DESCRIPTION",byline:"THE_THOUGHT_EVIDENCE_DESCRIPTION",example:"THE_THOUGHT_EVIDENCE_EXAMPLE",route:"app.generictextthoughts"},{type:"thought",name:"THE_EVIDENCE",description:"THE_EVIDENCE_EVIDENCE_DESCRIPTION",route:"app.evidencequestions"}]},beliefs:{activityId:44,activityName:"COMPLETED_BELIEFS_THOUGHT_RECORD",thoughtType:"BELIEFS",name:"THOUGHTS_ACTIVITY_BELIEFS",description:"THOUGHTS_ACTIVITY_BELIEFS_DESC",completionTitle:"THOUGHTS_ACTIVITY_BELIEFS_SUMMARY",completionText:"TTHOUGHTS_ACTIVITY_BELIEFS_COMPLETED",completionRoute:"app.beliefs-completed",recordingOrder:["thought","evidence"],premium:!0,steps:[{type:"thought",name:"YOUR_THOUGHTS",description:"THE_THOUGHT_BELIEF_DESCRIPTION",byline:"THE_THOUGHT_BELIEF_BYLINE",example:"THE_THOUGHT_BELIEF_EXAMPLE",route:"app.generictextthoughts"},{type:"thought",name:"DRILL_DOWN",description:"CORE_BELIEF_DESCRIPTION",byline:"CORE_BELIEF_BYLINE",route:"app.corebeliefstextthoughts",hints:{keys:["CORE_BELIEFS_TEXT_THOUGHT_HINT_ONE","CORE_BELIEFS_TEXT_THOUGHT_HINT_TWO","CORE_BELIEFS_TEXT_THOUGHT_HINT_THREE"]}},{type:"evidence",name:"EVIDENCE_FOR_BELIEF",description:"EVIDENCE_FOR_BELIEF_DESCRIPTION",byline:"EVIDENCE_FOR_BELIEF_BYLINE",forExample:"THE_EVIDENCE_FOR_EXAMPLE",againstExample:"THE_EVIDENCE_AGAINST_EXAMPLE",route:"app.corebeliefevidence"}]}};function _e(e,t,n){var o="";return 0<=t.indexOf("catastrophizing")&&(o+=e.instant("THOUGHTS_EMOTIONS_CATASTROPHIZING")),0<=t.indexOf("emotional_reasoning")&&(0<o.length&&(o+=", "),o+=e.instant("THOUGHTS_EMOTIONS_EMOTIONAL_REASONING")),0<=t.indexOf("mind_reading")&&(0<o.length&&(o+=", "),o+=e.instant("THOUGHTS_EMOTIONS_MIND_READING")),0<=t.indexOf("fortune_telling")&&(0<o.length&&(o+=", "),o+=e.instant("THOUGHTS_EMOTIONS_FORTUNE_TELLING")),0<=t.indexOf("extreme_words")&&(0<o.length&&(o+=", "),o+=e.instant("THOUGHTS_EMOTIONS_PRESSURIZED")),0<=t.indexOf("judging")&&(0<o.length&&(o+=", "),o+=e.instant("THOUGHTS_EMOTIONS_LABELLING")),0<=t.indexOf("personalization")&&(0<o.length&&(o+=", "),o+=e.instant("THOUGHTS_EMOTIONS_PERSONALIZATION")),0<=t.indexOf("overgeneralizing")&&(0<o.length&&(o+=", "),o+=e.instant("THOUGHTS_EMOTIONS_GENERALIZING")),0<=t.indexOf("negative_filtering")&&(0<o.length&&(o+=", "),o+=e.instant("THOUGHTS_EMOTIONS_NEGATIVE")),0<=t.indexOf("notsure")&&(0<o.length&&(o+=", "),o+=e.instant("NEGATIVE_THOUGHT")),0===o.length&&(o="negative"==n?e.instant("NEGATIVE_THOUGHT"):e.instant("POSITIVE_THOUGHT")),o}e.controller("ProgressCtrl",["$sce","$scope","$rootScope","$controller","$state","$http","$timeout","$translate","$ionicModal","$ionicPopup","$ionicHistory","HabitsService","GoalsService","AudioService","AccountService","GeneralService","$stateParams","PractitionerService","Environment","ActivityService","OverlayService",function(e,P,t,n,o,i,r,d,a,s,c,w,u,l,p,N,g,m,f,h,T){P.mediaRec=void 0,P.recording=!1,P.elapsedTime=0,P.src=void 0,P.maxTime=g.maxTime,P.maxTime||(P.maxTime=300),P.audioPrefix="journal",P.nextState="app.home";var v=l.getActiveThoughtId();v&&(P.thoughtId=v),P.getThoughtsRecordHeader=function(){return d.instant("THOUGHTS_RECORD_HEADER")},P.getClientName=function(){if(P.otherUser)return P.otherUser.account.firstName+" "+P.otherUser.account.lastName};var E,I,y=P.otherUser=void 0;P.accountHabits=[],P.accountHabitsById=[],P.accountHabitValues=[],P.accountHabitSubValues=[],P.accountSubGoals=void 0,P.accountThoughts=void 0,P.showingMood=!0,P.mode="week",P.pdfData={name:""};var O=new Date;function S(){P.dailyData={},P.weeklyData={},P.monthlyData={},P.allData={}}O.setHours(0,0,0,0),S(),P.showingNotes={},P.activeHighlightDay=void 0;var A=window.devicePixelRatio?window.devicePixelRatio:1;function C(e){P.accountHabits=e,P.hasHabits=!1;for(var t=0;t<e.length;++t){var n=e[t];P.filterMoodAndStress(n)&&(P.hasHabits=!0),P.accountHabitsById[n.id]=n;for(var o=0;o<n.habitValues.length;++o){var i=n.habitValues[o];P.accountHabitValues[i.id]=i}b(n.habitSubValues)}}function D(e){return P.accountHabitsById[e]}function U(e){return P.accountHabitValues[e]}function b(e){if(e)for(var t=0;t<e.length;++t){var n=e[t];P.accountHabitSubValues[n.id]=n}}function R(e){var t=e?1:-1;if(P.isModeActive("day"))return O.addDays(1*t);if(P.isModeActive("week")){var n=O.addDays(7*t);if(e)n.setDate(n.getDate()-n.getDay());else{var o=n.getDay();n.setDate(n.getDate()+(6-o))}return n}var i=new Date(O);return i.setMonth(i.getMonth()+t),i}function M(){return P.viewingOtherUser?P.otherUser&&p.isPractitioner()&&(p.isPremiumEnabled()||P.otherUser.account.id==p.getAccountUser().user.id||P.otherUser.account.premium)?(P.otherUser.account.id==p.getAccountUser().account.id&&p.setUserPreference("practitioner_completed_onboarding",!0),P.otherUser):void 0:p.getAccountUser()}function H(e){var t,n=M();if(!n)return!1;if(n.user)t=new Date(n.user.createdAt);else{if(!n.account)return!1;t=new Date(n.account.createdAt)}t.setHours(0,0,0,0);var o,i=R(e);return"day"==P.mode?o=i.addDays(1):"week"==P.mode?o=(i=X(i)).addDays(7):(i=K(i),(o=new Date(i)).setMonth(o.getMonth()+1)),i<new Date&&(t<=i||t<=o)}function x(e,t){var n=100*e/t;return isNaN(n)||0===n?"zero":n<=25?"one":n<=44?"two":n<=55?"three":n<=74?"four":n<=99?"five":"six"}function G(){return"day"==P.mode?P.dailyData:"week"==P.mode?P.weeklyData:P.monthlyData}function L(){return"day"==P.mode?new Date(O):"week"==P.mode?X(O):K(O)}function k(){var e=L();if("day"==P.mode)return e.addDays(1);if("week"==P.mode)return e.addDays(7);var t=new Date(e);return t.setMonth(e.getMonth()+1),t}function V(e){var t="HABITS_VALUES_"+e;return t=t.replace(/ /g,"_").toUpperCase(),d.instant(t)}function F(e,t){var n,o=ne(G(),L(),e);if(o){var i,a=o.habit;return i=0==t?o.minOrdinate:1==t?Math.round(o.averageOrdinate):o.maxOrdinate,1==e?(n=i,V(a.habitValues[n].display)):19==e?function(e,t){if(e)return V(e.habitValues[t].display)}(a,i):w.getHabitDisplay(a,i)}return"?"}function B(e){var t=Math.round(e.averageOrdinate),n=e.habit.habitValues[t];return w.getMoodClass(n)}function Y(e){var t=Math.round(e.averageOrdinate),n=e.habit.habitValues[t];return w.getStressClass(n)}function z(e,t,n){if(e.recordings&&e.recordings[t])return e.recordings[t][n]}function K(e){var t=new Date(e);return t.setDate(1),t.setHours(0,0,0,0),t}function X(e){var t=new Date(e),n=e.getDay();return(t=t.addDays(-n)).setHours(0,0,0,0),t}function W(e,t,n){var o=moment(e).format("L"),i=moment(e).format("ddd"),a=10*A+"pt";P.ctx.font=a+" Helvetica Neue, Helvetica, sans-serif",P.ctx.textAlign="center",P.ctx.fillStyle=P.viewingOtherUser?"rgb(43,43,43)":"rgb(255,255,255)",P.ctx.fillText(i,t+n/2,22*A);var r=8*A+"pt";P.ctx.font=r+" Helvetica Neue, Helvetica, sans-serif",P.ctx.fillStyle=P.viewingOtherUser?"rgb(43,43,43)":"rgb(25,25,25)",P.ctx.fillText(o,t+n/2,37*A)}function j(e,t,n,o,i,a){if(e)for(var r=0;r<2;++r)for(var s=0;s<e.length;++s){var c=e[s],u=t*((new Date(c.experiencedAtStr).getTime()-o)/i),l=95*A,d=a?6:4,p=n-(10*A+(c.valueInt-1)/d*l);if(0===r)0<s&&(P.ctx.strokeStyle=P.viewingOtherUser?"rgb(125,125,125, 1)":"rgba(255,255,255, 0.4)",P.ctx.beginPath(),P.ctx.moveTo(lastX,lastY),P.ctx.lineTo(u,p),P.ctx.lineWidth=A,P.ctx.stroke());else{var g;g=a?N.COLORS[7-c.valueInt]:N.STRESS_COLORS[c.valueInt-1];var m=hexToRgb(g),f="rgb("+m.r+","+m.g+","+m.b+")";P.ctx.fillStyle=f,P.ctx.beginPath(),P.ctx.arc(u,p,4*A,0,2*Math.PI),P.ctx.closePath(),P.ctx.fill()}lastX=u,lastY=p}}function q(e){if(P.canvas=document.getElementById("moodHistory"),P.ctx=P.canvas?P.canvas.getContext("2d"):void 0,P.ctx){var t=$("#moodHistory");P.ctx.canvas.width=t.parent().innerWidth()*A,P.ctx.canvas.height=150*A,t.css("width",t.parent().innerWidth()),t.css("height",150);var n=P.ctx.canvas.width,o=P.ctx.canvas.height;P.ctx.save(),P.ctx.clearRect(0,0,n,o),P.isModeActive("day")?function(){var e=P.ctx.canvas.width,t=P.ctx.canvas.height,n=O,o=n.getTime(),i=P.viewingOtherUser?"rgba(239, 239, 239, 1)":"rgba(0, 0, 0, 0.25)";P.ctx.fillStyle=i,P.ctx.fillRect(0,0,e,t);for(var a=1;a<24;++a){var r=new Date(n);r.setHours(n.getHours()+a);var s=e*((r.getTime()-o)/864e5);if(P.ctx.strokeStyle=P.viewingOtherUser?"rgba(204,204,204,1)":"rgba(255,255,255, 0.4)",P.ctx.beginPath(),P.ctx.moveTo(s,0),P.ctx.lineTo(s,7*A),P.ctx.lineWidth=A,P.ctx.stroke(),a%3==0&&12!=a){var c=moment(r).format("ha").toUpperCase(),u=8*A+"pt";P.ctx.font=u+" Helvetica Neue, Helvetica, sans-serif",P.ctx.fillStyle=P.viewingOtherUser?"rgb(43,43,43)":P.ctx.strokeStyle,P.ctx.textAlign="center",P.ctx.fillText(c,s,20*A)}}W(O,0,e),j(P.isShowingMood()?oe(1):oe(19),e,t,o,864e5,P.isShowingMood())}():(P.isModeActive("week")&&function(){for(var e=P.ctx.canvas.width,t=P.ctx.canvas.height,n=e/7,o=X(O),i=o.getTime(),a=0;a<7;++a){var r,s=o.addDays(a),c=e*(864e5*a/6048e5);r=P.viewingOtherUser?"rgba(239, 239, 239, 1)":"rgba(0, 0, 0, 0.25)",P.ctx.fillStyle=r,P.ctx.fillRect(c,0,n,t),0!=a&&(P.ctx.strokeStyle=P.viewingOtherUser?"rgba(204,204,204,1)":"rgba(0,0,0, 0.35)",P.ctx.beginPath(),P.ctx.moveTo(c,0),P.ctx.lineTo(c,t),P.ctx.lineWidth=A,P.ctx.stroke()),W(s,c,n)}j(P.isShowingMood()?oe(1):oe(19),e,t,i,6048e5,P.isShowingMood())}(),e||(Z(),J())),P.ctx.restore();for(var i=$(".vertical-stretch"),a=0;a<i.length;++a)element=$(i[a]),element.css("min-height","");r(Q)}}function J(){var e=ne(G(),L(),1);if(e&&0!=e.values.length){for(var t=0,n={},o=0;o<e.values.length;++o){var i=e.values[o].habitSubValueIds;if(i)for(var a=0;a<i.length;++a){var r=P.getHabitSubValueDisplayById(i[a]);console.log("display: "+r),n[r]?++n[r]:n[r]=1,n[r]>t&&(t=n[r])}}if(0<t){P.wordCloud="";var s=[];for(var c in n)s.push(c);s.sort();for(var u=0;u<s.length;++u){var l,d=n[c=s[u]];for(a=0;a<5;++a){var p=Math.round((a+1)/5*t);if(Math.round(a/5*t)<d&&d<=p){l="size"+(a+1);break}}0<u&&(P.wordCloud+=" "),P.wordCloud+='<span class="'+l+'">'+c+"</span>"}}else P.wordCloud=void 0}else P.wordCloud=void 0}function Z(){var e,t=G(),n={colors:P.isShowingMood()?(e=ne(t,L(),1),N.COLORS):(e=ne(t,L(),19),N.STRESS_COLORS),data:[]};if(e){for(var o=e.habit.habitValues,i=0,a={},r=0;r<e.values.length;++r){var s=e.values[r];a[s.habitValueId]?++a[s.habitValueId]:a[s.habitValueId]=1,++i}for(var c=0;c<o.length;++c){var u=o[c],l=a[u.id];void 0===l&&(l=0),n.data.push({name:V(u.display),y:0<i?l/i:0})}}else P.isShowingClientView()?n.colors=["white"]:n.colors=["black"],n.data.push({name:d.instant("NO_DATA"),y:1});$(".moodPieChart").highcharts({chart:{backgroundColor:"transparent",plotBackgroundColor:null,plotBorderWidth:null,plotShadow:!1,type:"pie",marginTop:0,marginBottom:0,marginLeft:0,marginRight:0},title:{text:null},tooltip:{headerFormat:"",pointFormat:"{point.name}: <b>{point.percentage:.1f}%</b>",followPointer:!1},plotOptions:{pie:{allowPointSelect:!1,cursor:"pointer",dataLabels:{enabled:!1}}},series:[n],credits:{enabled:!1}})}function Q(){for(var e=0,t=$(".vertical-stretch"),n=0;n<t.length;++n)element=$(t[n]),element.innerHeight()>e&&(e=element.innerHeight());for(n=0;n<t.length;++n)element=$(t[n]),element.css("min-height",e)}function ee(e){q(e)}function te(e,t,n){var o=e[N.getDayString(t)];if(o)return o.activities[n]}function ne(e,t,n){var o=e[N.getDayString(t)];if(o)return o.habits[n]}function oe(e){var t=P.allData.habits?P.allData.habits[e]:void 0;if(t)return t.values}function ie(e,t){e.activities||(e.activities={relax:[],thoughts:[],goals:[],social:[],account:[]}),e.goals||(e.goals=[]),e.thoughts||(e.thoughts=[]);var n=e.habits;if(n||(n=e.habits={}),t){var o=n[t.id];o||((o=n[t.id]={}).habit=t);var i=o.values;i||(i=o.values=[])}}function ae(e,t,n,o){var i=e[n];i||((i=e[n]={}).date=t),ie(i,o)}function re(e,t,n){if(t){var o=e.habits[t.id];o&&o.values.push(n)}}function se(e,t){e.goals.push(t)}function ce(e,t){e.thoughts.push(t)}function ue(e,t,n){e.activities[t].push(n)}function le(e,t){for(var n in e){var o=e[n],i=0,a=0;for(var r in o.habits){1!=r&&19!=r&&++a;for(var s=o.habits[r],c=s.habit,u=0,l=Number.MAX_SAFE_INTEGER,d=void 0,p=-1,g=void 0,m=s.values,f=0;f<m.length;++f){var h=U(m[f].habitValueId);if(u+=h.ordinate,h.ordinate<l&&(l=h.ordinate),h.ordinate>p&&(p=h.ordinate),1!=r&&19!=r&&0==f&&"day"==t)w.metGoal(c,h.ordinate)&&++i}if(s.averageOrdinate=u/m.length,"week"==t||"month"==t){l=Number.MAX_SAFE_INTEGER,p=-1,g=d=void 0;var T,v=o.date;"week"==t?T=v.addDays(7):(T=new Date(v)).setMonth(T.getMonth()+1);for(f=0;f<7;++f){var E=v.addDays(f);if("week"==t)(O=ne(P.dailyData,E,r))&&(O.averageOrdinate<l&&(l=O.averageOrdinate,d=E),O.averageOrdinate>p&&(p=O.averageOrdinate,g=E));else if("month"==t){for(var I=0,_=0,y=new Date(E);y<T;){var O;(O=ne(P.dailyData,y,r))&&(I+=O.averageOrdinate,++_),y=y.addDays(7)}if(0<_){var S=Math.round(I/_);S<l&&(l=S,d=E),p<S&&(p=S,g=E)}}}s.minOrdinate=l,s.minDate=d,s.maxOrdinate=p,s.maxDate=g}}if("day"==t)o.completedHabits=i,o.numHabits=a;else{var A,C=new Date(o.date);"week"==t?A=C.addDays(7):(A=new Date(C)).setMonth(A.getMonth()+1);for(var D=0,b=0;C<A;){n=N.getDayString(C);var R=P.dailyData[n];R&&(D+=R.completedHabits,b+=R.numHabits),C=C.addDays(1)}o.completedHabits=D,o.numHabits=b}}}function de(e,t){var n=N.getDayString(e);ae(P.dailyData,e,n,t);var o=X(e),i=N.getDayString(o);ae(P.weeklyData,o,i,t);var a=K(e),r=N.getDayString(a);ae(P.monthlyData,a,r,t),ie(P.allData,t)}function pe(e){var t,n=U(e.habitValueId);n&&(t=D(n.habitId));var o=new Date(e.experiencedAtStr),i=N.getDayString(o);de(o,t),re(P.dailyData[i],t,e);var a=X(o),r=N.getDayString(a);re(P.weeklyData[r],t,e);var s=K(o),c=N.getDayString(s);re(P.monthlyData[c],t,e),re(P.allData,t,e)}function ge(e){var t,n=e.activityId;if("CREATED_EXPERIMENT"!=(t=h.getActivityById(n)).name){var o=t.type;if(o){var i=new Date(e.recordedAtString),a=N.getDayString(i);de(i),ue(P.dailyData[a],o,e);var r=X(i),s=N.getDayString(r);ue(P.weeklyData[s],o,e);var c=K(i),u=N.getDayString(c);ue(P.monthlyData[u],o,e),ue(P.allData,o,e)}}}function me(e){var t=new Date(e.createdAtString),n=N.getDayString(t);de(t),ce(P.dailyData[n],e);var o=X(t),i=N.getDayString(o);ce(P.weeklyData[i],e);var a=K(t),r=N.getDayString(a);ce(P.monthlyData[r],e),ce(P.allData,e)}function fe(e){if(e.achievedRecordedAtString){var t=new Date(e.achievedRecordedAtString),n=N.getDayString(t);de(t),se(P.dailyData[n],e);var o=X(t),i=N.getDayString(o);se(P.weeklyData[i],e);var a=K(t),r=N.getDayString(a);se(P.monthlyData[r],e),se(P.allData,e)}}function he(e){P.habitSubValues||(P.habitSubValues={}),e.habitSubValues&&b(e.habitSubValues),e.habitData&&e.habitData.sort(function(e,t){return new Date(t.experiencedAt)-new Date(e.experiencedAt)});for(var t=0;t<e.habitData.length;++t){pe(e.habitData[t])}for(var n in le(P.dailyData,"day"),le(P.weeklyData,"week"),le(P.monthlyData,"month"),P.allData.habits){P.allData.habits[n].values.sort(function(e,t){return new Date(t.experiencedAt)-new Date(e.experiencedAt)})}for(var o=0;o<e.userActivities.length;++o)ge(e.userActivities[o]);if(e.thoughtContext&&e.thoughtContext.thoughts)for(var i=0;i<e.thoughtContext.thoughts.length;++i)me(e.thoughtContext.thoughts[i]);if(e.goalContext&&e.goalContext.accountSubGoals)for(var a in e.goalContext.accountSubGoals)for(var r=e.goalContext.accountSubGoals[a],s=0;s<r.length;++s)fe(r[s]);q()}function Te(e){E?e&&(I=E,E=e):((E=new Date).setMonth(E.getMonth()-1),E.setDate(1),E.setHours(0,0,0,0)),P.loading=!0,(P.viewingOtherUser?m.getUserActivity(P.otherUserAccountId,E,I):h.getActivityContextV2(E,I)).success(function(e){he(y=e),console.log("got activity context:"),console.log(e),e.accountHabits&&(P.accountHabits=e.accountHabits),P.viewingOtherUser?m.getUser(P.otherUserAccountId).success(function(e){P.otherUser=e,P.loading=!1}):P.loading=!1}).error(function(){P.error=d.instant("PROGRESS_LOADING_ERROR"),P.loading=!1})}P.closeDownloadModal=function(){T.modal.close(P.downloadModal).then(function(e){P.downloadModal=e})},P.showDownloadModal=function(){T.modal.open({modalId:"DownloadModal",templateUrl:"templates/download.modal.html",scope:P,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){P.downloadModal=e})},P.downloadCSV=function(e){if("all"===e)var t="/app/activity/csv/alldata.zip";else{t="/app/activity/csv/"+e+".csv?startMS="+L().getTime()+"&endMS="+k().getTime();P.viewingOtherUser&&(t+="&clientId="+P.otherUserAccountId)}window.open(t)},P.downloadPDF=function(){var e=$("input[name='reportWeek']:checked").val(),t="/app/activity/pdf?name="+P.pdfData.name+"&week="+e;P.viewingOtherUser&&(t+="&clientId="+P.otherUserAccountId),window.open(t)},P.toggleMood=function(){P.showingMood=!P.showingMood,Z(),q()},P.isShowingMood=function(){return P.showingMood},P.filterMoodAndStress=function(e){return 1!=e.id&&19!=e.id},P.getDayAbbreviation=function(e){var t=new Date;return t.setDate(t.getDate()-t.getDay()+e),moment(t).format("ddd")},P.getDaysBeforeFirstOfMonth=function(){for(var e=[],t=L().getDay(),n=0;n<t;++n)e.push(n+1);return e},P.getDaysInMonth=function(){for(var e=[],t=0,n=L(),o=k();n<o;)e.push(++t),n.setDate(n.getDate()+1);return e},P.isDayAvailable=function(e){var t=M();if(t){if(P.otherUser)var n=t.createdAt;else{if(!t.user)return!1;n=t.user.createdAt}e-=1;var o=L();0<e&&o.setDate(o.getDate()+e);var i=new Date(n);return i.setHours(0,0,0,0),i<=o&&o<new Date||P.hasMoodRating(e+1)}return!1},P.goToDay=function(e){if(P.isDayAvailable(e)){var t=L();0<(e-=1)&&t.setDate(t.getDate()+e),O=t,P.setMode("day")}},P.setActiveHighlightDay=function(e){P.isDayAvailable(e)?P.activeHighlightDay=e:P.activeHighlightDay=void 0},P.isDayInFuture=function(e){e-=1;var t=L();return 0<e&&t.setDate(t.getDate()+e),t>new Date},P.hasMoodRating=function(e){e-=1;var t=L();0<e&&t.setDate(t.getDate()+e);var n=P.isShowingMood()||forceMood?1:19;return!!ne(P.dailyData,t,n)},P.getDayMoodClass=function(e,t){e-=1;var n=L();0<e&&n.setDate(n.getDate()+e);var o=P.isShowingMood()||t?1:19,i=ne(P.dailyData,n,o);return i?P.isShowingMood()||t?B(i):Y(i):""},P.getModeHabitsClass=function(){var e=L(),t=N.getDayString(e),n=G()[t];if(n){var o=n.completedHabits,i=n.numHabits;if(void 0!==o&&void 0!==i)return x(o,i)}},P.getDayHabitClass=function(e){e-=1;var t=L();0<e&&t.setDate(t.getDate()+e);var n=N.getDayString(t),o=P.dailyData[n];if(o){var i=o.completedHabits,a=o.numHabits;if(void 0!==i&&void 0!==a)return x(i,a)}return"zero"},P.getDayActivityDisplay=function(e){e-=1;var t=L();0<e&&t.setDate(t.getDate()+e);var n=N.getDayString(t),o=P.dailyData[n],i=0;return o&&(i=o.activities.relax.length+o.activities.thoughts.length|o.activities.goals.length),0<i?i+"X":"0"},P.getDayActivityClass=function(e){P.getDayActivityDisplay(e)},P.moveBackwards=function(){O=R(!1),q(),O<E&&Te(K(O))},P.canMoveBackwards=function(){return H(!1)},P.moveForwards=function(){O=R(!0),q()},P.canMoveForwards=function(){return H(!0)},P.setMode=function(e){P.mode=e,r(q)},P.isModeActive=function(e){return P.mode==e},P.getAllDateDisplay=function(){var e=p.getAccountUser();return moment(e.user.createdAt).format("LL")+" - "+moment(moment.now()).format("LL")},P.getActiveDateDisplay=function(){if(P.isModeActive("day"))return moment(O).format("LL");if(P.isModeActive("week")){var e=X(O);return weekEnd=e.addDays(6),moment(e).format("LL")+" - "+moment(weekEnd).format("LL")}return moment(O).format("MMMM YYYY")},P.getHabitSubValueDisplayById=function(e){var t=P.accountHabitSubValues[e];if(t){var n=t.valueString;if(n){var o=d.instant(n.toUpperCase());return o==n.toUpperCase()?capitalizeFirstLetter(n):o}}},P.getRatingDisplay=function(e){return V(e.valueString)},P.getRatingDateDisplay=function(e){var t=new Date(e.experiencedAtStr);return moment(t).calendar()},P.getActivityDisplay=function(e){var t=h.getActivityById(e.activityId);if(t)return h.getDisplayForActivity(t.name)},P.getActivityDateDisplay=function(e){var t=new Date(e.recordedAtString);return moment(t).calendar()},P.getModeMinimumDay=function(e){var t=ne(G(),L(),e);if(t){var n=t.habit.goalMinimized||1==t.habit.id?t.maxDate:t.minDate;return moment(n).format("dddd")}return"?"},P.getModeMaximumDay=function(e){var t=ne(G(),L(),e);if(t){var n=t.habit.goalMinimized||1==t.habit.id?t.minDate:t.maxDate;return moment(n).format("dddd")}return"?"},P.getModeAverage=function(e){return F(e,1)},P.getModeMoodClass=function(){var e=ne(G(),L(),1);return e?B(e):""},P.getModeStressClass=function(){var e=ne(G(),L(),19);return e?Y(e):""},P.getModeMinimum=function(e){return F(e,0)},P.getModeMaximum=function(e){return F(e,2)},P.getDailyHabitValue=function(e){var t=ne(P.dailyData,L(),e);if(t&&t.values&&0<t.values.length){var n=U(t.values[0].habitValueId);return w.getHabitDisplayFromValue(D(e),n)}},P.getModeActivities=function(e){return te(G(),L(),e)},P.getModeActivityCount=function(e){var t=te(G(),L(),e);return t?t.length+"X":"0X"},P.getModeHabits=function(e){var t=ne(G(),L(),e);return t?t.values:[]},P.getModeGoals=function(){var e=G()[N.getDayString(L())];return e?e.goals:[]},P.getModeThoughts=function(){var e=G()[N.getDayString(L())];return e?e.thoughts:[]},P.getThoughtRecordingExtension=function(e){if(void 0!==e&&void 0!==e.recordings)var t=_.get(e,"recordings.thought.title")||_.get(e,"recordings.journal.title");var n=t.split(".");return n[n.length-1]},P.canShowMore=function(e){var t=!P.containsAudio(e);if(P.hasUnplayableAudio(e)||t)return!0},P.hasUnplayableAudio=function(e){return P.containsAudio(e)&&"m4a"!=P.getThoughtRecordingExtension(e)},P.handleThoughtReviewRequest=function(e){var t=P.canShowMore(e)&&!P.hasUnplayableAudio(e),n=P.hasUnplayableAudio(e);t?P.viewThought(e):n&&T.modal.open({modalId:"ReviewAudioModal",templateUrl:"templates/thoughts.review.audio.modal.html",scope:P,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){P.modal=e})},P.containsAudio=function(e){return"AUDIO_JOURNAL"==e.thoughtType||"AUDIO_DISTORTIONS"==e.thoughtType},P.getThoughtName=function(){return P.thought.title},P.getThoughtType=function(){return P.thoughtType},P.getCompletionTitle=function(){return d.instant(P.activity.completionTitle)},P.getRecordingOrder=function(){return P.activity.recordingOrder},P.getRecordingTitle=function(e){var t=function(e){for(var t=0;t<P.activity.steps.length;++t){var n=P.activity.steps[t];if(n.type==e)return n}}(e);return d.instant(t.name)},P.getRecordingText=function(e){return P.thought.recordings[e].notes},P.getRecordingTagByType=function(e,t){var n=P.thought.recordings[e];if(n.tags)for(var o=0;o<n.tags.length;++o){var i=n.tags[o];if(i.tagTypeString==t)return i}},P.getDistortionTagString=function(e,t){var n=P.thought.recordings[e];if(n.tags)for(var o=0;o<n.tags.length;++o){var i=n.tags[o];if(i.tagTypeString==t)return _e(d,i.tagString,i.tagTypeString)}},P.getRecordingTagByIndex=function(e,t){return P.thought.recordings[e].tags[t]},P.getUniqueTagDistortions=function(e){var t=function(e){for(var t=[],n=0;n<e.length;++n)for(var o=e[n].tagString.split(/[,;]/),i=0;i<o.length;++i){var a=o[i];t.indexOf(a)<0&&t.push(a)}return t}(P.thought.recordings[e].tags);if(t)for(var n=0;n<t.length;++n)t[n]=_e(d,t[n],"negative");return t},P.getRecordingTagName=function(e){return"positive"==e.tagTypeString?d.instant("EVIDENCE_FOR")+"...":"negative"==e.tagTypeString?d.instant("EVIDENCE_AGAINST")+"...":void 0},P.getRecordingTagString=function(e){return e.tagString},P.getRecordingTagStringDisplay=function(e){return _e(d,e.tagString,e.tagTypeString)},P.getRecordingSection=function(e,t,n){for(var o=P.thought.recordings[e].notes.split(" "),i="",a=t;a<t+n;++a)0<a&&(i+=" "),i+=o[a];return i},P.viewThought=function(e){var t,n;for(var o in P.thought=e,P.completed=!0,P.thoughtType=("TEXT_DISTORTIONS"==(t=P.thought).thoughtType||"AUDIO_DISTORTIONS"==t.thoughtType?"REFRAME":"AUDIO_JOURNAL"==t.thoughtType||"TEXT_JOURNAL"==t.thoughtType?"JOURNAL":t.thoughtType).toLowerCase(),P.activity=(n=P.thoughtType,Ie[n]),P.thought.recordings){var i=P.thought.recordings[o];i.tags&&i.tags.sort(function(e,t){return e.tagTime-t.tagTime})}var a={basic:"templates/thoughts.review.generic.modal.html",gratitude:"templates/thoughts.review.generic.modal.html",positivity:"templates/thoughts.review.generic.modal.html",beliefs:"templates/thoughts.review.beliefs.modal.html",blame:"templates/thoughts.review.blame.modal.html",evidence:"templates/thoughts.review.evidence.modal.html",journal:"templates/thoughts.review.journal.modal.html",traps:"templates/thoughts.review.traps.modal.html",reframe:"templates/thoughts.review.reframe.modal.html"}[P.thoughtType];T.modal.open({modalId:"ViewThoughtModal",templateUrl:a,scope:P,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){P.modal=e})},P.closeModal=function(){T.modal.close(P.modal).then(function(e){P.modal=e})},P.getGoalDateDisplay=function(e){var t=new Date(e.achievedRecordedAtString);return moment(t).calendar()},P.getRecordingSource=function(e,t){return z(e,t,"url")},console.log("recordingSource",P),P.getRecordingDuration=function(e,t){return z(e,t,"duration")},P.getRecordingTags=function(e,t){return z(e,t,"tags")},P.getRecordingTagLabel=function(e){var t;return t=e.tagString?0<=e.tagString.indexOf(",")?e.tagString.split(","):0<=e.tagString.indexOf(";")?e.tagString.split(";"):[e.tagStrings]:[],_e(d,t,e.tagTypeString)},P.getRecordingTagTimeDisplay=function(e){var t=e.tagTime;t<0&&(t=0);var n=Math.floor(t/60),o=Math.floor(t-60*n);return(n<10?"0"+n:n)+":"+(o<10?"0"+o:o)},P.getThoughtDateDisplay=function(e){var t=new Date(e.createdAtString);return moment(t).calendar()},P.getThoughtDisplay=function(e){return"TEXT_DISTORTIONS"==e.thoughtType?d.instant("COMPLETED_THINKING_TRAPS"):d.instant("COMPLETED_JOURNAL")},P.hasNotes=function(e){return e.habitDataNotes&&e.habitDataNotes.notes&&1<e.habitDataNotes.notes.length},P.toggleNotes=function(e){P.showingNotes[e.id]?delete P.showingNotes[e.id]:P.showingNotes[e.id]=e},P.showNotes=function(e){return!!P.showingNotes[e.id]},P.getWordCloud=function(){return P.wordCloud?e.trustAsHtml(P.wordCloud):""},$(window).on("resize",ee),P.$on("$destroy",function(){$(window).off("resize",ee)}),P.setActiveTab=function(e){o.go("practitioner.client.tab",{userId:g.userId,activeTab:e})};var ve=function(){if(P.clients){var e=_.find(P.clients,function(e){return e.account.id==P.otherUserAccountId});if(e&&"INVITED"==e.status)return!1}m.getUserContext(P.otherUserAccountId).success(function(e){S();var t=e.habitContext.habitValues;t.sort(function(e,t){return e.ordinate-t.ordinate}),C(t),Te(),r(q)})};P.viewingOtherUser=!1;var Ee=function(){if(g.clientId){P.otherUserAccountId=g.clientId;var e=p.getAccountUser();e&&e.user&&(P.viewingOtherUser=P.otherUserAccountId!=e.account.id)}};P.initProgress=function(e){Ee(),P.viewingOtherUser?ve():(C(w.getAccountHabits()),Te(),r(q)),e&&(O=new Date(e),P.setMode("day"))},P.initProgress(),t.$on("event:pacificaReady",function(){var e,t;Ee(),P.viewingOtherUser?ve():(P.pdfData.name=p.getAccountUser().user.name,C(w.getAccountHabits()),t=u.getAccountSubGoals(),P.accountSubGoals=t,e=l.getThoughts(),P.accountThoughts=e,y&&(S(),he(y)),r(q))})}]),e.controller("TrapsCompleteCtrl",["$scope","$controller",function(t,e){e("ProgressCtrl",{$scope:t}),t.getRecordingTags=function(e){return t.thought.recordings[e].tags}}]),e.controller("ReframeCompleteCtrl",["$scope","$controller",function(t,e){e("ProgressCtrl",{$scope:t}),t.getRecordingTags=function(e){return t.thought.recordings[e].tags}}])}(),function(){var e=angular.module("relaxCtrl",[]);function P(e,t,n){var o;"Ocean"==(window.thescope=e).bgSrc?o=[54,52968,!0]:"SummerNight"==e.bgSrc?o=[54,58568,!0]:"Campfire"==e.bgSrc?o=[54,31800,!0]:"ForestMorning"==e.bgSrc?o=[54,46707,!0]:"Stream"==e.bgSrc?o=[54,39936,!0]:"RooftopRain"==e.bgSrc?o=[54,59040,!0]:"City"==e.bgSrc?o=[54,30120,!0]:"Thunderstorm"==e.bgSrc?o=[54,59925,!0]:"Bach"==e.bgSrc?o=[75,143961,!0]:"Pinknoise"==e.bgSrc&&(o=[54,30145,!0]),e.bgPlayerInstance=new Howl({src:[e.backgroundURL],autoplay:!1,loop:!0,volume:.5,sprite:{bgSprite:o},onload:function(){e.checkIfLoaded()},onloaderror:function(){console.log("bgAudio error")}}),e.volumeData={bgVolume:.5};var i,a=n.getUserPreference("soundscape_volume");a&&(e.volumeData.bgVolume=+a),e.bgVolumeChanged=function(){i&&(t.cancel(i),i=void 0),i=t(function(){n.setUserPreference("soundscape_volume",e.volumeData.bgVolume)},500),e.bgPlayerInstance&&e.bgPlayerInstance.volume(e.volumeData.bgVolume)}}e.controller("RelaxCtrl",["$scope","$rootScope","$controller","$state","$http","$translate","$analytics","AccountService","MediaService","RelaxService","GeneralService",function(n,e,t,o,i,a,r,s,c,u,l){u.bgAudioSources,u.bgAudioText;var d=u.getRelaxCategories();u.breathingValues,u.breathingValueMaxIndex;n.exerciseCategories=u.categoryOrder,u.initRelaxExercises();var p=[],g=[],m=[],f=0;for(var h in d)for(var T=d[h].exercises,v=0;v<T.length;++v){var E=T[v];p[f]=E.exercise,g[f]=E.audio,m[f]=E.audioLength,++f}function I(){u.initializeBreatheParams(n,s)}function _(){s.setUserPreference("bg_audio_src",""+n.bgAudioSource),s.setUserPreference("breathe_cycle_length",""+n.cycleLength),s.setUserPreference("enable_meditation_mode",n.enableMeditationMode)}n.exerciseOptions={options:p,exerciseOptionOrdinal:0},n.$on("event:pacificaReady",I),I(),n.getExerciseCategory=function(e){var t="RELAX_CATEGORY_"+e;return t=u.replaceExerciseCharacters(t).toUpperCase(),a.instant(t)},n.getExerciseOptionTimeDisplay=function(e){return u.getExerciseTimeDisplay(e,s,l)},n.getCategoryExercises=function(e){return d[e].exercises},n.getExerciseIndexClass=function(e){var t=p[e];return n.getExerciseClass(t)},n.getExerciseClass=function(e){if(e)return u.replaceExerciseCharacters(e)},n.isPremiumEnabled=function(e){return!u.getExerciseObject(e).premium||s.isPremiumEnabled()},n.isMeditateActivity=function(e){return!!e&&e.meditation},n.getExerciseOptionDisplay=function(e){return u.getRelaxExerciseDisplay(e,a)},n.getExerciseOptionDescription=function(){var e=n.exerciseOptions.options[n.exerciseOptions.exerciseOptionOrdinal];return u.getRelaxExerciseDescription(e,a)},n.goToExercise=function(e){n.isPremiumEnabled(e.exercise)?(n.exercise=e,n.showRelaxOptions=!0):n.showPremiumModal(e.exercise)},n.hideRelaxOptions=function(){n.showRelaxOptions=!1},n.getActivityName=function(){return n.exercise?u.getRelaxExerciseDisplay(n.exercise.exercise,a):""},n.getActivityClass=function(){return n.exercise?u.replaceExerciseCharacters(n.exercise.exercise):""},n.getActivityDescription=function(){return n.exercise?u.getRelaxExerciseDescription(n.exercise.exercise,a):""},n.showCycleOptions=function(){return n.exercise&&"Soundscape Mode"!=n.exercise.exercise&&!n.isMeditateActivity(n.exercise)},n.showContinueOptions=function(){return"Soundscape Mode"!=n.exerciseName},n.updateSoundOption=function(){n.soundOptions.soundOptionOrdinal;n.bgAudioSource=n.bgAudioSources[n.soundOptions.soundOptionOrdinal],_(),r.eventTrack("setBackgroundAudio",{category:"relax",label:n.bgAudioSource}),$("html").removeClass("is_spinner")},n.updateCycleLength=function(){n.cycleLength=n.cycleOptions.options[n.cycleOptions.cycleOptionOrdinal],_(),r.eventTrack("setCycleLength",{category:"relax",label:""+n.cycleLength}),$("html").removeClass("is_spinner")},n.updateContinueOption=function(){n.continueOption=n.continueOptions.options[n.continueOptions.continueOptionOrdinal],n.enableMeditationMode=1==n.continueOptions.continueOptionOrdinal,_(),r.eventTrack("setContinueOption",{category:"relax",label:n.continueOption}),$("html").removeClass("is_spinner")},n.getCycleOptionDisplay=function(e){return e+" "+a.instant("RELAX_ACTIVITY_SECONDS_BREATHING")},n.getSoundOptionDisplay=function(e){var t="RELAX_ACTIVITY_SOUND_"+e;return t=t.replace(/ /g,"_").replace(/#/g,"").toUpperCase(),a.instant(t)},n.getContinueOptionDisplay=function(e){return e},n.startExercise=function(){var e={cycleLength:n.cycleLength,bgSrc:n.bgAudioSource,meditationMode:n.enableMeditationMode};if("Soundscape Mode"==n.exercise.exercise){if("none"==n.bgAudioSource)return void window.alert(a.instant("RELAX_ACTIVITY_SOUNDSCAPE_MODE_NO_SOUND_POPUP"));e.src="none",o.go("app.meditation",e)}else n.isMeditateActivity(n.exercise)?(e.src=n.exercise.audio,o.go("app.meditation",e)):o.go("app.breathe",e)}}]),e.controller("BreathingCtrl",["$scope","$rootScope","$controller","$state","$stateParams","$timeout","$http","$translate","$analytics","AccountService","MediaService","GeneralService","RelaxService","ActivityService",function(i,e,t,n,o,a,r,s,c,u,l,d,p,g){i.cancelLogoutTimer(),i.backgroundURL=void 0;var m,f;i.bgPlayerInstance=void 0,i.playing=!1,i.cycle=1,i.percentage=0,i.elapsedTime=0,i.startTime=void 0;var h=.5;i.enableMeditationMode=!1;var T=u.getUserPreference("enable_meditation_mode");T&&(i.enableMeditationMode="true"==T);var v=o.cycles;i.cycles=v?+v:8;var E=o.cycleLength;i.cycleLength=E?+E:10;var I=1e3*(i.cycleLength/3)/(h/.003),_="Inhale-10.mp3",y="Exhale-10.mp3";5==i.cycleLength?(_="Inhale-5.mp3",y="Exhale-5.mp3"):15==i.cycleLength?(_="Inhale-15.mp3",y="Exhale-15.mp3"):20==i.cycleLength?(_="Inhale-20.mp3",y="Exhale-20.mp3"):25==i.cycleLength&&(_="Inhale-25.mp3",y="Exhale-25.mp3"),"none"!=o.bgSrc?(i.bgSrc=o.bgSrc,l.getStreamingBackgroundURL(o.bgSrc+".mp3").success(function(e){i.backgroundURL=e.url,!!i.backgroundURL,P(i,a,u),D()})):(i.backgroundURL="none",!1,D()),i.getExerciseHeader=function(){return i.started?i.finished?s.instant("FINISHED"):i.playing?i.inhale?s.instant("INHALE"):s.instant("EXHALE"):s.instant("PAUSED"):s.instant("GET_READY")+"..."},i.pause=function(){i.playing=!i.playing,i.bgPlayerInstance&&(i.playing?i.bgPlayerInstance.play("bgSprite"):i.bgPlayerInstance.pause()),i.playing?(i.startTime=(new Date).getTime(),i.started&&(R(),i.inhale?i.playInhaleAudio(!1):i.playExhaleAudio(!1),0<i.personalAudioPosition&&i.personalAudio.play(playOptions))):(i.started&&(i.elapsedTime+=(new Date).getTime()-i.startTime,i.percentage=i.elapsedTime/1e3/i.cycleLength),inhaleAudio.pause(),exhaleAudio.pause())},i.playInhaleAudio=function(e){e&&(inhaleAudio.currentTime=0),inhaleAudio.play(),exhaleAudio.pause(),exhaleAudio.currentTime=0},i.playExhaleAudio=function(e){e&&(exhaleAudio.currentTime=0),exhaleAudio.play(),inhaleAudio.pause(),inhaleAudio.currentTime=0},i.getExerciseTitle=function(){if(i.cycle<=i.cycles){var e=s.instant("RELAX_ACTIVITY_CYCLE_X_OF_Y");return e=e.replace("[X]",i.cycle).replace("[Y]",i.cycles)}return s.instant("RELAX_ACTIVITY_COMPLETE")},i.checkIfLoaded=function(){("none"==o.bgSrc||i.bgPlayerInstance&&"loaded"==i.bgPlayerInstance.state())&&function(){if(i.playing)return;i.bgPlayerInstance&&i.bgPlayerInstance.play("bgSprite");A(),i.playing=!0}()};var O=100,S=0;function A(){i.bgPlayerInstance&&i.bgPlayerInstance.volume(S*i.volumeData.bgVolume/100),S<O?(a(A,30),++S):(S=0,i.startTime=(new Date).getTime(),i.started=!0,R())}function C(){i.bgPlayerInstance&&i.bgPlayerInstance.volume((O-S)*i.volumeData.bgVolume/100),S<O?(a(C,30),++S):(S=0,i.finishExercise())}function D(){m=document.getElementById("inhaleAudio"),f=document.getElementById("exhaleAudio"),m.src="/binaries/breathing-sounds/"+_,f.src="/binaries/breathing-sounds/"+y,m.volume=.25,f.volume=.25,m.load(),f.load(),i.canvas=$("canvas")[0],a(i.checkIfLoaded,1e3)}var b=135;function R(){if(i.playing&&!i.exited){0===i.percentage?(i.playInhaleAudio(!0),i.inhale=!0):i.percentage>=h&&i.inhale&&(i.playExhaleAudio(!0),i.inhale=!1);var e=(new Date).getTime(),t=(i.elapsedTime+(e-i.startTime))/1e3/i.cycleLength;.999<=t?i.cycle<i.cycles||i.enableMeditationMode?(i.cycle==i.cycles&&i.preFinishExercise(),i.percentage=0,i.elapsedTime=0,i.startTime=(new Date).getTime(),++i.cycle,i.inhale=!0,a(R,I)):i.preFinishExercise():(i.percentage=t,a(R,I)),function(){var e=i.canvas.getContext("2d"),t=i.canvas.width,n=i.canvas.height;e.clearRect(0,0,t,n);var o=i.percentage<.5?i.percentage/.5:(1-i.percentage)/.5;o=p.getBreathingValue(o),e.beginPath(),e.arc(b,b,96*o,0,2*Math.PI,!1),e.fillStyle="rgba(255, 255, 255, 0.3)",e.fill()}()}}i.finishedExercise=function(){return i.finished},i.preFinishExercise=function(){i.finished=!0,g.recordActivity("COMPLETED_BREATHING"),i.enableMeditationMode||C()},i.finishExercise=function(){n.go("app.home")},i.destroyCtrl=function(){i.bgPlayerInstance&&i.bgPlayerInstance.unload(),i.exited=!0},i.$on("$destroy",function(){i.destroyCtrl()})}]),e.controller("MeditationCtrl",["$scope","$rootScope","$controller","$state","$stateParams","$timeout","$http","$translate","$analytics","AccountService","MediaService","GeneralService","ActivityService","RelaxService",function(o,e,t,n,i,a,r,s,c,u,l,d,p,g){o.cancelLogoutTimer(),o.hasFlash=!1;try{o.hasFlash=Boolean(new ActiveXObject("ShockwaveFlash.ShockwaveFlash"))}catch(e){o.hasFlash=void 0!==navigator.mimeTypes["application/x-shockwave-flash"]}o.loading=!0,o.initialized=!1,o.paused=!1,o.streamingURL=void 0,o.backgroundURL=void 0;var m,f=!1,h=!1;o.elapsedTime=0,o.completedPlayback=!1,o.bgPlayerInstance=void 0,o.startedPlaying=!1,o.isSoundscape=!1,o.enableMeditationMode="true"==i.meditationMode,"none"!=i.src&&l.getStreamingMeditationURL(i.src).success(function(e){o.streamingURL=e.url,f=!!o.streamingURL,o.checkIfLoaded()}),"none"!=i.bgSrc?(o.bgSrc=i.bgSrc,l.getStreamingBackgroundURL(i.bgSrc+".mp3").success(function(e){o.backgroundURL=e.url,h=!!o.backgroundURL,P(o,a,u)})):(o.backgroundURL="none",h=!1),o.goBack=function(){window.history.go(-1)},o.pause=function(){!o.loading&&o.initialized&&(h&&(o.paused?o.bgPlayerInstance.play("bgSprite"):o.bgPlayerInstance.pause()),f&&m.pause(),o.paused=!o.paused)},o.destroyCtrl=function(){m&&m.remove(),o.bgPlayerInstance&&o.bgPlayerInstance.unload(),o.narrationTimeout&&a.cancel(o.narrationTimeout),o.exited=!0},o.$on("$destroy",function(){o.destroyCtrl()}),o.getElapsedTime=function(){var e=0;if(m){o.bgPlayerInstance&&(bgDuration=o.bgPlayerInstance.seek());var t=o.relaxObj.audioLength,n=m.getPosition();console.log("position: "+n),(e=t-n)<0&&(e=0)}return d.getTimeDisplay(e)},o.finishExercise=function(){n.go("app.home")},o.finishedExercise=function(){return o.completedPlayback};var T=100,v=0;function E(){o.bgPlayerInstance&&o.bgPlayerInstance.volume(v*o.volumeData.bgVolume/100),v<T?(a(E,30),++v):v=0}function I(){o.bgPlayerInstance&&o.bgPlayerInstance.volume((T-v)*o.volumeData.bgVolume/100),v<T?(a(I,30),++v):(v=0,o.finishExercise())}function _(){m&&(o.elapsedTime=m.getPosition(),o.exited||(o.narrationTimeout=a(_,300)))}function y(){o.startedPlaying||(o.startedPlaying=!0,m&&m.play(),o.bgPlayerInstance&&o.bgPlayerInstance.play("bgSprite"),E(),o.narrationTimeout=a(_,100))}o.checkIfLoaded=function(){("none"==i.src||o.streamingURL)&&("none"==i.bgSrc||o.bgPlayerInstance&&"loaded"==o.bgPlayerInstance.state())&&(o.loading=!1,o.isSoundscape="none"==i.src,function(){f&&(o.relaxObj=g.getExerciseObjectByAudio(i.src),(m=jwplayer("meditationAudio")).setup({file:o.streamingURL,height:40}),m.setVolume(100),m.onComplete(function(){o.completedPlayback=!0,p.recordActivity(o.relaxObj.activity),c.eventTrack("finishRelaxExercise",{category:"relax"}),o.enableMeditationMode||I()}));a(y,1e3),o.initialized=!0}())}}])}(),angular.module("therapistCtrl",[]).controller("TherapistCtrl",["$scope","$rootScope","$sce","$controller","$state","$ionicPopup","$ionicModal","$ionicScrollDelegate","AccountService","AssessmentService",function(t,e,n,o,i,a,r,s,c,u){function l(){c.initializeAppointmentFunctionality(t,i),c.initializeInviteFunctionality(t,r,a,s,n),u.initializeAssessmentFunctionality(t,i,a),t.loading=!1}c.isLoggedIn()?(o("VideoChatCtrl",{$scope:t}),t.showConnectionOptions=function(e){t.disconnectPractitioner(e)},t.loading=!0,t.isAppReady()&&l(),e.$on("event:pacificaReady",l),t.$on("event:userContextRefreshRequest",t.retrieveUserContext)):i.go("app.login")}]),function(){var e=angular.module("thoughtsCtrl",[]);e.controller("TextThoughtsReviewCtrl",["$sce","$scope","$rootScope","$state","$controller","$stateParams","$timeout","$translate","$ionicActionSheet","$ionicModal","$ionicPopup","$ionicPopover","AccountService","AudioService","HabitsService",function(e,l,t,n,o,i,a,d,r,s,c,p,u,g,m){var f;!l.thought&&i.thoughtId&&(l.thought=g.getThought(i.thoughtId)),l.analysisRecording=l.thought.recordings.analysis,l.thoughtRecording=l.thought.recordings.thought,l.analysisRecording?f=l.analysisRecording.notes.split(" "):l.thoughtRecording&&(f=l.thoughtRecording.notes.split(" "));var h="",T=l.analysisRecording?l.analysisRecording.tags:[];T.sort(function(e,t){return e.tagTime-t.tagTime});for(var v=0;v<f.length;++v){for(var E=!1,I=!1,_="",y="",O=0;O<T.length;++O){var S=T[O];if(v>=S.tagTime&&v<=S.tagTime+S.tagSpan-1){E=v==S.tagTime,I=v==S.tagTime+S.tagSpan-1,!0,S.tagTypeString&&(_=S.tagTypeString,"negative"==S.tagTypeString&&(y="onClick=\"showTagToolTip(event, '"+S.tagString+"', '"+S.tagTypeString+"')\"")),E&&(0,S.replaced&&(_+=" replaced"));break}}0<v&&(h+=" "),E&&(h+='<span class="thoughtWord thoughtHighlight start end '+_+'" '+y+">"),h+=f[v],I&&(h+="</span>")}l.thoughtHTML=e.trustAsHtml(h),l.getToughtTitle=function(){return l.thought.title},l.removePopover=function(){l.popover&&(l.popover.remove(),l.popover=void 0)},window.showTagToolTip=function(e,t,n){var o,i,a,r,s=$.event.fix(e),c=t?t.split(","):[],u='<ion-popover-view class="platform-ios"><ion-header-bar> <h1 class="title">'+(o=d,a=n,r="",0<=(i=c).indexOf("catastrophizing")&&(r+=o.instant("THOUGHTS_EMOTIONS_CATASTROPHIZING")),0<=i.indexOf("emotional_reasoning")&&(0<r.length&&(r+=", "),r+=o.instant("THOUGHTS_EMOTIONS_EMOTIONAL_REASONING")),0<=i.indexOf("mind_reading")&&(0<r.length&&(r+=", "),r+=o.instant("THOUGHTS_EMOTIONS_MIND_READING")),0<=i.indexOf("fortune_telling")&&(0<r.length&&(r+=", "),r+=o.instant("THOUGHTS_EMOTIONS_FORTUNE_TELLING")),0<=i.indexOf("extreme_words")&&(0<r.length&&(r+=", "),r+=o.instant("THOUGHTS_EMOTIONS_PRESSURIZED")),0<=i.indexOf("judging")&&(0<r.length&&(r+=", "),r+=o.instant("THOUGHTS_EMOTIONS_LABELLING")),0<=i.indexOf("personalization")&&(0<r.length&&(r+=", "),r+=o.instant("THOUGHTS_EMOTIONS_PERSONALIZATION")),0<=i.indexOf("overgeneralizing")&&(0<r.length&&(r+=", "),r+=o.instant("THOUGHTS_EMOTIONS_GENERALIZING")),0<=i.indexOf("negative_filtering")&&(0<r.length&&(r+=", "),r+=o.instant("THOUGHTS_EMOTIONS_NEGATIVE")),0<=i.indexOf("notsure")&&(0<r.length&&(r+=", "),r+=o.instant("NEGATIVE_THOUGHT")),0===r.length&&(r="negative"==a?o.instant("NEGATIVE_THOUGHT"):o.instant("POSITIVE_THOUGHT")),r)+"</h1> </ion-header-bar></ion-popover-view>";l.removePopover(),l.popover=p.fromTemplate(u,{scope:l}),l.popover.show(s)},l.$on("$destroy",function(){l.removePopover(),window.showTagToolTip=void 0})}]),e.controller("TextThoughtsJournalReviewCtrl",["$sce","$scope","$rootScope","$state","$controller","$stateParams","$timeout","$translate","$ionicActionSheet","$ionicModal","$ionicPopup","$ionicPopover","AccountService","AudioService","HabitsService",function(e,t,n,o,i,a,r,s,c,u,l,d,p,g,m){t.thought&&a.thoughtId&&(t.thought=g.getThought(a.thoughtId));var f=t.thought.recordings.journal;t.thoughtHTML=e.trustAsHtml(f.notes)}])}(),function(){var e=angular.module("upgradeCtrl",[]);e.controller("RedeemGiftCodeCtrl",["$scope","$rootScope","$controller","$state","$http","$timeout","$translate","AccountService","Environment",function(t,e,n,o,i,a,r,s,c){s.isPremiumEnabled()&&o.go("app.home"),t.formData={giftCode:""},t.redemptionSuccessful=!1,t.back=function(){window.history.go(-1)},t.redeem=function(){t.otherError=void 0,/^[a-zA-Z0-9]{4}-[a-zA-Z0-9]{4}-[a-zA-Z0-9]{4}-[a-zA-Z0-9]{4}$/gm.test(t.formData.giftCode)?(t.formatError=!1,s.redeemGiftCode(t.formData.giftCode).success(function(e){s.enablePremiumAccount(new Date(e),"GIFT_CODE"),t.redemptionSuccessful=!0}).error(function(){t.otherError=r.instant("REDEEM_GIFT_CODE_OTHER_ERROR")})):t.formatError=!0}}]),e.controller("UpgradeCtrl",["$scope","$rootScope","$controller","$state","$stateParams","$http","$timeout","$translate","AccountService","Environment",function(o,e,t,n,i,a,r,s,c,u){if(c.isLoggedIn()){o.allowSubscription=!0,o.canUpgrade()||(o.allowSubscription=!1),o.errorFields=[],o.accountUser=c.getAccountUser(),o.price,o.shouldShowCouponCode=!1,o.requestingCoupon=!1,o.coupon,o.pricing=recurly.Pricing(),o.updatingPricing=!1,o.upgradeComplete=!1,o.planType=void 0,o.allowSubscription?"monthly"!=i.plan&&"yearly"!=i.plan&&"lifetime"!=i.plan||(o.planType=i.plan):o.planType="giftpurchaser",o.planType||(o.planType="monthly");var l={};o.isPractitioner=function(){return c.isPractitioner()},o.isGiftPurchase=function(){return!!o.formData&&("bulkpurchaser"==o.formData.plan||"giftpurchaser"==o.formData.plan)},o.isBulkPurchase=function(){return!!o.formData&&"bulkpurchaser"==o.formData.plan},o.updateGiftPurchases=function(){20<=o.formData.purchases?o.formData.plan="bulkpurchaser":o.formData.plan="giftpurchaser",m()};var d=0;o.showCouponCode=function(){o.shouldShowCouponCode=!0},o.applyCoupon=function(){o.requestingCoupon=o.enteredCoupon(),m()},o.getDiscount=function(){return o.price?parseFloat(o.price.discount).toFixed(2):0},o.couponChanged=function(){o.requestingCoupon=o.enteredCoupon(),m()},o.enteredCoupon=function(){return!!o.formData.coupon&&0<o.formData.coupon.length},o.hasValidCoupon=function(){return o.requestingCoupon&&!!o.coupon},o.showPrice=function(){return!!o.price},o.setPlan=function(e){o.formData.plan=p(e),o.planType=e,m()},o.hasFieldError=function(e){for(var t=0;t<o.errorFields.length;++t)if(o.errorFields[t]==e)return!0;return!1},o.removeErrorField=function(e){for(var t=0;t<o.errorFields.length;++t)if(o.errorFields[t]==e){o.errorFields.splice(t,1);break}},o.addErrorField=function(e){for(var t=0;t<o.errorFields.length;++t)if(o.errorFields[t]==e)return;o.errorFields.push(e)},o.checkCVV=function(){return 0!=o.formData.cvv.length||(o.addErrorField("cvv"),!1)},o.checkCoupon=function(){return!(o.requestingCoupon&&!o.hasValidCoupon())||(o.addErrorField("coupon"),!1)},o.checkCreditCard=function(){var e=o.formData.ccNumber,t=recurly.validate.cardType(e),n=!1;recurly.validate.cardNumber(e)?o.removeErrorField("number"):(o.addErrorField("number"),n=!0),n?$(".credit-card-image").removeClass("generic visa mastercard amex visa discover"):"default"==t||"unknown"==t?($(".credit-card-image").addClass("generic"),$(".credit-card-image").removeClass("visa mastercard amex visa discover")):($(".credit-card-image").removeClass("generic"),$(".credit-card-image").addClass(t))},o.submittingForm=!1,o.submitForm=function(e){o.errorMsg="";var t=$("form");e.preventDefault(),recurly.token(t,function(e,t){if(e)console.log("Error"),console.log(e),o.errorMsg=e.message,e.fields&&(o.errorFields=e.fields),o.checkCVV(),o.checkCoupon(),o.$$phase||o.$apply();else{if(o.errorFields=[],o.checkCVV(),o.checkCoupon(),0<o.errorFields.length)return console.log("cvv or coupon error, had token: "+t.id),void(o.$$phase||o.$apply());o.submittingForm=!0,console.log("success: "+t.id),o.isGiftPurchase()?c.bulkPurchaseWithtoken(t.id,o.formData.firstName,o.formData.lastName,o.formData.address1,o.formData.address2,o.formData.city,o.formData.state,o.formData.postalCode,o.formData.country,o.formData.plan,o.formData.coupon,o.formData.purchases).success(function(e){e.expiration&&(c.userPreferences.has_purchased_gift_codes="true",c.enablePremiumAccount(new Date(e.expiration))),o.purchasedGiftCodes=e.giftCodes,o.upgradeComplete=!0,o.hasError=!0,o.submittingForm=!1}).error(function(){o.hasError=!0,o.submittingForm=!1}):c.subscribeWithToken(t.id,o.formData.firstName,o.formData.lastName,o.formData.address1,o.formData.address2,o.formData.city,o.formData.state,o.formData.postalCode,o.formData.country,o.formData.plan,o.formData.coupon).success(function(e){e?(c.enablePremiumAccount(new Date(e)),o.upgradeComplete=!0):o.hasError=!0,o.submittingForm=!1}).error(function(e){e.message&&(o.errorMsg=e.message),o.hasError=!0,o.submittingForm=!1})}o.$$phase||o.$apply()})},o.downloadGiftCodes=function(){c.getDownloadGiftCodeToken().success(function(e){window.open(u.serverURL+"/payment/giftCodes.csv?token="+e,"_blank")}).error(function(){window.alert("There was an error loading the gift codes.")})},o.isAppReady()?g():o.$on("event:pacificaReady",g)}else n.go("app.login");function p(e){var t=l[e];return t||e}function g(){c.isPractitioner()?(l.monthly="practitioner_monthly",l.yearly="practitioner_yearly"):(l.monthly="monthly",l.yearly="yearly",l.lifetime="lifetime"),o.formData={firstName:"",lastName:"",address1:"",address2:"",city:"",state:"",postalCode:"",country:"",ccNumber:"",cvv:"",coupon:"",plan:p(o.planType),purchases:1},i.couponCode&&(o.formData.coupon=i.couponCode,o.shouldShowCouponCode=!0),o.pricing.on("set.coupon",function(e){o.coupon=e,console.log("Set coupon"),console.log(e)}),o.pricing.on("change",function(e){console.log("Pricing changed:"+e.now.total),o.price=e.now,o.nextPrice=e.next,o.$$phase||o.$apply()}),m()}function m(){var t=++d;o.updatingPricing=!0;var e=o.pricing.plan(o.formData.plan,{quantity:1}).currency("USD").coupon(o.formData.coupon).tax({tax_code:"digital",vat_number:""});o.isGiftPurchase()&&e.addon("yearlypurchase",{quantity:o.formData.purchases}),e.catch(function(e){console.log("ERROR in pricing: "),console.log(e)}).done(function(e){t==d&&(console.log("done ("+d+" ):"),console.log(e),o.updatingPricing=!1,o.$$phase||o.$apply())})}}])}();var DID_INITIALIZE_MASONRY=!1;function initMasonry(){$(".masonry-grid").masonry({percentPosition:!0,itemSelector:".grid-item",columnWidth:".grid-sizer",gutter:5}),DID_INITIALIZE_MASONRY=!0}function redrawMasonry(){DID_INITIALIZE_MASONRY&&setTimeout(function(){$(".masonry-grid").masonry("reloadItems"),$(".masonry-grid").masonry()},0)}angular.module("webCommunityCtrl",[]).controller("WebCommunityCtrl",["$scope","$controller","$timeout","$location","$stateParams",function(e,t,n,o,i){t("GroupPostsCtrl",{$scope:e}),t("GroupsCtrl",{$scope:e}),e.loadCommunities(),e.initMasonry=function(){initMasonry()},e.$watch("groupPosts",function(){redrawMasonry()},!0),e.$on("$destroy",function(){DID_INITIALIZE_MASONRY=!1})}]),function(){var b=/^[a-zA-Z0-9.!#$%&’*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$/,R=/[0-9]{5}/,P=/^\b([A-z]{2})\b/,w=/[0-9]{10}/,N=/^(https?|ftp):\/\/([a-zA-Z0-9.-]+(:[a-zA-Z0-9.&%$-]+)*@)*((25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]?)(\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9]?[0-9])){3}|([a-zA-Z0-9-]+\.)*[a-zA-Z0-9-]+\.(com|edu|gov|int|mil|net|org|biz|arpa|info|name|pro|aero|coop|museum|[a-zA-Z]{2}))(:[0-9]+)*(\/($|[a-zA-Z0-9.,?'\\+&%$#=~_-]+))*$/;angular.module("practitionerAccountCtrl",[]).controller("PractitionerAccountCtrl",["$scope","$rootScope","$sce","$controller","$state","$http","$timeout","$ionicPopup","$translate","AccountService","PractitionerService","Token","Environment","authHttp","$location","$stateParams",function(o,e,t,n,a,r,s,c,u,l,d,p,g,m,f,h){if(l.isLoggedIn()){o.activeView=null,o.editingAgeGroups=!1,o.editingSpecialties=!1,o.editingOrientations=!1,o.editingLanguages=!1,o.showRemoveBtn=!1,o.billinginfo=null,o.updateView=function(e){"directory"==(o.activeView=e)?(h.activeTab="directory",f.search("activeTab","directory")):"billing"==e?null==o.billinginfo&&C():(h.activeTab=void 0,f.search(""))},o.isPractitioner=function(){return l.isPractitioner()};var T=function(e){var n=[];return e?(e.forEach(function(e){var t=angular.copy(e);t.selected=!0,n.push(t)}),n):[]};o.createEmptyStateLicense=function(){o.userLicenses.push({licenseState:"",licenseNumber:null})},o.buildAgeGroupString=function(){var e=[];for(o.ageGroupString="",o.editUser.ageGroups.zeroToFive&&e.push("0-5 Years"),o.editUser.ageGroups.sixToEleven&&e.push("6-11 Years"),o.editUser.ageGroups.twelveToSeventeen&&e.push("12-17 Years"),o.editUser.ageGroups.eighteenToSixtyFour&&e.push("18-64 Years"),o.editUser.ageGroups.sixtyFiveOrOver&&e.push("65 Years or Over"),i=0;i<e.length;i++)o.ageGroupString+=e[i],i!=e.length-1&&(o.ageGroupString+=", ")};var v=function(){o.specialtiesString=y(o.editUser.specialties,"specialty")},E=function(){o.orientationsString=y(o.editUser.orientations,"orientation")},I=function(){o.languagesString=y(o.editUser.languages,"language")},y=function(e,t,n){var o="";for(i=0;i<e.length;i++)o+=e[i][t],i!=e.length-1&&(o+=", ");return o};o.updateListingVisibility=function(t){o.accountUser.practitioner.publicDirectory=t,m.post("app/practitioner/account",o.accountUser.practitioner).success(function(e){o.editUser.publicDirectory=t}).error(function(e){o.formError=u.instant("UPDATE_PROFILE_ERROR")})};var O=function(){o.directoryVisibleMsg=t.trustAsHtml(u.instant("DIRECTORY_VISIBLE_MESSAGE")),o.directoryHiddenMsg=t.trustAsHtml(u.instant("DIRECTORY_HIDDEN_MESSAGE")),"true"!=l.getUserPreference("practitioner_settings_visited")?(l.setUserPreference("practitioner_settings_visited",!0),o.updateView("directory")):"directory"==h.activeTab?o.updateView("directory"):o.updateView("account"),o.editUser=angular.copy(o.accountUser.practitioner),o.buildAgeGroupString(),v(),E(),I(),0==o.editUser.npi&&(o.editUser.npi=""),o.editUser.supportedPayers||(o.editUser.supportedPayers=[]),o.userLicenses=o.editUser.stateLicenses,o.userLicenses.length||o.createEmptyStateLicense(),o.editUser.telehealth=o.editUser.telehealth.toString(),o.specialtySelections=T(o.editUser.specialties),o.languageSelections=T(o.editUser.languages),o.orientationSelections=T(o.editUser.orientations),o.payerSelections=T(o.editUser.supportedPayers),o.specialtyCheckbox=null,o.languageCheckbox=null,o.orientationCheckbox=null,o.payersCheckbox=null,o.stateLicenses=null,o.stateLicenseNumber=null};o.cancelEdits=function(){o.formErrors=[],D()},o.isEmailValidated=function(){return l.isEmailValidated()},o.isPremium=function(){return l.isPremiumEnabled()},o.getPremiumExpiration=function(){return l.getPremiumExpiration()},o.getAccountType=function(){if(o.accountUser&&o.accountUser.account){var e="Practitioner ";return l.isPremiumEnabled()?e+=u.instant("ACCOUNT_TYPE_FULL_ACCESS")+" - "+u.instant(o.accountUser.account.paymentType):e+=u.instant("ACCOUNT_TYPE_BASIC"),e}},o.isPhoneGood=function(){var e=o.editUser.location.phone;return 0!=e.length&&libphonenumber.parse(e,"US").phone};o.toggleSpecialties=function(){o.editingSpecialties=!o.editingSpecialties},o.toggleLanguages=function(){o.editingLanguages=!o.editingLanguages},o.toggleOrientations=function(){o.editingOrientations=!o.editingOrientations},o.toggleUserSelections=function(){o.editingUserSelections=!o.editingUserSelections},o.toggleAgeGroups=function(){o.editingAgeGroups=!o.editingAgeGroups},o.saveDetails=function(){var e,t,n;o.editUser.licenses&&delete o.editUser.licenses,o.editUser.stateLicenses=o.userLicenses,o.isSaving=!0,o.formConfirmation=void 0,e=o.editUser.email,o.editUser.location.phone,t=o.editUser.location.postalCode,n=o.editUser.location.state=o.editUser.location.state.toUpperCase(),o.formErrors=[],b.test(e)||o.formErrors.push(u.instant("LOGIN_ERROR_INVALID_EMAIL")),o.isPhoneGood()||o.formErrors.push(u.instant("INVALID_PHONE")),R.test(t)||o.formErrors.push(u.instant("INVALID_ZIP")),P.test(n)||o.formErrors.push(u.instant("INVALID_STATE")),""==o.editUser.npi||w.test(o.editUser.npi)||o.formErrors.push(u.instant("INVALID_NPI")),o.editUser.facebookUrl&&-1<o.editUser.facebookUrl.indexOf("facebook.com")&&o.formErrors.push(u.instant("INVALID_FACEBOOK")),o.editUser.twitterUrl&&-1<o.editUser.twitterUrl.indexOf("twitter.com")&&o.formErrors.push(u.instant("INVALID_TWITTER")),o.editUser.websiteUrl&&!N.test(o.editUser.websiteUrl)&&o.formErrors.push(u.instant("INVALID_WEBISTE")),o.editUser.stateLicenses.forEach(function(e,t){var n=[];for(e.licenseState&&!e.licenseNumber?o.formErrors.push(u.instante("INVALID_LICENSE_NUMBER")):!e.licenseState&&e.licenseNumber?o.formErrors.push(u.instante("INVALID_LICENSE_STATE")):e.licenseState||e.licenseNumber||n.push(t);n.length;)o.editUser.stateLicenses.splice(n.pop(),1)}),o.formErrors.length?o.isSaving=!1:m.post("app/practitioner/account",o.editUser).success(function(e){o.formConfirmation=u.instant("UPDATE_PROFILE_SUCCESS"),o.retrieveUserContext(),o.editingLanguages=!1,o.editingOrientations=!1,o.editingSpecialties=!1,o.editUserSelections=!1,o.editingAgeGroups=!1,s(function(){o.formConfirmation=void 0},4e3)}).error(function(e){o.formError=u.instant("UPDATE_PROFILE_ERROR")}).finally(function(){o.isSaving=!1})};o.isSelected=function(t,e){return-1<_.findIndex(e,function(e){return e.id==t})},o.updateSelection=function(t,e,n){var o=_.findIndex(e,function(e){return e.id==t.id});if(-1<o)return e.splice(o,1),void n.splice(o,1);n.push(t);var i=angular.copy(t);e.push(i),e[e.length-1].selected=!0,t.hasOwnProperty("specialty")?v():t.hasOwnProperty("orientation")?E():t.hasOwnProperty("language")&&I()},o.removeLicense=function(t){var e=_.findIndex(o.userLicenses,function(e){return e.id==t});o.userLicenses.splice(e,1)},o.photoHoverIn=function(){o.showRemoveBtn=!0},o.photoHoverOut=function(){o.showRemoveBtn=!1};var S=function(){c.alert({template:u.instant("An Error Occurred Attaching Your File"),okText:u.instant("OK_GOT_IT"),okType:"button-default"})},A=function(e){o.accountUser.practitioner.photo=e,o.editUser.photo=e};o.photoUploadChange=function(t){if(5<t.files[0].size/1024/1024)c.alert({template:u.instant("FILESIZE_TOO_BIG"),okText:u.instant("OK_GOT_IT"),okType:"button-default"});else{var o=t.files[0].type,e=o.split("/")[1];d.presignURL(e).success(function(e){var n=e.url;r.put(n,t.files[0],{headers:{"Content-Type":o}}).success(function(e){var t=n.split("?")[0];d.setPhotoURL(t).success(function(e){A(t)})}).error(function(e){S()})}).error(function(e){S()})}},o.removePhoto=function(){d.setPhotoURL("").success(function(e){A(null)}).error(function(e){c.alert({template:u.instant("UPLOAD_ERROR"),okText:u.instant("OK_GOT_IT"),okType:"button-default"})})},D(),e.$on("event:pacificaReady",D),m.get("app/support/practitionerOptions").success(function(e){o.languages=e.languages,o.payers=e.payers,o.orientations=e.orientations,o.specialties=e.specialties}).error(function(e){console.log("error retrieving settings: "+e)}),o.stateOptions={"":"Choose state",AL:"Alabama",AK:"Alaska",AZ:"Arizona",AR:"Arkansas",CA:"California",CO:"Colorado",CT:"Connecticut",DE:"Delaware",DC:"District Of Columbia",FL:"Florida",GA:"Georgia",GU:"Guam",HI:"Hawaii",ID:"Idaho",IL:"Illinois",IN:"Indiana",IA:"Iowa",KS:"Kansas",KY:"Kentucky",LA:"Louisiana",ME:"Maine",MD:"Maryland",MA:"Massachusetts",MI:"Michigan",MN:"Minnesota",MS:"Mississippi",MO:"Missouri",MT:"Montana",NE:"Nebraska",NV:"Nevada",NH:"New Hampshire",NJ:"New Jersey",NM:"New Mexico",NY:"New York",NC:"North Carolina",ND:"North Dakota",OH:"Ohio",OK:"Oklahoma",OR:"Oregon",PA:"Pennsylvania",PR:"Puerto Rico",RI:"Rhode Island",SC:"South Carolina",SD:"South Dakota",TN:"Tennessee",TX:"Texas",UT:"Utah",VT:"Vermont",VA:"Virginia",VI:"Virgin Islands",WA:"Washington",WV:"West Virginia",WI:"Wisconsin",WY:"Wyoming"};var C=function(){m.get("app/practitioner/billing").success(function(e){o.billinginfo=e,o.usages=[],o.billinginfo.subscriptions.forEach(function(e){e.addOns&&e.addOns.forEach(function(e){o.usages.push.apply(o.usages,e.usages)})})}).error(function(e){alert("ERROR!")})}}else a.go("app.login");function D(){o.accountUser=l.getAccountUser(),o.accountUser.practitioner&&(O(),o.accountUser.user&&(o.isPractitioner()||a.go("app.account")))}}])}(),function(){var e=angular.module("clientsCtrl",[]);e.filter("inviteStatus",function(){return function(e,t){switch(e){case 0:return"Invited";case 1:return"Connected";case 2:return"Discontinued";default:return"--"}}}),e.controller("ClientCtrl",["$scope","$rootScope","$controller","$state","$stateParams","$timeout","$translate","$ionicPopup","$ionicModal","AccountService","PractitionerService","$location","GroupsService","HomeworkService","OverlayService",function(l,e,t,n,o,i,d,a,r,p,s,c,u,g,m){function f(e){var t=e.shortName;return"PHQ-8"==t?24:"PHQ-9"==t?27:"GAD-7"==t?21:"CESD-R"==t?60:"DASS-21"==t?21:"PCL-5"==t?80:"AUDIT"==t?80:"PROMIS"==t?55:"STAI"==t?80:50}l.clientId=+o.clientId,l.loading=!0,l.activeTab=o.activeTab?o.activeTab:"schedule",Array.isArray(l.activeTab)&&(l.activeTab=l.activeTab[0]),l.loadingClient=!1,l.loadingData=!1,l.activeAssessments=[],l.assessments=[],s.initAssessmentFunctionality(l),l.launchHomeworkModal=function(e){l.dismissToolTip("viewed_assign_homework_tooltip"),l.openHomeworkModal(e)},l.closeEditHomeworkModal=function(){m.modal.close(l.editHomeworkModal).then(function(e){l.editHomeworkModal=e})},t("VideoChatCtrl",{$scope:l}),t("ProgressCtrl",{$scope:l}),l.getClientNotificationCount=function(e){return s.clientNotificationCount(e)},l.closeDownloadModal=function(){m.modal.close(l.downloadModal).then(function(e){l.downloadModal=e})},l.showDownloadModal=function(){l.downloadModal||(l.viewingOtherUser=!0,l.pdfData={name:""},m.modal.open({modalId:"DownloadModal",templateUrl:"templates/download.modal.html",scope:l,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){l.downloadModal=e}))},l.downloadCSV=function(e){var t="/app/activity/csv/"+e+".csv?clientId="+l.clientId;window.open(t)},l.downloadPDF=function(){var e=$("input[name='reportWeek']:checked").val(),t="/app/activity/pdf?name="+l.pdfData.name+"&week="+e;t+="&clientId="+l.clientId,window.open(t)},d("NO_ASSESSMENTS_DATA").then(function(e){l.chartConfig.lang.noData=e}),l.chartConfig={chart:{type:"spline",backgroundColor:"#EEE",ignoreHiddenSeries:!1,width:$(".assessment-dropdown").outerWidth()},series:[{data:[],id:"series1",name:"Score",color:"#AAA"}],title:{text:null},lang:{noData:""},noData:{style:{fontWeight:"300",fontFamily:"Helvetica,Arial,sans-serif",color:"rgb(154,154,154)",fontSize:"20px"}},xAxis:{type:"datetime",max:(new Date).getTime(),labels:{enabled:!0,formatter:function(){return moment(this.value).format("MM/DD/YY")},rotation:-40},minRange:6048e5,minTickInterval:864e5,lineWidth:1,tickLength:0,showEmpty:!0},yAxis:{title:{text:null},labels:{enabled:!0},gridLineColor:"transparent",lineWidth:1,tickLength:0,max:80,min:0,minTickInterval:1,showEmpty:!0},legend:{enabled:!1},credits:{enabled:!1},tooltip:{formatter:function(){return'<span style="font-size: 10px">'+moment(this.point.x).format("MMM DD, YYYY h:mm a")+'</span><br/><span style="color:'+this.series.color+'">'+this.series.name+"</span>: <b>"+this.point.y+"</b>"}}},l.startSessionClick=function(){l.canAccessPremiumActivity()?(l.startWebAppointmentNow(l.client),l.dismissToolTip("viewed_start_appointment_now_tooltip")):l.showClinicianPremiumModal()},l.isViewingPersonalAccount=function(){return p.getAccountUser().account.id==+l.clientId},l.canAccessPremiumActivity=function(){return l.isPremiumEnabled()||l.isViewingPersonalAccount()||l.client&&l.client.account.premium},l.checkCanAccessPremiumActivity=function(){return l.canAccessPremiumActivity()||l.showClinicianPremiumModal(),l.canAccessPremiumActivity()},l.setActiveTab=function(e,t){l.activeTab=e,c.search("activeTab",e),"activity"==e&&l.initProgress(t),"chat"==e&&u.clearGroupNotification(l.client.clientGroupId,O)},l.isTabActive=function(e){return l.activeTab==e},l.getClientName=function(){if(l.client)return l.client.account.firstName+" "+l.client.account.lastName},l.getAssessmentById=function(e){return _.find(l.assessments,{id:e})},l.hasClientGroup=function(){return l.client&&!!l.client.clientGroupId},l.createClientGroup=function(){l.canAccessPremiumActivity()?s.createClientGroup(l.clientId).success(function(e){l.client.clientGroupId=e,l.setActiveTab("chat"),window.location.reload()}).error(function(){a.alert({template:d.instant("GENERIC_ERROR"),okText:d.instant("OK_GOT_IT"),okType:"button-default"})}):l.showClinicianPremiumModal()},l.cancelAssessment=function(t){a.confirm({template:d.instant("CANCEL_ASSESSMENT_TEXT"),cancelText:d.instant("NO_CANCEL_ASSESSMENT"),cssClass:"cancel-assessment",cancelType:"button-default",title:d.instant("CANCEL_ASSESSMENT"),okText:d.instant("YES_CANCEL_ASSESSMENT"),okType:"button-default"}).then(function(e){e&&s.cancelAssessmentRequest(t.assessmentId,t.id).success(function(){l.loadAssessmentRequests()})})},l.assessmentHasRequests=function(e){return!!_.find(l.assessmentRequests,{assessmentId:e})},flattenQuestions=function(n){n.questions=[],n.parts.forEach(function(t){t.questions.forEach(function(e){e.instructions=t.instructions,n.questions.push(e)})})},l.downloadAssessmentPDF=function(e){s.downloadPDF(e.assessmentId,e.id).success(function(e){var t=URL.createObjectURL(e);window.open(t)})},l.viewAssessmentResults=function(e){l.selectedResults=e,s.getAssessment(e.assessmentId).success(function(e){l.selectedAssessment=e,flattenQuestions(l.selectedAssessment),m.modal.open({modalId:"ViewAssessmentResultsModal",templateUrl:"templates/practitioner/view-assessment-results.html",scope:l,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){l.viewAssessmentResultsModal=e})})},l.closeViewAssessmentResultsModal=function(){m.modal.close(l.viewAssessmentResultsModal).then(function(e){l.viewAssessmentResultsModal=e})},l.getAnswerText=function(e,t){return _.find(e.options,{id:t})},l.getIntervalDaysDisplay=function(e){return 7==e?"Repeats Weekly":14==e?"Repeats Every 2 Weeks":28==e?"Repeats Every 4 Weeks":void 0},l.loadAssessmentRequests=function(){l.chartConfig.series=[],l.loadingAssessmentRequests=!0,s.getAssessmentRequests(l.client.account.id).success(function(e){l.assessmentRequests=e.requests,l.parseUserAssessments()}).error(function(){console.log("There was an error loading assessment requests."),l.loadingAssessmentRequests=!1})},l.parseUserAssessments=function(){if(l.loadingAssessments&&!l.setupWatch&&l.$watch("assessments",function(e,t){l.setupWatch=!0,0<e.length&&0==t.length&&l.parseUserAssessments()}),!l.loadingAssessments){var c={},u=0;for(var e in l.maxYAxis=0,l.userAssessmentList=[],l.assessmentRequests.forEach(function(e){if(e.requestDate=moment.tz(e.requestDate,p.getUserTimeZone()),i=_.find(l.assessments,{id:e.assessmentId}),-1==l.userAssessmentList.indexOf(i)&&l.userAssessmentList.push(i),e.repeating&&(e.repeatStr=l.getIntervalDaysDisplay(e.intervalDays)),"COMPLETE"==e.userAssessment.status){e.userAssessment.finishedAt=moment.tz(e.userAssessment.finishedAt,p.getUserTimeZone());for(var t=e.userAssessment.scores,n=0;n<t.length;++n){var o=t[n],i=l.getAssessmentById(e.assessmentId),a=i.shortName+" "+d.instant(o.name),r=c[a];r||((r=c[a]={data:[],id:"series1",name:"Score",color:"#AAA"}).color=T[u%T.length],r.name=a,r.id=i.id,1<(u+=1)&&(l.chartConfig.legend.enabled=!0));var s=f(i);s>l.maxYAxis&&(l.maxYAxis=s),r.data.push([e.userAssessment.finishedAt.toDate().getTime(),o.score])}}}),0<l.maxYAxis?l.chartConfig.yAxis.max=l.maxYAxis:l.maxYAxis=80,l.chartConfig.series=[],c){var t=c[e];t.data.sort(function(e,t){return e[0]-t[0]}),l.chartConfig.series.push(t)}l.loadingAssessmentRequests=!1,l.chartConfig.completeSeries=angular.copy(l.chartConfig.series),0==l.chartConfig.completeSeries.length&&(l.chartConfig.completeSeries=h()),l.chartsReady=!0,l.displayedAssessment=null,0<l.userAssessmentList.length?(l.userAssessmentList.unshift({longName:"All Assessments",id:"all"}),l.displayedAssessment=l.userAssessmentList[0]):(l.upcomingRequests=[],l.previousRequests=[]),l.updateAssessmentView()}};var h=function(){return[{name:"hiddenMockData",showInLegend:!1,data:[[+new Date-864e5,50]],visible:!1}]};l.showingAssessmentResultsDropdown=!1,l.showingAssessmentEditDropdown=!1,l.updateAssessmentView=function(){var e=l.assessmentRequests;if(l.displayedAssessment&&"all"!=l.displayedAssessment.id){l.chartConfig.series=[],e=_.filter(l.assessmentRequests,{assessmentId:l.displayedAssessment.id}),l.chartConfig.yAxis.max=f(l.displayedAssessment);_.findIndex(l.chartConfig.completeSeries,{id:l.displayedAssessment.id});l.chartConfig.completeSeries.forEach(function(e){e.id==l.displayedAssessment.id&&l.chartConfig.series.push(e)}),0==l.chartConfig.series.length&&(l.chartConfig.series=h())}else l.chartConfig.yAxis.max=l.maxYAxis,l.chartConfig.series=l.chartConfig.completeSeries;l.upcomingRequests=[],l.previousRequests=[];moment();e.forEach(function(e){"COMPLETE"==e.userAssessment.status?l.previousRequests.push(e):l.upcomingRequests.push(e)}),l.displayedAssessment&&"all"==l.displayedAssessment.id&&(l.upcomingRequests=_.groupBy(l.upcomingRequests,function(e){return e.assessmentId}),l.previousRequests=_.groupBy(l.previousRequests,function(e){return e.assessmentId}));var t=!1;for(var n in l.upcomingRequests)if(!t){var o=_.findIndex(l.upcomingRequests[n],function(e){return e.repeating});-1<o&&(t=!0,l.upcomingRequests[n][o].firstRepeating=!0)}};var T=["#E77D8D","#AB8FBF","#48A3B6","#4BA578","#919640","#C77C4A"];l.activeRoom=null,l.loadingClient=!0,l.showingEditAppointmentDropdown=!1,l.showingEditHomeworkDropdown=!1,l.sortAppointments=function(){l.previousAppointments=[],l.upcomingAppointments=[];var n=moment();l.appointments.forEach(function(e){var t=l.canStartAppointment(e);t||moment(e.finishTime)>n?l.upcomingAppointments.push(e):l.previousAppointments.push(e),t&&"true"==o.startSession&&l.startWebAppointment(e)}),l.upcomingAppointments=_.sortBy(l.upcomingAppointments,"startTime");var t=!1;l.upcomingAppointments.forEach(function(e){!t&&e.repeating&&(e.firstRepeating=!0,t=!0)})};var v=function(e){var t=e.startTime.clone().add(e.intervalDays,"days"),n=s.evaluateException(e,t),o=angular.copy(e);n&&(o.cancelled=!0),o.startTime=t;var i=o.startTime.clone().add(o.duration,"m");return o.finishTime=moment.tz(i,p.getUserTimeZone()),o};function E(){s.getClientGoalContext(l.clientId).success(function(e){l.clientGoals=e.accountGoals,l.clientSubGoals=[],_.each(e.accountSubGoals,function(e){_.each(e,function(e){l.clientSubGoals.push(e)})})})}function I(){E(),s.getClientHabits(l.client).success(function(e){l.clientHabits=e}),l.client.homeworkRequests=g.annotateRequests(l.client.homeworkRequests),l.upcomingHomework=_.filter(l.client.homeworkRequests,function(e){return!e.finishedAt}),l.completedHomework=_.filter(l.client.homeworkRequests,function(e){return null!=e.finishedAt}),l.completedHomework=_.sortBy(l.completedHomework,"finishedAt"),l.completedHomework.reverse(),l.upcomingHomework=_.sortBy(l.upcomingHomework,"requestDate"),l.upcomingHomework.reverse()}l.loadAppointments=function(){l.appointments=[],s.getAppointmentsForClient(l.client.account.id).success(function(e){e.forEach(function(e){e.startTime=moment.tz(e.startTime,p.getUserTimeZone());var t=e.startTime.clone().add(e.duration,"m");if(e.finishTime=moment.tz(t,p.getUserTimeZone()),e.repeating){s.evaluateException(e,e.startTime)||l.appointments.push(e);for(var n=e;n.startTime.diff(moment(),"d")<e.intervalDays;){if((i=v(n)).cancelTime&&i.startTime.isAfter(moment(i.cancelTime)))break;i.cancelled||l.appointments.push(i),(n=i).cancelled=!1}if(!n.cancelTime)for(var o=0;o<3;){var i;(i=v(n)).cancelled||(l.appointments.push(i),o++),(n=i).cancelled=!1}}else l.appointments.push(e)}),l.loadingAppointments=!1,l.sortAppointments()}).error(function(){console.log("There was an error loading appointments."),l.loadingAppointments=!1})},l.openHomeworkModal=function(e){l.isPremiumEnabled()||l.isViewingPersonalAccount()||e&&e.account.premium?m.modal.open({modalId:"HomeworkModal",templateUrl:"templates/practitioner/edit-homework.html",scope:l,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){l.editHomeworkModal=e}):l.showClinicianPremiumModal()},l.getAuxActivity=function(e){return"GOALS"==e.activityCategory?function(e){var t=_.find(l.clientGoals,{id:e.auxiliaryId});if(t)return t.title;var n=_.find(l.clientSubGoals,{id:e.auxiliaryId});return n?n.title:void 0}(e):function(e){var t=_.find(l.clientHabits,{id:e.auxiliaryId});if(t&&t.name)return t.name}(e)},l.getHwCategoryName=function(e){return g.getCategoryName(e)},l.getGenericActivityText=function(e){switch(e.activityCategory){case"THOUGHTS":return d.instant("HW_ANY_THOUGHT");case"GOALS":return d.instant("HW_ANY_GOAL");case"RELAX":return d.instant("HW_ANY_RELAX");case"HABITS":return d.instant("HW_ANY_HEALTH")}},l.cancelHomework=function(n){a.confirm({template:d.instant("CANCEL_HOMEWORK_TEXT"),cancelText:d.instant("NO_CANCEL_ASSESSMENT"),cssClass:"cancel-assessment",cancelType:"button-default",title:d.instant("CANCEL_HOMEWORK"),okText:d.instant("YES_CANCEL_HOMEWORK"),okType:"button-default"}).then(function(e){e&&g.cancelHomework(l.clientId,n.id).success(function(e){var t=_.findIndex(l.upcomingHomework,n);-1<t&&l.upcomingHomework.splice(t,1)}).error(function(e){alert("An error occurred")})})};var y=function(){s.getUser(l.clientId).success(function(e){l.loadingClient=!1,e?(l.client=e,l.$broadcast("event:setClient"),O(),l.loadAssessments(),l.loadAssessmentRequests(),l.loadAppointments(),I(),l.joinDate=moment(l.client.account.createdAt).format("M/D/YYYY"),l.communitiesIneligible=!1,"true"==l.client.communitiesIneligible&&(l.communitiesIneligible=!0),"true"!=o.startSessionNow||l.startedAppt||(l.startedAppt=!0,l.startWebAppointmentNow(l.client))):n.go("practitioner.clients.refresh")}).error(function(){console.log("There was an error loading the user."),n.go("practitioner.clients"),l.loadingClient=!1})};function O(){l.client&&(l.clientNotificationCount=s.clientNotificationCount(l.client))}l.updateCommunitiesSetting=function(){l.updatingCommunities||(l.updatingCommunities=!0,s.disableCommunities(l.client.clientId,l.communitiesIneligible).success(function(e){l.updatingCommunities=!1,l.client.communitiesIneligible=l.communitiesIneligible}).error(function(e){l.communitiesIneligible=l.client.communitiesIneligible,l.updatingCommunities=!1}))},l.changeAssessments=function(e){l.dismissToolTip("viewed_assessment_edit_tooltip"),l.editAssessment(e)},l.changeAppointments=function(e){l.updateAppointment(e,!1,!0),l.dismissToolTip("viewed_recurring_appointments_tooltip")},setPractitionerId=function(){l.practitionerId=p.getAccountUser().practitioner.id},l.isAppReady()?(y(),setPractitionerId()):l.$on("event:pacificaReady",function(){setPractitionerId(),y()}),e.$on("event:homeworkAdded",function(e,t){l.upcomingHomework.unshift(t),t.activityCategory&&"GOALS"==t.activityCategory&&E()}),e.$on("event:appointmentsUpdated",y),e.$on("event:appointmentCancelled",y),e.$on("event:assessmentsUpdated",l.loadAssessmentRequests),l.$watch(function(){return c.path()},function(e,t){newId=e.split("/")[3],oldId=t.split("/")[3],newId!=oldId&&(l.clientId=parseInt(newId),y())},!0)}]),e.controller("ClientsCtrl",["$scope","$rootScope","$controller","$state","$stateParams","$timeout","$translate","$ionicPopup","AccountService","PractitionerService","HabitsService",function(a,e,t,n,o,i,r,s,c,u,l){a.errorMessage=void 0,a.showingSortClientDropdown=!1,a.sortBy="nextAppointment",a.filterBy="active",a.reverseSort=!1,a.showDisconnected=!1,a.filteredClients=[],a.showFilterDropdown=!1,a.deletedContent=[],a.showTooltips=!1,-1<n.current.name.indexOf("refresh")&&location.reload(),u.initAssessmentFunctionality(a),t("VideoChatCtrl",{$scope:a}),a.loadAssessments(),a.filterOptions=["active","inactive","all"];a.getClientNotificationCount=function(e){return u.clientNotificationCount(e)},a.hasDeletedContent=function(e){return-1<a.deletedContent.indexOf(e)},a.shouldShowTooltips=function(){if("inactive"==a.filterBy)return!1;var e=_.findIndex(a.activeClients,{fullName:"Demo Client"});if(-1<e){if(1==a.activeClients.length)return!1;if(2==a.activeClients.length){var t=a.activeClients[e];return a.activeClients.splice(e,1),a.activeClients.unshift(t),!0}}else if(e<0&&1==a.activeClients.length)return!0;return!1},a.deleteAllForClient=function(e){u.deleteAllForClient(e).success(function(){a.deletedContent.push(e),a.refreshClients()})},a.navigateToAppointment=function(e){a.goToClientStartAppointment(e.account.id)},a.toggleShowingSortClientDropdown=function(){a.showingSortClientDropdown=!a.showingSortClientDropdown},a.goToClientStartAppointment=function(e){n.go("practitioner.client.view",{clientId:e,startSession:!0})},a.goToClientStartAppointmentNow=function(e){n.go("practitioner.client.view",{clientId:e,startSessionNow:!0})},a.getFilterByLabel=function(e){switch(e){case"active":return r.instant("YOUR_ACTIVE_CLIENTS");case"inactive":return r.instant("YOUR_INACTIVE_CLIENTS");case"all":return r.instant("YOUR_CLIENTS_ALL")}},a.getFilterCount=function(e){if(a.clients)return"active"==e?a.activeClients.length:"inactive"==e?a.inactiveClients.length:a.clients.length},a.filterClients=function(e){e&&(a.filterBy=e),a.activeClients=_.filter(a.clients,function(e){return"CONNECTED"==e.status||"INVITED"==e.status}),a.inactiveClients=_.filter(a.clients,function(e){return"DISCONNECTED"==e.status}),a.showingClientDropdown=!1,a.sortClients(),a.setupFilterSet()},a.setupFilterSet=function(e){e&&(a.filterBy=e),"active"==a.filterBy?a.filteredClients=a.activeClients:"inactive"==a.filterBy?a.filteredClients=a.inactiveClients:a.filteredClients=a.clients,a.updateClientAssessmentGraph&&a.updateClientAssessmentGraph(a.filteredClients,a.graphAssessment.id)},a.sortClients=function(e){var n,o;e==a.sortBy&&(a.reverseSort=!a.reverseSort),e&&(a.sortBy=e),a.filteredClients.sort(function(e,t){if("nextAppointment"==a.sortBy||"lastActivity"==a.sortBy){if(o="nextAppointment"==a.sortBy?(n=e.nextAppointment?e.nextAppointment.startTime:null,t.nextAppointment?t.nextAppointment.startTime:null):(n=e.lastActivity,t.lastActivity),n&&o)return"nextAppointment"==a.sortBy?moment(n).isBefore(moment(o))?-1:1:moment(n).isAfter(moment(o))?-1:1;if(!n&&o)return 1;if(!o&&n)return-1}else if("lastAssessment"==a.sortBy)return e.lastAssessment&&t.lastAssessment?moment(e.lastAssessment.userAssessment.finishedAt).isBefore(moment(t.lastAssessment.userAssessment.finishedAt))?1:-1:e.lastAssessment?-1:t.lastAssessment?1:0;return e.account.lastName.toLowerCase()<t.account.lastName.toLowerCase()?-1:e.account.lastName.toLowerCase()>t.account.lastName.toLowerCase()?1:e.account.firstName.toLowerCase()<t.account.firstName.toLowerCase()?-1:e.account.firstName.toLowerCase()>t.account.firstName.toLowerCase()?1:0}),a.reverseSort&&a.filteredClients.reverse()},a.resendInviteEmail=function(e){u.resendInvite(e).success(function(){s.alert({template:"<div>Inivitation resent</div>",okText:r.instant("OK_GOT_IT"),okType:"button-default"})})},a.disconnect=function(t){s.confirm({template:"Are you sure you want to remove <strong>"+t.fullName+"</strong>?",cancelText:r.instant("CANCEL"),cancelType:"button-default",okText:r.instant("REMOVE"),okType:"button-default"}).then(function(e){e?u.disconnectClient(t).success(function(){t.status="DISCONNECTED",t.createdAt=(new Date).getTime(),a.refreshClients(d)}).error(function(){}):console.log("You are not sure")})};var d=function(){var t,e;a.filterClients(),a.setupFilterSet(),a.sortClients(),a.showTooltips=a.shouldShowTooltips(),a.hasAppointments=(t=!1,a.clients&&a.clients.forEach(function(e){e.nextAppointment&&(t=!0)}),t),a.uninvitedClient=(e=!1,a.clients&&a.clients.length&&(e="CONNECTED"!=a.clients[a.clients.length-1].status),e),a.chartsReady=a.chartsReady?a.chartsReady+1:1};function p(){c.isLoggedIn()?c.isPractitioner()?(a.showAgreement(),d()):n.go("app.home"):n.go("app.login")}a.isAppReady()?p():a.$on("event:pacificaReady",p),a.getTimeFormatted=function(e){return moment(e).format("M/D")+" at "+moment(e).format("hh:mmA")},a.updateAssessmentView=function(){0<a.graphAssessment.id&&c.setUserPreference("practitioner_last_overview_assessment",a.graphAssessment.id),a.updateClientAssessmentGraph(a.graphAssessment.id)},a.getAssessmentShortName=function(e){if(!a.assessments)return"";var t=_.find(a.assessments,{id:+e});return t?t.shortName:""},a.getAssessmentLongName=function(e){if(!a.assessments)return"";var t=_.find(a.assessments,{id:+e});return t?t.longName:""},a.getDisplayedAssessmentShortName=function(){return 0<a.graphAssessment.id?a.getAssessmentShortName(a.graphAssessment.id):""},a.getLastAssessmentName=function(e){var t=e.lastAssessment;if(t)return a.getAssessmentShortName(t.assessmentId)},a.getLastMoodDisplay=function(e){var t=e.moodData;if(t&&0<t.length){var n=t[t.length-1];return l.getHabitDisplayFromData(n)}},a.getLastMoodClass=function(e){var t=e.moodData;if(t&&0<t.length){var n=t[t.length-1];return l.getMoodClassFromData(n)}},a.getDateDisplay=function(e){var t=moment().startOf("day"),n=moment().subtract(1,"days").startOf("day"),o=moment().add(1,"days").startOf("day"),i=moment().add(7,"days").startOf("day");return moment(e).isSame(n,"d")?"Yesterday, "+a.getTimeFormatted(e):moment(e).isSame(t,"d")?"Today, "+a.getTimeFormatted(e):moment(e).isSame(o,"d")?"Tomorrow, "+a.getTimeFormatted(e):moment(e)<n||moment(e)>i?a.getTimeFormatted(e):moment(e).format("dddd")+", "+a.getTimeFormatted(e)},a.$watch("clients",function(){d()}),e.$on("event:clientsLoaded",function(){d()})}])}(),angular.module("findClientsCtrl",[]).controller("FindClientsCtrl",["$scope","AccountService","$translate","$sce","PractitionerService","$controller","$rootScope","$stateParams",function(s,t,n,o,i,e,a,c){function r(){s.directoryVisibleMsg=o.trustAsHtml(n.instant("DIRECTORY_VISIBLE_MESSAGE")),s.directoryHiddenMsg=o.trustAsHtml(n.instant("DIRECTORY_HIDDEN_MESSAGE")),s.accountUser=t.getAccountUser(),s.accountUser.practitioner&&s.accountUser.user&&(s.isPractitioner()||$state.go("app.home")),u(),s.findNewClientsRibbon=o.trustAsHtml(n.instant("FIND_NEW_CLIENTS_RIBBON")),i.getAppointments(new Date(2015,1,1),new Date(2020,1,1)).success(function(e){var n,o,t=_.sortBy(_.filter(e,function(e){return"CONSULTATION"==e.appointmentType&&e.clientId}),"startTime");t.reverse(),s.pastConsultations=[],s.futureConsultations=[],t.forEach(function(e){var t=moment(e.startTime).add(e.duration,"m");t.isBefore(moment())?s.pastConsultations.push(e):s.futureConsultations.push(e)}),s.futureConsultations=_.sortBy(s.futureConsultations,"startTime"),s.pastConsultations=_.sortBy(s.pastConsultations,"startTime").reverse(),s.pastConsultations.forEach(function(t){-1==(n=_.findIndex(s.clients,function(e){return t.clientId==e.clientId}))&&(n=_.findIndex(s.clients,function(e){return t.email==e.account.email&&"INVITED"==e.status})),-1<n&&(o=s.clients[n],t.clientStatus=o.status.charAt(0)+o.status.toLowerCase().slice(1))});var i,a,r=c.startSession;r&&(i=r,(a=_.find(s.futureConsultations,function(e){return e.id==i}))&&s.canStartAppointment(a)&&s.startWebAppointment(a))}),i.clearConsultationNotifications()}function u(){var e="";e=s.accountUser.practitioner.publicDirectory?n.instant("FIND_CLIENTS_VISIBLE"):s.accountUser.practitioner.pendingApproval?n.instant("PENDING_APPROVAL"):n.instant("DIRECTORY_HIDDEN_MESSAGE"),s.directoryStatusText=o.trustAsHtml(e)}e("VideoChatCtrl",{$scope:s}),s.showClientTooltip=!1,s.updateClientTooltipVisibility=function(e){s.showClientTooltip=e},s.addClientPrefilled=function(e){s.newClient({firstName:e.firstName,lastName:e.lastName,email:e.email})},s.updateListingVisibility=function(e){i.updateDirectoryVisibility(e).success(function(e){s.accountUser=t.getAccountUser(),u()}).error(function(e){console.log(e)})},s.isAppReady()?r():s.$on("event:pacificaReady",r),a.$on("event:appointmentCancelled",function(e,t){var n,o;n=t.appointment,-1<(o=_.findIndex(s.futureConsultations,function(e){return e.id==n.id}))&&s.futureConsultations.splice(o)})}]),angular.module("homeworkModalCtrl",[]).controller("HomeworkModalCtrl",["$scope","AccountService","PractitionerService","$translate","HomeworkService","GoalsService","ActivityService",function(c,e,u,t,l,n,o){function i(e,n){var t=[];return"thoughts"!=n&&"relax"!=n||(t=_.filter(o.activities,function(e){var t=!_.has(e,"displayKey");return"goals"!=e.type&&!t&&!e.excludeFromHw&&e.type==n})),"habits"==n&&u.getClientHabits(c.client).success(function(e){_.each(e,function(e){1!=e.id&&t.push({title:e.name,habitId:e.id,type:"habits"})})}),"relax"==n&&t.unshift({displayKey:"ANY_MEDITATION"}),"thoughts"==n&&t.unshift({activityDisplay:"ANY_THOUGHT_ENTRY"}),"habits"==n&&t.unshift({title:"Any Health Habit"}),t}c.homework={reminder:"0",reminderDate:moment().add(1,"d")},c.showSuggestions=!1,t(["MEDITATION","THOUGHT_ENTRY","HEALTH_HABIT","GOAL"]).then(function(e){c.homeworkTypeOptions=[{id:1,type:"meditation",label:e.MEDITATION},{id:2,type:"thought",label:e.THOUGHT_ENTRY},{id:3,type:"health",label:e.HEALTH_HABIT},{id:4,type:"goal",label:e.GOAL}],c.homework.type=c.homeworkTypeOptions[0]}),c.toggleShowSuggestions=function(e){c.showSuggestions=e},c.goalCategories=n.getCategoryOrder(),c.subGoalKeys=n.getSubGoalKeys(),c.selectGoal=function(e){c.homework.newSubGoal=t.instant(e)},c.toggleReminder=function(e){c.homework.reminder="1"==c.homework.reminder?"0":"1",c.$$phase||c.$apply()},c.getReminderDateTz=function(e){return moment(e).zoneAbbr()},c.getConfirmationDateDisplay=function(e){return moment(e).format("h:mm zz on MMMM D, YYYY")},c.relaxActivities=i(c.client,"relax"),c.thoughtActivities=i(c.client,"thoughts"),c.healthActivities=i(c.client,"habits"),c.homework.exercise=c.relaxActivities[0],c.$watch("homework.type",function(e,t){"meditation"==e.type&&(c.homework.exercise=c.relaxActivities[0]),"thought"==e.type&&(c.homework.exercise=c.thoughtActivities[0]),"health"==e.type&&(c.homework.exercise=c.healthActivities[0])}),c.getSelectedActivityId=function(e){try{if(e.exercise.id)return e.exercise.id;var t=e.exercise.activity;return o.activities[t].id}catch(e){return""}},c.getHomeworkScreenshot=function(e){return l.getHomeworkScreenshot(e)},c.getDescriptionKey=function(e){var t=e.exercise.displayKey,n=e.type.type,o="thought"===n&&"ANY_THOUGHT_ENTRY"!=t;return"RELAX_VISUALIZE_HELP_TITLE"===t?"RELAX_ACTIVITY_VISUALIZATION_DESCRIPTION":"UNGUIDED_MEDITATION_DISPLAY"===t?"RELAX_ACTIVITY_SOUNDSCAPE_MODE_DESCRIPTION":"meditation"===n&&"ANY_MEDITATION"!=t?e.exercise.displayKey+"_DESCRIPTION":o?e.exercise.descriptionDisplayKey:"health"===n?"Your client will be prompted to track this health habit within the Pacifica mobile app.":"goal"===n?"Your client will be prompted to completed this goal within the Pacifica mobile app.":void 0},c.closeHomeworkModal=function(){c.closeEditHomeworkModal(),c.showHomeworkConfirmationText=!1},c.saveHomework=function(e){var t,n,o,i=c.getSelectedActivityId(e),a=c.client.clientId,r="goal"==(t=e.type.type)?"goals":"health"==t?"habits":"meditation"==t?"relax":"thought"==t?"thoughts":void 0,s=e.newSubGoal;"1"==e.reminder&&(n=e.reminderDate),"health"===e.type.type&&e.exercise.habitId&&(o=e.exercise.habitId),u.saveHomeworkInternal(a,r,i,o,s,n).success(function(e){l.addRequest(e),c.showHomeworkConfirmationText=!0}).error(function(){console.log("failed to save homework assignment")})}}]),function(){var e=angular.module("scheduleCtrl",[]);e.directive("onFinishRender",["$timeout",function(o){return{restrict:"A",link:function(e,t,n){!0===e.$last&&o(function(){e.$emit(n.onFinishRender)})}}}]),e.controller("ScheduleCtrl",["$scope","$state","$timeout","$translate","$sce","$ionicModal","$ionicPopup","AccountService","PractitionerService","GeneralService","uiCalendarConfig","$rootScope",function(r,t,n,o,a,e,s,c,u,d,l,p){r.events=[],r.appointmentsLoaded=!1,r.calendarLoaded=!1;function g(e,t,n){e.beginPath(),e.moveTo(t.x,t.y),e.lineTo(n.x,n.y),e.strokeStyle="black",e.stroke()}r.$on("ngRepeatFinished",function(e){r.clients.forEach(function(e){var t=document.getElementById(e.clientId.toString()),n=t.getContext("2d");n.fillStyle="rgba(255, 255, 255, 1)",n.fillRect(0,0,t.width,t.height);for(var o,i=(new Date).getTime(),a=[],r=0;r<e.habitData.length;++r){var s=e.habitData[r],c=new Date(s.experiencedAtStr),u=d.COLORS[7-s.valueInt],l={x:t.width*((i-c.getTime())/6048e5),y:.1*t.height+.8*t.height*(7-s.valueInt)/6,amount:5,color:u};a.push(l),o&&g(n,l,o),o=l}o&&g(n,o,{x:0,y:t.height/2}),a.forEach(function(e){!function(e,t){e.beginPath(),e.arc(t.x,t.y,t.amount,0,2*Math.PI,!1);var n=hexToRgb(t.color),o="rgb("+n.r+","+n.g+","+n.b+")";e.fillStyle=o,e.fill(),e.lineWidth=1,e.strokeStyle="#666666",e.stroke()}(n,e)})})}),r.getBaaTitle=function(){var e=o.instant("PLEASE_SIGN_BAA");return a.trustAsHtml(e)};var m=function(e){var t=[e.appointmentType.toLowerCase()],n=e.startTime.clone().add(e.duration,"m");n.isAfter(moment())||t.push("old-event");var o=e.firstName+" "+e.lastName;return"CONSULTATION"!=e.appointmentType||e.clientId||(o="Open Consultation"),{start:e.startTime,end:n,title:o,appointment:e,className:t,stick:!0}},f=function(e){return e.isAfter(r.calendarStart)&&e.isBefore(r.calendarEnd)},h=function(t,n){var e=-1;if(r.events.length)e=_.findIndex(r.events,function(e){return n?e.appointment.id==t.appointment.id&&e.start.isSame(t.start):e.appointment.id==t.appointment.id});return e};function T(e,t){return!!e.clientId||!!t.clone().add(e.duration,"m").isAfter(moment())}r.loadAppointments=function(){u.getAppointments(new Date(2015,1,1),new Date(2020,1,1)).success(function(e){r.appointments=[],e.forEach(function(e){if(e.startTime=moment.tz(e.startTime,c.getUserTimeZone()),e.end=moment.tz(e.startTime.clone().add(e.duration,"m"),c.getUserTimeZone()),r.calendarStart||(r.calendarStart=moment().startOf("week"),r.calendarEnd=moment().endOf("week")),e.repeating){var t=u.getFirstRecurringInstance(e,r.calendarStart);for(t.isSame(e.startTime)||r.appointments.push(e),f(t)||(r.appointments.push(e),t=t.clone().add(e.intervalDays,"d"));f(t)&&(!e.cancelTime||!t.isAfter(e.cancelTime));){var n=u.evaluateException(e,t),o=angular.copy(e);"CONSULTATION"!==e.appointmentType&&!n||"CONSULTATION"==e.appointmentType&&T(e,t)&&!n?(o.startTime=t,o.end=t.clone().add(e.duration,"m"),item=m(o),-1==(i=h(item,!0))&&(r.events.push(item),r.appointments.push(o))):t.isSame(e.startTime)&&r.appointments.push(e),t=t.clone().add(e.intervalDays,"d")}}else{var i;if("CONSULTATION"!=e.appointmentType||"CONSULTATION"==e.appointmentType&&T(e,e.startTime))item=m(e),-1==(i=h(item,!1))?(r.events.push(item),r.appointments.push(e)):r.events[i]=item}}),r.eventSources=[r.events],r.appointmentsLoaded=!0,r.initialLoad=!1}).error(function(){console.log("an error occurred retrieving appointments")})},r.clickToJoin=function(e){null!=r.editAppointmentModal&&r.closeEditAppointmentModal(),r.goToClient(e)};var v=function(e,t,n){e.end.isAfter(moment())&&("CONSULTATION"==e.appointment.appointmentType&&e.appointment.clientId?r.showConsultConfirmation(e.appointment):r.updateAppointment(e.appointment,e.appointment.repeating))},E=function(e,t,n,o){if(0!=r.clients.length){e=moment.tz(e,c.getUserTimeZone());var i=moment.utc(),a=moment.tz.zone(c.getUserTimeZone()).offset(i);e.add(a,"m"),e.isAfter(moment())&&(r.newAppointment(),r.editAppointment.startTime=e,r.editAppointment.startDate=e)}},I=function(){if(l.calendars.hasOwnProperty("mainCalendar")){r.calendarLoaded=!0;var e=l.calendars.mainCalendar.fullCalendar("getView");e.hasOwnProperty("start")&&(r.calendarStart=e.start,r.calendarEnd=e.end),r.appointments.forEach(function(t){if(t.repeating)for(var n=u.getFirstRecurringInstance(t,r.calendarStart);f(n)&&(!t.endTime||!n.isAfter(t.cancelTime));){var e=u.evaluateException(t,n),o=_.find(r.appointments,function(e){return 0==e.startTime.diff(n)&&e.id==t.id});if(!_.find(r.events,function(e){return 0==e.appointment.startTime.diff(n)&&e.appointment.id==t.id})&&!e&&("CONSULTATION"!=t.appointmentType||"CONSULTATION"==t.appointmentType&&T(t,n))){var i=angular.copy(t);i.startTime=n,i.end=n.clone().add(t.duration,"m"),item=m(i),r.events.push(item),o||r.appointments.push(i)}n=n.clone().add(t.intervalDays,"d")}else _.find(r.events,function(e){return 0==e.appointment.startTime.diff(t.startTime)&&e.appointment.id==t.id})||(item=m(t),r.events.push(item))})}n(function(){$(".fc-scroller").scrollTop(305)},0)};function y(){var e;c.isLoggedIn()?c.isPractitioner()?(r.initialLoad=!0,r.practitionerUserId=c.getAccountUser().user.id,e=c.getLocale(),r.uiConfig={calendar:{locale:e,defaultView:"agendaWeek",allDaySlot:!1,height:$(window).height()-240,editable:!0,selectable:!0,header:{left:"prev agendaWeek month next",center:"title",right:""},eventClick:v,select:E,eventBackgroundColor:"rgb(76,151,22)",eventBorderColor:"#67ca9e",eventTextColor:"#fff",timeFormat:"h(:mm)t",eventStartEditable:!1,viewRender:I,eventDurationEditable:!1,eventAfterAllRender:function(e){$(".fc-scroller").css("overflow-y","scroll")}}},r.loadAppointments()):t.go("app.home"):t.go("app.login")}var O=function(n){var e=_.findIndex(r.appointments,function(e){return n.exceptionTime?e.id==n.id&&e.startTime.isSame(n.exceptionTime):e.id==n.id&&e.startTime.isSame(n.startTime)});-1<e&&r.appointments.splice(e,1),n.exceptionTime&&r.appointments.forEach(function(e,t){e.id==n.id&&e.exceptions.push(n)})};p.$on("event:appointmentsUpdated",r.loadAppointments),p.$on("event:appointmentCancelled",function(e,t){var n,o;t.hasOwnProperty("repeating")&&1==t.repeating?function(n){var o=[];for(r.events.forEach(function(e,t){e.appointment.id==n.id&&o.push(t)}),i=0;i<o.length;i++)delete r.events[o[i]];O(n)}(t.appointment):(n=t.appointment,-1<(o=_.findIndex(r.events,function(e){return n.exceptionTime?e.appointment.id==n.id&&e.appointment.startTime.isSame(n.exceptionTime):e.appointment.id==n.id&&e.appointment.startTime.isSame(n.startTime)}))&&r.events.splice(o,1),O(n)),null!=r.consultConfirmModal&&r.closeConsultConfirmModal()}),r.isAppReady()?y():r.$on("event:pacificaReady",function(){y()})}])}(),angular.module("tutorialsCtrl",[]).controller("TutorialsCtrl",["$scope","$state","$timeout","$ionicModal","AccountService","PractitionerService","GeneralService",function(e,t,n,o,i,a,r){}]),angular.module("videochat",[]).controller("VideoChatCtrl",["$rootScope","$scope","$translate","$ionicPopup","AccountService","PractitionerService","$state","$location",function(t,o,i,a,r,s,c,e){var n;function u(t,n){Twilio.Video.createLocalVideoTrack().then(function(e){o.videoTrack=e,t&&t.addTrack(e),o.$apply(function(){o.localTracks.push(e)}),Twilio.Video.createLocalAudioTrack().then(function(e){o.audioTrack=e,t&&t.addTrack(e),o.$apply(function(){o.localTracks.push(e),n&&n()})},function(e){console.error("Unable to access local audio",e)})},function(e){console.error("Unable to access local video",e)})}function l(){for(var e;e=o.localTracks.pop();)"audio"==e.kind?o.audioTrack=void 0:o.videoTrack=void 0,e.stop(),e.detach()}o.remoteParticipants={},o.clientConnected=!1,o.localTracks=[],o.activeRoom=void 0,o.videoTrack=void 0,o.audioTrack=void 0,o.fullscreen=!1,o.dragOptions={container:"draggable-area"},o.hasRemoteParticipant=function(){for(var e in o.remoteParticipants)return!0;return!1},o.previewCamera=function(){0==o.localTracks.length?u():l()},o.toggleCamera=function(e){o.videoTrack&&o.videoTrack.enable(e)},o.toggleAudio=function(e){o.audioTrack&&o.audioTrack.enable(e)};var d=function(){return confirmationMessage=i.instant("LEAVE_SESSION_WARNING"),event.returnValue=confirmationMessage,confirmationMessage};function p(){o.activeRoom&&(o.activeRoom.disconnect(),o.activeRoom=void 0,o.activeAppointment=void 0,o.setShowSidebar(!0),e.search("startSession",null),e.search("startSessionNow",null),o.restartLogoutTimer(),window.removeEventListener("beforeunload",d))}o.leaveSession=function(){o.activeRoom&&a.confirm({template:"<div>"+i.instant("LEAVE_SESSION_WARNING")+"</div>",cancelText:i.instant("CANCEL"),cancelType:"button-default",okText:i.instant("LEAVE"),okType:"button-default"}).then(function(e){e&&p()})};var g=t.$on("$stateChangeStart",function(e,t,n){o.activeRoom&&(e.preventDefault(),a.confirm({template:"<div>"+i.instant("LEAVE_SESSION_WARNING")+"</div>",cancelText:i.instant("CANCEL"),cancelType:"button-default",okText:i.instant("LEAVE"),okType:"button-default"}).then(function(e){e&&(p(),c.go(t.name,n))}))});function m(e){(o.activeRoom=e).participants.forEach(function(n){o.$apply(function(){console.log("Already in Room: '"+n.identity+"'"),o.remoteParticipants[n.sid]=[],n.tracks.forEach(function(e,t){o.$apply(function(){o.remoteParticipants[n.sid].push(e)})})})}),e.on("participantConnected",function(e){o.$apply(function(){console.log('Participant "'+e.identity+'" connected')})}),e.on("trackAdded",function(e,n){o.remoteParticipants[n.sid]=[],n.tracks.forEach(function(e,t){o.$apply(function(){o.remoteParticipants[n.sid].push(e)})})}),e.on("trackRemoved",function(e,n){o.remoteParticipants[n.sid]=[],n.tracks.forEach(function(e,t){o.remoteParticipants[n.sid].push(e)})}),e.on("participantDisconnected",function(e){o.$apply(function(){delete o.remoteParticipants[e.sid]})}),e.on("disconnected",function(){console.log("Left"),o.clientConnected=!1,e.participants.forEach(function(e){delete o.remoteParticipants[e.sid]}),l(),o.activeRoom=void 0}),o.$$phase||o.$apply()}o.$on("$destroy",function(){g&&g(),p()}),o.activateSession=function(){if(o.activeAppointment)return o.cancelLogoutTimer(),r.getVideoToken().success(function(e){function t(){var e={name:o.activeAppointment.roomId,logLevel:"info"};window.addEventListener("beforeunload",d),o.localTracks&&(e.tracks=o.localTracks),Twilio.Video.connect(n,e).then(m,function(e){console.error("Could not connect to Twilio: "+e.message)}),o.$$phase||o.$apply()}console.info("Token Retrieved: "+e.token),n=e.token,0==o.localTracks.length?u(void 0,t):t()})},o.activateSession(),o.startWebAppointmentNow=function(e){if(o.checkWebRTCSupport()){e&&o.clients&&(o.client=_.find(o.clients,{id:e.id}));var n=null;o.appointments&&o.appointments.forEach(function(e){var t=e.startTime.clone().add(e.duration,"m");e.startTime.isSame(moment(),"day")&&t.isAfter(moment())&&(n=e)}),null==n?a.confirm({title:i.instant("START_SESSION"),template:i.instant("START_NEW_SESSION_TEXT"),cssClass:"cancel-assessment",okText:i.instant("YES"),okType:"button-default",cancelText:i.instant("CANCEL_LOWER"),cancelType:"button-default"}).then(function(e){e&&s.newAppointment({practitionerId:r.getAccountUser().practitioner.id,clientId:o.client.account.id,description:"Unscheduled Session",startTime:moment(),duration:50,appointmentType:"TELETHERAPY",intervalDays:0}).success(function(e){e.startTime=moment.tz(e.startTime,r.getUserTimeZone()),e.endTime=moment.tz(e.startTime.clone().add(e.duration,"m"),r.getUserTimeZone()),t.$broadcast("event:appointmentsUpdated"),o.startWebAppointment(e)}).error(function(e){e.message&&a.alert({title:i.instant("START_SESSION_ERROR"),template:e.message,okText:i.instant("DISMISS"),okType:"button-default"})})}):o.startWebAppointment(n)}},o.startWebAppointment=function(e){o.checkWebRTCSupport()&&(o.activeRoom||(o.activeAppointment=e,o.activateSession(),o.setShowSidebar(!1)))}}]),angular.module("abstractGroupPostsCtrl",[]).controller("AbstractGroupPostsCtrl",["$scope","$state","$sce","$timeout","$analytics","$translate","$ionicModal","$ionicScrollDelegate","$ionicActionSheet","AccountService","HabitsService","GoalsService","AudioService","GroupsService","GeneralService","Environment","OverlayService","SkillsService","$rootScope","ActivityService",function(m,n,r,f,o,h,e,i,t,a,s,c,u,T,l,d,v,E,I,p){m.showingMenu=void 0,m.showingMore={};function g(e){return e.lastIndexOf(".")==e.length-1?e+"..":e+"..."}m.userVotes={},m.userCommentVotes={},m.sharingData={},m.groupPostData={postText:""},m.communityPostData={postText:""},m.reportPostData={postText:""},m.isOwnerById=function(e){return T.getGroupImmediate(e).creatorId==a.getAccountUser().user.id},m.isOwner=function(e){return e&&e.creatorId==a.getAccountUser().user.id},m.isGroupOwner=function(e){return e.creatorId==a.getAccountUser().user.id},m.hasUserNickname=function(){return m.getUserNickname()&&0<m.getUserNickname().length},m.getUserNickname=function(){return a.getAccountUser().user.publicName},m.hasPostNotification=function(e){return T.hasPostNotification(e)},m.hasGroupNotification=function(e){return T.hasGroupNotification(e)},m.getGroupNotificationCount=function(e){return T.getGroupNotificationCount(e)},m.checkOfflineMode=function(){if(d.isOnline())return!1;v.popup.alert({template:h.instant("GROUPS_OFFLINE_ERROR"),okText:h.instant("OK_GOT_IT"),okType:"button-default"});return!0},m.getPostCreatorNickname=function(e){if(e)return e.creatorNickname?e.creatorNickname:"["+h.instant("DELETED")+"]"},m.getPostAvatar=function(e){return a.getPostAvatar(e)},m.getPostDate=function(e){if(e){if(e.momentDate)return e.momentDate;var t="object"==typeof e.createdAt?e.createdAt:new Date(e.createdAt);return e.momentDate=moment(t).calendar(),e.momentDate}};var y={formatHref:function(e,t){return e},target:function(e){return null},linkAttributes:{onClick:"event.stopPropagation(); event.preventDefault(); window.open(event.target.href, '_blank', 'location=no');"},events:{click:function(e){e.preventDefault(),e.stopPropagation()}}};function O(e){var t=m.groupPostData.postText.trim();t&&0!==t.length&&t!=h.instant("DEFAULT_MOOD_SHARE_TEXT")&&t!=h.instant("DEFAULT_THOUGHT_SHARE_TEXT")&&t!=h.instant("DEFAULT_EXPERIMENT_SHARE_TEXT")||(m.groupPostData.postText=e)}function S(e,t,n){if(e.recordings&&e.recordings[t])return e.recordings[t][n]}function A(){v.popup.alert({template:h.instant("MISSING_EXPERIMENT_DATA_ERROR"),okText:h.instant("OK_GOT_IT"),okType:"button-default"})}function C(){var e;e=m.mobile?"views/groups/communities.createPost.modal.html":"templates/community/community.createPost.modal.html",v.modal.open({modalId:"CreatePostModal",templateUrl:e,scope:m,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){m.createCommunityPostModal=e})}m.getPostTitle=function(e,t,n){var o=e.title,i=!1;if(m.group&&(i="COMMUNITY"!=m.group.groupType),m.showingMore[e.id]||i||!m.canShowMore(e)||t)return e.linkifiedTitle||(e.linkifiedTitle=linkifyStr(o,y)),n?e.linkifiedTitle:r.trustAsHtml(e.linkifiedTitle);if(e.truncatedTitle)return n?e.truncatedTitle:r.trustAsHtml(e.truncatedTitle);var a=o.substring(140).indexOf(" ");return e.truncatedTitle=0<=a?linkifyStr(g(o.substring(0,140+a)),y):linkifyStr(g(o.substring(0,140)),y),n?e.truncatedTitle:r.trustAsHtml(e.truncatedTitle)},m.canShowMore=function(e){var t=e.title;return void 0===m.showingMore[e.id]&&140<t.length},m.showMore=function(e){if(m.showSocialTooltip=!1,m.mobile||(m.previousScrollPosition=$(window).scrollTop()),m.group&&"GROUP"==m.group.groupType)m.canShowMore(e)?m.showingMore[e.id]=e.id:delete m.showingMore[e.id],i.resize();else{var t={postId:void 0===e.groupPostId?(T.storeCachedPost(e,m.postDataObjects?m.postDataObjects[e.id]:void 0,m.userVotes),e.id):e.groupPostId,order:"date"};0<=n.$current.name.indexOf("app.groups")?n.go("app.groups-post-comments",t):m.mobile?n.go("app.communities-post-comments",t):(m.postId=t.postId,v.modal.open({modalId:"PostCommentsModal",templateUrl:"templates/community/community.post.comments.modal.html",scope:m,data:t,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){m.postCommentsModal=e}))}},m.closePostCommentsModal=function(){v.modal.close(m.postCommentsModal).then(function(e){m.postCommentsModal=e,!m.mobile&&m.previousScrollPosition&&($(window).scrollTop(m.previousScrollPosition),m.previousScrollPosition=void 0)})},m.hasVote=function(e){if(!e)return!1;if("comments"==m.activeTab)return m.hasCommentVote(e);var t=m.userVotes[e.id];return t&&t.up||e.creatorId==a.getAccountUser().user.id},m.removeVote=function(e,t){if(e.stopPropagation(),e.preventDefault(),"comments"==m.activeTab)m.removeCommentVote(e,t);else{if(m.isPostOwner(t)){v.popup.alert({template:h.instant("REMOVE_OWNED_POST_VOTE_ERROR"),okText:h.instant("OK_GOT_IT"),okType:"button-default"});return}delete m.userVotes[t.id],--t.ups,--t.score,T.removeVote(t)}},m.addUserVotes=function(e){for(var t=0;t<e.length;++t){var n=e[t];m.userVotes[n.postId]=n}},m.createVoteObject=function(e){m.userVotes[e.id]={postId:e.id,groupId:m.group?m.group.id:e.groupId,up:!0,recordedAt:new Date}},m.voteUp=function(e,t){e.stopPropagation(),e.preventDefault(),"comments"==m.activeTab?m.voteCommentUp(e,t):(++t.ups,++t.score,m.createVoteObject(t),T.voteUp(t.id,m.group?m.group.id:t.groupId))},m.addUserCommentVotes=function(e){for(var t=0;t<e.length;++t){var n=e[t];m.userCommentVotes[n.postCommentId]=n}},m.createCommentVoteObject=function(e){m.userCommentVotes[e.id]={postId:e.id,groupId:m.group?m.group.id:e.groupId,up:!0,recordedAt:new Date}},m.hasCommentVote=function(e){var t=m.userCommentVotes[e.id];return t&&t.up||e.creatorId==a.getAccountUser().user.id},m.voteCommentUp=function(e,t){e.stopPropagation(),e.preventDefault(),++t.ups,++t.score,m.createCommentVoteObject(t),T.voteCommentUp(t.id,t.groupPostId,t.groupId)},m.removeCommentVote=function(e,t){if(e.stopPropagation(),e.preventDefault(),m.isPostOwner(t))v.popup.alert({template:h.instant("REMOVE_OWNED_POST_VOTE_ERROR"),okText:h.instant("OK_GOT_IT"),okType:"button-default"});else delete m.userCommentVotes[t.id],--t.ups,--t.score,T.removeCommentVote(t)},m.viewUserProfile=function(e,t){e.stopPropagation(),e.preventDefault(),t.creatorNickname&&n.go("app.community-profile",{userId:t.creatorId,nickname:t.creatorNickname})},m.closeReportModal=function(){v.modal.close(m.reportModal).then(function(e){m.reportModal=e,m.reportPostData.postText=""})},m.reportPost=function(){var e=m.reportPostData.postText.trim();if(e&&0!==e.length){var t=m.referUserData.referUser;m.reportError=void 0,T.reportPost(m.reportingPostId,e,!!t).success(function(){m.closeReportModal(),m.removePostById&&m.removePostById(m.reportingPostId),f(function(){v.popup.alert({template:h.instant("REPORT_POST_CONFIRM"),okText:h.instant("OK_GOT_IT"),okType:"button-default"})},500)}).error(function(){v.popup.alert({template:h.instant("REPORT_POST_ERROR"),okText:h.instant("OK_GOT_IT"),okType:"button-default"})})}else m.reportError=h.instant("REPORT_POST_TEXT_ERROR")},m.showReportPost=function(t,n){var e;(t.stopPropagation(),t.preventDefault(),m.reportingComment=!1,a.getAccountUser().user.banned)?v.popup.alert({template:h.instant("BANNED_USER_ERROR"),okText:h.instant("OK_GOT_IT"),okType:"button-default"}):m.isUserEmailValidated()?(m.reportingPostId=n.id,m.reportPostData.postText="",m.referUserData={referUser:!1},e=m.mobile?"views/groups/groups.report.modal.html":"templates/groups/groups.report.modal.html",m.reportModal||v.modal.open({modalId:"ReportModal",templateUrl:e,scope:m,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){m.reportModal=e})):m.checkRemoteEmailValidation(function(e){e&&m.showReportPost(t,n)})},m.closeSubGoalModal=function(){v.modal.close(m.goalModal).then(function(e){m.goalModal=e})},m.clearSubGoal=function(){m.viewData.subGoal=""},m.updateGoalOption=function(){m.goalForSubGoal=m.goalOptions.goals[m.goalOptions.goalOptionOrdinal],m.valueData&&m.valueData.redraw&&++m.valueData.redraw},m.getGoalOptionDisplay=function(e){return e.title},m.saveSubGoal=function(){"?"!=m.valueData.value?(m.noDataError=!1,v.loading.show(h.instant("EXPERIMENTS_SETTING_EXPERIMENT")+"..."),c.addSubGoal(m.goalForSubGoal.id,m.viewData.subGoal,l.getTodayString(),m.difficultyValues[m.valueData.valueIndex].valueInt).success(function(){m.closeSubGoalModal(),v.loading.hide()}).error(function(){m.closeSubGoalModal(),v.loading.hide()}),o.eventTrack("addSubGoal",{category:"groups"})):m.noDataError=!0},m.allDifficultyColors=["#60d293","#5fe9c4","#5bdddf","#58caf6","#66edff","#ffe566","#ffbe66","#ff9b73","#ef7d7d","#ff6669"],m.$watch("valueData.valueIndex",function(){if(m.valueData){var e=m.valueData.valueIndex;m.lastValueIndex!=e&&(m.difficultyColors[1]=m.allDifficultyColors[e])}}),m.addExperiment=function(e,t){e.stopPropagation(),e.preventDefault();var n=m.getExperiment(t);m.goalOptions={goals:c.getAccountGoals(),goalOptionOrdinal:0},m.updateGoalOption(),m.viewData={subGoal:n.title,error:!1,submitting:!1},m.colorPercentages=[0,1],m.difficultyColors=["#c8c8c8",l.getColor("green"),"#c8c8c8"],m.difficultyValues=[10];for(var o=0;o<10;++o)m.difficultyValues[o]=createValue(o,o+1);m.valueData={value:"?",valueIndex:0,percentage:0,redraw:0},m.getSpinnerDifficulty=function(){if(m.valueData)return m.difficultyValues[m.valueData.valueIndex].valueInt},v.modal.open({modalId:"GoalModal",templateUrl:"views/goals/goals.addCommunitySubGoal.modal.html",scope:m,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){m.goalModal=e})},m.showAddExperiment=function(e){if(m.isPostOwner(e))return!1;var t=m.getExperiment(e);return t&&t.title},m.savePost=function(e,o){e.preventDefault(),e.stopPropagation(),v.popup.confirm({template:"<div>"+h.instant("SAVE_POST_TO_FEED_CONFIRM")+"</div>",cancelText:h.instant("CANCEL"),cancelType:"button-default",okText:h.instant("SAVE"),okType:"button-default"}).then(function(e){if(e){var t=a.getAccountUser().user.personalGroupId,n=T.getCachedPostData(o.id);T.createGroupPost(t,o.title,n).success(function(e){p.recordActivity("ADD_POST_TO_HOPE_FEED"),m.mobile?l.showToast(h.instant("POST_TO_PERSONAL_FEED_SUCCESS"),!0,"bottom"):v.popup.alert({template:h.instant("POST_TO_PERSONAL_FEED_SUCCESS"),okText:h.instant("OK_GOT_IT"),okType:"button-default"})}).error(function(){v.popup.alert({template:h.instant("CREATE_POST_ERROR"),okText:h.instant("OK_GOT_IT"),okType:"button-default"})})}})},m.sharePost=function(e,t){var n;console.log("post",t),o.eventTrack("sharePostClick",{category:"communities"}),e.preventDefault(),e.stopPropagation(),n=d.isDevelopment()?"http://dev.thinkpacifica.com/community/post/":"http://www.thinkpacifica.com/community/post/",n+=t.id,m.mobile?window.plugins.socialsharing.share(h.instant("SHARE_POST_TEXT")+' "'+t.title+'"',null,null,n):(m.socialTooltipUrl=n,v.modal.open({modalId:"ShareContentModal",templateUrl:"templates/community/community.shareContent.modal.html",scope:m,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){m.shareContentModal=e}))},m.closeShareContentModal=function(){v.modal.close(m.shareContentModal).then(function(e){m.shareContentModal=e})},m.deletePost=function(e,t){e&&(e.preventDefault(),e.stopPropagation()),v.popup.confirm({template:"<div>"+h.instant("ARCHIVE_POST_PROMPT")+"</div>",cancelText:h.instant("CANCEL"),cancelType:"button-default",okText:h.instant("REMOVE"),okType:"button-default"}).then(function(e){e&&T.archivePost(t.id).success(function(){m.removePost(t)}).error(function(){v.popup.alert({template:h.instant("ARCHIVE_POST_ERROR"),okText:h.instant("OK_GOT_IT"),okType:"button-default"})})})},m.isPostOwner=function(e){return e&&e.creatorId==a.getAccountUser().user.id},m.isFeaturedInFeed=function(e){return T.isFeaturedInFeed(e)},m.showMenu=function(e){return m.showingMenu==e.id},m.toggleMenu=function(e,t){e.stopPropagation(),e.preventDefault(),m.showingMenu==t.id?m.showingMenu=void 0:m.showingMenu=t.id},m.closeShareMoodModal=function(){v.modal.close(m.moodModal).then(function(e){m.moodModal=e})},m.hasSharingData=function(e){return m.sharingData[e]},m.shareWeeksMood=function(){var e=s.getAllMoodHabitData(),t=[],n=new Date((new Date).getTime()-5184e5);if(n.setHours(0,0,0,0),e&&0<e.length)for(var o=0;o<e.length;++o){var i=e[o];n<new Date(i.experiencedAtStr)&&t.push(i)}if(0===t.length)v.popup.alert({template:h.instant("MISSING_MOOD_DATA_ERROR"),okText:h.instant("OK_GOT_IT"),okType:"button-default"});else m.sharingData={},t.sort(function(e,t){return new Date(e.experiencedAtStr)-new Date(t.experiencedAtStr)}),m.sharingData.Mood={moodEntries:t,startDate:n.toString(),numberOfDays:7},m.closeShareMoodModal(),O(h.instant("DEFAULT_MOOD_SHARE_TEXT"))},m.getRecordingSource=function(e,t){return S(e,t,"url")},m.getRecordingDuration=function(e,t){return S(e,t,"duration")},m.getRecordingTags=function(e,t){return S(e,t,"tags")},m.isThoughtExpired=function(e){var t=m.getThought(e);return!(!t||!t.expiresAtStr)&&new Date(t.expiresAtStr)<new Date},m.isAudioJournal=function(e){var t=m.getThought(e);return t&&"AUDIO_JOURNAL"==t.thoughtType},m.isAudioThought=function(e){var t=m.getThought(e);return t&&(!t.thoughtType||"AUDIO_DISTORTIONS"==t.thoughtType)},m.isTextThought=function(e){var t=m.getThought(e);return t&&"TEXT_DISTORTIONS"==t.thoughtType},m.isTextJournal=function(e){var t=m.getThought(e);return t&&"TEXT_JOURNAL"==t.thoughtType},m.getTextThoughtDisplay=function(e){var t=m.getThought(e);if(t&&"TEXT_DISTORTIONS"==t.thoughtType){var n=t.recordings.analysis,o=n?n.notes:"";return 250<o.length&&(o=o.substring(0,250)+"..."),o}},m.getTextJournalDisplay=function(e){var t=m.getThought(e);if(t&&"TEXT_JOURNAL"==t.thoughtType){var n=t.recordings.journal,o=n?n.notes:"";return 250<o.length&&(o=o.substring(0,250)+"..."),o}},m.closeTextThoughtModal=function(){v.modal.close(m.textThoughtModal).then(function(e){m.textThoughtModal=e})},m.getThoughtDate=function(e){var t=m.getThought(e);if(t)return moment(new Date(t.createdAtString)).calendar()},m.closeShareThoughtModal=function(){v.modal.close(m.thoughtModal).then(function(e){m.thoughtModal=e})},m.getShareThoughtButtonText=function(){return h.instant("SHARE_THOUGHT")},m.getShareThoughtCopy=function(){return h.instant("SHARE_THOUGHT_COPY")},m.getThoughtItemDisplay=function(e){return e.title},m.updateSelectedThought=function(){m.selectedThought=m.thoughtOptions.thoughts[m.thoughtOptions.thoughtOrdinal]},m.getSelectedThought=function(){if(m.selectedThought)return m.selectedThought.title},m.showingModal=function(){return m.moodModal||m.thoughtModal||m.experimentModal},m.shareThought=function(){m.sharingData={},m.sharingData.Thought=m.selectedThought,O(h.instant("DEFAULT_THOUGHT_SHARE_TEXT")),m.closeShareThoughtModal()},m.closeShareExperimentModal=function(e){v.modal.close(m.experimentModal).then(function(e){m.experimentModal=e})},m.getExperimentItemDisplay=function(e){return e.title},m.getShareExperimentCopy=function(){return h.instant("SHARE_EXPERIMENT_COPY")},m.getShareExperimentButtonText=function(){return h.instant("SHARE_EXPERIMENT")},m.updateSelectedExperiment=function(){m.selectedExperiment=m.experimentOptions.experiments[m.experimentOptions.experimentOrdinal]},m.getSelectedExperiment=function(){if(m.selectedExperiment)return m.selectedExperiment.title},m.shareExperiment=function(){"GROUP"==m.group.groupType||"PERSONAL"==m.group.groupType?(m.sharingData={},m.sharingData.Experiment=m.selectedExperiment,O(h.instant("DEFAULT_EXPERIMENT_SHARE_TEXT"))):m.createPostInternal(m.selectedExperiment.title,{Experiment:m.selectedExperiment}),m.closeShareExperimentModal(!0)},m.showExperimentShare=function(){if("GROUP"!=m.group.groupType&&"PERSONAL"!=m.group.groupType||!m.sharingData.Experiment){var e=c.getAccountSubGoals();if(e){var t=[];for(var n in e)for(var o=e[n],i=0;i<o.length;++i){var a=o[i];a.achievedRecordedAt&&t.push(a)}if(0===t.length)return void A();t.sort(function(e,t){var n=new Date(e.achievedRecordedAtString);return new Date(t.achievedRecordedAtString)-n}),m.selectedExperiment=t[0],m.experimentOptions={experiments:t,experimentOrdinal:0},v.modal.open({modalId:"ExperimentModal",templateUrl:"views/groups/groups.experiment.modal.html",scope:m,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){m.experimentModal=e})}else A()}else m.sharingData={},r=h.instant("DEFAULT_EXPERIMENT_SHARE_TEXT"),m.groupPostData.postText.trim()==r&&(m.groupPostData.postText="");var r},m.inputHasFocus=!1,m.inputFocused=function(){"PERSONAL"==m.group.groupType||m.isUserEmailValidated()||m.checkRemoteEmailValidation(function(e){e&&(m.inputHasFocus=!0)})},m.inputBlurred=function(){m.inputHasFocus=!1},m.isInputFocused=function(){return m.inputHasFocus},m.inputChanged=function(){if(m.websocketSend){var e=m.hasPostText();e&&!m.typing?(m.typing=!0,m.websocketSend("typing")):!e&&m.typing&&(m.typing=!1,m.websocketSend("nottyping"))}},m.hasPostText=function(){var e=m.groupPostData.postText;return!!e&&0<(e=e.trim()).length},m.editPost=function(e,t,n){e&&(e.preventDefault(),e.stopPropagation()),t.comments&&0<t.comments?l.showToast(h.instant("CANNOT_EDIT_POST_MSG"),!1,"center"):(n&&(m.isEditingComment=!0),m.isEditing=!0,m.postForEdit=t,m.communityPostData.postText=m.getPostTitle(t,!0,!0),C())},m.postEdited=function(){m.editedPost=!0},m.editCommunityPost=function(){m.closeCreatePostModal()},m.checkClosePost=function(){m.editedPost?v.popup.confirm({template:h.instant("THOUGHTS_GO_BACK_PROMPT"),cancelText:h.instant("CANCEL"),cancelType:"button-default",okText:h.instant("CONFIRM"),okType:"button-default"}).then(function(e){e&&m.closeCreatePostModal()}):m.closeCreatePostModal()},m.closeCreatePostModal=function(){v.modal.close(m.createCommunityPostModal).then(function(e){m.createCommunityPostModal=e,m.isEditing=!1,m.editedPost=!0,m.postForEdit=void 0})},m.showCreatePost=function(){if(!m.checkOfflineMode()){if(!m.hasUserNickname())return m.attemptingCommunityPost=!0,void m.showUpdateNickname();if(m.isUserEmailValidated())if(m.canCreateCommunityPost())m.group&&"Experiments"==m.group.name?m.showExperimentShare():(m.communityPostData.postText="","Your Mind Matters Podcast"==m.group.name?m.groupDescription=h.instant("COMMUNITY_YOUR_MIND_MATTERS_PODCAST_POST"):m.groupDescription=m.group.description,C());else if(a.getAccountUser().user.banned)v.popup.alert({template:h.instant("BANNED_USER_ERROR"),okText:h.instant("OK_GOT_IT"),okType:"button-default"});else v.popup.alert({template:h.instant("CREATE_POST_COOLOFF_ERROR"),okText:h.instant("OK_GOT_IT"),okType:"button-default"});else m.checkRemoteEmailValidation(function(e){e&&m.showCreatePost()})}},m.loadGroupOnDemand=function(){T.getGroup(m.groupId).success(function(e){m.group=e,m.loadingGroup=!1,m.initView&&m.initView()}).error(function(){m.loadingGroup=!1})},m.createPostInternal=function(e,t,n){var a,r;if(m.submittingPost=!0,m.typing=!1,t)for(var o in a=[],t){if(a.push({name:"type",value:o}),a.push({name:"version",value:"1"}),"Mood"==o){var i=t.Mood.moodEntries;a.push({name:"data",value:JSON.stringify(i)}),a.push({name:"startDate",value:t.Mood.startDate}),a.push({name:"numberOfDays",value:t.Mood.numberOfDays})}else if("Thought"==o){var s=t.Thought;a.push({name:"data",value:JSON.stringify(s)});var c=new Date((new Date).getTime()+6048e5);a.push({name:"expiresAtStr",value:c.toString()})}else if("Experiment"==o){var u=t.Experiment;a.push({name:"data",value:JSON.stringify(u)})}else if("Image"==o){var l=t.Image,d=document.createElement("a");d.href=l.url,I.isSavingQuoteImage?(a.push({name:"imageURL",value:l.url}),I.isSavingQuoteImage=!1):a.push({name:"path",value:d.pathname.substring(1)}),r=l.url}break}$("#postText").blur();var p=m.groupPostData.postText,g=m.communityPostData.postText;m.isEditingComment?T.editComment(m.postForEdit.id,e).success(function(e){m.isEditingComment=!1,m.submittingPost=!1,m.isEditing=!1,m.loadPostComments(!0)}).error(function(){m.groupPostData.postText=p,m.communityPostData.postText=g,v.popup.alert({template:h.instant("CREATE_POST_ERROR"),okText:h.instant("OK_GOT_IT"),okType:"button-default"}),m.submittingPost=!1}):T.createGroupPost(m.groupId,e,a,n).success(function(e){m.groupPostData.postText="",m.communityPostData.postText="",m.submittingPost=!1;var t=m.group&&m.group.groupType?m.group.groupType:null;if("PERSONAL"!=t){if("GROUP"==t||"CLIENT"==t){m.groupPosts.push(e),m.postDataObjects[e.id]={};for(var n=0;n<a.length;++n){var o=a[n];m.postDataObjects[e.id][o.name]=o.value}r&&(m.postDataObjects[e.id].url=r),f(function(){m.scrollToNewPosts()})}else if("COMMUNITY"==t)if(E.checkForLevelUp(),m.groupPosts){var i=_.findIndex(m.groupPosts,{id:e.id});-1<i?m.groupPosts[i]=e:m.groupPosts.splice(0,0,e)}else I.postEdited=!0;m.createVoteObject(e),m.updateMoodGraphs&&f(m.updateMoodGraphs),f(function(){I.$broadcast("event:createdMessage")},500),m.finishedPost&&m.finishedPost(e),m.sharingData={}}else m.finishedPost&&m.finishedPost(e)}).error(function(){m.groupPostData.postText=p,m.communityPostData.postText=g,v.popup.alert({template:h.instant("CREATE_POST_ERROR"),okText:h.instant("OK_GOT_IT"),okType:"button-default"}),m.submittingPost=!1})},m.createPost=function(e,t){if(e&&(e.preventDefault(),e.stopPropagation()),!m.checkOfflineMode())if("PERSONAL"!=m.group.groupType&&a.getAccountUser().user.banned)v.popup.alert({template:h.instant("BANNED_USER_ERROR"),okText:h.instant("OK_GOT_IT"),okType:"button-default"});else if("PERSONAL"==m.group.groupType||m.isUserEmailValidated()){var n=!1;m.hasSharingData&&(n=m.hasSharingData("Mood")||m.hasSharingData("Thought")||m.hasSharingData("Experiment"));var o=m.groupPostData.postText.trim();"PERSONAL"==m.group.groupType||0!==o.length||n?m.createPostInternal(o,m.sharingData,t):m.groupError=h.instant("CREATE_POST_TEXT_ERROR")}else m.checkRemoteEmailValidation(function(e){e&&m.createPost()})},m.canCreateCommunityPost=function(){return!a.getAccountUser().user.banned&&T.canCreatePublicGroupPost(m.group)},m.createCommunityPost=function(){var e;m.postForEdit&&(e=m.postForEdit.id,m.groupId=m.postForEdit.groupId);var t=m.communityPostData.postText.trim();0!==t.length?500<t.length?m.communityError=h.instant("CREATE_POST_LENGTH_ERROR"):(m.communityError=void 0,m.createPostInternal(t,null,e),m.closeCreatePostModal(),m.showNew&&m.showNew(),m.mobile||redrawMasonry()):m.communityError=h.instant("CREATE_POST_TEXT_ERROR")},m.deleteComment=function(e,t){e.preventDefault(),e.stopPropagation(),v.popup.confirm({template:"<div>"+h.instant("ARCHIVE_COMMENT_PROMPT")+"</div>",cancelText:h.instant("CANCEL"),cancelType:"button-default",okText:h.instant("REMOVE"),okType:"button-default"}).then(function(e){e&&T.archiveComment(t.id).success(function(){m.removeComment(t)}).error(function(){o.addEventAppsee("errorTriggered","archiveComment");v.popup.alert({template:h.instant("ARCHIVE_COMMENT_ERROR"),okText:h.instant("OK_GOT_IT"),okType:"button-default"})})})},T.initValidateEmailFunctionality(m),T.initCreateGroupFunctionality(m),T.initInviteFunctionality(m)}]),angular.module("communitiesHelpCtrl",[]).controller("CommunitiesHelpCtrl",["$scope","$sce","$state","$stateParams","$controller","$translate","$ionicHistory","$ionicSlideBoxDelegate","AccountService",function(e,n,t,o,i,a,r,s,c){i("HelpCtrl",{$scope:e}),e.getHelpSlide=function(e){var t="COMMUNITIES_HELP_SLIDE_"+e;return n.trustAsHtml(a.instant(t))},e.getSlideIndex=function(){return"slide"+s.$getByHandle("communities-help-slides").currentIndex()},e.confirm=function(){c.setUserPreference("viewed_community_rules","true"),r.currentView(r.backView()),"app.communities-help"==t.current.name?t.go("app.communities-posts",{groupId:o.groupId,order:o.order},{location:"replace"}):"app.groups-help"==t.current.name&&t.go("app.group-posts",{groupId:o.groupId,order:o.order},{location:"replace"})}}]),angular.module("contributingFactorsCompleteCtrl",[]).controller("ContributingFactorsCompleteCtrl",["$scope","$rootScope","$controller","$state","$stateParams","$timeout","$translate","$ionicHistory","$ionicPopup","AccountService","AudioService","HabitsService","Environment",function(d,e,t,n,o,i,a,r,s,c,u,l,p){d.mobile?t("ThoughtCompleteCtrl",{$scope:d}):t("ProgressCtrl",{$scope:d});var g=["#5DA5DA","#FAA43A","#60BD68","#F15854","#B2912F","#B276B2","#DECF3F","#F17CB0"];d.getTagColor=function(e){return g[e%g.length]},d.recording=d.thought.recordings.event,d.tags=d.recording.tags,window.drawCanvas=function(){d.canvasScale=window.devicePixelRatio;var e=$("#pieChart")[0],t=e.getContext("2d"),n=$(e).innerWidth(),o=$(e).innerHeight();e.width!=n*d.canvasScale&&(e.width=n*d.canvasScale),e.height!=o*d.canvasScale&&(e.height=o*d.canvasScale),e.style.width=n+"px",e.style.height=o+"px";var i=e.width,a=e.height;t.clearRect(0,0,i,a),t.save();for(var r=0,s=0,c=0;c<d.tags.length;++c)s+=d.tags[c].tagSpan;for(var u=0;u<d.tags.length;++u){var l=d.tags[u];t.fillStyle=g[u%g.length],t.beginPath(),t.moveTo(e.width/2,e.height/2),t.arc(e.width/2,e.height/2,e.height/2,r,r+2*Math.PI*(l.tagSpan/s),!1),t.lineTo(e.width/2,e.height/2),t.fill(),r+=2*Math.PI*(l.tagSpan/s)}t.restore()},i(drawCanvas)}]),angular.module("evidenceCompleteCtrl",[]).controller("EvidenceCompleteCtrl",["$scope","$controller","$translate",function(n,e,o){n.mobile?e("ThoughtCompleteCtrl",{$scope:n}):e("ProgressCtrl",{$scope:n}),n.recording=n.thought.recordings.thought,n.getQuestionYesNo=function(e){var t=n.recording.tags[e];return o.instant("positive"==t.tagTypeString?" YES":"NO")},n.showQuestionAnswer=function(e){return"positive"==n.recording.tags[e].tagTypeString},n.getQuestionAnswer=function(e){return n.recording.tags[e].tagString}}]),angular.module("groupPostCommentsCtrl",[]).controller("GroupPostCommentsCtrl",["$scope","$rootScope","$controller","$stateParams","$timeout","$translate","$ionicPlatform","$ionicScrollDelegate","AccountService","GroupsService","OverlayService",function(o,n,e,t,i,a,r,s,c,u,l){function d(){o.offset=0}function p(){o.loadingComments=!0,u.findGroupPostComments(o.postId,o.order,o.limit,o.offset).success(function(e){var t=e.postComments;o.loadingComments=!1;e.postComments;o.canLoadMore=t.length==o.limit,o.lastPostLoad=new Date,o.postComments.push.apply(o.postComments,t),o.addUserCommentVotes(e.userVotes),s.resize(),o.$broadcast("scroll.refreshComplete")}).error(function(){o.loadingComments=!1})}e("AbstractGroupPostsCtrl",{$scope:o}),o.postId=o.postId||+t.postId,o.inputFocused=function(){o.hasUserNickname()?o.checkRemoteEmailValidation(function(e){e&&(o.inputHasFocus=!0)}):(o.showUpdateNickname(),$("#postText").blur(),o.inputHasFocus=!0)},o.finishedPost=function(e){o.editedPost&&(o.post=e)},o.getGroupRemainingPostCharacters=function(){var e=o.groupPostData.postText;return e||(e=""),512-e.length},o.removePost=function(e){n.didDeleteCommunityPost=!0,o.goBack()},o.getCommentPostTitle=function(){return o.post?o.getPostTitle(o.post,!0):a.instant("LOADING")+"..."},o.showNew=function(){"date"!=o.order&&(o.order="date",d(),o.postComments.length=0,p())},o.showAllTime=function(){"score"!=o.order&&(o.order="score",d(),o.postComments.length=0,p())},o.getExperiment=function(){if(o.postData){if(o.postData.experiment)return o.postData.experiment;if("Experiment"==o.postData.type){var e=o.postData.data;if(e){var t=JSON.parse(e);return o.postData.experiment=t}o.postData.experiment={}}}return{}},o.postComment=function(e){if(e&&(e.preventDefault(),e.stopPropagation()),!o.checkOfflineMode())if(c.getAccountUser().user.banned)l.popup.alert({template:a.instant("BANNED_USER_ERROR"),okText:a.instant("OK_GOT_IT"),okType:"button-default"});else if(o.hasUserNickname()){var t=o.groupPostData.postText.trim();0!==t.length||hasSharingData?($("#postText").blur(),o.postingComment=!0,o.postingCommentText=t,o.groupPostData.postText="",u.postComment(o.postId,o.post.groupId,t).success(function(e){o.postingComment=!1,o.postComments.splice(0,0,e),o.showNew(),o.createVoteObject(e),++o.post.comments,i(function(){n.$broadcast("event:createdMessage")},500)}).error(function(){o.groupPostData.postText=o.postingCommentText;l.popup.alert({template:a.instant("POSTING_COMMENT_ERROR"),okText:a.instant("OK_GOT_IT"),okType:"button-default"});o.postingComment=!1})):o.groupError=a.instant("CREATE_POST_TEXT_ERROR")}else o.showUpdateNickname()},o.removeComment=function(e){--o.post.comments,o.removeCommentById(e.id)},o.removeCommentById=function(e){for(var t=0;t<o.postComments.length;++t)if(o.postComments[t].id==e)return void o.postComments.splice(t,1)},o.checkForEditClose=function(){o.editedComment?l.popup.confirm({template:a.instant("THOUGHTS_GO_BACK_PROMPT"),cancelText:a.instant("CANCEL"),cancelType:"button-default",okText:a.instant("CONFIRM"),okType:"button-default"}).then(function(e){e&&o.closeEditCommentModal()}):o.closeEditCommentModal()},o.closeEditCommentModal=function(){l.modal.close(o.editCommentModal).then(function(e){o.editCommentModal=e}),o.updatingComment=!1,o.editComment=null,o.editedComment=!1},o.updateComment=function(){o.updatingComment=!0,o.closeEditCommentModal()},o.didEditComment=function(){o.editedComment=!0},o.editCommentClick=function(e,t){e.preventDefault(),e.stopPropagation(),o.commentForEdit=o.getPostTitle(t,!0,!0),l.modal.open({modalId:"EditCommentModal",templateUrl:"views/groups/communities.editComment.modal.html",scope:o,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){o.editCommentModal=e})},o.closeReportModal=function(){if(o.reportModal)return o.reportPostData.postText="",l.modal.close(o.reportModal).then(function(e){o.reportModal=e})},o.reportComment=function(){var e=o.reportPostData.postText.trim();if(e&&0!==e.length){var t=o.referUserData.referUser;o.reportError=void 0,u.reportComment(o.reportingCommentId,e,!!t).success(function(){o.closeReportModal().then(function(){o.removeCommentById(o.reportingCommentId),--o.post.comments;l.popup.alert({template:a.instant("REPORT_POST_CONFIRM"),okText:a.instant("OK_GOT_IT"),okType:"button-default"})})}).error(function(){$analytics.addEventAppsee("errorTriggered","reportComment");l.popup.alert({template:a.instant("REPORT_POST_ERROR"),okText:a.instant("OK_GOT_IT"),okType:"button-default"})})}else o.reportError=a.instant("REPORT_POST_TEXT_ERROR")},o.showReportComment=function(e,t){var n;(e.stopPropagation(),e.preventDefault(),o.reportingComment=!0,c.getAccountUser().user.banned)?l.popup.alert({template:a.instant("BANNED_USER_ERROR"),okText:a.instant("OK_GOT_IT"),okType:"button-default"}):(o.reportingCommentId=t.id,o.referUserData={referUser:!1},n=o.mobile?"views/groups/groups.report.modal.html":"templates/groups/groups.report.modal.html",l.modal.open({modalId:"ReportModal",templateUrl:n,scope:o,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){o.reportModal=e}))},o.loadMorePostComments=function(){o.offset+=o.limit,p()},o.$on("$ionicView.beforeEnter",function(){t.previousTab&&$("#groupPosts.comments").addClass("came-from-home-feed")}),o.post=u.getCachedPost(o.postId),o.post?(o.groupId=o.post.groupId,o.loadGroupOnDemand(),o.postData=u.getCachedPostData(o.post.id),o.userVotes=u.getCachedUserVotes()):u.getGroupPost(o.postId).success(function(e){e&&e.groupPostsContext&&e.groupPostsContext.groupPosts&&0<e.groupPostsContext.groupPosts.length&&(o.post=e.groupPostsContext.groupPosts[0],o.groupId=o.post.groupId,o.loadGroupOnDemand(),o.addUserVotes(e.userVotes))}).error(function(){$analytics.addEventAppsee("errorTriggered","getGroupPost"),l.popup.alert({template:a.instant("LOADING_COMMENTS_ERROR"),okText:a.instant("OK_GOT_IT"),okType:"button-default"})}),o.order=t.order,o.order||(o.order="score"),o.mobile||"hotness"!=o.order||(o.order="date"),o.limit=25,o.offset=0,o.canLoadMore=!0,u.initEditNicknameFunctionality(o),r.onHardwareBackButton(function(e){return o.nicknameModal&&o.closeNicknameModal(),!1}),o.postComments=[],p()}]),angular.module("groupPostsCtrl",[]).controller("GroupPostsCtrl",["$scope","$location","$controller","$state","$stateParams","$timeout","$translate","$ionicScrollDelegate","$ionicPlatform","AccountService","HabitsService","GroupsService","GeneralService","Environment","TokenService","OverlayService","$sce","$rootScope","$analytics",function(L,n,e,t,o,l,i,d,a,s,k,c,V,r,u,F,p,g,m){var f=3e4;function h(){L.destroying||L.websocketError||!L.chatConnection||y()}function T(){var e;return(L.mobile?(e=d.getScrollPosition().top,d.getScrollView().__maxScrollTop):(e=$(window).scrollTop(),$(document).height()-$(window).height()))-30<e&&"GROUP"==L.group.groupType}function v(e){if(e.data.startsWith("{")){var t=JSON.parse(e.data);L.usersTyping=t.usersTyping;var n=T(),o=t.groupPosts;if(o&&0<o.length){for(var i=0;i<o.length;++i){var a=o[i];a.creatorId!=s.getAccountUser().user.id&&(L.groupPosts.push(a),L.hasNewPosts=!0)}var r=t.groupPostData;r&&(A(r),l(function(){L.updateMoodGraphs(!1,!1)})),n&&L.scrollToNewPosts()}L.$$phase||L.$apply()}}function E(e){console.log("Error detected: "),console.log(e),O(),!L.websocketOpened||L.creatingWebsocket?(L.websocketError=!0,l(L.checkForNewPosts,f)):y()}function I(){(function(e){if(!e)return!1;var t=e.groupType,n="COMMUNITY"!=t&&"PERSONAL"!=t,o="COMMUNITY"==t&&"date"==L.order;return n||o})(L.group)&&L.checkForNewPosts(!0),y(),c.clearGroupNotification(L.groupId)}function y(){if(L.group&&("GROUP"==L.group.groupType||"CLIENT"==L.group.groupType)&&s.isLoggedIn()&&(!L.chatConnection||0!==L.chatConnection.readyState)){L.creatingWebsocket=!0,L.chatConnection&&O();var e=u.getToken();if("notsecure"!=e){var t=r.websocketURL+"/chat/group/"+L.group.id;(e=u.getToken())&&(t+="?token="+e),L.chatConnection=new WebSocket(t),L.chatConnection.onclose=h,L.chatConnection.onmessage=v,L.chatConnection.onerror=E,L.chatConnection.onopen=function(){console.log("Connection open!"),L.websocketOpened=!0},L.creatingWebsocket=!1}else l(L.checkForNewPosts,f)}}function O(){if(L.chatConnection){var e=L.chatConnection.readyState;0!==e&&1!=e||L.chatConnection.close(),L.chatConnection=void 0}}function S(e,t){var n=0,o=L.getThought(e);if(o&&o.recordings&&o.recordings.thought&&o.recordings.thought.tags)for(var i=o.recordings.thought.tags,a=0;a<i.length;++a){i[a].tagTypeString==t&&++n}return n}function A(e){if(e)for(var t=0;t<e.length;++t){var n=e[t],o=L.postDataObjects[n.postId];o||(o={},L.postDataObjects[n.postId]=o),o[n.name]=n.value}}function C(e){if(L.group){var r=0===L.groupPosts.length||e;r&&(L.loadingPosts=!0),c.findGroupPosts(L.group,L.order,L.limit,L.offset).success(function(e){L.lastPostLoad=new Date;var t=e.groupPostsContext.groupPosts;r&&(L.groupPosts.length=0),A(e.groupPostsContext.groupPostData),L.canLoadMore=t.length==L.limit;var n,o,i=L.group.groupType;if("GROUP"==i||"CLIENT"==i){t=t.reverse(),Array.prototype.splice.apply(L.groupPosts,[0,0].concat(t));var a=$("body").hasClass("modal-open");if(!L.mobile&&!a){n=$(".chat-scroll-container");o=n.attr("data-chat-type");L.$$postDigest(function(){var e=$(".group-message-wrapper:first");n=$(".chat-scroll-container"),o=n.attr("data-chat-type"),o&&"clinician"==o?$(".chat-scroll-container").scrollTop(e.offset().top-324):$(window).scrollTop(e.offset().top-158)})}}else L.groupPosts.push.apply(L.groupPosts,t),L.groupPosts=_.uniq(L.groupPosts);L.addUserVotes(e.userVotes),L.loadingPosts=!1,d.resize(),r&&(n=$(".chat-scroll-container"),(o=n.attr("data-chat-type"))&&"clinician"==o&&L.scrollToNewPosts(),L.mobile&&"COMMUNITY"!=i&&d.scrollBottom()),"GROUP"==L.group.groupType&&l(function(){L.updateMoodGraphs(r,!r)}),L.$broadcast("scroll.refreshComplete")}).error(function(){m.addEventAppsee("errorTriggered","loadGroupPosts");F.popup.alert({template:i.instant("LOADING_POSTS_ERROR"),okText:i.instant("OK_GOT_IT"),okType:"button-default"});L.loadingPosts=!0,L.$broadcast("scroll.refreshComplete")})}}e("AbstractGroupPostsCtrl",{$scope:L}),L.clinicianDashChatInitialized=function(){L.scrollBottomOnChatMessagesRendered=!0},L.clinicianChatMessagesRendered=function(){L.scrollBottomOnChatMessagesRendered&&$(".chat-scroll-container").scrollTop($(".chat-scroll-container").prop("scrollHeight"))},L.switchGroup=function(e){n.search({groupId:e,order:"hotness"}),L.groupId=e,L.groupPosts=[],L.loadGroupOnDemand()},L.$watch(function(){return n.search()},function(e,t){var n="groupId"in e&&"groupId"in t&&e.groupId!==t.groupId;if(!L.group&&L.loadingGroup){var o=function(){!L.loadingGroups?L.loadGroupOnDemand():l(function(){console.log("waiting for group to be ready"),o()},50)};o()}else(n||!0===g.postEdited)&&(L.switchGroup(e.groupId),g.postEdited=void 0)},!0),L.loadingGroup=!0,L.initView=function(){C(),y()},L.getGroupTitle=function(){var e=L.group?L.group.name:void 0;return e?20<e.length&&" "==(e=e.substring(0,20)).substring(19)&&(e=e.substring(0,19)):e="",e},L.getGroupCode=function(){return L.group&&L.isOwner(L.group)?L.group.code:""},L.getClinicianAvatar=function(e,t){if(t&&t.userId==e.creatorId)return t.photoUrl},L.showGroupTip=function(){return!(L.group&&1<L.group.members)&&(!s.getUserPreference("sent_group_invitation")&&L.isOwner(L.group))},L.showManageGroupTooltip=function(){var e=s.getUserPreference("viewed_manage_group_tooltip");return!(L.showGroupTip()||e&&"false"!=e)},L.dismissManageGroupTooltip=function(){L.viewManageGroupTooltip=!1,s.setUserPreference("viewed_manage_group_tooltip","true")},L.websocketSend=function(e){L.chatConnection&&L.chatConnection.send(e)},document.addEventListener("resume",I,!1),a.on("pause",function(){O()}),L.$on("$destroy",function(){L.destroying=!0,document.removeEventListener("resume",I,!1),O()}),L.scrollToNewPosts=function(){if(L.mobile)d.scrollBottom(!0);else{var e=$(".chat-scroll-container"),t=e.attr("data-chat-type");t&&"clinician"==t?e.scrollTop(e[0].scrollHeight):$("html, body").animate({scrollTop:$(document).height()},"slow")}L.hasNewPosts=!1},$(".scroll-content").scroll(function(){var e=d.getScrollPosition().top;d.getScrollView().__maxScrollTop-150<e&&(L.hasNewPosts=!1,L.$$phase||L.$digest())}),L.checkForNewPosts=function(s){var e;L.lastPostLoad&&L.group?(e=0<L.groupPosts.length?new Date(L.groupPosts[L.groupPosts.length-1].createdAt):L.lastPostLoad,c.findNewerPosts(L.group,e).success(function(e){var t=e.groupPostsContext.groupPosts;if(0<t.length){for(var n=T(),o=t.length-1;0<=o;--o)for(var i=t[o],a=L.groupPosts.length-1;0<=a;--a){var r=L.groupPosts[a];i.id!=r.id||t.splice(o,1)}if(0<t.length)L.hasNewPosts=!0,"GROUP"==L.group.groupType||"CLIENT"==L.group.groupType?(t=t.reverse(),L.groupPosts.push.apply(L.groupPosts,t)):Array.prototype.splice.apply(L.groupPosts,[0,0].concat(t)),A(e.groupPostsContext.groupPostData),L.lastPostLoad=new Date,n?L.scrollToNewPosts():"PERSONAL"==L.group.groupType&&d.scrollTop(),l(function(){L.updateMoodGraphs(!1,!1)})}s||l(L.checkForNewPosts,f)}).error(function(){console.log("There was a problem loading newer posts.")})):l(L.checkForNewPosts,f)},L.isOwner=function(){return L.group&&L.group.creatorId==s.getAccountUser().user.id},L.viewGroupUsers=function(e){e.stopPropagation(),e.preventDefault(),L.group&&t.go("app.groups-users",{groupId:L.group.id})},L.groupPosts=[],L.postDataObjects={},L.limit=25,L.offset=0,L.canLoadMore=!0,L.order=L.order?L.order:o.order,L.loadMoreGroupsPosts=function(e){var t;t=void 0!==typeof e&&e,L.offset+=L.limit,C(t)},L.reloadCommunityPosts=function(){C(!(L.offset=0))},L.isPostType=function(e,t){if(e){var n=L.postDataObjects[e.id];return!!n&&n.type==t}},L.getCommunityName=function(){if(!L.group)return"";var e=L.group.name,t=("COMMUNITY_"+e).replace(/ /g,"_").toUpperCase(),n=i.instant(t);return n==t?e:n},L.getPost=function(e){for(var t=0;t<L.groupPosts.length;++t){var n=L.groupPosts[t];if(n.id==e)return n}},L.getMoodEntries=function(e){var t=L.postDataObjects[e.id];if(t){if(t.moodEntries)return t.moodEntries;if("Mood"==t.type){var n=t.data;if(n){var o=JSON.parse(n);return t.moodEntries=o}}}},L.getMoodStartDate=function(e){var t=L.postDataObjects[e.id];if(t){if(t.startDate)return t.startDate;if("Mood"==t.type){var n=t.data;if(n&&n.startDate){var o=new Date(n.startDate);return t.startDate=o}}}},L.getMoodNumberOfDays=function(e){var t=L.postDataObjects[e.id];if(t){if(t.numberOfDays)return t.numberOfDays;if("Mood"==t.type){var n=t.data;if(n){var o=+n.numberOfDays;return t.numberOfDays=o}}}},L.getMoodClass=function(e){var t=L.getMoodEntries(e);if(t&&0<t.length){var n=t[t.length-1];return k.getMoodClass(n)}},L.getMoodDisplay=function(e){var t=L.getMoodEntries(e);if(t&&0<t.length){var n=t[t.length-1];return k.getHabitDisplayFromValue(n)}},L.getMoodData=function(e){var t=L.getMoodEntries(e);if(t&&0<t.length){for(var n="",o=0;o<t.length;++o){if(0<o&&(n+="|"),void 0===t[o].valueInt)n+=k.getHabitValueById(t[o].habitValueId).valueInt;else n+=t[o].valueInt;n+=";"+t[o].experiencedAtStr}return n}},L.getPositiveFlags=function(e){return S(e,"positive")},L.getNegativeFlags=function(e){return S(e,"negative")},L.getImagePostSrc=function(e){var t=L.postDataObjects[e.id];if(t&&"Image"==t.type)return t.url},L.getThought=function(e){var t=L.postDataObjects[e.id];if(t){if(t.thought)return t.thought;if("Thought"==t.type){var n=t.data;if(n){var o=JSON.parse(n);return t.thought=o}t.thought={}}}return{}},L.getExperiment=function(e){var t=L.postDataObjects[e.id];if(t){if(t.experiment)return t.experiment;if("Experiment"==t.type){var n=t.data;if(n){var o=JSON.parse(n);return t.experiment=o}t.experiment={}}}return{}},L.getExperimentCompletionDate=function(e){var t=L.getExperiment(e);if(t){var n=t.achievedRecordedAtString;if(n)return moment(new Date(n)).calendar()}};var D=function(){L.groupPosts.length=0,L.offset=0,C(),d.scrollTop()};function B(e,t){var n,o,i=e.getBoundingClientRect();return t.changedTouches&&(n=t.changedTouches[0].pageX),n||(n=void 0!==t.pageX?t.pageX:t.clientX),t.changedTouches&&(o=t.changedTouches[0].pageY),o||(o=void 0!==t.pageY?t.pageY:t.clientY),{x:n-i.left,y:o-i.top}}L.showTop=function(){L.mobile||n.search("order","hotness"),L.order="hotness",D()},L.showNew=function(){L.mobile||n.search("order","date"),L.order="date",D()},L.showAllTime=function(){L.mobile||n.search("order","score"),L.order="score",D()},L.handleCommunitySwipe=function(e){if("left"===e){if("hotness"===L.order)return void L.showNew();if("date"===L.order)return void L.showAllTime()}if("right"===e){if("score"===L.order)return void L.showNew();if("date"===L.order)return void L.showTop()}},L.removePost=function(e){L.removePostById(e.id)},L.removePostById=function(e){for(var t=0;t<L.groupPosts.length;++t)if(L.groupPosts[t].id==e)return void L.groupPosts.splice(t,1)},L.getCommunityPostRemainingCharacters=function(){var e=L.communityPostData.postText;return 500-(e=e?e.trim():"").length},L.getGroupRemainingPostCharacters=function(){var e=L.groupPostData.postText;return e||(e=""),500-e.length},l(function(){$(".community-tabs").css("top",$("ion-header-bar").outerHeight()+"px")}),L.getMoodDetailDate=function(){if(L.moodDetailDate)return moment(L.moodDetailDate).calendar()},L.getMoodColor=function(e){return V.COLOR_NAMES[7-e.valueInt]},L.getHabitSubValue=function(e){var t=k.getHabitSubValueName(0,e);return t?i.instant(t.toUpperCase()):i.instant("UNKNOWN")},L.getMoodRatingDisplay=function(e){var t="HABITS_VALUES_"+e.valueString;return t=t.replace(/ /g,"_").toUpperCase(),i.instant(t)},L.getMoodRatingDateDisplay=function(e){var t=new Date(e.experiencedAtStr);return moment(t).calendar()},L.hasNotes=function(e){return e.habitDataNotes&&e.habitDataNotes.notes&&1<e.habitDataNotes.notes.length},L.closeMoodDetailModal=function(){F.modal.close(L.moodDetailModal).then(function(e){L.moodDetailModal=e})},L.updateMoodGraph=function(t,n,o,i,a,g,r,e){var m,s=t.data("startdate"),f=new Date(s),h=+t.data("numberofdays"),c=f.getTime(),u=864e5*h,T=+t.data("postid");if(e){var l=function(e){m=B(o[0],e),r=Math.floor(h*(m.x/g)),L.updateMoodGraph(t,n,o,i,a,g,r)},d=function(e){endPos=B(o[0],e),endPos.x==m.x&&endPos.y==m.y&&function(){console.log("click");var e=m.x/g,t=Math.floor(e*h),n=new Date(f.getTime()+1e3*t*60*60*24);L.moodDetailDate=n;var o=new Date(n.getTime()+864e5),i=L.getPost(T);if(i){var a=L.getMoodEntries(i);if(a){L.modalMoodEntries=[];for(var r={},s=0;s<a.length;++s){var c=a[s],u=new Date(c.experiencedAtStr);if(n<u&&u<o&&(L.modalMoodEntries.push(c),c.habitSubValueIds))for(var l=0;l<c.habitSubValueIds.length;++l)r[c.habitSubValueIds[l]]=p}var d=[];for(var p in r)k.getHabitSubValueName(0,p)||d.push(p);0<d.length&&k.getHabitSubValues(d),F.modal.open({modalId:"MoodDetailModal",templateUrl:"views/groups/groups.moodDetail.modal.html",scope:L,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){L.moodDetailModal=e})}}}(),r=-1,L.updateMoodGraph(t,n,o,i,a,g,r)};o[0].addEventListener("mousedown",l),o[0].addEventListener("mouseup",d),o[0].addEventListener("touchstart",l),o[0].addEventListener("touchend",d)}for(var p=o[0].getContext("2d"),v=p.canvas.width=g*i,E=p.canvas.height=a*i,I=v/h,_=0;_<h;++_){var y;y=_==r?"rgba(0, 0, 0, 0.3)":_%2==0?"rgba(0, 0, 0, 0.5)":"rgba(0, 0, 0, 0.55)";var O=_*I;p.fillStyle=y,p.fillRect(O,0,I,E);var S=new Date(f.getTime());S.setDate(S.getDate()+_);var A=moment(S).format("L");p.textAlign="center",p.font="25px sans-serif",p.fillStyle="rgb(150,150,150)",p.fillText(A,O+I/2,30)}for(var C=n.split("|"),D=0;D<2;++D)for(var b=0;b<C.length;++b){var R=C[b].split(";"),P=(new Date(R[1]).getTime()-c)/u*v,w=E-(40+(+R[0]-1)/6*(E-30-80));if(0===D){if(0<b){var N=C[b-1].split(";"),U=(new Date(N[1]).getTime()-c)/u*v,M=E-(40+(+N[0]-1)/6*(E-30-80));p.strokeStyle="rgba(255,255,255, 0.4)",p.beginPath(),p.moveTo(U,M),p.lineTo(P,w),p.stroke()}}else{var H=V.COLORS[7-R[0]],x=hexToRgb(H),G="rgb("+x.r+","+x.g+","+x.b+")";p.fillStyle=G,p.beginPath(),p.arc(P,w,8,0,2*Math.PI),p.closePath(),p.fill()}}},L.updateMoodGraphs=function(e,t){if(0!==$(".group-post").length){for(var n=$("div[data-mooddata]"),o=window.devicePixelRatio,i=window.innerWidth,a=n.length,r=0;r<a;++r){var s=$(n[r]),c=""+s.data("mooddata");if(s.data("startdate")){i=s.outerWidth();var u=s.find("canvas");u[0].width<100&&(u.css("width",i),u.css("height",120),L.updateMoodGraph(s,c,u,o,120,i,-1,!0))}}e&&l(function(){d.scrollBottom(t)})}},L.scrollBottom=function(){$(window).scrollTop($(document).height())},L.$on("$ionicView.beforeEnter",function(e,t){L.mobile&&g.didDeleteCommunityPost&&(L.reloadCommunityPosts(),g.didDeleteCommunityPost=!1)}),L.mobile||o.groupId?L.groupId=o.groupId:"/app/groups"===n.path()?c.findUserGroups().success(function(e){L.filteredGroups=e.userGroups.filter(function(e){return"GROUP"===e.groupType}),0<L.filteredGroups.length?(L.groupId=L.filteredGroups[0].id,t.go("app.groups",{groupId:L.groupId})):(L.group=void 0,t.go("app.groups",{groupId:""}))}):-1!=n.path().indexOf("/practitioner/client/")?c.findUserGroups().success(function(e){function t(){L.groupId=L.client.clientGroupId,n.search({groupId:L.groupId,activeTab:"chat"}),L.loadGroupOnDemand();var e=$(document).height()-$(".client-menu").offset().top-120-$(".group-message-bar").height();$(".chat-scroll-container").css("height",e),L.scrollToNewPosts()}L.client?t():once(L,"event:setClient",t)}):c.findPublicGroups().success(function(e){L.groupId=e.publicGroups[0].id,L.communities=e.publicGroups,L.userLikes=e.userLikes,L.userShares=e.userShares,L.loadingCommunities=!1,n.search({groupId:L.groupId,order:"hotness"}),L.loadGroupOnDemand()}),o.therapist?L.therapist=o.therapist:s.onceUserContextInitialized(function(){s.isPractitioner()&&(L.therapist=s.getAccountUser().practitioner)}),L.loadGroupOnDemand(),c.initEditFunctionality(L),c.initEditNicknameFunctionality(L),c.clearGroupNotification(L.groupId)}]);var ctrl=angular.module("groupsCtrl",[]);ctrl.controller("GroupsCtrl",["$scope","$state","$timeout","$analytics","$translate","$ionicSideMenuDelegate","$ionicScrollDelegate","$ionicHistory","$ionicPlatform","AccountService","GroupsService","SkillsService","GeneralService","Environment","$q","OverlayService",function(a,r,t,i,s,e,n,o,c,u,l,d,p,g,m,f){function h(){l.findUserGroups().success(function(e){a.filteredGroups=e.userGroups.filter(function(e){return"GROUP"===e.groupType}),0<a.filteredGroups.length?(a.groupId=a.filteredGroups[0].id,r.go("app.groups",{groupId:a.groupId,order:"hotness"})):(a.group=void 0,r.go("app.groups",{groupId:""}))})}a.searchQuery={query:""},a.$on("$ionicView.beforeEnter",function(e,t){var n=u.getUserPreference("completed_social_intro");if(n&&"true"==n){if("app.groups"==r.current.name){var o=u.getUserPreference("viewed_groups_popup");o&&"false"!=o||(a.showBrowseIfEmpty=!0)}}else{a.showActivityIntroModal("community",function(){u.setUserPreference("completed_social_intro",!0)});var i=a.$on("event:introVideoModalClosed",function(){"app.communities"==r.current.name?i&&i():"app.groups"==r.current.name&&(a.userGroups&&0===a.userGroups.length&&a.browseCuratedGroups(),i&&i())})}}),a.$on("$ionicView.afterEnter",function(e,t){a.backButtonCancel=c.registerBackButtonAction(function(){openURL("/home")},101),o.clearHistory()}),a.$on("$ionicView.afterLeave",function(e,t){a.backButtonCancel&&(a.backButtonCancel(),a.backButtonCancel=void 0)});var T,v=l.getLastActiveTab();function E(){a.loadingGroups=!1,a.userGroups=void 0,a.communities=void 0,a.userLikes=0,a.userShares=0,a.pendingInvites=[]}function I(){l.setLastActiveTab(a.activeTab),n.resize()}function y(e){for(var t=0;t<a.userGroups.length;++t){if(e==a.userGroups[t].id){a.userGroups.splice(t,1);break}}}function O(){T=void 0;var e=a.searchQuery.query;e&&e.trim(),""!==e?(a.hasSearchEntry=!0,a.isSearching=!0,l.searchForGroup(e).success(function(e){a.searchableGroups=e,a.isSearching=!1}).error(function(){a.clearGroupSearch(),a.hasSearchEntry=!1,a.isSearching=!1;f.popup.alert({template:s.instant("GROUP_SEARCH_ERROR"),okText:s.instant("OK_GOT_IT"),okType:"button-default"})})):(a.isSearching=!1,a.hasSearchEntry=!1)}function S(){u.isLoggedIn()&&g.isOnline()&&(a.showGroups()?a.activateGroups(!0):a.activateCommunities(!0))}a.activeTab=v||"communities",a.getSocialLevel=function(){return d.getSkillLevel("social")},a.goToSkills=function(){window.openURL("/progress/mood?tab=skills")},a.showHelp=function(){f.actionSheet.show({buttons:[{text:'<i class="icon ion-ios-help-outline"></i> '+s.instant("ABOUT_COMMUNITY")},{text:'<i class="icon ion-ios-play-outline"></i> '+s.instant("WATCH_MILO_IS_LOST")},{text:'<i class="icon ion-ios-list-outline"></i> '+s.instant("VIEW_COMMON_QUESTIONS")},{text:'<i class="icon ion-ios-people-outline"></i> '+s.instant("VIEW_RULES")}],titleText:s.instant("HELP_LINKS"),cancelText:s.instant("CANCEL"),cancel:function(){},buttonClicked:function(e){return 0===e?a.showActivityIntroModal("community"):1===e?u.viewVideo(u.COMMUNITY_VIDEO):2==e?window.open("http://help.thinkpacifica.com/hc/en-us/sections/203653507-Groups-Communities","_blank","location=no"):3==e&&("app.communities"==r.current.name?r.go("app.communities-help"):r.go("app.groups-help")),!0}})},a.getActiveTabTitle=function(){return s.instant("COMMUNITY")},a.showGroups=function(){return"groups"==a.activeTab},a.showCommunities=function(){return"communities"==a.activeTab},a.hasGroupNotification=function(e){return l.hasGroupNotification(e)},a.getGroupNotificationCount=function(e){return l.getGroupNotificationCount(e)},a.hasAnyPostNotification=function(){return l.hasPostNotification()},a.getPostNotificationCount=function(){return l.getPostNotificationCount()},a.getGroupAvatar=function(e){return"avatar_"+u.getAvatarCharacter(e.creatorAvatar,e.creatorId)},a.openSideMenu=function(){e.toggleLeft()},a.$on("$destroy",function(){document.removeEventListener("resume",S,!1)}),document.addEventListener("resume",S,!1),a.goToProfile=function(){a.hasUserNickname()?(l.clearAllPostNotifications(),r.go("app.community-profile")):a.showUpdateNickname()},a.checkOfflineMode=function(){if(g.isOnline())return!1;f.popup.alert({template:s.instant("GROUPS_OFFLINE_ERROR"),okText:s.instant("OK_GOT_IT"),okType:"button-default"});return!0},a.hasUserNickname=function(){var e=u.getAccountUser();return e&&e.user&&e.user.publicName&&0<e.user.publicName.length},a.getUserNickname=function(){var e=u.getAccountUser();return e&&e.user&&e.user.publicName&&0<e.user.publicName.length?e.user.publicName:""+s.instant("SET_UP_PROFILE")},a.getUserAvatar=function(){return u.getAccountUser().user?"avatar_"+u.getAvatarCharacter(u.getAccountUser().user.avatar,u.getAccountUser().user.id):""},a.getUserLikes=function(){return a.userLikes+""},a.getUserShares=function(){return a.userShares+""},a.loadGroups=function(e){a.userGroups||(a.loadingGroups=!0),l.findUserGroups(e).success(function(e){a.userGroups=angular.copy(e.userGroups);var t=_.findIndex(a.userGroups,function(e){return"PERSONAL"==e.groupType});-1<t&&a.userGroups.splice(t,1);var n=_.findIndex(a.userGroups,function(e){return"CLIENT"==e.groupType});-1<n&&a.userGroups.splice(n,1),a.pendingInvites=e.pendingInvites,!a.showBrowseIfEmpty||a.userGroups&&0!==a.userGroups.length||(a.browseCuratedGroups(),a.showBrowseIfEmpty=!1),a.loadingGroups=!1}).error(function(){f.popup.alert({template:s.instant("LOADING_GROUPS_ERROR"),okText:s.instant("OK_GOT_IT"),okType:"button-default"});a.loadingGroups=!1})},a.loadCommunities=function(){var t=m.defer();return a.communities||(a.loadingCommunities=!0),l.findPublicGroups().success(function(e){a.communities=e.publicGroups,a.userLikes=e.userLikes,a.userShares=e.userShares,a.loadingCommunities=!1,t.resolve(e)}).error(function(){if(g.isWeb())f.popup.alert({template:s.instant("LOADING_COMMUNITIES_ERROR"),okText:s.instant("OK_GOT_IT"),okType:"button-default"});else p.showToast(s.instant("LOADING_COMMUNITIES_ERROR"));a.loadingCommunities=!1,t.reject("error loading communities")}),t.promise},a.activateGroups=function(e){a.checkOfflineMode()||(i.eventTrack("activateGroups",{category:"group"}),a.activeTab="groups",l.clearAllGroupNotifications(),e||I(),a.loadGroups(),t(function(){$("#groupTitle").addClass("active"),$("#communitiesTitle").removeClass("active")}))},a.activateCommunities=function(e){a.checkOfflineMode()||(i.eventTrack("activateCommunities",{category:"group"}),a.activeTab="communities",e||I(),a.loadCommunities().then(function(){n.resize()}),t(function(){$("#communitiesTitle").addClass("active"),$("#groupTitle").removeClass("active"),n.resize()}))},a.isOwner=function(e){return e&&e.creatorId==u.getAccountUser().user.id},a.isOwnerById=function(e){return l.getGroupImmediate(e).creatorId==u.getAccountUser().user.id},a.getCommunityName=function(e){var t=e.name,n=("COMMUNITY_"+t).replace(/ /g,"_").toUpperCase(),o=s.instant(n);return o==n?t:o},a.getCommunityDescription=function(e){var t=("COMMUNITY_"+e.name+"_DESCRIPTION").replace(/ /g,"_").toUpperCase(),n=s.instant(t);return n==t?e.description:n},a.archiveGroup=function(e,t){(e.stopPropagation(),e.preventDefault(),a.checkOfflineMode())||(i.eventTrack("archiveGroupPopup",{category:"group"}),f.popup.confirm({template:"<div>"+s.instant("ARCHIVE_GROUP_PROMPT")+"</div>",cancelText:s.instant("CANCEL"),cancelType:"button-default",okText:s.instant("REMOVE"),okType:"button-default"}).then(function(e){e?t.curated||t.creatorId!=u.getAccountUser().user.id?l.leaveGroup(t.id).success(function(){y(t.id),a.mobile||h()}).error(function(){f.popup.alert({template:s.instant("ARCHIVE_GROUP_ERROR"),okText:s.instant("OK_GOT_IT"),okType:"button-default"})}):(l.archiveGroup(t.id).success(function(){y(t.id),a.mobile||h()}).error(function(){f.popup.alert({template:s.instant("ARCHIVE_GROUP_ERROR"),okText:s.instant("OK_GOT_IT"),okType:"button-default"})}),i.eventTrack("archiveGroupConfirm",{category:"groups"})):i.eventTrack("archiveGroupCancel",{category:"groups"})}))},a.closeJoinGroupModal=function(){return f.modal.close(a.joinModal).then(function(e){a.joinModal=e,a.groupCodeError=void 0})},a.clearGroupSearch=function(){a.searchQuery.query="",a.hasSearchEntry=!1},a.joinGroup=function(){var e;if(!a.showGroupCode||(e=$("#groupCode").val())&&0!==e.length){a.groupCodeError=void 0;var t=a.joinForm.joinGroupNickname.trim();t&&0!==t.length?(a.joiningGroup=!0,a.showGroupCode||a.joinGroupCode?(e||(e=a.joinGroupCode),l.joinGroup(e,t).success(function(e){a.loadGroups(!0),a.clearGroupSearch(),a.closeJoinGroupModal().then(function(){a.joiningGroup=!1,a.mobile||r.go("app.groups",{groupId:a.joinGroupId})}),a.mobile&&n.resize()}).error(function(e,t,n,o){if(i.addEventAppsee("errorTriggered","joinGroup"),404==t)a.groupCodeError=s.instant("GROUP_CODE_NOT_FOUND");else f.popup.alert({template:s.instant("JOIN_GROUP_ERROR"),okText:s.instant("OK_GOT_IT"),okType:"button-default"});a.joiningGroup=!1})):l.acceptInvite(a.joinGroupId,t).success(function(e){a.loadGroups(!0),a.closeJoinGroupModal(),a.joiningGroup=!1}).error(function(){i.addEventAppsee("errorTriggered","acceptInvite");f.popup.alert({template:s.instant("JOIN_GROUP_ERROR"),okText:s.instant("OK_GOT_IT"),okType:"button-default"});a.joiningGroup=!1})):a.groupError=s.instant("GROUP_NICKNAME")}else a.groupCodeError=s.instant("GROUP_CODE_PLACEHOLDER")},a.showJoinGroup=function(e,t){var n;a.groupError=void 0,a.showGroupCode=!1,a.joinGroupId=e,a.joinGroupCode=t,a.joinForm={joinGroupNickname:u.getAccountUser().user.publicName},n=a.mobile?"views/groups/groups.joinGroup.modal.html":"templates/groups/groups.joinGroup.modal.html",f.modal.open({modalId:"JoinGroupModal",templateUrl:n,scope:a,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){a.joinModal=e})},a.showJoinGroupByCode=function(){var e;a.groupError=void 0,a.showGroupCode=!0,a.joinGroupId=void 0,a.joinGroupCode=void 0,a.joinForm={joinGroupNickname:u.getAccountUser().user.publicName},e=a.mobile?"views/groups/groups.joinGroup.modal.html":"templates/groups/groups.joinGroup.modal.html",f.modal.open({modalId:"JoinGroupModal",templateUrl:e,scope:a,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){a.joinModal=e})},a.getGroupDescription=function(e){var t=e.description;return t&&140<t.length&&(t=t.substring(0,140)+"..."),t},a.joinCuratedGroup=function(e,t){a.showJoinGroup(e,t),a.closeBrowseGroupsModal()},a.closeBrowseGroupsModal=function(){f.modal.close(a.browseGroupsModal).then(function(e){a.browseGroupsModal=e})},a.browseCuratedGroups=function(){var e;u.setUserPreference("viewed_groups_popup",!0),a.displayingCategories={},a.loadingCuratedGroups=!0,e=a.mobile?"views/groups/groups.browseGroups.modal.html":"templates/groups/groups.browseGroups.modal.html",f.modal.open({modalId:"BrowseGroupsModal",templateUrl:e,scope:a,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){a.browseGroupsModal=e,l.findCuratedGroups().success(function(e){l.initializeCuratedGroups(a,e),a.loadingCuratedGroups=!1}).error(function(e){console.log("Error loading curated groups:"),console.log(e),a.loadingCuratedGroups=!1})})},a.displayingCategories={},a.isDisplayingCategory=function(e){return!!a.displayingCategories[e]},a.toggleCategoryDisplay=function(e){a.isDisplayingCategory(e)?delete a.displayingCategories[e]:a.displayingCategories[e]=!0,n.resize()},a.hasSearchEntry=!1,a.isSearching=!1,a.searchableGroups=void 0,a.searchGroups=function(){T&&t.cancel(T),T=t(O,1e3)},a.deleteInvite=function(t){f.popup.confirm({template:"<div>"+s.instant("DELETE_INVITE_PROMPT")+"</div>",cancelText:s.instant("CANCEL"),cancelType:"button-default",okText:s.instant("DELETE"),okType:"button-default"}).then(function(e){e&&l.deleteInvite(t).success(function(){for(var e=0;e<a.pendingInvites.length;++e){a.pendingInvites[e].userGroup.id==t&&a.pendingInvites.splice(e,1)}}).error(function(){i.addEventAppsee("errorTriggered","deleteInvite");f.popup.alert({template:s.instant("DELETE_INVITE_ERROR"),okText:s.instant("OK_GOT_IT"),okType:"button-default"})})})},a.goToGroup=function(e){if(!a.checkOfflineMode()){var t="GROUP"==e.groupType?"date":"hotness";if("GROUP"==e.groupType){var n=u.getUserPreference("viewed_community_rules");n&&"true"==n?r.go("app.group-posts",{groupId:e.id,order:t}):r.go("app.groups-help",{intro:!0,groupId:e.id,order:t})}else{var o=u.getUserPreference("viewed_community_rules");o&&"true"==o?r.go("app.communities-posts",{groupId:e.id,order:t}):r.go("app.communities-help",{intro:!0,groupId:e.id,order:t})}}},a.toggleMobileSideBar=function(){$("body").toggleClass("showing-mobile-side-bar")},a.$on("$ionicView.enter",function(){S()}),a.$on("$ionicView.afterLeave",function(){E()});var A=function(){pref=u.getUserPreference("communities_ineligible"),"true"==pref&&r.go("app.home")};!a.mobile&&a.isAppReady()&&A(),a.$on("event:initializedFromStorage",function(){A()}),a.$on("event:pacificaReady",function(){A()}),E(),a.mobile||a.loadGroups(!0),l.initEditFunctionality(a),l.initCreateGroupFunctionality(a),l.initValidateEmailFunctionality(a),l.initEditNicknameFunctionality(a)}]),angular.module("groupsHelpCtrl",[]).controller("GroupsHelpCtrl",["$scope","$sce","$state","$stateParams","$controller","$translate","$ionicHistory","AccountService",function(e,n,t,o,i,a,r,s){i("HelpCtrl",{$scope:e}),e.getHelpSlide=function(e){var t="GROUPS_HELP_SLIDE_"+e;return n.trustAsHtml(a.instant(t))},e.confirm=function(){s.setUserPreference("viewed_groups_disclaimer","true"),r.currentView(r.backView()),t.go("app.group-posts",{groupId:o.groupId,order:o.order},{location:"replace"})}}]),angular.module("groupsProfileCtrl",[]).controller("GroupsProfileCtrl",["$scope","$timeout","$stateParams","$ionicScrollDelegate","$controller","$translate","AccountService","GroupsService","OverlayService",function(o,t,n,i,e,a,r,s,c){function u(e,t){if(e)for(var n=r.getAccountUser().user.id,o=0;o<e.length;++o){var i=e[o];i.creatorId==n&&(i.creatorAvatar=t)}}function l(e){!e&&o.shares||(o.shares&&!o.otherUserId&&0!==o.shareOffset||(o.shares=[]),o.loadingShares=!0,s.getShares(o.limit,o.shareOffset,o.otherUserId?o.otherUserId:void 0).success(function(e){if(o.canLoadMoreShares=e.length==o.limit,o.shares.push.apply(o.shares,e),console.log("got shares:"),console.log(e),o.viewingOtherUser)n=e,s.getUserLikes(n).success(function(e){o.addUserVotes(e)}).error(function(){$analytics.addEventAppsee("errorTriggered","getUserLikes"),c.popup.alert({template:a.instant("LOAD_PROFILE_CONTENT_ERROR"),okText:a.instant("OK_GOT_IT"),okType:"button-default"})});else for(var t in e)o.createVoteObject(e[t]);var n;o.loadingShares=!1,i.resize()}).error(function(){c.popup.alert({template:a.instant("LOAD_PROFILE_CONTENT_ERROR"),okText:a.instant("OK_GOT_IT"),okType:"button-default"});o.loadingShares=!1}))}function d(e){if(e||!o.likes)o.likes&&!o.otherUserId&&0!==o.likeOffset||(o.likes=[]),o.loadingLikes=!0,s.getLikes(o.limit,o.likeOffset,o.otherUserId?o.otherUserId:void 0).success(function(e){for(var t in o.canLoadMoreLikes=e.length==o.limit,o.likes.push.apply(o.likes,e),console.log("got likes:"),console.log(e),e)o.createVoteObject(e[t]);o.loadingLikes=!1,i.resize()}).error(function(){$analytics.addEventAppsee("errorTriggered","getLikes");c.popup.alert({template:a.instant("LOAD_PROFILE_CONTENT_ERROR"),okText:a.instant("OK_GOT_IT"),okType:"button-default"});o.loadingLikes=!1});else for(var t=o.likes.length-1;0<=t;--t)o.hasVote(o.likes[t])||o.likes.splice(t,1)}e("AbstractGroupPostsCtrl",{$scope:o}),s.findPublicGroups(),n.userId?(o.loadingUser=!0,o.viewingOtherUser=!0,o.otherUserId=+n.userId,r.getPublicUser(o.otherUserId).success(function(e){o.user=e,n.nickname&&(o.user.publicName=n.nickname),o.loadingUser=!1}).error(function(){$analytics.addEventAppsee("errorTriggered","loadPublicUser");c.popup.alert({template:a.instant("LOAD_PROFILE_CONTENT_ERROR"),okText:a.instant("OK_GOT_IT"),okType:"button-default"});o.loadingUser=!1})):o.user=r.getAccountUser().user,o.getUserName=function(){return o.viewingOtherUser&&o.loadingUser?a.instant("LOADING")+"...":n.nickname?n.nickname:o.user.publicName},o.deletePostFromProfile=function(e,t){"comments"==o.activeTab?o.deleteComment(e,t):o.deletePost(e,t)},o.removeComment=function(e){var t=_.findIndex(o.comments,{id:e.id});-1<t&&o.comments.splice(t,1)},o.getUserAvatar=function(){return o.viewingOtherUser&&o.loadingUser?"":"avatar_"+r.getAvatarCharacter(o.user.avatar,o.user.id)},o.isAvatarSelected=function(e){var t=r.getAccountUser().user;return e==r.getAvatarCharacter(t.avatar,t.id)},o.setUserAvatar=function(t){r.setAvatar(t).success(function(e){o.user.avatar=t,u(o.shares,t),u(o.likes,t),u(o.comments,t),o.closeAvatarModal()}).error(function(){c.popup.alert({template:a.instant("ERROR_UPDATING_AVATAR"),okText:a.instant("OK_GOT_IT"),okType:"button-default"})})},o.closeAvatarModal=function(){c.modal.close(o.chooseAvatarModal).then(function(e){o.chooseAvatarModal=e})},o.showChooseAvatar=function(){c.modal.open({modalId:"ToolsModal",templateUrl:"views/groups/communities.chooseAvatar.modal.html",scope:o,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){o.chooseAvatarModal=e})},o.getJoinedDate=function(){if(o.user){var e=new Date(o.user.createdAt);return moment(e).format("LL")}return""},o.activeTab="shares",o.limit=25,o.shares=void 0,o.shareOffset=0,o.canLoadMoreShares=!0,o.likes=void 0,o.likeOffset=0,o.canLoadMoreLikes=!0,o.comments=void 0,o.commentOffset=0,o.canLoadMoreComments=!0,s.initEditNicknameFunctionality(o),o.findPublicGroupName=function(e){return s.findPublicGroupName(e)},o.setActiveTab=function(e){"shares"==(o.activeTab=e)?l():"likes"==e?d():o.loadPostComments(),i.scrollTop(),t(i.resize)},o.removePost=function(e){o.removePostById(e.id)},o.removePostById=function(e){if(o.shares)for(var t=0;t<o.shares.length;++t)if(o.shares[t].id==e){o.shares.splice(t,1);break}if(o.likes)for(var n=0;n<o.likes.length&&o.likes[n].id!=e;++n);},o.getActivePosts=function(){return"shares"==o.activeTab?o.shares:"likes"==o.activeTab?o.likes:o.comments},o.isLoading=function(){return o.loadingShares||o.loadingLikes},o.finishedPost=function(e){var t=_.findIndex(o.getActivePosts(),{id:e.id});-1<t&&(o.getActivePosts()[t]=e)},o.loadPostComments=function(e){!e&&o.comments||(o.comments&&!o.otherUserId&&0!==o.commentOffset||(o.comments=[]),o.loadingComments=!0,s.getComments(o.limit,o.commentOffset,o.otherUserId?o.otherUserId:void 0,e).success(function(e){if(o.canLoadMoreComments=e.length==o.limit,o.comments.push.apply(o.comments,e),console.log("got comments:"),console.log(e),o.otherUserId)n=e,s.getUserCommentLikes(n).success(function(e){o.addUserCommentVotes(e)}).error(function(){$analytics.addEventAppsee("errorTriggered","getUserCommentLikes"),c.popup.alert({template:a.instant("LOAD_PROFILE_CONTENT_ERROR"),okText:a.instant("OK_GOT_IT"),okType:"button-default"})});else for(var t in e)o.createVoteObject(e[t]);var n;o.loadingComments=!1,i.resize()}).error(function(){c.popup.alert({template:a.instant("LOAD_PROFILE_CONTENT_ERROR"),okText:a.instant("OK_GOT_IT"),okType:"button-default"});o.loadingComments=!1}))},o.loadMoreLikes=function(){o.likeOffset+=o.limit,d(!0)},o.loadMoreShares=function(){o.shareOffset+=o.limit,l(!0)},o.loadMoreComments=function(){o.commentOffset+=o.limit,o.loadPostComments(!0)},o.loadMorePosts=function(){"shares"==o.activeTab?o.loadMoreShares():"likes"==o.activeTab?o.loadMoreLikes():o.loadMoreComments()},o.canLoadMore=function(){return"shares"==o.activeTab?o.canLoadMoreShares:"likes"==o.activeTab?o.canLoadMoreLikes:o.canLoadMoreComments},t(function(){$(".community-tabs").css("top",$("ion-header-bar").outerHeight()+"px")}),o.setActiveTab("shares")}]),angular.module("groupUsersCtrl",[]).controller("GroupsUsersCtrl",["$scope","$state","$timeout","$stateParams","$analytics","$translate","AccountService","GroupsService","Environment","OverlayService",function(i,o,e,t,n,a,r,s,c,u){var l;i.group=s.getGroupImmediate(+t.groupId),i.loadingUsers=!0,i.notificationData={},i.updateCommunityNotifications=function(){r.setUserPreference("receive_community_notifications",i.notificationData.communityNotification,function(){i.communityNotificationUpdated=!0,e(function(){i.communityNotificationUpdated=!1},3e3)})},i.checkOfflineMode=function(){if(c.isOnline())return!1;u.popup.alert({template:a.instant("GROUPS_OFFLINE_ERROR"),okText:a.instant("OK_GOT_IT"),okType:"button-default"});return!0},i.getGroupCode=function(){return i.group.code},i.viewUserProfile=function(e,t,n){e.stopPropagation(),e.preventDefault(),o.go("app.groups-profile",{userId:t.userId,nickname:n})},i.leaveGroup=function(e){(e.stopPropagation(),e.preventDefault(),i.checkOfflineMode())||(n.eventTrack("archiveGroupPopupFromMembers",{category:"group"}),u.popup.confirm({template:"<div>"+a.instant("LEAVE_GROUP_PROMPT")+"</div>",cancelText:a.instant("CANCEL"),cancelType:"button-default",okText:a.instant("LEAVE"),okType:"button-default"}).then(function(e){e&&s.leaveGroup(i.group.id).success(function(){i.goBack(-2)}).error(function(){u.popup.alert({template:a.instant("LEAVE_GROUP_ERROR"),okText:a.instant("OK_GOT_IT"),okType:"button-default"})})}))},i.copyCodeToClipboard=function(){cordova.plugins.clipboard.copy(i.group.code,function(){u.popup.alert({template:a.instant("GROUP_CODE_COPIED"),okText:a.instant("OK_GOT_IT"),okType:"button-default"})},function(){})},i.isOwner=function(){return i.group.creatorId==r.getAccountUser().user.id},i.isYou=function(e){return e.userId==r.getAccountUser().user.id},i.deletePendingInvite=function(t){u.popup.confirm({template:"<div>"+a.instant("DELETE_INVITE_PROMPT")+"</div>",cancelText:a.instant("CANCEL"),cancelType:"button-default",okText:a.instant("DELETE"),okType:"button-default"}).then(function(e){e&&s.deleteInvite(i.group.id,t).success(function(){for(var e=0;e<i.pendingInvites.length;++e)if(i.pendingInvites[e].email==t){i.pendingInvites.splice(e,1);break}}).error(function(){u.popup.alert({template:a.instant("DELETE_INVITE_ERROR"),okText:a.instant("OK_GOT_IT"),okType:"button-default"})})})},i.removeUser=function(t){u.popup.confirm({template:"<div>"+a.instant("REMOVE_USER_PROMPT")+"</div>",cancelText:a.instant("CANCEL"),cancelType:"button-default",okText:a.instant("REMOVE"),okType:"button-default"}).then(function(e){e&&s.removeUser(i.group.id,t).success(function(){for(var e=0;e<i.groupUsers.length;++e)if(i.groupUsers[e].userId==t){i.groupUsers.splice(e,1);break}--i.group.members}).error(function(){u.popup.alert({template:a.instant("REMOVE_USER_ERROR"),okText:a.instant("OK_GOT_IT"),okType:"button-default"})})})},l=r.getUserPreference("receive_community_notifications"),i.notificationData.communityNotification=l?""+("true"==l.toLowerCase()):"true",s.initInviteFunctionality(i),s.getGroupUsers(+t.groupId).success(function(e){var t=e.groupUsers;i.groupUsers=t;for(var n=0;n<i.groupUsers.length;++n){var o=i.groupUsers[n];if(i.isYou(o)){i.groupUsers.splice(n,1),i.groupUsers.unshift(o);break}}i.pendingInvites=e.pendingInvites,i.loadingUsers=!1}).error(function(e){u.popup.alert({template:a.instant("RETRIEVE_USERS_ERROR"),okText:a.instant("OK_GOT_IT"),okType:"button-default"}),i.loadingUsers=!1})}]);