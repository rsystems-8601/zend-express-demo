window.backButtonOverride=void 0;var playingAudioLineItems=[],playerIds=0;function getMousePos(e,t){var n,i,o=e.getBoundingClientRect();return t.changedTouches&&(n=t.changedTouches[0].pageX),n||(n=void 0!==t.pageX?t.pageX:t.clientX),t.changedTouches&&(i=t.changedTouches[0].pageY),i||(i=void 0!==t.pageY?t.pageY:t.clientY),{x:n-o.left,y:i-o.top}}angular.module("pacifica",["abstractGroupPostsCtrl","accessibilityService","accountCtrl","accountService","activityService","audioService","authService","clientsCtrl","contributingFactorsCompleteCtrl","scheduleCtrl","errorService","evidenceCompleteCtrl","generalService","goalsService","groupsCtrl","groupPostCommentsCtrl","groupPostsCtrl","groupUsersCtrl","groupsHelpCtrl","groupsProfileCtrl","communitiesHelpCtrl","groupsService","habitsCtrl","habitsService","homeCtrl","homeworkModalCtrl","ionic","loginCtrl","mediaService","moodCtrl","overlayService","pacifica-templates","pacificaAnalytics","pascalprecht.translate","pathService","practitionerService","pacificaDirectives","payService","progressCtrl","relaxCtrl","skillsService","storageService","thoughtsCtrl","tokenProvider","tutorialsCtrl","webCommunityCtrl","ui.utils","upgradeCtrl","webappEnvironmentService","moment-picker","videochat","therapistCtrl","assessmentService","assessmentIntroCtrl","assessmentQuestionCtrl","assessmentResultsCtrl","ui.calendar","practitionerAccountCtrl","findClientsCtrl","homeworkService","relaxService","feedService","overlayService","ngCordova.plugins.nativeStorage"]).config(["$stateProvider","$urlRouterProvider","$logProvider","$locationProvider","$translateProvider","$analyticsProvider","$uiViewScrollProvider","momentPickerProvider","TokenProvider",function(e,t,n,i,o,r,a,c,s){o.useStaticFilesLoader({prefix:"/js/app/i18n/",suffix:".json"}),o.preferredLanguage("en"),o.fallbackLanguage("en"),n.debugEnabled(!0),a.useAnchorScroll(),initializeRoutes(e),moment.locale("en",{longDateFormat:{LTS:"h:mm:ss A",LT:"h:mm A",L:"M/D",LL:"MMMM D, YYYY",LLL:"MMMM D, YYYY LT",LLLL:"dddd, MMMM D, YYYY LT"},calendar:{lastDay:"[Yesterday at] LT",sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",lastWeek:"L LT",nextWeek:"dddd [at] LT",sameElse:"L LT"}}),moment.locale("en-gb",{longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"D/M",LL:"D MMMM YYYY",LLL:"D MMMM YYYY LT",LLLL:"dddd, D MMMM YYYY LT"},calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"L LT",sameElse:"L LT"}}),moment.locale("es",{longDateFormat:{LT:"H:mm",LTS:"LT:ss",L:"D/M",LL:"D [de] MMMM [de] YYYY",LLL:"D [de] MMMM [de] YYYY LT",LLLL:"dddd, D [de] MMMM [de] YYYY LT"},calendar:{sameDay:function(){return"[hoy a la"+(1!==this.hours()?"s":"")+"] LT"},nextDay:function(){return"[mañana a la"+(1!==this.hours()?"s":"")+"] LT"},nextWeek:function(){return"dddd [a la"+(1!==this.hours()?"s":"")+"] LT"},lastDay:function(){return"[ayer a la"+(1!==this.hours()?"s":"")+"] LT"},lastWeek:"L LT",sameElse:"L LT"}}),moment.locale("fr",{longDateFormat:{LT:"HH:mm",LTS:"LT:ss",L:"D/M",LL:"D MMMM YYYY",LLL:"D MMMM YYYY LT",LLLL:"dddd D MMMM YYYY LT"},calendar:{sameDay:"[Aujourd'hui à] LT",nextDay:"[Demain à] LT",nextWeek:"dddd [à] LT",lastDay:"[Hier à] LT",lastWeek:"L LT",sameElse:"L LT"}}),c.options({hoursFormat:"h a"}),s.hasToken()?t.otherwise("/app/home"):t.otherwise("/app/login")}]).run(["$rootScope","$window","$location",function(i,e,t){var n,o,r,a,c;i.location=t,i.loadedTranslation=!1,$(window).on("hashchange",function(e){var t=e.originalEvent.oldURL,n=(e.originalEvent.newURL,$("body").hasClass("modal-open"));n&&"function"==typeof i.closeActiveModal?(i.closeActiveModal(),i.closeActiveModal=void 0,setTimeout(function(){window.location=t},0)):n&&"function"!=typeof i.closeActiveModal&&console.log("Cannot close modal from rootScope without a close-handler defined.")}),e.fbAsyncInit=function(){FB.init({appId:"830202777051419",status:!0,cookie:!0,xfbml:!0,version:"v3.1"})},n=document,o="script",r="facebook-jssdk",c=n.getElementsByTagName(o)[0],n.getElementById(r)||((a=n.createElement(o)).id=r,a.src="https://connect.facebook.net/en_US/sdk.js",c.parentNode.insertBefore(a,c))}]).filter("activeClients",["$filter",function(e){return function(e){return activeClients=[],e.forEach(function(e){"CONNECTED"!=e.status&&"INVITED"!=e.status||activeClients.push(e)}),activeClients}}]).controller("AppCtrl",["$scope","$rootScope","$state","$http","$timeout","$translate","$analytics","$ionicModal","$ionicPopup","ErrorService","AccountService","HabitsService","GoalsService","AudioService","GeneralService","PractitionerService","Environment","TokenService","AssessmentService","GroupsService","ActivityService","PathService","AccessibilityService","$sce","OverlayService",function(u,r,i,e,n,t,a,o,c,s,l,d,g,p,m,f,v,h,T,L,C,M,w,S,y){u.retrievedUserContext=!1,u.appIsReady=!1,u.wasLoggedOut=!1,u.mobile=!1,u.showSidebar=!0,u.shouldShowSidebar=function(){return u.showSidebar},u.isClientsView=function(){return"practitioner.clients"==i.current.name},u.setShowSidebar=function(e){u.showSidebar=e},r.$on("$translateLoadingSuccess",function(){r.loadedTranslation=!0,D()}),localStorage.getItem("hasSeenMobileWarning")&&(u.mobile=!1),u.isMobile=function(){return l.isLoggedIn()&&u.mobile},u.checkWebRTCSupport=function(){return!(!(navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia)||function(){var e=window.navigator.userAgent,t=e.indexOf("MSIE ");if(0<t)return parseInt(e.substring(t+5,e.indexOf(".",t)),10);if(0<e.indexOf("Trident/")){var n=e.indexOf("rv:");return parseInt(e.substring(n+3,e.indexOf(".",n)),10)}var i=e.indexOf("Edge/");return 0<i&&parseInt(e.substring(i+5,e.indexOf(".",i)),10)}())||(c.alert({template:"<div>"+t.instant("BROWSER_DOES_NOT_SUPPORT_WEBRTC")+"</div>",okText:t.instant("OK_GOT_IT"),okType:"button-default"}),!1)},u.dismissToolTip=function(e){l.setUserPreference(e,!0)},u.showToolTip=function(e){if(!l.accountUser.user)return!1;var t=l.getUserPreference(e);return!t||"false"==t},u.canStartAppointment=function(e){if("TELETHERAPY"!=e.appointmentType&&"CONSULTATION"!=e.appointmentType)return!1;var t=moment(),n=moment(e.startTime),i=moment(e.startTime).add(-5,"minutes"),o=moment(e.startTime).add(e.duration,"m").add(15,"minutes");return n.isSame(n,"day")&&i.isBefore(t)&&o.isAfter(t)},u.closeTrialModal=function(){y.modal.close(u.trialModal).then(function(e){u.trialModal=e})},u.showTrialModal=function(){y.modal.open({modalId:"StartTrialModal",templateUrl:"templates/practitioner/starttrial.modal.html",scope:u,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){u.trialModal=e})},u.isComplimentary=function(){var e=l.getAccountUser();return e&&e.account&&"COMPLIMENTARY"==e.account.paymentType},u.canUpgrade=function(){return!l.isPremiumEnabled()||!!u.isComplimentary()},u.getComplimentaryRemainingDays=function(){var e=l.getAccountUser();if(e&&e.account&&"COMPLIMENTARY"==e.account.paymentType){var t=new Date(e.account.premiumExpiresAt),n=new Date;if(n<t){var i=t.getTime(),o=n.getTime();return Math.floor((i-o)/864e5)}}return 0},u.showClinicianPremiumModal=function(){y.modal.open({modalId:"ClinicianPremiumModal",templateUrl:"templates/practitioner/upgrade.html",scope:u,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){u.clinicianUpgradeModal=e})},u.closeClinicianPremiumModal=function(){y.modal.close(u.clinicianUpgradeModal).then(function(e){u.clinicianUpgradeModal=e})};var P,A,b=!(u.useWebApp=function(){u.mobile=!1,localStorage.setItem("hasSeenMobileWarning","true"),i.go("app.home")}),Y=localStorage.getItem("clientView");function D(){r.loadedTranslation&&u.retrievedUserContext&&(u.appIsReady=!0,a.initialize(v.getGATrackingCode(),v.getAppVersion(),i.current.url),L.initFromLocalStorage(),n(function(){r.$broadcast("event:pacificaReady")}))}Y&&"true"==Y&&(b=!0),u.showClientView=function(){b=!0,localStorage.setItem("clientView","true"),u.removePractitionerClass(),window.location.hash="#/app"},u.setClinicianView=function(){b=!1,localStorage.removeItem("clientView"),u.addPractitionerClass()},u.showClinicianView=function(){u.setClinicianView(),window.location.hash="#/practitioner/clients"},u.isShowingClientView=function(){return b},u.isPractitioner=function(){return l.isPractitioner()},u.hasSignedBAA=function(){var e=l.getAccountUser();return!(!e||!e.practitioner)&&e.practitioner.baaSigned},u.isInPreviewMode=function(){var e=l.getAccountUser();return e&&e.practitioner&&!u.hasSignedBAA()},u.isInInviteMode=function(){var e=l.getUserPreference("practitioner_completed_postupgrade");return!(u.isInPreviewMode()||e&&"false"!=e)},u.isPHI=function(){return l.isPHI()},u.restartLogoutTimer=function(){if(u.cancelLogoutTimer(),l.isLoggedIn()){if(l.isPractitioner()&&!u.isInPreviewMode())return;P=n(function(){l.logout().success(function(){$("html").removeClass("practitioner"),r.$broadcast("event:loginRequired")})},l.getLoginTimeout())}},u.cancelLogoutTimer=function(){P&&(n.cancel(P),P=void 0)},u.$on("$stateChangeSuccess",function(e,t,n,i,o){"app.upgrade"==i.name&&"app.login"==t.name?(r.returnToState=i,r.returnToParams=o):(delete r.returnToState,delete r.returnToParams),"app.login"==t.name&&(u.appRenderReady=!0),-1<t.name.indexOf("practitioner")&&u.setClinicianView(),a.pageTrack(t.url),u.restartLogoutTimer()}),v.isDebug()?window.onerror=function(e,t,n){console.log("JS Error:"),console.log(e),alert("ERROR:"+e+"\nurl: "+t+"\nline: "+n),e+="\n"+(new Error).stack,l.postJSError(e,t,n)}:window.onerror=function(e,t,n){console.log("JS Error:"),console.log(e),e+="\n"+(new Error).stack,l.postJSError(e,t,n)},u.serverError=!1,u.downloadedFile=!1,u.showingPremiumModal=!1,u.loadingUserContext=!1,u.lastUserContextRequest=void 0,u.getLang=function(){var e=l.getLocale();return e?l.getLang(e):l.getLang("en-us")},u.isLoggedIn=function(){var e=l.getAccountUser();return e&&e.user},u.isPremium=function(){return l.isPremiumEnabled()},u.hasSignedTOS=function(){return"true"==l.getUserPreference("signed_supplemental_tos")},u.isEmailValidated=function(){return l.isEmailValidated()},u.showPremiumModal=function(){u.showingPremiumModal=!0},u.hidePremiumModal=function(){u.showingPremiumModal=!1},"undefined"!=typeof gapi&&gapi.load("auth2",function(){gapi.auth2.init({client_id:googlePlayClientID}),u.googleAuth=gapi.auth2.getAuthInstance()}),u.socialLogout=function(){u.googleAuth&&1==u.googleAuth.isSignedIn.get()&&u.googleAuth.signOut().then(function(){console.log("Signing out for Google")}),FB.getLoginStatus(function(e){"connected"==e.status&&FB.logout(function(e){console.log("Signing out for Facebook")})})},u.logout=function(){u.socialLogout(),l.logout().success(function(){r.$broadcast("event:loginRequired")})},u.showReedemGiftCode=function(){i.go("app.redeem")},u.isAppReady=function(){return u.appIsReady},window.showTermsOfService=u.showTermsOfService=function(){window.open("http://www.thinkpacifica.com/tos/","_blank")},window.showPrivacyPolicy=u.showPrivacyPolicy=function(){window.open("http://www.thinkpacifica.com/privacy/","_blank")},u.getUpdatedAgreementText=function(){return S.trustAsHtml(t.instant("UPDATED_AGREEMENT_TEXT"))},u.showAgreement=function(){l.shouldViewTerms()&&(r.showingAgreementModal||"app.login"==i.current.name||(r.showingAgreementModal=!0,y.modal.open({modalId:"AcceptTermsModal",templateUrl:"templates/acceptTerms.modal.html",scope:u,animation:"slide-in-up",ignoreStatusBar:!1,recordAppseeEvent:!1}).then(function(e){u.agreementModal=e})))},r.$on("event:userContextInitialized",function(){u.appRenderReady=!0,u.retrievedUserContext=!0,u.wasLoggedOut=!1,checkLocalePreference(),E(),A=n(k,U),D(),r.loadedTranslation?u.showAgreement():r.$on("event:pacificaReady",u.showAgreement)}),u.acceptTerms=function(){y.modal.close(u.agreementModal).then(function(e){u.agreementModal=e,r.showingAgreementModal=!1,l.userAcceptTerms()})},u.retrieveUserContext=function(){if(u.loadingUserContext=!0,console.log("retrieving user context."),!h.hasToken())return console.log("No token to retrieve user context."),void i.go("app.login",{},{location:"replace"});l.findUserContext().success(function(e){console.log("got user context:"),console.log(e),u.initializeUserContext(e,r,l,d,g,p,v,T,C,M),u.loadingUserContext=!1,u.lastUserContextRequest=new Date,u.isPractitioner()&&(f.checkForAgreements(u),f.initClientFunctionality(u),f.initAppointmentFunctionality(u),u.refreshClients())}).error(function(e,t,n,i){console.log("error loading user context"),u.loadingUserContext=!1,u.retrievedUserContext=!0,D()})},u.goBack=function(e){window.backButtonOverride?window.backButtonOverride():history.back()},u.goToClient=window.goToClient=function(e){i.go("practitioner.client.view",{clientId:e})},u.goToClientTab=function(e,t){i.go("practitioner.client.tab",{clientId:e,activeTab:t})},u.goClients=function(){l.isPractitioner()&&i.go("practitioner.clients")},u.showingAddDropdown=!1,u.showingAccountDropdown=!1,u.showingMobileMenu=!1,u.toggleMobileMenu=function(){u.showingMobileMenu=!u.showingMobileMenu},u.getRecurringDisplay=function(e){return _.find(u.recurringOptions,{value:e}).display},u.recurringOptions=[{value:0,display:"Just Once"},{value:7,display:"Every Week"},{value:14,display:"Every 2 Weeks"},{value:28,display:"Every 4 Weeks"}],u.goTutorials=function(){l.isPractitioner()&&i.go("practitioner.tutorials")},u.goToSchedule=function(){l.isPractitioner()&&i.go("practitioner.schedule")},u.goHome=function(){i.go("app.home")},u.goToProgress=function(e){l.isPractitioner()&&e?l.isPremiumEnabled()||u.isViewingPersonalAccount()?i.go("practitioner.progress",{userId:e.account.id,viewingOtherUser:!0}):u.showClinicianPremiumModal():i.go("app.progress")},u.getClientName=function(){if(u.client)return u.client.account.firstName+" "+u.client.account.lastName},u.goToAccount=function(e){if(l.isPractitioner()&&!b){var t={};e&&(t.activeTab=e),i.go("practitioner.account",t)}else i.go("app.account")},u.removePractitionerClass=function(){$("html").hasClass("practitioner")&&$("html").removeClass("practitioner")},u.addPractitionerClass=function(){$("html").addClass("practitioner")},u.goToTherapist=function(){i.go("app.therapist")},u.goToGroups=function(){i.go("app.groups")},u.goToCommunity=function(){i.go("app.community")},u.goToUpgrade=function(e,t){var n;e&&(n={plan:e,couponCode:t}),l.isPractitioner()?u.hasSignedBAA()?i.go("practitioner.upgrade",n):u.goClients():i.go("app.upgrade",n),u.closeClinicianPremiumModal(),u.hidePremiumModal()},u.hideTherapistTab=function(){var e=l.getConnectionContext();return!(e&&e.practitioners&&0<e.practitioners.length)&&"true"!=l.getUserPreference("working_with_professional")},u.isRelaxActivity=function(){return i.includes("app.breathe")||i.includes("app.meditation")},u.isLoginActivity=function(){return i.includes("app.login")},u.canViewCommunities=function(){return"true"!=l.getUserPreference("communities_ineligible")},u.isTabActive=function(e){return"Home"==e?i.includes("app.home"):"Progress"==e?i.includes("app.progress"):"Community"==e?i.includes("app.community"):"Groups"==e?i.includes("app.groups"):"Account"==e?i.includes("app.account"):"Therapist"==e?i.includes("app.therapist"):"Clients"==e?i.includes("practitioner.clients"):"Schedule"==e?i.includes("practitioner.schedule"):"Tutorials"==e?i.includes("practitioner.tutorials"):"activity"==e?i.includes("practitioner.progress"):"Find"==e&&i.includes("practitioner.findClients")},u.goToFindClients=function(){l.isPractitioner()&&i.go("practitioner.findClients")},u.goToStartConsult=function(e){l.isPractitioner()&&i.go("practitioner.findClients",{startSession:e})},u.getConsultationsNotificationsCount=function(){return l.appointmentContext.claimedConsultationNotificationCount},window.checkLocalePreference=function(){var e,t=l.getUserPreference("preferred_locale");void 0===t?(e=navigator.languages&&0<navigator.languages.length?navigator.languages[0]:navigator.userLanguage?navigator.userLanguage:navigator.language)?l.setLocale(e):l.setLocale("en-US"):l.updateLocale(t)},u.getSchedulerDateDisplay=function(e){return moment(e).format("MMMM Do, YYYY")},u.getSchedulerTimeDisplay=function(e){return moment(e).format("LT")},u.roundUpToNearestFiveMinutes=function(e){return additionalMinutes=5-e.minutes()%5,5==additionalMinutes?e:e.add(additionalMinutes,"m")},u.isPacificaLiteUser=function(){var e=l.getSplitTestContext();return!(!e||!e.splitTestGroups)&&"lite"==e.splitTestGroups.umnPilot},u.initializeUserContext=function(e,t,n,i,o,r,a,c,s,l){window.initializeUserContext(e,t,n,i,o,r,a,c,s,l,u)},u.hasBeenLoggedOut=function(){return u.wasLoggedOut},w.initialize().then(function(e){}),u.$on("event:loginRequired",function(e,t){u.wasLoggedOut=!0,h.clear(),$("html").hasClass("practitioner")&&$("html").removeClass("practitioner"),t||(t={}),i.go("app.login",t,{location:"replace"}),n(function(){l.clearData(),d.logout(),g.logout(),L.logout(),p.logout(),localStorage.clear(),E()})}),u.hasLoadedTranslation=function(){return r.loadedTranslation},checkLocalePreference(),u.retrieveUserContext();var U=6e4;function E(){A&&(n.cancel(A),A=void 0)}function k(){l.isLoggedIn()&&(l.ping(),A=n(k,U))}}]);